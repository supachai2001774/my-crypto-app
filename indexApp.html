<!DOCTYPE html>
<!-- 
    SYSTEM: Crypto Miner Tycoon
    BACKEND: Hybrid (LocalStorage / MySQL Ready)
    DATABASE SCHEMA: See database.sql
-->
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Miner Tycoo</title>
    <script src="sync-manager.js"></script>
    <script src="live-sync.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="theme-color" content="#4e54c8">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=1.2">
    <style>
        /* AI Toast System */
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 11000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .ai-toast { pointer-events: auto; background: rgba(10, 14, 30, 0.95); backdrop-filter: blur(10px); border-left: 4px solid #00f2ff; border-radius: 4px; padding: 15px 20px; color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 15px; min-width: 300px; transform: translateX(100%); animation: slideIn 0.3s ease-out forwards; overflow: hidden; position: relative; }
        .ai-toast::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #00f2ff, transparent); animation: scan 2s linear infinite; }
        .ai-toast.success { border-color: #00b894; }
        .ai-toast.error { border-color: #ff7675; }
        .ai-toast.warning { border-color: #fdcb6e; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { transform: translateX(100%); opacity: 0; } }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* AI Maintenance Overlay */
        .maint-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 8, 20, 0.98); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #00f2ff; font-family: 'Kanit', sans-serif; backdrop-filter: blur(15px); overflow: hidden; }
        .maint-content { text-align: center; position: relative; z-index: 2; padding: 40px; border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 20px; background: rgba(0,0,0,0.6); box-shadow: 0 0 30px rgba(0, 242, 255, 0.1); max-width: 90%; width: 400px; }
        .maint-icon { font-size: 4rem; margin-bottom: 20px; animation: pulse 2s infinite; text-shadow: 0 0 20px rgba(0, 242, 255, 0.5); }
        .maint-title { font-size: 2rem; font-weight: bold; margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase; background: linear-gradient(90deg, #fff, #00f2ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .maint-desc { color: #aaa; font-size: 1rem; line-height: 1.6; }
        .maint-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px); background-size: 30px 30px; pointer-events: none; z-index: 1; }
        .maint-scanline { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: rgba(0, 242, 255, 0.3); opacity: 0.5; animation: scanline 3s linear infinite; pointer-events: none; z-index: 1; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes scanline { 0% { top: -10%; } 100% { top: 110%; } }
    </style>
</head>
<body>

    <div id="maintenanceOverlay" class="maint-overlay" style="display: none;">
        <div class="maint-grid"></div>
        <div class="maint-scanline"></div>
        <div class="maint-content">
            <i class="fas fa-microchip maint-icon" onclick="emergencyExit()"></i>
            <div class="maint-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</div>
            <div style="color: #00f2ff; font-size: 1.2rem; margin-bottom: 10px; font-weight: bold;">‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</div>
            <p id="maintMessage" class="maint-desc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..</p>
            <div style="margin-top: 20px; font-size: 0.8rem; color: rgba(0, 242, 255, 0.5);">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ AI: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
        </div>
    </div>

    <div class="app-container">
        
        <div class="top-header">
    <div class="profile-pill" onclick="openNotificationHistory()">
        <div class="avatar-small" id="headerAvatar"><i class="fas fa-user"></i></div>
        <div>
            <div id="headerName" class="header-name">Guest</div>
            <div id="headerID" class="header-id">ID: ---</div>
        </div>
        <div style="margin-left: 5px; position: relative;">
            <i class="fas fa-bell" style="color: #aaa; font-size: 0.9rem;"></i>
            <div id="headerNotifBadge" class="neon-badge" style="position: absolute; top: -8px; right: -8px; display: none;">0</div>
        </div>
    </div>
    
    <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Refresh ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
    <div style="display: flex; gap: 15px; align-items: center;">
        <div style="font-size: 1rem; cursor: pointer; position: relative;" 
             onclick="manualRefresh()" 
             title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Ctrl+R)">
            <i class="fas fa-sync" id="refreshIcon"></i>
            <span id="syncStatus" style="position: absolute; top: -5px; right: -5px; width: 8px; height: 8px; background: #00ff9d; border-radius: 50%; box-shadow: 0 0 5px #00ff9d;"></span>
        </div>
        <div style="font-size: 1. 2rem;" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
        </div>
    </div>
</div>
                    
        <div class="page active" id="dashboardPage">
            <!-- AI Dashboard Card (Consolidated Stats) -->
            <div class="ai-dashboard-card">
                <div style="position: absolute; top: 15px; right: 15px; z-index: 10;">
                    <button onclick="confirmReset()" style="background: rgba(255, 0, 85, 0.1); border: 1px solid rgba(255, 0, 85, 0.3); color: #ff0055; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='rgba(255, 0, 85, 0.2)'" onmouseout="this.style.background='rgba(255, 0, 85, 0.1)'" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                        <i class="fas fa-redo-alt" style="font-size: 0.8rem;"></i>
                    </button>
                </div>
                <div class="ai-core-visual">
                    <div class="ai-core-inner"></div>
                    <i class="fas fa-microchip" style="font-size: 2rem; color: var(--primary); position: absolute; z-index: 2; filter: drop-shadow(0 0 10px var(--primary));"></i>
                </div>
                <h2 style="margin: 0 0 5px; color: #fff; font-size: 1.5rem; letter-spacing: 1px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏∏‡∏î AI</h2>
                <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 15px;">
                    <div style="font-size: 0.8rem; color: #94a3b8;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="miningStatus" style="color: var(--success); text-shadow: 0 0 10px var(--success);">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span></div>
                    <div style="font-size: 0.8rem; color: #94a3b8;">‡πÇ‡∏´‡∏°‡∏î: <span id="miningMode" style="color: #94a3b8;">‡∏û‡∏±‡∏Å</span></div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-item">
                        <div class="label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏∏‡∏î</div>
                        <div class="value" id="hashrateDisplay">0.0</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">MH/s</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
                        <div class="value" id="dailyProfitDisplay">‡∏ø0.00</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</div>
                        <div class="value" id="balanceDisplay">‡∏ø0.00</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
                        <div class="value" id="incomeDisplay">+‡∏ø0.00</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">/‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
                        <div style="font-size: 0.65rem; color: var(--success); margin-top: 2px; white-space: nowrap;" id="estDailyDisplay">‡∏ß‡∏±‡∏ô‡∏•‡∏∞ ‡∏ø0.00</div>
                    </div>
                </div>
            </div>

            <!-- Mining Connection Alert (Hidden by default) -->
            <div id="miningConnectionStatus" style="display: none; background: rgba(255, 0, 85, 0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 0, 85, 0.3); margin: 15px 0; animation: slideIn 0.3s ease-out;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 0, 85, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-wifi-slash" style="color: var(--danger); font-size: 1.2rem; animation: pulse 1s infinite;"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: var(--danger); font-size: 0.95rem;">‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î</div>
                        <div style="font-size: 0.8rem; color: #cbd5e1;">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...</div>
                    </div>
                    <button onclick="reconnectMining()" class="cyber-btn" style="padding: 8px 15px; font-size: 0.8rem; white-space: nowrap; background: var(--danger); border: none; box-shadow: 0 0 10px rgba(255, 0, 85, 0.3);">
                        <i class="fas fa-sync"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                    </button>
                </div>
            </div>

            <!-- AI Announcement Board -->
            <div class="ai-announce-card" onclick="openAnnounceModal()" style="cursor: pointer; margin: 20px 0; position: relative; overflow: hidden; border-radius: 16px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(0, 242, 255, 0.2); box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);">
                <!-- Scanline effect -->
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none;"></div>
                
                <div style="padding: 15px; display: flex; gap: 15px; align-items: center; position: relative; z-index: 2;">
                    <!-- Animated Icon -->
                    <div style="width: 50px; height: 50px; border-radius: 12px; background: rgba(0, 242, 255, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(0, 242, 255, 0.3); position: relative;">
                        <i class="fas fa-rss" style="color: #00f2ff; font-size: 1.5rem; animation: pulse 2s infinite;"></i>
                        <div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #00f2ff; border-radius: 50%; box-shadow: 0 0 10px #00f2ff; animation: blink 1s infinite;"></div>
                    </div>
                    
                    <!-- Content -->
                    <div style="flex: 1; overflow: hidden;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <span style="color: #00f2ff; font-size: 0.7rem; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 0 5px rgba(0, 242, 255, 0.5);">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏∞‡∏ö‡∏ö</span>
                        <span id="annBadge" style="display:none; background: rgba(245, 158, 11, 0.2); border: 1px solid #f59e0b; color: #f59e0b; padding: 1px 5px; border-radius: 4px; font-size: 0.6rem;">‡πÉ‡∏´‡∏°‡πà</span>
                            <span id="annLabel" style="font-size: 0.7rem; color: #aaa; margin-left: auto;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                        </div>
                        <div id="dashboardAnnounce" style="color: #fff; font-family: 'Courier New', monospace; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 0 2px rgba(255, 255, 255, 0.5);">
                            ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="openShopPage()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem;"><i class="fas fa-shopping-cart"></i></div>
                    <div class="menu-label">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div id="shopBadgeFloat" class="badge-float" style="display: none;">‡πÉ‡∏´‡∏°‡πà</div>
                </div>
                <div class="menu-item" onclick="openWalletModal('deposit')">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--success); box-shadow: 0 0 10px rgba(0, 255, 157, 0.2);"><i class="fas fa-arrow-circle-down" style="color: var(--success);"></i></div>
                    <div class="menu-label">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</div>
                    <div id="depositBadge" class="badge-float" style="background: var(--success); display: none;">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                </div>
                <div class="menu-item" onclick="openWalletModal('withdraw')">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--warning); box-shadow: 0 0 10px rgba(255, 184, 0, 0.2);"><i class="fas fa-arrow-circle-up" style="color: var(--warning);"></i></div>
                    <div class="menu-label">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                    <div id="withdrawBadge" class="badge-float" style="background: var(--warning); display: none;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</div>
                </div>
                <div class="menu-item" onclick="showBankModal()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem;"><i class="fas fa-university"></i></div>
                    <div class="menu-label">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                </div>
                <div class="menu-item" onclick="showReferralModal()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--danger); box-shadow: 0 0 10px rgba(255, 0, 85, 0.2);"><i class="fas fa-users" style="color: var(--danger);"></i></div>
                    <div class="menu-label">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</div>
                    <div class="badge-float" style="background: var(--danger); animation: none; top: -5px; right: -5px;">‡∏°‡∏≤‡πÅ‡∏£‡∏á</div>
                </div>
                <div class="menu-item" onclick="switchPage('settingsPage', document.getElementById('navSettings'))">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: #a0aec0;"><i class="fas fa-cog" style="color: #a0aec0;"></i></div>
                    <div class="menu-label">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
                </div>
            </div>

            <!-- Active Contracts Section -->
            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px;">
                    <div style="font-size: 0.9rem; color: #fff; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-file-contract" style="color: var(--primary);"></i>
                        ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);" id="activeContractCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                <div id="activeContractsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>

            <!-- Server Status -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; border: 1px solid var(--border); margin-bottom: 80px;">
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); animation: pulse 2s infinite;"></div>
                    <span style="color: var(--success); font-weight: bold; font-size: 0.9rem;">LIVE SYSTEM</span>
                </div>
                <div style="font-size: 0.65rem; color: #aaa; margin-top: 5px;">MySQL Ready (Mode: Hybrid)</div>
            </div>
        </div>

        <div class="page" id="shopPage">
            <h2 style="margin-left: 10px; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 10px; letter-spacing: 1px;">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
            <div id="shopList" class="shop-grid-new"></div>
        </div>

        <div class="page" id="walletPage">
            <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
            <div id="transList" style="margin-top: 10px;"></div>
        </div>

        <div class="page" id="settingsPage">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 100px; height: 100px; margin: 0 auto; position: relative;">
                    <div class="avatar-small" style="width: 100%; height: 100%; border: 4px solid rgba(255,255,255,0.1);" id="settingAvatar">
                        <i class="fas fa-user" style="font-size: 3rem;"></i>
                    </div>
                    <div onclick="document.getElementById('uploadProfile').click()" style="position: absolute; bottom: 0; right: 0; background: var(--accent); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <i class="fas fa-camera" style="font-size: 0.8rem; color: #000;"></i>
                    </div>
                </div>
                <input type="file" id="uploadProfile" hidden accept="image/*" onchange="changeProfilePic()">
                <h2 id="settingName" style="margin: 10px 0 5px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
                <div id="settingID" style="color: #aaa;">ID: ---</div>
                <div style="margin-top: 5px; color: #00b894; font-size: 0.8rem;"><i class="fas fa-circle" style="font-size: 6px;"></i> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
            </div>

            <div class="menu-list-item" onclick="showBankModal()">
                <i class="fas fa-university" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <div id="installAppBtn" class="menu-list-item" style="display: none; background: linear-gradient(90deg, rgba(112, 0, 255, 0.2), rgba(0, 242, 255, 0.2)); border: 1px solid var(--primary);" onclick="installPWA()">
                <i class="fas fa-download" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <div class="menu-list-item" onclick="showRemoteGuide()">
                <i class="fas fa-mobile-alt" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏Å‡∏•</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <!-- Referral Card -->
            <div class="menu-list-item" style="background: linear-gradient(135deg, rgba(255, 0, 85, 0.1), rgba(0, 0, 0, 0)); border: 1px solid var(--danger);" onclick="showReferralModal()">
                <div style="display: flex; align-items: center; width: 100%;">
                    <div style="background: rgba(255, 0, 85, 0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 0 10px var(--danger);">
                        <i class="fas fa-user-plus" style="color: var(--danger); margin: 0;"></i>
                    </div>
                    <div style="flex: 1; color: var(--danger);">
                        <div style="font-weight: bold;">‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö ‡∏ø50 + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‡∏ø100</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: var(--danger);"></i>
                </div>
            </div>

            <div style="margin-top: 20px; margin-bottom: 10px; color: #94a3b8; font-size: 0.8rem; padding-left: 5px;">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>

            <!-- Sound -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-volume-up" style="width:20px;"></i> ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                    <div class="switch-sub">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swSound" onchange="saveSystemSetting('sound_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <select id="selSound" class="input-dark" style="margin-bottom: 15px;" onchange="saveSystemSetting('sound_type', this.value); soundMgr.play(this.value);">
                <option value="standard">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</option>
                <option value="alert">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</option>
                <option value="emphasis">‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</option>
                <option value="rapid">‡∏£‡∏±‡∏ß</option>
                <option value="fast">‡πÄ‡∏£‡πá‡∏ß</option>
            </select>

            <!-- Vibration -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-mobile-alt" style="width:20px;"></i> ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô</div>
                    <div class="switch-sub">‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swVib" onchange="saveSystemSetting('vib_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <select id="selVib" class="input-dark" style="margin-bottom: 15px;" onchange="saveSystemSetting('vib_type', this.value); vibMgr.trigger(this.value);">
                <option value="standard">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</option>
                <option value="fast">‡πÄ‡∏£‡πá‡∏ß</option>
                <option value="emphasis">‡πÄ‡∏ô‡πâ‡∏ô</option>
                <option value="alert">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</option>
            </select>

            <!-- Wake Lock -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-sun" style="width:20px;"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div>
                    <div class="switch-sub">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swWake" onchange="saveSystemSetting('wake_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Live Monitor -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-desktop" style="width:20px;"></i> ‡∏à‡∏≠‡∏†‡∏≤‡∏û‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏î</div>
                    <div class="switch-sub">‡πÅ‡∏™‡∏î‡∏á Logs ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swMonitor" onchange="saveSystemSetting('monitor_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

    </div>

    <div id="liveMonitor" style="display: none; position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; border-radius: 8px; padding: 10px; z-index: 900; box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin-bottom: 5px;">
            <div style="color: #00f2ff; font-size: 0.7rem; font-weight: bold; letter-spacing: 1px;"><i class="fas fa-terminal"></i> SYSTEM TERMINAL</div>
            <i class="fas fa-times" style="color: #94a3b8; cursor: pointer; font-size: 0.8rem;" onclick="document.getElementById('liveMonitor').style.display='none'; document.getElementById('swMonitor').checked=false; saveSystemSetting('monitor_enabled', false);"></i>
        </div>
        <div id="liveMonitorContent" style="height: 100px; overflow-y: auto; font-size: 0.65rem; font-family: 'Courier New', monospace;"></div>
    </div>

    <div class="bottom-nav-glass">
        <div class="nav-btn active" id="navHome" onclick="switchPage('dashboardPage', this)">
            <i class="fas fa-home"></i>
            <div class="nav-label">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</div>
        </div>
        <div class="nav-btn" id="navShop" onclick="openShopPage()">
            <div style="position: relative;">
                <i class="fas fa-shopping-cart"></i>
                <div id="shopBadgeNav" class="nav-badge" style="display: none;"></div>
            </div>
            <div class="nav-label">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        </div>
        <div class="nav-btn" id="navWallet" onclick="openWalletPage()">
            <div style="position: relative;">
                <i class="fas fa-wallet"></i>
                <div id="navWalletBadge" class="nav-badge" style="display: none;"></div>
            </div>
            <div class="nav-label">‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</div>
        </div>
        <div class="nav-btn" id="navSettings" onclick="switchPage('settingsPage', this)">
            <i class="fas fa-cog"></i>
            <div class="nav-label">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        </div>
    </div>

    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid rgba(0, 242, 255, 0.3); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);">
                    <i class="fas fa-user-astronaut" style="font-size: 2.5rem; color: #00f2ff;"></i>
                </div>
                <h2 style="color: #00f2ff; margin: 0; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">MINING PRO</h2>
                <div style="font-size: 0.8rem; color: #94a3b8; letter-spacing: 1px;">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            </div>
            
            <div class="input-group" style="margin-bottom: 15px;">
                <div style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px; margin-left: 5px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
                <input type="text" id="loginUser" class="cyber-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            </div>
            <div class="input-group" style="margin-bottom: 25px;">
                <div style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px; margin-left: 5px;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
                <input type="password" id="loginPass" class="cyber-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            </div>
            
            <button class="cyber-btn" onclick="login()" style="width: 100%; margin-bottom: 15px;">
                <i class="fas fa-sign-in-alt"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
            
            <div style="text-align: center; font-size: 0.9rem; color: #94a3b8;">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <span style="color: #00f2ff; cursor: pointer; text-decoration: underline; text-underline-offset: 3px;" onclick="toSignup()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
            </div>
        </div>
    </div>

    <div id="signupModal" class="modal">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #00f2ff; margin: 0; letter-spacing: 1px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
                <div style="font-size: 0.8rem; color: #94a3b8;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∏‡∏î</div>
            </div>
            
            <input type="text" id="regUser" class="cyber-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" style="margin-bottom: 10px;">
            <input type="password" id="regPass" class="cyber-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" style="margin-bottom: 10px;">
            
            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;"></div>
            
            <input type="text" id="regName" class="cyber-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á)" style="margin-bottom: 10px;">
            <select id="regBank" class="cyber-input" style="margin-bottom: 10px;">
                <option value="kbank">KBANK - ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
                <option value="scb">SCB - ‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
                <option value="ktb">KTB - ‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</option>
                <option value="bbl">BBL - ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
                <option value="gsb">GSB - ‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</option>
            </select>
            <input type="tel" id="regAcc" class="cyber-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" style="margin-bottom: 10px;">
            
            <!-- Referral Code Input -->
            <div style="position: relative; margin-bottom: 20px;">
                <input type="text" id="regRefCode" class="cyber-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="padding-right: 40px;">
                <i class="fas fa-ticket-alt" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #00f2ff;"></i>
            </div>
            
            <button class="cyber-btn" onclick="signup()" style="width: 100%; margin-bottom: 15px;">
                <i class="fas fa-user-plus"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
            </button>
            
            <div style="text-align: center; font-size: 0.8rem; cursor: pointer; color: #94a3b8;" onclick="toLogin()">
                <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </div>
        </div>
    </div>

    <div id="walletModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position: absolute; right: 15px; top: 15px; cursor: pointer;" onclick="document.getElementById('walletModal').style.display='none'"></i>
            <h3 id="walletTitle">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <input type="number" id="walletAmount" class="input-dark" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
            <button class="btn-action" onclick="submitTransaction()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
    </div>

    <div id="bankModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position: absolute; right: 15px; top: 15px; cursor: pointer;" onclick="document.getElementById('bankModal').style.display='none'"></i>
            <h3>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
            <div id="myBankInfo"></div>
        </div>
    </div>

    <div id="refModal" class="modal">
        <div class="modal-content" style="padding: 0; overflow: hidden; background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; width: 90%; max-width: 400px; border-radius: 16px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.1);">
            <div style="padding: 15px; max-height: 80vh; overflow-y: auto;">
                <i class="fas fa-times" style="position: absolute; right: 10px; top: 10px; cursor: pointer; z-index: 10; color: #94a3b8; background: rgba(255,255,255,0.05); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onclick="document.getElementById('refModal').style.display='none'"></i>
                
                <!-- Header Banner -->
                <div class="ref-banner" style="background: linear-gradient(135deg, rgba(0, 242, 255, 0.1) 0%, rgba(0, 242, 255, 0.05) 100%); border: 1px solid rgba(0, 242, 255, 0.2); border-radius: 15px; padding: 15px; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0, 242, 255, 0.1); margin-bottom: 15px;">
                    <div style="position: relative; z-index: 2;">
                        <h2 style="margin: 0; font-size: 1.3rem; color: #00f2ff; font-weight: 800; letter-spacing: 1px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h2>
                        <p style="margin: 5px 0 10px; font-size: 0.8rem; color: #94a3b8;">‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                        <div style="display: inline-block; background: rgba(0, 242, 255, 0.1); padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; color: #00f2ff; border: 1px solid rgba(0, 242, 255, 0.3);">
                            <i class="fas fa-users"></i> ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                        </div>
                    </div>
                    <i class="fas fa-network-wired" style="position: absolute; right: -15px; bottom: -20px; font-size: 6rem; color: rgba(0, 242, 255, 0.05); transform: rotate(-20deg);"></i>
                </div>

                <!-- Stats Row -->
                <div class="ref-stats-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="ref-stat-box" style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="color: var(--warning); font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase;">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                        <div class="ref-stat-num" id="refPendingCount" style="color: var(--warning); font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">0</div>
                        <div style="font-size: 0.6rem; color: #64748b;">‡∏Ñ‡∏ô</div>
                    </div>
                    <div class="ref-stat-box" style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="color: var(--success); font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase;">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>
                        <div class="ref-stat-num" id="refCompletedCount" style="color: var(--success); font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);">0</div>
                        <div style="font-size: 0.6rem; color: #64748b;">‡∏Ñ‡∏ô</div>
                    </div>
                </div>

                <!-- Referral Code Box -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px; text-align: center; text-transform: uppercase;">‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0, 242, 255, 0.05); padding: 12px 15px; border-radius: 8px; border: 1px dashed rgba(0, 242, 255, 0.3); position: relative;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #00f2ff; letter-spacing: 3px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.3); font-family: monospace;" id="myRefCode">---</div>
                        <i class="fas fa-copy" style="cursor: pointer; color: #00f2ff; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: rgba(0, 242, 255, 0.1); border: 1px solid rgba(0, 242, 255, 0.3); transition: 0.3s;" onclick="copyRef()" onmouseover="this.style.background='rgba(0,242,255,0.2)'" onmouseout="this.style.background='rgba(0,242,255,0.1)'"></i>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.7rem; color: #64748b;">
                        ‡πÅ‡∏ï‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡∏¥‡∏ç
                    </div>
                </div>

                <!-- Friend List -->
                <div style="text-align: left; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; color: #fff; padding-left: 5px; border-left: 3px solid #00f2ff; padding-left: 10px;">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
                <div id="refList" style="min-height: 100px; margin-bottom: 60px;">
                    <!-- Content -->
                </div>
            </div>
            
            <!-- Bottom Floating Button -->
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; background: linear-gradient(to top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8)); border-top: 1px solid rgba(255,255,255,0.05);">
                <button class="cyber-btn" onclick="claimBonus()" id="btnClaimBonus" style="width: 100%;">
                    <i class="fas fa-gift"></i> ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (0.00)
                </button>
            </div>
        </div>
    </div>

    <div id="announceModal" class="modal">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); max-width: 400px; width: 90%; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #00f2ff; box-shadow: 0 0 10px #00f2ff;"></div>
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 90%, rgba(0, 242, 255, 0.05) 100%); pointer-events: none;"></div>
            
            <div style="text-align: center; margin-bottom: 20px; position: relative; z-index: 2;">
                <div style="width: 70px; height: 70px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid rgba(0, 242, 255, 0.3);">
                    <i class="fas fa-bullhorn" style="font-size: 2.5rem; color: #00f2ff; animation: swing 3s infinite ease-in-out;"></i>
                </div>
                <h2 style="color: white; margin: 0; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">System Broadcast</h2>
                <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
            </div>
            
            <div class="glass-panel" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">
                <div id="announceBody" style="color: #e2e8f0; font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap;"></div>
            </div>
            
            <button class="cyber-btn" style="width: 100%;" onclick="closeAnnounce()">
                <i class="fas fa-check"></i> ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö
            </button>
        </div>
    </div>

    <div id="warningFloatBadge" style="display: none; position: fixed; top: 20%; right: 0; z-index: 9900; background: rgba(255, 0, 85, 0.9); color: white; padding: 12px 15px 12px 12px; border-radius: 12px 0 0 12px; box-shadow: -5px 5px 20px rgba(255, 0, 85, 0.4); cursor: pointer; transition: 0.3s; border-left: 3px solid #fff;" onclick="showLastWarning()">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: blink 1s infinite;"></div>
            <i class="fas fa-exclamation-triangle" style="font-size: 1.2rem;"></i>
            <div style="font-size: 0.8rem; font-weight: bold; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); margin-left: 5px; max-height: 60px;">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
        </div>
    </div>

    <script>
        let lastWarningData = null;

        function showLastWarning() {
            if(lastWarningData) {
                showSystemWarningModal(lastWarningData.title, lastWarningData.msg);
            }
        }

        function hideWarningBadge() {
            const badge = document.getElementById('warningFloatBadge');
            if(badge) badge.style.display = 'none';
        }

            function manualRefresh() {
        const icon = document.getElementById('refreshIcon');
        icon.style.animation = 'spin 1s linear';
        
        setTimeout(() => {
            icon.style.animation = 'none';
        }, 1000);
        
        console.log('üîÑ Manual refresh');
        liveSync.forceRefresh();
        loadUserData();
        updateUI();
        renderUserTrans();
        renderProfile();
        loadShop();
        
        showToast('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // Add spin animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
        function checkUserBanStatus() {
    if(! currentUser) return;
    
    const isBanned = syncManager.isUserBanned(currentUser.username);
    if(isBanned) {
        showToast('‚ùå ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß', 'error');
        alert('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'); 
        logout();
    }
}
        // --- PWA Logic ---
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installAppBtn');
            if(btn) btn.style.display = 'flex';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    document.getElementById('installAppBtn').style.display = 'none';
                });
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.log('SW failed:', err));
            });
        }

        // Core Logic
        let currentUser = null;
        let balance = 0.00;
        let hashrate = 0.00;
        let dailyProfit = 0.00;
        let lastProfitDate = new Date().toDateString();
        let currentAction = '';
        let isMining = true;
        let clientIP = 'Unknown';
        
        // Fetch IP
        fetch('https://api.ipify.org?format=json')
            .then(r => r.json())
            .then(d => clientIP = d.ip)
            .catch(e => console.log('IP Fetch Error:', e));

        function getDeviceID() {
            let did = localStorage.getItem('device_id');
            if(!did) {
                did = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('device_id', did);
            }
            return did;
        }

        window.onload = function() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Referral Code
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if(refCode) {
                localStorage.setItem('pending_ref', refCode);
            }

            const saved = localStorage.getItem('current_user');
            let isValidUser = false;

            if(saved) {
                try {
                    const u = JSON.parse(saved);
                    const allUsers = JSON.parse(localStorage.getItem('mining_users')) || {};
                    if(allUsers[u.username] && allUsers[u.username]. banned) {
                        alert('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß');
                        localStorage.removeItem('current_user');
                        window.location.reload();
                    } else {
                        currentUser = u;
                        document.getElementById('loginModal').style.display = 'none';
                        initApp();
                        isValidUser = true;
                        
                        console.log('üë§ Logged in as:', currentUser.username);
                        console.log('üìä Initial Data:', { balance, hashrate });
                    }
                } catch (e) {
                    console.error('User data corrupted', e);
                    localStorage.removeItem('current_user');
                }
            }
            
            if(!isValidUser) {
                document.getElementById('loginModal'). style.display = 'flex';
            }
        };
            // ============ üî¥ LIVE SYNC LISTENERS ============

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
liveSync.on('users', (data) => {
    console.log('üì° Users data updated');
    if(currentUser) {
        const isBanned = data[currentUser. username]?.banned;
        if(isBanned) {
            showToast('‚ùå ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö', 'error');
            setTimeout(() => logout(), 2000);
        }
    }
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
liveSync.on('transactions', (transactions) => {
    console.log('üì° Transactions updated');
    renderUserTrans();
    
    if(currentUser) {
        const myTrans = transactions.filter(t => t.user === currentUser.username);
        myTrans.forEach(t => {
            if(! t.processed && t.status === 'approved') {
                if(t.type === 'deposit') {
                    showToast(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${t.amount. toLocaleString()} ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß! `, 'success');
                    loadUserData();
                    updateUI();
                }
                if(t.type === 'withdraw') {
                    showToast(`‚úÖ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${t.amount.toLocaleString()} ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
                }
            }
            if(! t.processed && t.status === 'rejected') {
                showToast(`‚ùå ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`, 'error');
            }
        });
    }
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
liveSync. on('shop', (data) => {
    console.log('üì° Shop items updated');
    loadShop();
    showToast('üîÑ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï', 'info');
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤
liveSync.on('maintenance', (data) => {
    console.log('üì° Maintenance status changed');
    const isMaint = localStorage.getItem('mining_maintenance') === 'true';
    const overlay = document.getElementById('maintenanceOverlay');
    
    if(isMaint) {
        overlay.style.display = 'flex';
        showToast('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á', 'warning');
    } else {
        overlay.style.display = 'none';
        showToast('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
    }
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
liveSync.on('referrals_updated', (data) => {
    console.log('üì° Referrals updated');
    if(currentUser && data.username === currentUser.username) {
        renderReferralUI();
        showToast('üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á', 'info');
        
        // Optional: Check for approved referrals to play success sound
        const refs = data.data || [];
        if(refs.some(r => (r.status === 'approved' || r.status === 'completed') && !r.claimed)) {
             if(typeof soundMgr !== 'undefined') soundMgr.play('success');
             showToast('‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }
    }
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà
liveSync. on('announcement', (data) => {
    console.log('üì° New announcement');
    checkAnnounce();
    showToast('üì¢ ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'info');
    
    const badge = document.getElementById('annBadge');
    if(badge) badge.style.display = 'block';
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
liveSync.on('profile_updated', (data) => {
    if(currentUser && data.username === currentUser.username) {
        console.log('üì° My profile updated');
        loadUserData();
        updateUI();
        renderProfile();
    }
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
liveSync.on('referrals_updated', (data) => {
    if(currentUser && data.username === currentUser.username) {
        console.log('üì° My referrals updated');
        renderReferralUI();
        showToast('üë• ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô', 'info');
    }
});

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Force Update (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î)
liveSync.on('force_update', (data) => {
    if(currentUser && data.username === currentUser.username) {
        console.log('üì° Force update received:', data);
        
        if(data.type === 'rig_deleted') {
                    console.log('‚ö†Ô∏è Rig deleted event processed');
                    isMining = false;
                    
                    // 1. Recalculate & Save Hashrate (Crucial!)
                    let active = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
                    hashrate = active.reduce((sum, item) => sum + (item.speed || 0), 0);
                    saveData();

                    // 2. Refresh Data & UI
                    loadUserData();
                    renderActiveContracts();
                    updateUI();
                    
                    // 2.5 Force Pause UI Update
                    const btnMode = document.getElementById('miningMode');
                    if(btnMode) {
                        btnMode.innerText = '‡∏û‡∏±‡∏Å';
                        btnMode.style.color = '#94a3b8';
                        btnMode.style.textShadow = 'none';
                    }

                    // 3. Notification
                    if(soundMgr) soundMgr.play('alert');
                    
                    setTimeout(() => {
                        const rigName = data.rigName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
                        const profitShow = dailyProfit ? dailyProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00';
                        
                        if(hashrate > 0) {
                             alert(`‚ö†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î "${rigName}" ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÇ‡∏î‡∏¢ Admin\nüí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ø${profitShow}\n‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠...`);
                        } else {
                             // Ask to buy more
                             if(confirm(`‚ö†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î "${rigName}" ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÇ‡∏î‡∏¢ Admin\nüí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ø${profitShow}\n‚õî ‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß\nüõí ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                 openShopPage();
                             }
                        }
                    }, 100);
                }
    }
});

// Manual refresh button
document.addEventListener('keydown', (e) => {
    if(e.ctrlKey && e.key === 'r') {
        e. preventDefault();
        console.log('üîÑ Manual refresh requested');
        liveSync.forceRefresh();
        renderUserTrans();
        renderProfile();
        loadShop();
        showToast('üîÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß', 'success');
    }
});

console.log('‚úÖ App Live Sync listeners registered');
console.log('Live Sync Status:', liveSync.getStatus());

        function syncMiningData() {
            if(!currentUser) return;
            
            let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser.username}`)) || [];
            let active = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
            let shopItems = JSON.parse(localStorage.getItem('mining_shop_items')) || [];
            let changed = false;

            // 1. Recover Rigs from Active Items (if Rigs lost)
            if(rigs.length === 0 && active.length > 0) {
                console.log('‚ôªÔ∏è Recovering mining_rigs from active_items');
                rigs = active.map(a => {
                    const shopItem = shopItems.find(i => i.id === a.id) || { icon: 'fa-server', price: 0 };
                    return {
                        id: a.id,
                        name: a.name,
                        speed: a.speed,
                        price: shopItem.price || 0,
                        icon: shopItem.icon || 'fa-server',
                        status: 'active',
                        timestamp: Date.now(), // Estimated
                        expiresAt: a.expiresAt
                    };
                });
                localStorage.setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                changed = true;
            }

            // 2. Sync Active Items from Rigs (Source of Truth)
            // This fixes the issue where paid items weren't added to active_items
            if(rigs.length > 0) {
                const now = Date.now();
                const calculatedActive = rigs
                    .filter(r => !r.expiresAt || r.expiresAt > now)
                    .map(r => ({
                        id: r.id,
                        name: r.name,
                        speed: r.speed,
                        expiresAt: r.expiresAt
                    }));
                
                // Compare arrays (simple stringify check)
                if(JSON.stringify(calculatedActive) !== JSON.stringify(active)) {
                    console.log('‚ôªÔ∏è Syncing active_items from mining_rigs');
                    localStorage.setItem(`active_items_${currentUser.username}`, JSON.stringify(calculatedActive));
                    active = calculatedActive;
                    changed = true;
                }
            }

            // 3. Verify Hashrate
            const realHashrate = active.reduce((sum, item) => sum + (item.speed || 0), 0);
            if(Math.abs(hashrate - realHashrate) > 0.1) {
                console.log(`‚ôªÔ∏è Correcting hashrate: ${hashrate} -> ${realHashrate}`);
                hashrate = realHashrate;
                saveData();
                changed = true;
            }

            if(changed) {
                updateUI();
                renderActiveContracts();
            }
        }

        function initApp() {
            // Default Announcement
            if(! localStorage.getItem('mining_announcement')) {
                const defaultAnn = { msg: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Crypto Miner Tycoon! ', date: new Date().toISOString() };
                localStorage. setItem('mining_announcement', JSON.stringify(defaultAnn));
            }

            loadUserData();
            loadSystemSettings();
            
            // Sync Data Integrity
            syncMiningData();

            // Auto start if possible
            autoMiningController();
            checkExpiration();
            loadShop();
            
            setInterval(miningLoop, 1000);
            setInterval(syncAdmin, 2000);
            renderProfile();
            checkAnnounce();

            // ============ üî¥ SYNC LISTENERS ============
            
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            syncManager.on('user_deleted', (data) => {
                if(currentUser && currentUser.username === data.username) {
                    showToast('‚ùå ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', 'error');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
            syncManager.on('transaction_approved', (data) => {
                if(currentUser && currentUser.username === data.user) {
                    console.log('Transaction approved:', data);
                    
                    const msg = data.status === 'approved' 
                        ? `‚úÖ ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß! ‡∏ø${data.amount.toLocaleString()}`
                        : `‚ùå ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`;
                    
                    showToast(msg, data.status === 'approved' ?  'success' : 'error');
                    
                    if(data.status === 'approved') {
                        // Reload user data
                        loadUserData();
                        updateUI();
                        renderUserTrans();
                        addNotification(msg, data.status === 'approved' ?  'success' : 'error');
                    }
                    
                    if(typeof soundMgr !== 'undefined') {
                        soundMgr.play('emphasis');
                    }
                    if(typeof vibMgr !== 'undefined') {
                        vibMgr.trigger('emphasis');
                    }
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤
            syncManager.on('maintenance_mode_changed', (data) => {
                const overlay = document.getElementById('maintenanceOverlay');
                const msg = data.enabled 
                    ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß.. .'
                    : '‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                
                showToast(msg, data.enabled ? 'warning' : 'success');
                
                if(data.enabled) {
                    overlay. style.display = 'flex';
                } else {
                    overlay.style.display = 'none';
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤
            syncManager.on('maintenance_msg_changed', (msg) => {
                const msgEl = document.getElementById('maintMessage');
                if(msgEl) {
                    msgEl.innerText = msg;
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
            syncManager.on('announcement_posted', (data) => {
                if(data && data.msg) {
                    showToast('üì¢ ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'info');
                    checkAnnounce();
                    
                    // Show new badge
                    const badge = document.getElementById('annBadge');
                    if(badge) badge.style.display = 'block';
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
            syncManager.on('announcement_cleared', () => {
                const annEl = document.getElementById('dashboardAnnounce');
                if(annEl) {
                    annEl.innerText = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ';
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            syncManager. on('shop_updated', () => {
                console.log('Shop updated from admin');
                loadShop();
                checkShopUpdate();
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            syncManager.on('shop_items_updated', (items) => {
                console.log('Shop items updated:', items);
                loadShop();
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
            syncManager.on('password_reset', (data) => {
                if(currentUser && currentUser.username === data.username) {
                    showToast('‚ö†Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'warning');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
            });

            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            syncManager.cleanOldData();

            console.log('‚úÖ App Sync Listeners Registered');
            console.log('Sync Manager Debug:', syncManager.debugInfo());
        }

        function syncAdmin() {
    if(!currentUser) return;
    
    // 1. Check Ban Status
    checkUserBanStatus();

    // 2. Heartbeat
    localStorage.setItem(`last_active_${currentUser.username}`, Date.now());
    
    // 3.  Check Announcement
    checkAnnounce();
    
    // 4.  Check Shop Update
    checkShopUpdate();

    // 5. Check Maintenance
    const maint = localStorage.getItem('mining_maintenance') === 'true';
    const maintMsg = localStorage.getItem('mining_maintenance_msg') || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå... ';
    const overlay = document.getElementById('maintenanceOverlay');
    const bypass = sessionStorage.getItem('maintenance_bypass');
    
    if(maint && bypass !== 'true') {
        overlay.style.display = 'flex';
        document.getElementById('maintMessage').innerText = maintMsg;
    } else {
        overlay.style.display = 'none';
    }

    // 6.  Sync Transactions (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
    let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
    let updated = false;
    trans. forEach(t => {
        if(t.user === currentUser.username && ! t.processed) {
            if(t.status === 'approved' && t.type === 'deposit') { 
                balance += t.amount; 
                updated = true; 
                t.processed = true;
                localStorage.setItem('wallet_badge_deposit', 'true');
                addNotification(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à +‡∏ø${t.amount.toLocaleString()}`, 'success');
            }
            else if(t.status === 'rejected' && t.type === 'withdraw') { 
                balance += t.amount; 
                updated = true; 
                t. processed = true;
                localStorage. setItem('wallet_badge_withdraw', 'true');
                addNotification(`‚ùå ‡∏ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, 'error');
            }
            else if(t.status === 'approved' && t.type === 'withdraw') { 
                t.processed = true; 
                updated = true;
                localStorage.setItem('wallet_badge_withdraw', 'true');
                addNotification(`‚úÖ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ø${t.amount.toLocaleString()}`, 'success');
            } 
        }
    });
    if(updated) {
        localStorage.setItem('mining_transactions', JSON.stringify(trans));
        saveData(); 
        updateUI();
        renderUserTrans();
    }
    checkWalletBadges();

    // 7. Verify Data Integrity
    const verification = syncManager.verifyUserData(currentUser.username);
    if(! verification.isValid) {
        console.warn('User data invalid, logging out');
        logout();
    }
}

        function checkWalletBadges() {
            // Deposit Badge
            const dBadge = document.getElementById('depositBadge');
            if(localStorage.getItem('wallet_badge_deposit') === 'true') {
                if(dBadge) dBadge.style.display = 'block';
                document.getElementById('navWalletBadge').style.display = 'block';
            } else {
                if(dBadge) dBadge.style.display = 'none';
            }

            // Withdraw Badge
            const wBadge = document.getElementById('withdrawBadge');
            if(localStorage.getItem('wallet_badge_withdraw') === 'true') {
                if(wBadge) wBadge.style.display = 'block';
                document.getElementById('navWalletBadge').style.display = 'block';
            } else {
                if(wBadge) wBadge.style.display = 'none';
            }

            // If no sub-badges, hide nav badge
            if(localStorage.getItem('wallet_badge_deposit') !== 'true' && localStorage.getItem('wallet_badge_withdraw') !== 'true') {
                document.getElementById('navWalletBadge').style.display = 'none';
            }
        }

        function openWalletModal(type) {
            currentAction = type || 'deposit'; // Default to deposit if not specified
            
            // Clear badges
            if(type === 'deposit') localStorage.removeItem('wallet_badge_deposit');
            if(type === 'withdraw') localStorage.removeItem('wallet_badge_withdraw');
            checkWalletBadges();

            const modal = document.getElementById('walletModal');
            const content = modal.querySelector('.modal-content');
            
            // Base structure with Tabs
            content.innerHTML = `
                <div style="position: absolute; right: 15px; top: 15px; cursor: pointer; color: var(--text-muted); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.05);" onclick="document.getElementById('walletModal').style.display='none'">
                    <i class="fas fa-times"></i>
                </div>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 1px;">Wallet</h2>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 25px; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <button onclick="switchWalletTab('deposit')" id="tabDeposit" class="cyber-btn" style="flex:1; border-radius: 8px; font-size: 0.9rem;">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <button onclick="switchWalletTab('withdraw')" id="tabWithdraw" class="cyber-btn" style="flex:1; border-radius: 8px; font-size: 0.9rem;">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>

                <div id="walletBody"></div>
            `;
            
            modal.style.display='flex';
            switchWalletTab(currentAction);
        }

        function switchWalletTab(type) {
            currentAction = type;
            const body = document.getElementById('walletBody');
            const tabDep = document.getElementById('tabDeposit');
            const tabWit = document.getElementById('tabWithdraw');
            
            // Update Tabs Style
            if(type === 'deposit') {
                tabDep.classList.add('primary');
                tabDep.style.background = 'var(--primary)';
                tabDep.style.color = '#000';
                tabDep.style.boxShadow = '0 0 15px var(--primary-dim)';
                
                tabWit.classList.remove('primary');
                tabWit.style.background = 'transparent';
                tabWit.style.color = 'var(--text-muted)';
                tabWit.style.boxShadow = 'none';
            } else {
                tabWit.classList.add('primary');
                tabWit.style.background = 'var(--warning)';
                tabWit.style.color = '#000';
                tabWit.style.boxShadow = '0 0 15px rgba(255, 204, 0, 0.3)';
                
                tabDep.classList.remove('primary');
                tabDep.style.background = 'transparent';
                tabDep.style.color = 'var(--text-muted)';
                tabDep.style.boxShadow = 'none';
            }

            let users = JSON.parse(localStorage.getItem('mining_users')) || {};
            let u = users[currentUser.username] || {bank: 'N/A', acc: 'N/A', name: 'Guest'};

            if(type === 'deposit') {
                body.innerHTML = `
                    <div class="glass-panel" style="margin-bottom: 20px; text-align: center; padding: 25px;">
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px;">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å (THB)</div>
                        <div style="position: relative; max-width: 200px; margin: 0 auto;">
                            <input type="number" id="walletAmount" class="cyber-input" placeholder="0.00" 
                                   style="font-size: 1.8rem; text-align: center; height: 60px; color: var(--success); font-weight: bold; padding: 0;" 
                                   oninput="updateDepositUI(this.value)">
                        </div>
                        <div style="font-size: 0.75rem; color: var(--warning); margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1 ‡∏ö‡∏≤‡∏ó
                        </div>
                    </div>

                    <!-- Auto QR Section (Hidden by default) -->
                    <div id="qrSection" style="display:none; animation: slideUp 0.3s ease-out;">
                         
                         <div style="text-align: center; margin-bottom: 15px;">
                            <h3 style="color: var(--primary); margin: 0; text-transform: uppercase; letter-spacing: 1px;">QR Payment AP</h3>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                         </div>

                         <div class="glass-panel" style="border: 1px solid var(--primary); box-shadow: 0 0 15px var(--primary-dim); padding: 20px; position: relative; overflow: hidden;">
                            <!-- Header Info -->
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: white; margin-bottom: 5px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
                                <div style="font-size: 1.2rem; color: var(--success); font-weight: bold;">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="qrAmountDisplay">0.00</span> ‡∏ö‡∏≤‡∏ó</div>
                                <div style="font-size: 0.9rem; color: var(--danger); margin-top: 5px; font-weight: bold;" id="qrTimer">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 01:00:00</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;" id="qrExpiry">QR Code ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --/--/-- ‡πÄ‡∏ß‡∏•‡∏≤ --:--</div>
                            </div>

                            <!-- QR Code & Bank Info -->
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div id="qrContainer" style="background: white; padding: 10px; display: inline-block; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-bottom: 15px;">
                                    <img id="qrImage" src="" style="width: 180px; height: 180px; display: block;">
                                </div>

                                <!-- Warning -->
                                <div style="color: var(--warning); font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; padding: 0 10px; line-height: 1.4;">
                                    <i class="fas fa-exclamation-triangle"></i> ‡πÇ‡∏õ‡∏£‡∏î‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                                </div>

                                <!-- Transfer Route Info -->
                                <div style="margin-top: 15px;">
                                    <!-- From User -->
                                    <div style="font-size: 0.8rem; color: var(--text-muted); text-align: left; margin-bottom: 5px; padding-left: 5px;">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                                    <div id="userBankInfoDisplay" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; text-align: left;">
                                        <!-- Populated by JS -->
                                    </div>

                                    <!-- To Admin -->
                                    <div style="font-size: 0.8rem; color: var(--text-muted); text-align: left; margin-bottom: 5px; padding-left: 5px;">‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                                    <div id="adminBankInfoDisplay" style="background: rgba(46, 204, 113, 0.1); padding: 12px; border-radius: 8px; border: 1px solid var(--success); text-align: left;">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>

                            <!-- Instructions -->
                            <div style="text-align: left; font-size: 0.8rem; color: #cbd5e1; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="margin-bottom: 8px; font-weight: bold; color: var(--primary);">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</div>
                                <div style="margin-bottom: 4px;">1. ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ QR Code ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
                                <div style="margin-bottom: 4px;">2. ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</div>
                                <div style="margin-bottom: 4px;">3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π "‡∏™‡πÅ‡∏Å‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "QR Code" ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡∏õ‡πÑ‡∏ß‡πâ</div>
                                <div style="margin-bottom: 4px;">4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                                <div style="margin-bottom: 4px;">5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏•‡∏¥‡∏õ ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
                                <div style="margin-top: 8px; color: var(--warning); line-height: 1.4;">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
                                <div style="margin-top: 10px; font-size: 0.7rem; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px;">
                                    ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏ï‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                                </div>
                            </div>

                            <!-- Slip Upload -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</div>
                                <div style="font-size: 0.7rem; color: #64748b; margin-bottom: 8px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå jpg, jpeg ‡πÅ‡∏•‡∏∞ .png ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 MB</div>
                                <input type="file" id="slipUpload" accept="image/*" class="cyber-input" style="padding: 10px; font-size: 0.9rem; height: auto;" onchange="handleSlipSelect(this)">
                                <div id="slipPreview" style="margin-top:10px; text-align:center; display:none;">
                                    <img id="slipPreviewImg" style="max-width:100%; max-height:200px; border-radius:8px; border:1px solid var(--text-muted);">
                                    <div style="font-size:0.7rem; color:var(--success); margin-top:5px;"><i class="fas fa-check-circle"></i> ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß</div>
                                </div>
                                <div style="text-align: center; font-size: 0.8rem; color: var(--primary); margin-top: 10px; opacity: 0.8;">
                                    ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </div>
                            </div>

                            <!-- Buttons -->
                            <div style="display: flex; gap: 10px;">
                                <button id="btnConfirmPayment" class="cyber-btn" onclick="confirmPayment()" style="width: 100%; opacity: 0.5; cursor: not-allowed; filter: grayscale(100%);" disabled>
                                    <i class="fas fa-check"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                                </button>
                            </div>

                         </div>
                    </div>
                `;
            } else {
                // Withdrawal Tab
                let users = JSON.parse(localStorage.getItem('mining_users'));
                let u = users[currentUser.username];
                let bankHtml = '';
                
                if(!u.bank || !u.acc) {
                    bankHtml = `<div class="glass-panel" style="border-color: var(--danger); background: rgba(255, 0, 85, 0.05); text-align: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: var(--danger); margin-bottom: 10px;"></i>
                        <div style="color: var(--danger); font-weight: bold; margin-bottom: 5px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
                        <button class="cyber-btn" style="font-size: 0.8rem; padding: 8px 20px;" onclick="document.getElementById('walletModal').style.display='none'; showBankModal();">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
                    </div>`;
                } else {
                    bankHtml = `
                        <div class="glass-panel" style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--bg-dark), #1a1a2e); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-university" style="font-size: 1.5rem; color: var(--secondary);"></i>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: white; letter-spacing: 1px;">${formatBankAcc(u.acc)}</div>
                                <div style="font-size: 0.8rem; color: var(--primary);">${u.bank.toUpperCase()} - ${u.name}</div>
                            </div>
                        </div>
                    `;
                }

                body.innerHTML = `
                    ${bankHtml}
                    
                    <div class="glass-panel" style="text-align: center; margin-bottom: 20px; border: 1px solid var(--warning); box-shadow: 0 0 10px rgba(255, 204, 0, 0.1);">
                        <div style="color: var(--text-muted); font-size: 0.85rem;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ</div>
                        <div style="color: var(--warning); font-size: 2rem; font-weight:bold; margin: 5px 0; text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">${balance.toLocaleString('en-US', {minimumFractionDigits: 2})} <span style="font-size: 1rem; color: white;">THB</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 200 ‡∏ö‡∏≤‡∏ó</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                        <div style="position: relative;">
                            <input type="number" id="walletAmount" class="cyber-input" placeholder="0.00" 
                                   style="padding-right: 80px; font-size: 1.2rem; font-weight:bold; color: white;"
                                   oninput="updateWithdrawUI(this.value)">
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); font-weight: bold; cursor: pointer; font-size: 0.85rem; text-transform: uppercase;" onclick="fillMaxWithdraw()">MAX</span>
                        </div>
                    </div>

                    <div class="glass-panel" style="padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                            <span style="color: var(--text-muted);">‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô</span>
                            <span style="color: white;" id="withdrawBaseAmount">0.00 THB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                            <span style="color: var(--text-muted);">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (3%)</span>
                            <span style="color: var(--danger);" id="withdrawFee">0.00 THB</span>
                        </div>
                        <div style="width: 100%; height: 1px; background: rgba(255,255,255,0.1); margin: 10px 0;"></div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: bold;">
                            <span style="color: var(--text-muted);">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <span style="color: var(--success); text-shadow: 0 0 10px var(--success-dim);" id="netWithdrawAmount">0.00 THB</span>
                        </div>
                    </div>

                    <button class="cyber-btn" onclick="submitTransaction()" style="width: 100%; --btn-bg: var(--warning); color: #000;">
                        <i class="fas fa-paper-plane"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                `;
            }
        }

        function updateWithdrawUI(val) {
            const base = document.getElementById('withdrawBaseAmount');
            const fee = document.getElementById('withdrawFee');
            const net = document.getElementById('netWithdrawAmount');
            
            const amt = parseFloat(val);
            
            if(amt && amt > 0) {
                const feeVal = amt * 0.03; // 3% Fee
                const netVal = amt - feeVal;
                
                base.innerText = amt.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
                fee.innerText = feeVal.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
                net.innerText = netVal.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
            } else {
                base.innerText = "0.00 THB";
                fee.innerText = "0.00 THB";
                net.innerText = "0.00 THB";
            }
        }

        function fillMaxWithdraw() {
            const input = document.getElementById('walletAmount');
            input.value = balance;
            updateWithdrawUI(balance);
        }

        let depositTimerInterval = null;

        function updateDepositUI(val) {
            const qrSec = document.getElementById('qrSection');
            const qrImg = document.getElementById('qrImage');
            const qrContainer = document.getElementById('qrContainer');
            const qrAmtDisp = document.getElementById('qrAmountDisplay');
            const bankInfoDisp = document.getElementById('adminBankInfoDisplay');
            const userBankDisp = document.getElementById('userBankInfoDisplay');
            
            if(val && parseFloat(val) >= 1) {
                if(qrSec) {
                    qrSec.style.display = 'block';
                    
                    const amt = parseFloat(val).toFixed(2);
                    if(qrAmtDisp) qrAmtDisp.innerText = amt;
                    
                    // Get Admin Bank Settings
                    const bankName = localStorage.getItem('admin_bank_name') || 'promptpay';
                    const bankNum = localStorage.getItem('admin_bank_number') || localStorage.getItem('admin_pp_number') || '0812345678';
                    const accName = localStorage.getItem('admin_acc_name') || 'System Account';
                    
                    // Check if we are using PromptPay (QR) or Bank Transfer
                    if(bankName === 'promptpay') {
                        if(qrContainer) qrContainer.style.display = 'inline-block';
                        if(qrImg) {
                            qrImg.style.display = 'block';
                            qrImg.src = `https://promptpay.io/${bankNum}/${val}`;
                        }
                    } else {
                        // Bank Transfer Mode - Hide QR, show bank info prominently
                        if(qrContainer) qrContainer.style.display = 'none';
                    }

                    // Show User Bank Info (Source)
                    if(userBankDisp) {
                        const users = JSON.parse(localStorage.getItem('mining_users')) || {};
                        // Ensure currentUser is available (it is a global variable in this scope)
                        const u = (typeof currentUser !== 'undefined' && currentUser) ? (users[currentUser.username] || {}) : {};
                        
                        if(u.bank && u.acc) {
                            userBankDisp.innerHTML = `
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="font-weight:bold; font-size:1rem; color: var(--warning); text-transform:uppercase;">${u.bank.toUpperCase()}</div>
                                    <div style="font-size:0.8rem; color:#aaa;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                                </div>
                                <div style="font-size:1.1rem; font-weight:bold; color:white; letter-spacing:1px; margin: 2px 0;">${u.acc}</div>
                                <div style="font-size:0.85rem; color:#ccc;">${u.name}</div>
                            `;
                        } else {
                             userBankDisp.innerHTML = `
                                <div style="color: var(--danger); font-size: 0.9rem; text-align: center; padding: 10px;">
                                    <i class="fas fa-exclamation-circle"></i> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                </div>
                            `;
                        }
                    }

                    // Show Admin Bank Info (Destination)
                    if(bankInfoDisp) {
                        if(bankName !== 'promptpay') {
                            bankInfoDisp.style.display = 'block';
                            bankInfoDisp.innerHTML = `
                                <div style="font-weight:bold; font-size:1.1rem; color: var(--secondary); text-transform:uppercase;">${bankName.toUpperCase()}</div>
                                <div style="font-size:1.2rem; font-weight:bold; color:white; letter-spacing:1px; margin: 2px 0;">${bankNum}</div>
                                <div style="font-size:0.9rem; color:#eee;">${accName}</div>
                                <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</div>
                                <div style="font-size:0.8rem; color:#aaa;">‡∏™‡∏≤‡∏Ç‡∏≤: ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà</div>
                            `;
                        } else {
                            bankInfoDisp.style.display = 'none';
                        }
                    }
                    
                    // Start Timer if not running
                    startQRTimer();
                }
            } else {
                if(qrSec) qrSec.style.display = 'none';
                stopQRTimer();
            }
        }

        function startQRTimer() {
            if(depositTimerInterval) clearInterval(depositTimerInterval);
            
            // Set 1 hour from now
            const now = new Date();
            const expireTime = new Date(now.getTime() + 60 * 60 * 1000);
            
            // Update Expiry Date Text
            const expiryEl = document.getElementById('qrExpiry');
            if(expiryEl) {
                const dateStr = expireTime.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const timeStr = expireTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                expiryEl.innerText = `QR Code ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr}`;
            }

            const timerEl = document.getElementById('qrTimer');
            
            // Update immediately
            updateTimerDisplay(expireTime, timerEl);

            depositTimerInterval = setInterval(() => {
                updateTimerDisplay(expireTime, timerEl);
            }, 1000);
        }

        function updateTimerDisplay(expireTime, timerEl) {
            const diff = expireTime - Date.now();
            if(diff <= 0) {
                clearInterval(depositTimerInterval);
                if(timerEl) timerEl.innerText = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
                return;
            }
            
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            
            if(timerEl) timerEl.innerText = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ${h} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${m} ‡∏ô‡∏≤‡∏ó‡∏µ ${s} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }

        function stopQRTimer() {
            if(depositTimerInterval) clearInterval(depositTimerInterval);
            const timerEl = document.getElementById('qrTimer');
            if(timerEl) timerEl.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 01:00:00";
        }

        function handleSlipSelect(input) {
            const btn = document.getElementById('btnConfirmPayment');
            const preview = document.getElementById('slipPreview');
            const previewImg = document.getElementById('slipPreviewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // Enable button
                    if(btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.style.filter = 'none';
                    }
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
                // Disable button
                if(btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.style.filter = 'grayscale(100%)';
                }
            }
        }

        function confirmPayment() {
             const amtInput = document.getElementById('walletAmount');
             const val = parseFloat(amtInput.value);
             const slipInput = document.getElementById('slipUpload');
             
             if(!val || val < 1) return showToast('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1 ‡∏ö‡∏≤‡∏ó)', 'error');
             
             if (!slipInput || !slipInput.files || slipInput.files.length === 0) {
                 return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', 'error');
             }
             
             const file = slipInput.files[0];
             const reader = new FileReader();
             
             reader.onload = function(e) {
                 const slipBase64 = e.target.result;
                 
                 // Create Pending Transaction
                 let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
                 trans.push({
                    id: Date.now(),
                    user: currentUser.username,
                    type: 'deposit',
                    amount: val,
                    timestamp: Date.now(),
                    status: 'pending',
                    slip: slipBase64
                 });
                 localStorage.setItem('mining_transactions', JSON.stringify(trans));
                 
                 // Show Success
                 showToast('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'success');
                 document.getElementById('walletModal').style.display = 'none';
                 
                 // Clear inputs
                 amtInput.value = '';
                 slipInput.value = '';
                 updateDepositUI(0);
                 
                 // Refresh Trans List
                 renderUserTrans();
             };
             
             reader.onerror = function() {
                 showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
             };
             
             reader.readAsDataURL(file);
        }

        function openWalletPage() {
            // Clear all wallet badges when viewing history
            localStorage.removeItem('wallet_badge_deposit');
            localStorage.removeItem('wallet_badge_withdraw');
            checkWalletBadges();
            switchPage('walletPage', document.getElementById('navWallet'));
            renderUserTrans();
        }

        function renderUserTrans() {
            const list = document.getElementById('transList');
            if(!list) return;
            
            let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
            // Filter my transactions
            trans = trans.filter(t => t.user === currentUser.username);
            // Sort Newest First
            trans.sort((a,b) => b.timestamp - a.timestamp);
            
            if(trans.length === 0) {
                list.innerHTML = `
                    <div style="text-align:center; color:var(--text-muted); margin-top:50px; padding: 40px;">
                        <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 1px dashed var(--text-muted);">
                            <i class="fas fa-history" style="font-size:2.5rem; opacity:0.5;"></i>
                        </div>
                        <div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            trans.forEach(t => {
                let statusBadge = '';
                if(t.status === 'pending') statusBadge = '<span style="color:var(--warning); background:rgba(255, 204, 0, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(255, 204, 0, 0.2);"><i class="fas fa-clock"></i> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
                else if(t.status === 'approved') statusBadge = '<span style="color:var(--success); background:rgba(0, 255, 157, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(0, 255, 157, 0.2); box-shadow: 0 0 5px rgba(0, 255, 157, 0.2);"><i class="fas fa-check-circle"></i> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
                else statusBadge = '<span style="color:var(--danger); background:rgba(255, 0, 85, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(255, 0, 85, 0.2);"><i class="fas fa-times-circle"></i> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>';
                
                let icon = t.type === 'deposit' ? '<i class="fas fa-arrow-down" style="color:var(--success);"></i>' : '<i class="fas fa-arrow-up" style="color:var(--warning);"></i>';
                let iconBg = t.type === 'deposit' ? 'rgba(0, 255, 157, 0.1)' : 'rgba(255, 204, 0, 0.1)';
                let iconBorder = t.type === 'deposit' ? 'var(--success)' : 'var(--warning)';
                
                let title = t.type === 'deposit' ? '‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
                let amountColor = t.type === 'deposit' ? 'var(--success)' : 'var(--warning)';
                let sign = t.type === 'deposit' ? '+' : '-';
                
                // Fee detail text
                let feeDetail = '';
                if(t.type === 'withdraw' && t.fee) {
                    feeDetail = `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: ${t.fee.toLocaleString()}</div>`;
                }

                list.innerHTML += `
                    <div class="glass-panel" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; animation: slideUp 0.3s ease-out;">
                        <div style="display:flex; gap:15px; align-items:center;">
                            <div style="width:45px; height:45px; border-radius:12px; background:${iconBg}; display:flex; align-items:center; justify-content:center; font-size:1.2rem; border: 1px solid ${iconBorder}; box-shadow: 0 0 10px ${iconBg};">
                                ${icon}
                            </div>
                            <div>
                                <div style="font-weight: bold; color: white; font-size:1rem;">${title}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${new Date(t.timestamp).toLocaleString('th-TH')}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: ${amountColor}; font-size:1.1rem; text-shadow: 0 0 10px ${amountColor}40;">${sign}${t.amount.toLocaleString()}</div>
                            ${feeDetail}
                            <div style="margin-top: 6px;">${statusBadge}</div>
                        </div>
                    </div>
                `;
            });
        }

        function miningLoop() {
            checkExpiration();
            autoMiningController();
            
            // Check for new day reset
            if(lastProfitDate !== new Date().toDateString()) {
                dailyProfit = 0;
                lastProfitDate = new Date().toDateString();
                saveData();
            }
            
            if(isMining && hashrate > 0) {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ = hashrate ‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                balance += hashrate;
                dailyProfit += hashrate;
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                if(Math.floor(Date.now() / 10000) % 1 === 0) {
                    saveData();
                }
                
                updateUI();
                
                console.log(`‚õèÔ∏è Mining: +${hashrate.toFixed(2)} ‡∏ø | Balance: ${balance.toFixed(2)} ‡∏ø`);
            }
        }

        function checkAnnounce() {
            try {
                let raw = localStorage.getItem('mining_announcement');
                let ann = null;
                try { ann = raw ? JSON.parse(raw) : null; } catch (_) { ann = raw ? { msg: raw, date: new Date().toISOString() } : null; }
                if(ann && ann.msg) {
                    // Update Dashboard Board
                    const db = document.getElementById('dashboardAnnounce');
                    if(db) db.innerText = ann.msg;

                    const lastAnn = localStorage.getItem('last_ann_seen');
                    if(lastAnn !== ann.date) {
                        const b = document.getElementById('annBadge');
                        if(b) b.style.display = 'block';
                        const l = document.getElementById('annLabel');
                        if(l) { l.innerText = '‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà'; l.style.color = '#ef4444'; }
                    } else {
                        const b = document.getElementById('annBadge');
                        if(b) b.style.display = 'none';
                        const l = document.getElementById('annLabel');
                        if(l) { l.innerText = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; l.style.color = '#aaa'; }
                    }
                }
                
                // Check for Referrer Notifications
                if(currentUser) {
                    let notifs = JSON.parse(localStorage.getItem(`notifications_${currentUser.username}`)) || [];
                    const unread = notifs.filter(n => !n.read);
                    if(unread.length > 0) {
                         // Show Toast or Alert
                         const lastNotif = unread[unread.length-1];
                         
                         // Prevent duplicate toast for same session if needed, or just show last
                         // Simple Implementation: Show Toast
                         showToast(lastNotif.msg, lastNotif.type || 'info');
                         notifs.forEach(n => n.read = true);
                         localStorage.setItem(`notifications_${currentUser.username}`, JSON.stringify(notifs));
                         }
                }

            } catch (e) { console.error(e); }
        }

        function openAnnounceModal() {
            try {
                const ann = JSON.parse(localStorage.getItem('mining_announcement'));
                if(ann && ann.msg) {
                    document.getElementById('announceBody').innerText = ann.msg;
                    document.getElementById('announceModal').style.display = 'flex';
                    // Mark as seen
                    localStorage.setItem('last_ann_seen', ann.date);
                    checkAnnounce(); // Update UI immediately
                } else {
                    alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®');
                }
            } catch(e) { console.error(e); }
        }

        function closeAnnounce() {
            document.getElementById('announceModal').style.display = 'none';
        }



        function renderActiveContracts() {
            const list = document.getElementById('activeContractsList');
            const countEl = document.getElementById('activeContractCount');
            if(!list) return;

            let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser.username}`)) || [];
            
            // Filter active rigs
            const now = Date.now();
            const activeRigs = rigs.filter(r => !r.expiresAt || r.expiresAt > now);
            
            if(countEl) countEl.innerText = `${activeRigs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if(activeRigs.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; color: var(--text-muted); font-size: 0.8rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>`;
                return;
            }
            
            let html = '';
            // Sort by expiry (shortest first), then permanent
            activeRigs.sort((a, b) => {
                if(a.expiresAt && b.expiresAt) return a.expiresAt - b.expiresAt;
                if(a.expiresAt) return -1;
                return 1;
            });

            activeRigs.forEach(r => {
                let timeLeft = '‡∏ñ‡∏≤‡∏ß‡∏£';
                let statusColor = 'var(--success)';
                
                if(r.paused) {
                    timeLeft = '‚õî ‡∏û‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î';
                    statusColor = '#fbbf24'; // Warning yellow
                } else if(r.expiresAt) {
                    const diff = r.expiresAt - now;
                    const h = Math.floor(diff / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    timeLeft = `${h}‡∏ä‡∏°. ${m}‡∏ô. ${s}‡∏ß‡∏¥.`;
                    
                    if(diff < 60000) statusColor = 'var(--danger)'; // Last minute
                    else if(diff < 3600000) statusColor = 'var(--warning)'; // Last hour
                }

                const daily = r.speed * 86400;
                const dateStr = r.timestamp ? new Date(r.timestamp).toLocaleDateString('th-TH') : '';

                html += `
                <div style="background: rgba(20, 25, 40, 0.6); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 15px;">
                    <div class="cyber-icon-box" style="width: 40px; height: 40px; font-size: 1rem; --card-color: ${statusColor}; border-color: ${statusColor}; box-shadow: 0 0 10px ${statusColor}20;">
                        <i class="fas ${r.icon || 'fa-server'}" style="color: ${statusColor};"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="font-weight: bold; font-size: 0.9rem; color: #fff;">${r.name}</div>
                            <div style="font-size: 0.75rem; color: ${statusColor}; font-weight: bold;">${timeLeft}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.75rem; color: var(--text-muted);">
                            <div>Speed: <span style="color: #fff;">${r.speed} MH/s</span></div>
                            <div>${dateStr}</div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--success); margin-top: 2px;">
                            ‚âà ‡∏ø${daily.toLocaleString()}/‡∏ß‡∏±‡∏ô
                        </div>
                    </div>
                </div>
                `;
            });
            
            if(list.innerHTML !== html) {
                list.innerHTML = html;
            }
        }

        function updateUI() {
            renderActiveContracts();
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            const incomePerSec = hashrate > 0 ? hashrate : 0;
            
            document.getElementById('balanceDisplay').innerText = 
                `‡∏ø${parseFloat(balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('incomeDisplay').innerText = 
                `+‡∏ø${incomePerSec.toFixed(3)}`;
            
            // Update Estimated Daily Profit
            const dailyEst = incomePerSec * 86400;
            const estEl = document.getElementById('estDailyDisplay');
            if(estEl) estEl.innerText = `‡∏ß‡∏±‡∏ô‡∏•‡∏∞ ‡∏ø${dailyEst.toLocaleString('en-US', {maximumFractionDigits: 0})}`;

            document.getElementById('hashrateDisplay').innerText = 
                hashrate.toFixed(1);
            
            // Update Daily Profit Display
            const dailyEl = document.getElementById('dailyProfitDisplay');
            if(dailyEl) {
                dailyEl.innerText = `‡∏ø${dailyProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            autoMiningController();
            updateMiningMode();
        }

        function switchPage(pid, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // --- Auth ---
        function toSignup() { 
            document.getElementById('loginModal').style.display='none'; 
            document.getElementById('signupModal').style.display='flex'; 
            
            // Auto-fill Referral Code
            const pendingRef = localStorage.getItem('pending_ref');
            if(pendingRef) {
                document.getElementById('regRefCode').value = pendingRef;
            }
        }
        function toLogin() { document.getElementById('signupModal').style.display='none'; document.getElementById('loginModal').style.display='flex'; }
        
        function signup() {
            const u = document.getElementById('regUser').value;
            const p = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            const bank = document.getElementById('regBank').value;
            const acc = document.getElementById('regAcc').value;
            const manualRef = document.getElementById('regRefCode').value;
            
            if(!u || !p || !name || !acc) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
            let users = JSON.parse(localStorage.getItem('mining_users')) || {};
            if(users[u]) return showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'error');

            users[u] = {
                pass: p, id: Math.floor(100000+Math.random()*900000),
                name: name, bank: bank, acc: acc,
                regDate: new Date().toISOString(), banned: false,
                referrer: null,
                ip: clientIP,
                deviceId: getDeviceID()
            };
            localStorage.setItem('mining_users', JSON.stringify(users));
            
            let startBalance = 0;

            // Process Referral (Manual Code or Link)
            let refId = null;
            
            // 1. Priority: Manual Input
            if(manualRef && manualRef.trim().length > 0) {
                refId = manualRef.trim().replace(/x/i, ''); // Remove 'X' or 'x'
            } 
            // 2. Fallback: URL Link
            else {
                const pendingRef = localStorage.getItem('pending_ref');
                if(pendingRef) refId = pendingRef.replace(/x/i, '');
            }

            if(refId) {
                const referrerName = Object.keys(users).find(k => users[k].id == refId);
                if(referrerName) {
                    // Save Referrer Link
                    users[u].referrer = referrerName;
                    localStorage.setItem('mining_users', JSON.stringify(users));

                    let refs = JSON.parse(localStorage.getItem(`mining_referrals_${referrerName}`)) || [];
                    if(!refs.find(r => r.name === u)) {
                        refs.push({
                            name: u,
                            date: new Date().toISOString(),
                            status: 'pending',
                            claimed: false,
                            ip: clientIP,
                            deviceId: getDeviceID()
                        });
                        localStorage.setItem(`mining_referrals_${referrerName}`, JSON.stringify(refs));
                        
                        // Notify Referrer
                        let refNotifications = JSON.parse(localStorage.getItem(`notifications_${referrerName}`)) || [];
                        refNotifications.push({
                            msg: `‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà! ${u} ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)`,
                            date: new Date().toISOString(),
                            read: false
                        });
                        localStorage.setItem(`notifications_${referrerName}`, JSON.stringify(refNotifications));
                    }
                } else if(manualRef) {
                    showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡πà‡∏≠‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)', 'warning');
                }
                localStorage.removeItem('pending_ref');
            }

            // Init Profile
            const pf = { username: u, balance: startBalance, hashrate: 0.0, avatar: null };
            localStorage.setItem(`pf_${u}`, JSON.stringify(pf));
            
            if(startBalance > 0) showToast(`‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏ø${startBalance}`, 'success');
            else showToast('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'success');
            
            toLogin();
        }

        function login() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            let users = JSON.parse(localStorage.getItem('mining_users')) || {};
            if(users[u] && users[u].pass === p) {
                if(users[u].banned) return showToast('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß', 'error');
                currentUser = { username: u };
                localStorage.setItem('current_user', JSON.stringify(currentUser));
                document.getElementById('loginModal').style.display='none';
                initApp();
                showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else { showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
        }

        function logout() { localStorage.removeItem('current_user'); location.reload(); }

        // --- Data ---
        function saveData() { 
            if(currentUser) { 
                let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`)); 
                pf.balance = balance; 
                pf.hashrate = hashrate; 
                pf.dailyProfit = dailyProfit;
                pf.lastProfitDate = lastProfitDate;
                localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf)); 
            } 
        }
        function loadUserData() {
            let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`));
            if(pf) {
                balance = parseFloat(pf.balance || 0);
                hashrate = parseFloat(pf.hashrate || 0);
                dailyProfit = parseFloat(pf.dailyProfit || 0);
                lastProfitDate = pf.lastProfitDate || new Date().toDateString();

                // Check date reset immediately on load
                if(lastProfitDate !== new Date().toDateString()) {
                    dailyProfit = 0;
                    lastProfitDate = new Date().toDateString();
                    saveData();
                }

                console.log('üìä Loaded Data:', { balance, hashrate, dailyProfit });
                
                // ‚úÖ Auto-start mining if hashrate > 0
                if(hashrate > 0) {
                    // Note: We allow auto-start here, but rig_deleted event might pause it momentarily
                    isMining = true;
                    console.log('üöÄ Auto-starting mining...');
                }
                
                updateUI();
            }
        }
        function renderProfile() {
            let users = JSON.parse(localStorage.getItem('mining_users'));
            let uData = users[currentUser.username];
            let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`));
            
            document.getElementById('headerName').innerText = currentUser.username;
            document.getElementById('headerID').innerText = `ID: ${uData.id}`;
            document.getElementById('settingName').innerText = currentUser.username;
            document.getElementById('settingID').innerText = `ID: ${uData.id}`;
            document.getElementById('myRefCode').innerText = uData.id + "X";
            
            if(pf.avatar) {
                document.getElementById('headerAvatar').innerHTML = `<img src="${pf.avatar}">`;
                document.getElementById('settingAvatar').innerHTML = `<img src="${pf.avatar}">`;
            }
            
            updateNotifBadge();
        }

        function changeProfilePic() {
            const file = document.getElementById('uploadProfile').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`));
                    pf.avatar = e.target.result;
                    localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf));
                    renderProfile();
                }
                reader.readAsDataURL(file);
            }
        }

        // Removed duplicate openWalletModal
        function previewSlip() {
            const file = document.getElementById('slipUpload').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('slipImg').src = e.target.result;
                    document.getElementById('slipPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function submitDeposit() {
            const amt = parseFloat(document.getElementById('walletAmount').value);
            if(!amt || amt < 40) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 40 ‡∏ö‡∏≤‡∏ó', 'warning');
            
            // Simulate Automatic Payment Check
            const btn = document.getElementById('btnDeposit');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô...';
            
            // Play wait sound/vib if needed
            // setTimeout to simulate network check
            setTimeout(() => {
                // Success
                let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
                trans.push({
                    id: Date.now(), 
                    user: currentUser.username, 
                    type: 'deposit', 
                    amount: amt,
                    status: 'approved', 
                    timestamp: Date.now(), 
                    processed: true,
                    method: 'qr_auto'
                });
                localStorage.setItem('mining_transactions', JSON.stringify(trans));
                
                balance += amt;
                saveData(); 
                updateUI();
                
                // Notify User
                showToast(`‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${amt.toLocaleString()} THB`, 'success');
                
                // Reset UI
                btn.disabled = false;
                btn.innerHTML = originalText;
                document.getElementById('walletModal').style.display='none';
                
                // Sound & Vib Success
                if(typeof soundMgr !== 'undefined') soundMgr.play('emphasis');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('emphasis');

                // Add Notification
                addNotification(`‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à +${amt.toLocaleString()} THB`);
                
            }, 3000);
        }

        function submitTransaction() {
            const amt = parseFloat(document.getElementById('walletAmount').value);
            if(!amt) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'warning');
            
            // Deposit is handled by submitDeposit() now
            
            if(currentAction === 'withdraw') {
                let users = JSON.parse(localStorage.getItem('mining_users'));
                let u = users[currentUser.username];
                if(!u.bank || !u.acc) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'warning');
                                //‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô//
                if(amt < 200) return showToast('‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 200 ‡∏ö‡∏≤‡∏ó', 'warning');
                if(amt > 200000) return showToast('‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 200,000 ‡∏ö‡∏≤‡∏ó‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning');
                if(balance < amt) return showToast('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
                
                const fee = amt * 0.03;
                const net = amt - fee;
                
                if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô?\n\n‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô: ‡∏ø${amt.toLocaleString()}\n‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (3%): ‡∏ø${fee.toLocaleString()}\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ‡∏ø${net.toLocaleString()}`)) return;
                
                balance -= amt;
                
                let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
                trans.push({
                    id: Date.now(), user: currentUser.username, type: currentAction, amount: amt,
                    fee: fee, net: net, // Store fee details
                    status: 'pending', timestamp: Date.now(), processed: false
                });
                localStorage.setItem('mining_transactions', JSON.stringify(trans));
                saveData(); updateUI();
                showToast('‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
                document.getElementById('walletModal').style.display='none';
            }
        }

        function formatBankAcc(acc) {
            if(!acc) return '---';
            const cleaned = ('' + acc).replace(/\D/g, '');
            if(cleaned.length === 10) {
                return `${cleaned.substring(0,3)}-${cleaned.substring(3,4)}-${cleaned.substring(4,9)}-${cleaned.substring(9)}`;
            }
            return acc;
        }

        function showBankModal() {
            let users = JSON.parse(localStorage.getItem('mining_users'));
            let u = users[currentUser.username];
            
            const modal = document.getElementById('bankModal');
            const content = modal.querySelector('.modal-content');
            
            // Reset modal content structure if needed
            if(!document.getElementById('myBankInfo')) {
                 // This handles if we are re-rendering inside an existing structure or setting it up
                 // But since we are replacing the innerHTML of the modal content mostly or specific part?
                 // The original code targeted 'myBankInfo' which is inside the modal.
                 // Let's just update the 'myBankInfo' content as the original did.
            }
            
            document.getElementById('myBankInfo').innerHTML = `
                <div class="bank-card ${u.bank}" style="margin-bottom: 25px; position: relative; overflow: hidden; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                    <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;"></div>
                    <i class="fas fa-university bank-logo-watermark" style="opacity: 0.1; font-size: 8rem; position: absolute; bottom: -20px; right: -20px;"></i>
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
                        <div class="bank-chip" style="width: 50px; height: 35px; background: linear-gradient(135deg, #d4af37, #f9e58a); border-radius: 6px; position: relative;">
                            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.2);"></div>
                            <div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: rgba(0,0,0,0.2);"></div>
                        </div>
                        <div style="text-align: right; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                            <div style="font-weight: bold; font-size: 1.1rem;">${u.bank.toUpperCase()}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8;">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏î‡∏ö‡∏¥‡∏ï</div>
                        </div>
                    </div>
                    
                    <div style="z-index: 2; position: relative; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                        <div class="bank-number" style="font-size: 1.5rem; letter-spacing: 3px; margin-bottom: 15px; font-family: monospace;">${formatBankAcc(u.acc)}</div>
                        <div class="bank-holder" style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div>
                                <div style="font-size: 0.6rem; opacity: 0.7; margin-bottom: 2px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏ï‡∏£</div>
                                <div style="font-size: 1rem; text-transform: uppercase;">${u.name}</div>
                            </div>
                            <div style="font-size:1.5rem;">
                                <i class="fab fa-cc-visa"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="cyber-btn" onclick="showBankEdit()" style="width: 100%;">
                    <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            `;
            document.getElementById('bankModal').style.display='flex';
        }

        function showBankEdit() {
            let users = JSON.parse(localStorage.getItem('mining_users'));
            let u = users[currentUser.username];
            
            document.getElementById('myBankInfo').innerHTML = `
                <div class="glass-panel" style="text-align:left; margin-bottom:20px; padding: 25px;">
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                        <div class="custom-select-wrapper" style="position: relative;">
                            <select id="editBank" class="cyber-input" style="width: 100%; appearance: none; cursor: pointer;">
                                <option value="kbank" ${u.bank==='kbank'?'selected':''}>‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
                                <option value="scb" ${u.bank==='scb'?'selected':''}>‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
                                <option value="ktb" ${u.bank==='ktb'?'selected':''}>‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
                                <option value="bbl" ${u.bank==='bbl'?'selected':''}>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
                                <option value="gsb" ${u.bank==='gsb'?'selected':''}>‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); pointer-events: none;"></i>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <input type="tel" id="editAcc" class="cyber-input" value="${u.acc}" placeholder="0123456789" maxlength="10">
                    </div>
                    
                    <div>
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <input type="text" id="editName" class="cyber-input" value="${u.name}">
                    </div>
                </div>
                
                <div style="display:flex; gap:15px;">
                    <button class="cyber-btn" style="flex:1; background: transparent; border-color: var(--text-muted); color: var(--text-muted); box-shadow: none;" onclick="showBankModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="cyber-btn" style="flex:1; --btn-bg: var(--success);" onclick="saveBankInfo()">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            `;
        }

        function saveBankInfo() {
            const bank = document.getElementById('editBank').value;
            const acc = document.getElementById('editAcc').value;
            const name = document.getElementById('editName').value;
            
            if(!acc || !name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            
            let users = JSON.parse(localStorage.getItem('mining_users'));
            users[currentUser.username].bank = bank;
            users[currentUser.username].acc = acc;
            users[currentUser.username].name = name;
            
            localStorage.setItem('mining_users', JSON.stringify(users));
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            showBankModal();
        }
        function showReferralModal() { 
            document.getElementById('refModal').style.display='flex'; 
            renderReferralUI();
        }

        function renderReferralUI() {
            // Load User Specific Referrals
            let refs = JSON.parse(localStorage.getItem(`mining_referrals_${currentUser.username}`));
            if(!refs) {
                refs = [];
                localStorage.setItem(`mining_referrals_${currentUser.username}`, JSON.stringify(refs));
            }
            
            const list = document.getElementById('refList');
            const pCount = document.getElementById('refPendingCount');
            const cCount = document.getElementById('refCompletedCount');
            
            let pending = 0;
            let completed = 0;
            let bonus = 0;

            list.innerHTML = '';

            if(refs.length === 0) {
                list.innerHTML = `
                    <div class="ref-list-empty" style="text-align: center; padding: 40px 0; color: var(--text-muted);">
                        <div style="width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: 1px dashed var(--text-muted);">
                            <i class="fas fa-user-plus" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                        <div style="font-size: 1.1rem; font-weight: bold; color: var(--text-main);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏¥‡∏ç</div>
                        <div style="font-size: 0.85rem;">‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
                    </div>
                `;
            } else {
                refs.forEach(r => {
                    if(r.status === 'pending') pending++;
                    else if(r.status === 'completed') {
                        completed++;
                        if(!r.claimed) bonus += 50; // 50 THB Bonus
                    }
                    
                    let statusColor = r.status === 'completed' ? 'var(--success)' : 'var(--warning)';
                    let statusText = r.status === 'completed' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    let icon = r.status === 'completed' ? 'fa-check' : 'fa-clock';
                    
                    list.innerHTML += `
                        <div class="glass-panel" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; border-radius: 16px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px var(--primary-dim);">
                                    <i class="fas fa-user" style="color: white;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 1rem; font-weight: bold; color: white;">${r.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${new Date(r.date).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${statusColor}; font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 6px; display: inline-block; border: 1px solid ${statusColor};">
                                    <i class="fas ${icon}"></i> ${statusText}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            pCount.innerText = pending;
            cCount.innerText = completed;
            
            const btn = document.getElementById('btnClaimBonus');
            if(bonus > 0) {
                btn.innerHTML = `<i class="fas fa-gift" style="margin-right:5px;"></i> ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (‡∏ø${bonus.toFixed(2)})`;
                btn.style.background = 'linear-gradient(135deg, var(--success), #00cec9)';
                btn.style.color = '#000';
                btn.style.fontWeight = 'bold';
                btn.style.cursor = 'pointer';
                btn.style.boxShadow = '0 0 15px rgba(0, 255, 157, 0.4)';
                btn.onclick = function() { claimBonus(bonus); };
            } else {
                btn.innerHTML = `<i class="fas fa-gift" style="margin-right:5px;"></i> ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (0.00)`;
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.color = '#777';
                btn.style.cursor = 'not-allowed';
                btn.style.boxShadow = 'none';
                btn.onclick = null;
            }
        }

        function copyRef() {
            const code = document.getElementById('myRefCode').innerText;
            if(!code || code === '---' || code === 'undefinedX') {
                alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
                return;
            }
            
            // Dynamic Link
            const baseUrl = window.location.href.split('?')[0];
            const link = `${baseUrl}?ref=${code}`;
            
            navigator.clipboard.writeText(link);
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        function claimBonus(amount) {
            if(!amount || amount <= 0) return;
            balance += amount;
            
            let refs = JSON.parse(localStorage.getItem(`mining_referrals_${currentUser.username}`)) || [];
            refs.forEach(r => { if(r.status === 'completed' || r.status === 'approved') r.claimed = true; });
            localStorage.setItem(`mining_referrals_${currentUser.username}`, JSON.stringify(refs));
            
            // Record Transaction
            let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
            trans.push({
                id: Date.now(), user: currentUser.username, type: 'deposit', amount: amount,
                status: 'approved', timestamp: Date.now(), processed: true,
                method: 'referral_commission', fee: 0, net: amount
            });
            localStorage.setItem('mining_transactions', JSON.stringify(trans));
                    
            saveData();
            updateUI();
            renderReferralUI();
            
            // Custom Success Modal (AI Theme)
            const modalId = 'claimSuccessModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10001';
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; text-align:center; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none;"></div>
                    
                    <div style="width: 80px; height: 80px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid #00f2ff; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);">
                        <i class="fas fa-gift" style="font-size: 3rem; color: #00f2ff; animation: bounce 2s infinite;"></i>
                    </div>
                    <h2 style="color: #fff; margin:0 0 5px; text-shadow: 0 0 5px #00f2ff;">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <p style="color: #94a3b8; margin-bottom: 20px; font-family: monospace;">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #00f2ff; margin-bottom: 20px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5); font-family: monospace;">
                        ‡∏ø${amount.toFixed(2)}
                    </div>
                    <button class="btn-action" style="background: rgba(0, 242, 255, 0.1); color: #00f2ff; border: 1px solid #00f2ff; font-weight: bold; border-radius: 8px;" onclick="document.getElementById('${modalId}').remove()">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
                </div>
            `;
            document.body.appendChild(div);
        }

        // --- Shop ---
        function loadShop() {
            const g = document.getElementById('shopList');
            if(!g) return;
            g.innerHTML = '';
            const disabled = localStorage.getItem('shop_disabled') === 'true';
            const notice = localStorage.getItem('shop_notice');
            let items = JSON.parse(localStorage.getItem('mining_shop_items'));
            const seeded = localStorage.getItem('shop_seeded') === 'true';

            if(disabled) {
                g.innerHTML = `<div class="glass-panel" style="text-align:center; padding: 30px;">
                    <div style="font-size:1.2rem; font-weight:bold; color: var(--warning); margin-bottom: 8px;">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>
                    <div style="color: var(--text-muted);">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</div>
                    ${notice ? `<div style="margin-top:10px; color:#fff;">${notice}</div>` : ''}
                </div>`;
                return;
            }

            if(!items) {
                if(!seeded) {
                    const catalog = [
                        {id: 6, name: "‡∏ä‡∏∏‡∏î‡∏Ç‡∏∏‡∏î Bitcoin ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (24‡∏ä‡∏°.)", speed: 0.05, price: 0, tier: 'limited', tag: 'free', icon: 'fa-bitcoin'},
                        {id: 1, name: "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≠ GTX 1060 (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)", speed: 0.5, price: 500, tier: 'basic', icon: 'fa-fan'},
                        {id: 7, name: "‡πÅ‡∏ó‡πà‡∏ô‡∏Ç‡∏∏‡∏î Titanium Mk1", speed: 12.0, price: 12000, tier: 'mid', tag: 'used', icon: 'fa-hammer'},
                        {id: 2, name: "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≠ RTX 3060 Ti", speed: 2.5, price: 2500, tier: 'mid', icon: 'fa-memory'},
                        {id: 3, name: "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≠ RTX 4090 Ultimate", speed: 8.0, price: 9500, tier: 'pro', tag: 'hot', icon: 'fa-microchip'},
                        {id: 4, name: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î ASIC S19 Pro", speed: 25.0, price: 28000, tier: 'pro', icon: 'fa-server'},
                        {id: 5, name: "‡πÅ‡∏ó‡πà‡∏ô‡∏Ç‡∏∏‡∏î Quantum V1", speed: 80.0, price: 85000, tier: 'legendary', tag: 'new', icon: 'fa-atom'},
                    ];
                    localStorage.setItem('mining_shop_items', JSON.stringify(catalog));
                    localStorage.setItem('shop_seeded', 'true');
                    items = catalog;
                } else {
                    items = [];
                }
            }

            if(items.length === 0) {
                g.innerHTML = `<div class="glass-panel" style="text-align:center; padding: 30px;">
                    <div style="font-size:1.2rem; font-weight:bold; color: #fff; margin-bottom: 8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div style="color: var(--text-muted);">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô</div>
                    ${notice ? `<div style="margin-top:10px; color:#fff;">${notice}</div>` : ''}
                </div>`;
                return;
            }

            let activeItems = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
            if(notice) g.innerHTML += `<div class="glass-panel" style="margin-bottom:15px;">${notice}</div>`;

            items.forEach(i => {
                const tagClass = i.tag ? i.tag : '';
                const tagLabel = i.tag ? ({hot:'‡∏Æ‡∏≠‡∏ï', new:'‡πÉ‡∏´‡∏°‡πà', sale:'‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤', best:'‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', used:'‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á', free:'‡∏ü‡∏£‡∏µ'}[i.tag] || i.tag) : null;
                let btnText = '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <i class="fas fa-shopping-cart"></i>';
                let btnState = '';
                let btnStyle = 'margin-top:5px; padding:8px 0; font-size:0.9rem;';
                if(i.id === 6) {
                    const existing = activeItems.find(x => x.id === 6);
                    if(existing) {
                        const timeLeft = Math.max(0, Math.floor((existing.expiresAt - Date.now()) / 1000));
                        const h = Math.floor(timeLeft / 3600);
                        const m = Math.floor((timeLeft % 3600) / 60);
                        btnText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${h}‡∏ä‡∏°. ${m}‡∏ô.`;
                        btnState = 'disabled';
                        btnStyle += 'background: #555; cursor: not-allowed;';
                    } else {
                        btnText = '‡∏£‡∏±‡∏ö‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ <i class="fas fa-gift"></i>';
                        btnStyle += 'background: linear-gradient(135deg, #ffd700, #f1c40f); color: #000; font-weight: 800;';
                    }
                }
                const icon = i.icon || 'fa-microchip';
                const tier = i.tier || 'basic';
                let tierColor = 'var(--primary)';
                if(tier === 'legendary') tierColor = '#f1c40f';
                else if(tier === 'pro') tierColor = '#e056fd';
                else if(tier === 'mid') tierColor = '#00cec9';
                else if(tier === 'basic') tierColor = '#74b9ff';
                else if(tier === 'limited') tierColor = '#ff7675';
                const isUsed = tagClass.includes('used');
                const cardClass = isUsed ? 'shop-card-cyber used' : 'shop-card-cyber';
                g.innerHTML += `
                <div class="${cardClass}" style="--card-color: ${tierColor};">
                    ${tagLabel ? `<div style=\"position: absolute; top: 10px; right: 10px; background: ${tierColor}; color: #000; font-size: 0.6rem; font-weight: bold; padding: 2px 8px; border-radius: 4px;\">${tagLabel}</div>` : ''}
                    <div class="cyber-icon-box" style="border-color: ${tierColor}; box-shadow: 0 0 15px ${tierColor}40;">
                        <i class="fas ${icon}" style="color: ${tierColor};"></i>
                    </div>
                    <h3 style="margin: 10px 0 5px; font-size: 1rem; color: white;">${i.name}</h3>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: center; align-items: center; gap: 5px; color: #94a3b8; font-size: 0.8rem;">
                            <i class="fas fa-bolt" style="color: ${tierColor};"></i>
                            <span>+${i.speed} MH/s</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--success); text-shadow: 0 0 5px rgba(0,255,157,0.3);">
                            ‚âà ‡∏ø${(i.speed * 86400).toLocaleString()}/‡∏ß‡∏±‡∏ô
                        </div>
                    </div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: white; margin-bottom: 15px; text-shadow: 0 0 10px ${tierColor}80;">
                        ${i.price === 0 ? '‡∏ü‡∏£‡∏µ' : '‡∏ø'+i.price.toLocaleString()}
                    </div>
                    <button class="cyber-btn" onclick="buyItem(${i.price}, ${i.speed}, ${i.id})" ${btnState} style="${btnState ? 'opacity:0.5;cursor:not-allowed;' : ''} border-color: ${tierColor}; color: ${tierColor}; box-shadow: 0 0 10px ${tierColor}20;">
                        ${btnText}
                    </button>
                </div>`;
            });
        }

        let lastKnownShopUpdate = localStorage.getItem('shop_last_update');
        
        function checkShopUpdate() {
            const currentUpdate = localStorage.getItem('shop_last_update');
            const myLastSeen = localStorage.getItem('shop_seen_update');
            
            // Live Update Logic
            if(currentUpdate && currentUpdate !== lastKnownShopUpdate) {
                lastKnownShopUpdate = currentUpdate;
                loadShop(); // Live Reload
                
                // Create Modal Alert for New Item
                const modalId = 'newItemModal';
                if(!document.getElementById(modalId)) {
                    const div = document.createElement('div');
                    div.id = modalId;
                    div.className = 'modal';
                    div.style.display = 'flex';
                    div.style.zIndex = '9999';
                    div.innerHTML = `
                        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; text-align:center; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none;"></div>
                            
                            <i class="fas fa-rocket" style="font-size: 3rem; color: #00f2ff; margin-bottom: 15px; animation: bounce 2s infinite; text-shadow: 0 0 15px rgba(0, 242, 255, 0.5);"></i>
                            <h2 style="color: #fff; margin:0; text-shadow: 0 0 5px #00f2ff;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                            <p style="color: #94a3b8; font-family: monospace; margin-top: 5px;">‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</p>
                            
                            <button class="btn-action" style="background: rgba(0, 242, 255, 0.1); color: #00f2ff; border: 1px solid #00f2ff; font-weight: bold; border-radius: 8px; margin-top: 20px;" onclick="document.getElementById('${modalId}').remove(); openShopPage()">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                            <div style="margin-top:10px; font-size:0.8rem; color: #64748b; cursor:pointer;" onclick="document.getElementById('${modalId}').remove()">‡∏õ‡∏¥‡∏î</div>
                        </div>
                    `;
                    document.body.appendChild(div);
                }
                showToast('‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô', 'success');
            }

            if(currentUpdate && currentUpdate !== myLastSeen) {
                const b1 = document.getElementById('shopBadgeFloat');
                const b2 = document.getElementById('shopBadgeNav');
                if(b1) b1.style.display = 'block';
                if(b2) b2.style.display = 'block';
            } else {
                const b1 = document.getElementById('shopBadgeFloat');
                const b2 = document.getElementById('shopBadgeNav');
                if(b1) b1.style.display = 'none';
                if(b2) b2.style.display = 'none';
            }
        }
        
        function buyItem(p, s, id) {
            if(id === 6) { // Free Bitcoin Starter 24h
                let active = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
                const existing = active.find(x => x.id === 6);
                if(existing) {
                    showToast('‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'warning');
                    return;
                }
                
                // 24 Hours Expiration
                active.push({
                    id: 6, 
                    name: 'Bitcoin Starter 24h',
                    speed: s, 
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000)
                });
                localStorage.setItem(`active_items_${currentUser.username}`, JSON.stringify(active));
                
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° hashrate ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                hashrate += s;
                isMining = true; // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                
                saveData(); 
                updateUI(); 
                loadShop();
                updateMiningMode();
                miningLoop();
                
                try {
                    let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser.username}`)) || [];
                    const itemsC = JSON.parse(localStorage.getItem('mining_shop_items')) || [];
                    const item = itemsC.find(x => x.id === id) || { name: 'Bitcoin Starter 24h', icon: 'fa-bitcoin' };
                    rigs.push({ 
                        id, 
                        name: item.name, 
                        speed: s, 
                        price: 0, 
                        icon: item.icon, 
                        status: 'active', 
                        timestamp: Date.now(), 
                        expiresAt: Date.now() + (24 * 60 * 60 * 1000) 
                    });
                    localStorage. setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                } catch (_) {}
                
                showToast('‚úÖ ‡∏£‡∏±‡∏ö Bitcoin Starter 24h ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!  ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ', 'success');
                addNotification('‚úÖ ‡∏Ç‡∏∏‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß +' + s. toFixed(2) + ' MH/s', 'success');
                
                if(typeof soundMgr !== 'undefined') soundMgr.play('emphasis');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('emphasis');
                return;
            }

            // ‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠
            if(balance >= p) {
                balance -= p; 
                // hashrate += s; // Let syncMiningData handle this or recalculate
                
                // Add to Rigs first (Source of Truth)
                try {
                    let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser.username}`)) || [];
                    const itemsC = JSON.parse(localStorage.getItem('mining_shop_items')) || [];
                    const item = itemsC.find(x => x.id === id) || { name: 'Rig', icon: 'fa-microchip' };
                    rigs.push({ 
                        id, 
                        name: item.name, 
                        speed: s, 
                        price: p, 
                        icon: item.icon, 
                        status: 'active', 
                        timestamp: Date.now() 
                    });
                    localStorage.setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                } catch (e) {
                    console.error('Error saving rig:', e);
                }

                // Sync everything
                syncMiningData();
                isMining = true;

                saveData(); 
                updateUI(); 
                updateMiningMode();
                miningLoop();
                
                showToast(`‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +${s} MH/s`, 'success');
                addNotification(`üí∞ ‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -‡∏ø${p. toLocaleString()} | +${s. toFixed(2)} MH/s`, 'success');
                
                if(typeof soundMgr !== 'undefined') soundMgr.play('emphasis');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('emphasis');
            } else { 
                showToast('‚ùå ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏ï‡πâ‡∏≠‡∏á ‡∏ø' + (p - balance).toFixed(2), 'error');
                if(typeof soundMgr !== 'undefined') soundMgr. play('alert');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('alert');
            }
        }

        function updateMiningMode() {
            const el = document.getElementById('miningMode');
            if(!el) return;
            if(isMining && hashrate > 0) {
                el.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏∏‡∏î';
                el.style.color = 'var(--success)';
                el.style.textShadow = '0 0 10px var(--success)';
            } else {
                el.innerText = '‡∏û‡∏±‡∏Å';
                el.style.color = '#94a3b8';
                el.style.textShadow = 'none';
            }
        }

        function autoMiningController() {
            // Pure automatic mining based on hashrate
            if(hashrate > 0 && !isMining) {
                isMining = true;
                updateMiningMode();
                console.log('üîÑ Auto-started mining');
            } else if(hashrate <= 0 && isMining) {
                isMining = false;
                updateMiningMode();
                console.log('üõë Auto-stopped mining (No hashrate)');
            }
        }

        function startMining() {
            console.warn('Manual start is disabled. System is fully automatic.');
            autoMiningController();
        }

        function stopMining() {
            console.warn('Manual stop is disabled. System is fully automatic.');
            autoMiningController();
        }

        function checkExpiration() {
            if(! currentUser) return;
            let active = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
            if(active.length === 0) return;

            let now = Date.now();
            let updatedActive = [];
            let expiredSpeed = 0;
            let hasExpired = false;

            active.forEach(item => {
                if(item.expiresAt > now) {
                    updatedActive.push(item);
                } else {
                    expiredSpeed += item.speed;
                    hasExpired = true;
                }
            });

            if(hasExpired) {
                hashrate = Math.max(0, hashrate - expiredSpeed);
                localStorage.setItem(`active_items_${currentUser. username}`, JSON.stringify(updatedActive));
                
                console.log(`‚è∞ Item expired!  Hashrate: ${hashrate. toFixed(2)}`);
                
                saveData();
                updateUI();
                autoMiningController();
                updateMiningMode();
                
                try {
                    let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser. username}`)) || [];
                    const nowTs = Date.now();
                    rigs. forEach(r => { if(r.expiresAt && r.expiresAt <= nowTs) r.status = 'expired'; });
                    localStorage.setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                } catch (_) {}
                
                loadShop();
                
                showToast('‚è∞ ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ‡πÅ‡∏£‡∏á‡∏Ç‡∏∏‡∏î‡∏•‡∏î‡∏•‡∏á ' + expiredSpeed.toFixed(2) + ' MH/s', 'warning');
                addNotification(`‚è∞ ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ -${expiredSpeed.toFixed(2)} MH/s`, 'warning');
            }
        }

        function openShopPage() {
            // Mark as seen
            const lastUpdate = localStorage.getItem('shop_last_update');
            if(lastUpdate) {
                localStorage.setItem('shop_seen_update', lastUpdate);
            }
            checkShopUpdate(); // Update UI to hide badge
            switchPage('shopPage', document.getElementById('navShop'));
        }

        // --- Sound & Vibration & Monitor ---
        class SoundManager {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.enabled = localStorage.getItem('sound_enabled') === 'true';
                this.type = localStorage.getItem('sound_type') || 'standard'; 
            }

            play(overrideType) {
                if (!this.enabled) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const type = overrideType || this.type;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;
                
                if (type === 'standard' || type === 'alert') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now);
                    osc.frequency.exponentialRampToValueAtTime(440, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'emphasis') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(880, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'rapid') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.1, now);
                    osc.start(now);
                    osc.stop(now + 0.05);
                    
                    const osc2 = this.ctx.createOscillator();
                    const gain2 = this.ctx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(this.ctx.destination);
                    osc2.type = 'triangle';
                    osc2.frequency.setValueAtTime(800, now + 0.1);
                    gain2.gain.setValueAtTime(0.1, now + 0.1);
                    osc2.start(now + 0.1);
                    osc2.stop(now + 0.15);
                } else if (type === 'fast') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(1200, now);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                }
            }
        }

        class VibrationManager {
            constructor() {
                this.enabled = localStorage.getItem('vib_enabled') === 'true';
                this.type = localStorage.getItem('vib_type') || 'standard'; 
            }

            trigger(overrideType) {
                if (!this.enabled || !navigator.vibrate) return;
                const type = overrideType || this.type;
                if (type === 'fast') navigator.vibrate(50);
                else if (type === 'emphasis') navigator.vibrate([100, 50, 100]);
                else if (type === 'alert') navigator.vibrate(200);
                else navigator.vibrate(100); 
            }
        }

        const soundMgr = new SoundManager();
        const vibMgr = new VibrationManager();

        let wakeLock = null;
        async function toggleWakeLock(enable) {
            if ('wakeLock' in navigator) {
                if (enable) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake Lock active');
                    } catch (err) { console.error(err); }
                } else {
                    if (wakeLock !== null) {
                        wakeLock.release();
                        wakeLock = null;
                        console.log('Wake Lock released');
                    }
                }
            }
        }

        function addNotification(msg, type) {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            history.push({
                msg: msg,
                type: type,
                timestamp: Date.now(),
                read: false
            });
            if(history.length > 50) history.shift();
            localStorage.setItem(`history_notifs_${currentUser.username}`, JSON.stringify(history));
            
            // Update Badge
            updateNotifBadge();
        }

        function updateNotifBadge() {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            let unread = history.filter(h => !h.read).length;
            
            const badge = document.getElementById('headerNotifBadge');
            if(badge) {
                if(unread > 0) {
                    badge.style.display = 'block';
                    badge.innerText = unread > 99 ? '99+' : unread;
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function openNotificationHistory() {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            
            // Mark all as read
            let hasUnread = false;
            history.forEach(h => {
                if(!h.read) {
                    h.read = true;
                    hasUnread = true;
                }
            });
            if(hasUnread) {
                localStorage.setItem(`history_notifs_${currentUser.username}`, JSON.stringify(history));
                updateNotifBadge();
            }

            history.sort((a,b) => b.timestamp - a.timestamp);
            
            const modalId = 'notifHistoryModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            let listHtml = '';
            if(history.length === 0) {
                listHtml = `
                    <div style="text-align:center; color:var(--text-muted); padding:40px;">
                        <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px dashed var(--text-muted);">
                            <i class="fas fa-bell-slash" style="font-size:1.5rem; opacity:0.5;"></i>
                        </div>
                        <div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                    </div>`;
            } else {
                history.forEach(h => {
                    let icon = h.type === 'success' ? '<i class="fas fa-check-circle"></i>' : (h.type === 'error' ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-info-circle"></i>');
                    let color = h.type === 'success' ? 'var(--success)' : (h.type === 'error' ? 'var(--danger)' : 'var(--primary)');
                    let bg = h.type === 'success' ? 'rgba(0, 255, 157, 0.1)' : (h.type === 'error' ? 'rgba(255, 0, 85, 0.1)' : 'rgba(0, 242, 255, 0.1)');
                    
                    listHtml += `
                        <div class="glass-panel" style="padding: 15px; margin-bottom: 10px; display:flex; gap:15px; align-items:flex-start; animation: slideUp 0.3s ease-out;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${bg}; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: ${color}; border: 1px solid ${color}; box-shadow: 0 0 10px ${bg}; flex-shrink: 0;">
                                ${icon}
                            </div>
                            <div style="flex:1;">
                                <div style="font-size: 0.95rem; color: var(--text-main); line-height: 1.4;">${h.msg}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; display: flex; align-items: center; gap: 5px;">
                                    <i class="far fa-clock"></i> ${new Date(h.timestamp).toLocaleString('th-TH')}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10000';
            div.innerHTML = `
                <div class="modal-content" style="height: 70vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: rgba(10, 14, 30, 0.95);">
                    <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2);">
                        <div>
                            <h2 style="margin:0; color: var(--primary); text-transform: uppercase; letter-spacing: 1px;">Notification Log</h2>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        </div>
                        <div onclick="document.getElementById('${modalId}').remove()" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.05); cursor: pointer; color: var(--text-muted);">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    
                    <div style="flex:1; overflow-y: auto; padding: 15px;">
                        ${listHtml}
                    </div>
                    
                    <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                        <button class="cyber-btn" style="width: 100%;" onclick="document.getElementById('${modalId}').remove()">
                            <i class="fas fa-check"></i> ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
        }

        function addLiveLog(msg, color = "#00cec9") {
            const mon = document.getElementById('liveMonitorContent');
            if(!mon) return;
            const div = document.createElement('div');
            div.innerText = "> " + msg;
            div.style.color = color;
            div.style.fontFamily = "monospace";
            div.style.fontSize = "0.6rem";
            div.style.fontWeight = "bold";
            div.style.textShadow = `0 0 5px ${color}`;
            mon.appendChild(div);
            if(mon.children.length > 6) mon.removeChild(mon.children[0]);
        }

        function sendAdminLog(msg, type='info') {
            if(!currentUser) return;
            const logs = JSON.parse(localStorage.getItem('mining_live_logs')) || [];
            logs.push({
                timestamp: Date.now(),
                user: currentUser.username,
                msg: msg,
                type: type
            });
            // Keep last 50 logs
            if(logs.length > 50) logs.shift();
            localStorage.setItem('mining_live_logs', JSON.stringify(logs));
        }

        function updateLiveMonitor() {
            const mon = document.getElementById('liveMonitorContent');
            if(!mon) return;
            
            const cmds = [
                "Mining block #" + Math.floor(Math.random()*999999),
                "Verifying hash...",
                "Share accepted (" + (Math.random()*50+10).toFixed(2) + "ms)",
                "Syncing with VPS...",
                "Temperature: " + (Math.random()*10+60).toFixed(1) + "C",
                "Fan Speed: " + Math.floor(Math.random()*20+80) + "%",
                "Calculating nonce...",
                "Peer connected: 192.168.X.X",
                "Network difficulty: " + (Math.random()*100).toFixed(2) + "T"
            ];
            const cmd = cmds[Math.floor(Math.random()*cmds.length)];
            
            // Only add random log if not paused or just randomly
            // We reuse addLiveLog for consistency
            const div = document.createElement('div');
            div.innerText = "> " + cmd;
            div.style.color = "#00cec9";
            div.style.fontFamily = "monospace";
            div.style.fontSize = "0.6rem";
            mon.appendChild(div);
            if(mon.children.length > 6) mon.removeChild(mon.children[0]);
        }

        setInterval(() => {
            if(document.getElementById('liveMonitor')?.style.display === 'block') updateLiveMonitor();
        }, 800);

        function loadSystemSettings() {
            const swSound = document.getElementById('swSound');
            if(swSound) swSound.checked = soundMgr.enabled;

            const swVib = document.getElementById('swVib');
            if(swVib) swVib.checked = vibMgr.enabled;

            const swWake = document.getElementById('swWake');
            if(swWake) swWake.checked = localStorage.getItem('wake_enabled') === 'true';

            const swMonitor = document.getElementById('swMonitor');
            if(swMonitor) swMonitor.checked = localStorage.getItem('monitor_enabled') === 'true';
            
            if(localStorage.getItem('wake_enabled') === 'true') toggleWakeLock(true);
            if(localStorage.getItem('monitor_enabled') === 'true') {
                const liveMonitor = document.getElementById('liveMonitor');
                if(liveMonitor) liveMonitor.style.display = 'block';
            }
            
            const selSound = document.getElementById('selSound');
            if(selSound) selSound.value = soundMgr.type;

            const selVib = document.getElementById('selVib');
            if(selVib) selVib.value = vibMgr.type;
        }

        function confirmReset() {
            if(confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n- ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ\n- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö')) {
                resetUserData();
            }
        }

        function resetUserData() {
            if(!currentUser) return;
            
            // 1. Reset Memory
            balance = 0;
            hashrate = 0;
            dailyProfit = 0;
            isMining = false;
            
            // 2. Clear Storage
            localStorage.removeItem(`mining_rigs_${currentUser.username}`);
            localStorage.removeItem(`active_items_${currentUser.username}`);
            
            // 3. Reset Profile
            let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`)) || {};
            pf.balance = 0;
            pf.hashrate = 0;
            pf.dailyProfit = 0;
            localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf));
            
            // 4. Update UI
            updateUI();
            renderActiveContracts();
            
            showToast('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            
            // 5. Stop Mining Loop (it will restart if hashrate > 0, but now it is 0)
            if(soundMgr) soundMgr.play('alert');
        }

        function saveSystemSetting(key, value) {
            localStorage.setItem(key, value);
            if(key === 'sound_enabled') soundMgr.enabled = value;
            if(key === 'sound_type') soundMgr.type = value;
            if(key === 'vib_enabled') vibMgr.enabled = value;
            if(key === 'vib_type') vibMgr.type = value;
            if(key === 'wake_enabled') toggleWakeLock(value);
            if(key === 'monitor_enabled') document.getElementById('liveMonitor').style.display = value ? 'block' : 'none';
        }
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `ai-toast ${type}`;
            
            let icon = 'fa-info-circle';
            if(type === 'success') icon = 'fa-check-circle';
            if(type === 'error') icon = 'fa-exclamation-circle';
            if(type === 'warning') icon = 'fa-exclamation-triangle';

            toast.innerHTML = `
                <i class="fas ${icon}" style="font-size: 1.2rem;"></i>
                <div>
                    <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 2px;">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">${msg}</div>
                </div>
            `;

            container.appendChild(toast);

            if(typeof soundMgr !== 'undefined') {
                if(type === 'error') soundMgr.play('alert');
                else soundMgr.play('standard');
            }
            if(typeof vibMgr !== 'undefined') vibMgr.trigger('standard');

            // Auto remove
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        let clickCount = 0;
        function emergencyExit() {
            clickCount++;
            if(clickCount >= 5) {
                // Override local maintenance check
                sessionStorage.setItem('maintenance_bypass', 'true'); 
                document.getElementById('maintenanceOverlay').style.display = 'none';
                showToast('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô', 'warning');
                clickCount = 0;
            }
        }

        function reconnectMining() {
            const btn = document.querySelector('#miningConnectionStatus button');
            if(btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
                btn.disabled = true;
                
                setTimeout(() => {
                    manualRefresh(); // Use existing refresh function
                    
                    // Force check connection immediately
                    if(navigator.onLine) {
                        document.getElementById('miningConnectionStatus').style.display = 'none';
                        showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    } else {
                        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
                    }
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 800);
            }
        }

        // --- System Sync Loop ---
        function updateConnectionStatus() {
            // 1. Update Last Active (Heartbeat)
            if(currentUser) {
                localStorage.setItem(`last_active_${currentUser.username}`, Date.now());
            }

            // 2. Check Maintenance Mode
            const bypass = sessionStorage.getItem('maintenance_bypass');
            const maint = localStorage.getItem('mining_maintenance');
            const overlay = document.getElementById('maintenanceOverlay');
            
            if (maint === 'true' && bypass !== 'true') {
                const msg = localStorage.getItem('mining_maintenance_msg') || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏ö...';
                const msgEl = document.getElementById('maintMessage');
                if(msgEl) msgEl.innerHTML = msg.replace(/\n/g, '<br>');
                if(overlay) overlay.style.display = 'flex';
            } else {
                if(overlay) overlay.style.display = 'none';
            }

            // 3. Update Connection Status
            const statusEl = document.getElementById('miningStatus');
            const alertEl = document.getElementById('miningConnectionStatus');
            
            if(statusEl) {
                if(navigator.onLine) {
                    statusEl.innerHTML = '<i class="fas fa-wifi"></i> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏î)';
                    statusEl.style.color = '#00f2ff';
                    statusEl.style.textShadow = '0 0 10px #00f2ff';
                    if(alertEl) alertEl.style.display = 'none';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                    statusEl.style.color = '#ff7675';
                    statusEl.style.textShadow = 'none';
                    if(alertEl) alertEl.style.display = 'block';
                }
            }

            // 4. Check User Notifications (Real-time Admin Alerts)
            if(currentUser) {
                let notifs = JSON.parse(localStorage.getItem(`notifications_${currentUser.username}`)) || [];
                let unread = notifs.filter(n => !n.read);
                
                if(unread.length > 0) {
                    unread.forEach(n => {
                        showToast(n.msg, n.type);
                        n.read = true;
                        
                        // Add to local notification history if exists
                        addNotification(n.msg, n.type);
                    });
                    localStorage.setItem(`notifications_${currentUser.username}`, JSON.stringify(notifs));
                    
                    // Sound & Vib
                    if(typeof soundMgr !== 'undefined') soundMgr.play('alert');
                    if(typeof vibMgr !== 'undefined') vibMgr.trigger('alert');
                }
            }

            // 5. Update Announcement
            let _rawAnn = localStorage.getItem('mining_announcement');
            let annData = null;
            try { annData = _rawAnn ? JSON.parse(_rawAnn) : null; } catch (_) { annData = _rawAnn ? { msg: _rawAnn, date: new Date().toISOString() } : null; }
            const annEl = document.getElementById('dashboardAnnounce');
            if(annEl && annData) {
                // Only update if text is different to avoid flicker
                if(annEl.innerText !== annData.msg) {
                    annEl.innerText = annData.msg;
                    // Show badge if new
                    const annBadge = document.getElementById('annBadge');
                    if(annBadge) annBadge.style.display = 'block';
                    
                    // Marquee effect if too long
                    if(annData.msg.length > 40) {
                        annEl.innerHTML = `<marquee scrollamount="5">${annData.msg}</marquee>`;
                    }
                }
            }
        }

        // Start Loop (Fast 500ms)
        updateConnectionStatus();
        setInterval(updateConnectionStatus, 500);

        // Real-time Force Update Listener
        liveSync.on('force_update', (data) => {
            if(!currentUser || !data) return;
            
            if(data.username === currentUser.username) {
                console.log('‚ö° Force Update Received:', data);
                
                if(data.type === 'rig_paused' || data.type === 'rig_resumed' || data.type === 'rig_deleted') {
                    // Show Toast Immediately
                    if(data.msg) showToast(data.msg, data.type === 'rig_paused' || data.type === 'rig_deleted' ? 'warning' : 'success');
                    
                    // Special Warning Modal for Paused/Deleted
                    if(data.type === 'rig_paused') {
                         showSystemWarningModal('‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î', data.msg || '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏û‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
                    }

                    // Play sound
                    if(typeof soundMgr !== 'undefined') {
                        soundMgr.play(data.type === 'rig_resumed' ? 'success' : 'alert');
                    }

                    // Refresh Data
                    loadUserData();
                    
                    // Refresh UI if on mining page
                    if(currentAction === 'mining') {
                         // Force re-render of rig list
                         updateUI();
                    }
                }
            }
        });

        function showSystemWarningModal(title, msg) {
            // Store for recall
            lastWarningData = { title, msg };
            
            // Show floating badge
            const badge = document.getElementById('warningFloatBadge');
            if(badge) {
                badge.style.display = 'block';
                badge.classList.add('shake');
                setTimeout(() => badge.classList.remove('shake'), 500);
            }

            const modalId = 'sysWarningModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10002'; // Higher than others
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="background: rgba(20, 10, 10, 0.98); border: 1px solid var(--danger); text-align:center; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 0 30px rgba(255, 0, 0, 0.3); position: relative; overflow: hidden; animation: slideUp 0.3s ease-out;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 0, 0, 0.05) 10px, rgba(255, 0, 0, 0.05) 20px); pointer-events: none;"></div>
                    
                    <div style="width: 80px; height: 80px; background: rgba(255, 0, 0, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid var(--danger); box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger); animation: pulse 1s infinite;"></i>
                    </div>
                    <h2 style="color: var(--danger); margin:0 0 10px; text-shadow: 0 0 10px rgba(255, 0, 0, 0.3);">${title}</h2>
                    <p style="color: #e2e8f0; margin-bottom: 25px; line-height: 1.5;">${msg}</p>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="cyber-btn" style="flex: 1; --btn-bg: #334155; border: none; color: white;" onclick="document.getElementById('${modalId}').remove()">
                            ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                        </button>
                        <button class="cyber-btn" style="flex: 1; --btn-bg: var(--danger); border: none; color: white;" onclick="hideWarningBadge(); document.getElementById('${modalId}').remove()">
                            ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö (‡∏•‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            
            if(typeof vibMgr !== 'undefined') vibMgr.trigger('alert');
        }

        function showRemoteGuide() {
            const modalId = 'remoteGuideModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10005';
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="max-width: 350px; background: rgba(10, 14, 30, 0.95); border: 1px solid var(--primary); text-align:center; border-radius: 16px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); animation: slideUp 0.3s ease-out;">
                    <div style="width: 70px; height: 70px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);">
                        <i class="fas fa-mobile-alt" style="font-size: 2rem; color: var(--primary);"></i>
                    </div>
                    <h2 style="color: var(--primary); margin: 0 0 15px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.3);">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏Å‡∏•</h2>
                    
                    <div style="text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="color: white; margin: 0 0 5px;"><i class="fas fa-download" style="color: var(--success);"></i> 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</h4>
                        <p style="color: #94a3b8; font-size: 0.85rem; margin: 0 0 10px; padding-left: 20px;">‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏Å‡∏• ‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ <strong>Chrome Remote Desktop</strong> ‡∏à‡∏≤‡∏Å Google Play Store ‡∏´‡∏£‡∏∑‡∏≠ App Store</p>
                        
                        <h4 style="color: white; margin: 0 0 5px;"><i class="fas fa-desktop" style="color: var(--warning);"></i> 2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h4>
                        <p style="color: #94a3b8; font-size: 0.85rem; margin: 0; padding-left: 20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Google ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà</p>
                    </div>
                    
                    <button class="cyber-btn" style="width: 100%;" onclick="document.getElementById('${modalId}').remove()">
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
                    </button>
                </div>
            `;
            document.body.appendChild(div);
        }
    </script>
    <div id="toastContainer"></div>
</body>
</html>
