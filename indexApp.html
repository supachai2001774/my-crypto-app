<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Miner Tycoo123</title>
    <script src="sync-manager.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3067/3067789.png">
    <meta name="theme-color" content="#4e54c8">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=1.2">
    <style>
        /* AI Toast System */
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 11000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .ai-toast { pointer-events: auto; background: rgba(10, 14, 30, 0.95); backdrop-filter: blur(10px); border-left: 4px solid #00f2ff; border-radius: 4px; padding: 15px 20px; color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 15px; min-width: 300px; transform: translateX(100%); animation: slideIn 0.3s ease-out forwards; overflow: hidden; position: relative; }
        .ai-toast::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #00f2ff, transparent); animation: scan 2s linear infinite; }
        .ai-toast.success { border-color: #00b894; }
        .ai-toast.error { border-color: #ff7675; }
        .ai-toast.warning { border-color: #fdcb6e; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { transform: translateX(100%); opacity: 0; } }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* AI Maintenance Overlay */
        .maint-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 8, 20, 0.98); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #00f2ff; font-family: 'Kanit', sans-serif; backdrop-filter: blur(15px); overflow: hidden; }
        .maint-content { text-align: center; position: relative; z-index: 2; padding: 40px; border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 20px; background: rgba(0,0,0,0.6); box-shadow: 0 0 30px rgba(0, 242, 255, 0.1); max-width: 90%; width: 400px; }
        .maint-icon { font-size: 4rem; margin-bottom: 20px; animation: pulse 2s infinite; text-shadow: 0 0 20px rgba(0, 242, 255, 0.5); }
        .maint-title { font-size: 2rem; font-weight: bold; margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase; background: linear-gradient(90deg, #fff, #00f2ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .maint-desc { color: #aaa; font-size: 1rem; line-height: 1.6; }
        .maint-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px); background-size: 30px 30px; pointer-events: none; z-index: 1; }
        .maint-scanline { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: rgba(0, 242, 255, 0.3); opacity: 0.5; animation: scanline 3s linear infinite; pointer-events: none; z-index: 1; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes scanline { 0% { top: -10%; } 100% { top: 110%; } }
    </style>
</head>
<body>

    <div id="maintenanceOverlay" class="maint-overlay" style="display: none;">
        <div class="maint-grid"></div>
        <div class="maint-scanline"></div>
        <div class="maint-content">
            <i class="fas fa-microchip maint-icon" onclick="emergencyExit()"></i>
            <div class="maint-title">SYSTEM OFFLINE</div>
            <div style="color: #00f2ff; font-size: 1.2rem; margin-bottom: 10px; font-weight: bold;">‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</div>
            <p id="maintMessage" class="maint-desc">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
            <div style="margin-top: 20px; font-size: 0.8rem; color: rgba(0, 242, 255, 0.5);">AI SECURITY PROTOCOL: ACTIVE</div>
        </div>
    </div>

    <div class="app-container">
        
        <div class="top-header">
            <div class="profile-pill" onclick="openNotificationHistory()">
                <div class="avatar-small" id="headerAvatar"><i class="fas fa-user"></i></div>
                <div>
                    <div id="headerName" class="header-name">Guest</div>
                    <div id="headerID" class="header-id">ID: ---</div>
                </div>
                <div style="margin-left: 5px; position: relative;">
                    <i class="fas fa-bell" style="color: #aaa; font-size: 0.9rem;"></i>
                    <div id="headerNotifBadge" class="neon-badge" style="position: absolute; top: -8px; right: -8px; display: none;">0</div>
                </div>
            </div>
            <div style="font-size: 1.2rem;" onclick="logout()"><i class="fas fa-sign-out-alt"></i></div>
        </div>

        <div class="page active" id="dashboardPage">
            <!-- AI Dashboard Card (Consolidated Stats) -->
            <div class="ai-dashboard-card">
                <div class="ai-core-visual">
                    <div class="ai-core-inner"></div>
                    <i class="fas fa-microchip" style="font-size: 2rem; color: var(--primary); position: absolute; z-index: 2; filter: drop-shadow(0 0 10px var(--primary));"></i>
                </div>
                <h2 style="margin: 0 0 5px; color: #fff; font-size: 1.5rem; letter-spacing: 1px;">AI Mining Core</h2>
                <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 15px;">
                    <div style="font-size: 0.8rem; color: #94a3b8;">STATUS: <span id="miningStatus" style="color: var(--success); text-shadow: 0 0 10px var(--success);">ONLINE</span></div>
                    <div style="font-size: 0.8rem; color: #94a3b8;">‡πÇ‡∏´‡∏°‡∏î: <span id="miningMode" style="color: #94a3b8;">‡∏û‡∏±‡∏Å</span></div>
                    <div style="display:flex; gap:8px;">
                        <button class="cyber-btn" onclick="startMining()" style="padding:4px 10px; font-size:0.75rem;">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
                        <button class="cyber-btn" onclick="stopMining()" style="padding:4px 10px; font-size:0.75rem; background: transparent; border-color: var(--danger); color: var(--danger); box-shadow:none;">‡∏´‡∏¢‡∏∏‡∏î</button>
                    </div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-item">
                        <div class="label">Hashrate</div>
                        <div class="value" id="hashrateDisplay">0.0</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">MH/s</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Balance</div>
                        <div class="value" id="balanceDisplay">‡∏ø0.00</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">THB</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Income</div>
                        <div class="value" id="incomeDisplay">+‡∏ø0.00</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">/sec</div>
                    </div>
                </div>
            </div>

            <!-- AI Announcement Board -->
            <div class="ai-announce-card" onclick="openAnnounceModal()" style="cursor: pointer; margin: 20px 0; position: relative; overflow: hidden; border-radius: 16px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(0, 242, 255, 0.2); box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);">
                <!-- Scanline effect -->
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none;"></div>
                
                <div style="padding: 15px; display: flex; gap: 15px; align-items: center; position: relative; z-index: 2;">
                    <!-- Animated Icon -->
                    <div style="width: 50px; height: 50px; border-radius: 12px; background: rgba(0, 242, 255, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(0, 242, 255, 0.3); position: relative;">
                        <i class="fas fa-rss" style="color: #00f2ff; font-size: 1.5rem; animation: pulse 2s infinite;"></i>
                        <div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #00f2ff; border-radius: 50%; box-shadow: 0 0 10px #00f2ff; animation: blink 1s infinite;"></div>
                    </div>
                    
                    <!-- Content -->
                    <div style="flex: 1; overflow: hidden;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <span style="color: #00f2ff; font-size: 0.7rem; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 0 5px rgba(0, 242, 255, 0.5);">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏∞‡∏ö‡∏ö</span>
                        <span id="annBadge" style="display:none; background: rgba(245, 158, 11, 0.2); border: 1px solid #f59e0b; color: #f59e0b; padding: 1px 5px; border-radius: 4px; font-size: 0.6rem;">NEW</span>
                            <span id="annLabel" style="font-size: 0.7rem; color: #aaa; margin-left: auto;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                        </div>
                        <div id="dashboardAnnounce" style="color: #fff; font-family: 'Courier New', monospace; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 0 2px rgba(255, 255, 255, 0.5);">
                            ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                    <div class="menu-item" onclick="openShopPage()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem;"><i class="fas fa-shopping-cart"></i></div>
                    <div class="menu-label">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div id="shopBadgeFloat" class="badge-float" style="display: none;">‡πÉ‡∏´‡∏°‡πà</div>
                </div>
                <div class="menu-item" onclick="openWalletModal('deposit')">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--success); box-shadow: 0 0 10px rgba(0, 255, 157, 0.2);"><i class="fas fa-arrow-circle-down" style="color: var(--success);"></i></div>
                    <div class="menu-label">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</div>
                    <div id="depositBadge" class="badge-float" style="background: var(--success); display: none;">SUCCESS</div>
                </div>
                <div class="menu-item" onclick="openWalletModal('withdraw')">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--warning); box-shadow: 0 0 10px rgba(255, 184, 0, 0.2);"><i class="fas fa-arrow-circle-up" style="color: var(--warning);"></i></div>
                    <div class="menu-label">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                    <div id="withdrawBadge" class="badge-float" style="background: var(--warning); display: none;">UPDATE</div>
                </div>
                <div class="menu-item" onclick="showBankModal()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem;"><i class="fas fa-university"></i></div>
                    <div class="menu-label">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                </div>
                <div class="menu-item" onclick="showReferralModal()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--danger); box-shadow: 0 0 10px rgba(255, 0, 85, 0.2);"><i class="fas fa-users" style="color: var(--danger);"></i></div>
                    <div class="menu-label">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</div>
                    <div class="badge-float" style="background: var(--danger); animation: none; top: -5px; right: -5px;">HOT</div>
                </div>
                <div class="menu-item" onclick="switchPage('settingsPage', document.getElementById('navSettings'))">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: #a0aec0;"><i class="fas fa-cog" style="color: #a0aec0;"></i></div>
                    <div class="menu-label">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
                </div>
            </div>
        </div>

        <div class="page" id="shopPage">
            <h2 style="margin-left: 10px; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 10px; letter-spacing: 1px;">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
            <div id="shopList" class="shop-grid-new"></div>
        </div>

        <div class="page" id="walletPage">
            <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
            <div id="transList" style="margin-top: 10px;"></div>
        </div>

        <div class="page" id="settingsPage">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 100px; height: 100px; margin: 0 auto; position: relative;">
                    <div class="avatar-small" style="width: 100%; height: 100%; border: 4px solid rgba(255,255,255,0.1);" id="settingAvatar">
                        <i class="fas fa-user" style="font-size: 3rem;"></i>
                    </div>
                    <div onclick="document.getElementById('uploadProfile').click()" style="position: absolute; bottom: 0; right: 0; background: var(--accent); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <i class="fas fa-camera" style="font-size: 0.8rem; color: #000;"></i>
                    </div>
                </div>
                <input type="file" id="uploadProfile" hidden accept="image/*" onchange="changeProfilePic()">
                <h2 id="settingName" style="margin: 10px 0 5px;">Username</h2>
                <div id="settingID" style="color: #aaa;">ID: ---</div>
                <div style="margin-top: 5px; color: #00b894; font-size: 0.8rem;"><i class="fas fa-circle" style="font-size: 6px;"></i> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
            </div>

            <div class="menu-list-item" onclick="showBankModal()">
                <i class="fas fa-university" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <div id="installAppBtn" class="menu-list-item" style="display: none; background: linear-gradient(90deg, rgba(112, 0, 255, 0.2), rgba(0, 242, 255, 0.2)); border: 1px solid var(--primary);" onclick="installPWA()">
                <i class="fas fa-download" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <!-- Referral Card -->
            <div class="menu-list-item" style="background: linear-gradient(135deg, rgba(255, 0, 85, 0.1), rgba(0, 0, 0, 0)); border: 1px solid var(--danger);" onclick="showReferralModal()">
                <div style="display: flex; align-items: center; width: 100%;">
                    <div style="background: rgba(255, 0, 85, 0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 0 10px var(--danger);">
                        <i class="fas fa-user-plus" style="color: var(--danger); margin: 0;"></i>
                    </div>
                    <div style="flex: 1; color: var(--danger);">
                        <div style="font-weight: bold;">‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">‡∏Ñ‡∏∏‡∏ì‡∏£‡∏±‡∏ö ‡∏ø50 + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‡∏ø100</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: var(--danger);"></i>
                </div>
            </div>

            <div style="margin-top: 20px; margin-bottom: 10px; color: #94a3b8; font-size: 0.8rem; padding-left: 5px;">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (System Settings)</div>

            <!-- Sound -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-volume-up" style="width:20px;"></i> ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                    <div class="switch-sub">Notification Sounds</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swSound" onchange="saveSystemSetting('sound_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <select id="selSound" class="input-dark" style="margin-bottom: 15px;" onchange="saveSystemSetting('sound_type', this.value); soundMgr.play(this.value);">
                <option value="standard">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Standard)</option>
                <option value="alert">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Alert)</option>
                <option value="emphasis">‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Emphasis)</option>
                <option value="rapid">‡∏£‡∏±‡∏ß (Rapid)</option>
                <option value="fast">‡πÄ‡∏£‡πá‡∏ß (Fast)</option>
            </select>

            <!-- Vibration -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-mobile-alt" style="width:20px;"></i> ‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô</div>
                    <div class="switch-sub">Haptic Feedback</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swVib" onchange="saveSystemSetting('vib_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <select id="selVib" class="input-dark" style="margin-bottom: 15px;" onchange="saveSystemSetting('vib_type', this.value); vibMgr.trigger(this.value);">
                <option value="standard">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Standard)</option>
                <option value="fast">‡πÄ‡∏£‡πá‡∏ß (Fast)</option>
                <option value="emphasis">‡πÄ‡∏ô‡πâ‡∏ô (Emphasis)</option>
                <option value="alert">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Alert)</option>
            </select>

            <!-- Wake Lock -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-sun" style="width:20px;"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div>
                    <div class="switch-sub">Always On Display</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swWake" onchange="saveSystemSetting('wake_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

    </div>

    <div class="bottom-nav-glass">
        <div class="nav-btn active" id="navHome" onclick="switchPage('dashboardPage', this)">
            <i class="fas fa-home"></i>
            <div class="nav-label">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</div>
        </div>
        <div class="nav-btn" id="navShop" onclick="openShopPage()">
            <div style="position: relative;">
                <i class="fas fa-shopping-cart"></i>
                <div id="shopBadgeNav" class="nav-badge" style="display: none;"></div>
            </div>
            <div class="nav-label">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        </div>
        <div class="nav-btn" id="navWallet" onclick="openWalletPage()">
            <div style="position: relative;">
                <i class="fas fa-wallet"></i>
                <div id="navWalletBadge" class="nav-badge" style="display: none;"></div>
            </div>
            <div class="nav-label">‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</div>
        </div>
        <div class="nav-btn" id="navSettings" onclick="switchPage('settingsPage', this)">
            <i class="fas fa-cog"></i>
            <div class="nav-label">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        </div>
    </div>

    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid rgba(0, 242, 255, 0.3); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);">
                    <i class="fas fa-user-astronaut" style="font-size: 2.5rem; color: #00f2ff;"></i>
                </div>
                <h2 style="color: #00f2ff; margin: 0; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">MINING PRO</h2>
                <div style="font-size: 0.8rem; color: #94a3b8; letter-spacing: 1px;">SECURE ACCESS PORTAL</div>
            </div>
            
            <div class="input-group" style="margin-bottom: 15px;">
                <div style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px; margin-left: 5px;">USERNAME</div>
                <input type="text" id="loginUser" class="cyber-input" placeholder="Enter your ID">
            </div>
            <div class="input-group" style="margin-bottom: 25px;">
                <div style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px; margin-left: 5px;">PASSWORD</div>
                <input type="password" id="loginPass" class="cyber-input" placeholder="Enter password">
            </div>
            
            <button class="cyber-btn" onclick="login()" style="width: 100%; margin-bottom: 15px;">
                <i class="fas fa-sign-in-alt"></i> ACCESS SYSTEM
            </button>
            
            <div style="text-align: center; font-size: 0.9rem; color: #94a3b8;">
                No account? <span style="color: #00f2ff; cursor: pointer; text-decoration: underline; text-underline-offset: 3px;" onclick="toSignup()">Register Now</span>
            </div>
        </div>
    </div>

    <div id="signupModal" class="modal">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #00f2ff; margin: 0; letter-spacing: 1px;">NEW USER REGISTRATION</h2>
                <div style="font-size: 0.8rem; color: #94a3b8;">Create your mining identity</div>
            </div>
            
            <input type="text" id="regUser" class="cyber-input" placeholder="Username" style="margin-bottom: 10px;">
            <input type="password" id="regPass" class="cyber-input" placeholder="Password" style="margin-bottom: 10px;">
            
            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;"></div>
            
            <input type="text" id="regName" class="cyber-input" placeholder="Full Name (Real Name)" style="margin-bottom: 10px;">
            <select id="regBank" class="cyber-input" style="margin-bottom: 10px;">
                <option value="kbank">KBANK - Kasikorn</option>
                <option value="scb">SCB - Siam Commercial</option>
                <option value="ktb">KTB - Krungthai</option>
                <option value="bbl">BBL - Bangkok Bank</option>
                <option value="gsb">GSB - Government Savings</option>
            </select>
            <input type="tel" id="regAcc" class="cyber-input" placeholder="Bank Account Number" style="margin-bottom: 20px;">
            
            <button class="cyber-btn" onclick="signup()" style="width: 100%; margin-bottom: 15px;">
                <i class="fas fa-user-plus"></i> CONFIRM REGISTRATION
            </button>
            
            <div style="text-align: center; font-size: 0.8rem; cursor: pointer; color: #94a3b8;" onclick="toLogin()">
                <i class="fas fa-arrow-left"></i> Back to Login
            </div>
        </div>
    </div>

    <div id="walletModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position: absolute; right: 15px; top: 15px; cursor: pointer;" onclick="document.getElementById('walletModal').style.display='none'"></i>
            <h3 id="walletTitle">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <input type="number" id="walletAmount" class="input-dark" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
            <button class="btn-action" onclick="submitTransaction()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
    </div>

    <div id="bankModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position: absolute; right: 15px; top: 15px; cursor: pointer;" onclick="document.getElementById('bankModal').style.display='none'"></i>
            <h3>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
            <div id="myBankInfo"></div>
        </div>
    </div>

    <div id="refModal" class="modal">
        <div class="modal-content" style="padding: 0; overflow: hidden; background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; width: 90%; max-width: 400px; border-radius: 16px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.1);">
            <div style="padding: 20px; max-height: 85vh; overflow-y: auto;">
                <i class="fas fa-times" style="position: absolute; right: 15px; top: 15px; cursor: pointer; z-index: 10; color: #94a3b8; background: rgba(255,255,255,0.05); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onclick="document.getElementById('refModal').style.display='none'"></i>
                
                <!-- Header Banner -->
                <div class="ref-banner" style="background: linear-gradient(135deg, rgba(0, 242, 255, 0.1) 0%, rgba(0, 242, 255, 0.05) 100%); border: 1px solid rgba(0, 242, 255, 0.2); border-radius: 15px; padding: 20px; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0, 242, 255, 0.1); margin-bottom: 20px;">
                    <div style="position: relative; z-index: 2;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: #00f2ff; font-weight: 800; letter-spacing: 1px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">NETWORK NODE</h2>
                        <p style="margin: 5px 0 10px; font-size: 0.8rem; color: #94a3b8;">Expand your mining network</p>
                        <div style="display: inline-block; background: rgba(0, 242, 255, 0.1); padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; color: #00f2ff; border: 1px solid rgba(0, 242, 255, 0.3);">
                            <i class="fas fa-users"></i> REFERRAL PROGRAM
                        </div>
                    </div>
                    <i class="fas fa-network-wired" style="position: absolute; right: -15px; bottom: -20px; font-size: 6rem; color: rgba(0, 242, 255, 0.05); transform: rotate(-20deg);"></i>
                </div>

                <!-- Stats Row -->
                <div class="ref-stats-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="ref-stat-box" style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="color: var(--warning); font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase;">Pending</div>
                        <div class="ref-stat-num" id="refPendingCount" style="color: var(--warning); font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">0</div>
                        <div style="font-size: 0.6rem; color: #64748b;">NODES</div>
                    </div>
                    <div class="ref-stat-box" style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="color: var(--success); font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase;">Active</div>
                        <div class="ref-stat-num" id="refCompletedCount" style="color: var(--success); font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);">0</div>
                        <div style="font-size: 0.6rem; color: #64748b;">NODES</div>
                    </div>
                </div>

                <!-- Referral Code Box -->
                <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px; text-align: center; text-transform: uppercase;">Your Access Code</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0, 242, 255, 0.05); padding: 12px 15px; border-radius: 8px; border: 1px dashed rgba(0, 242, 255, 0.3); position: relative;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #00f2ff; letter-spacing: 3px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.3); font-family: monospace;" id="myRefCode">---</div>
                        <i class="fas fa-copy" style="cursor: pointer; color: #00f2ff; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: rgba(0, 242, 255, 0.1); border: 1px solid rgba(0, 242, 255, 0.3); transition: 0.3s;" onclick="copyRef()" onmouseover="this.style.background='rgba(0,242,255,0.2)'" onmouseout="this.style.background='rgba(0,242,255,0.1)'"></i>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.7rem; color: #64748b;">
                        Tap icon to copy invitation link
                    </div>
                </div>

                <!-- Friend List -->
                <div style="text-align: left; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; color: #fff; padding-left: 5px; border-left: 3px solid #00f2ff; padding-left: 10px;">CONNECTED NODES</div>
                <div id="refList" style="min-height: 100px; margin-bottom: 60px;">
                    <!-- Content -->
                </div>
            </div>
            
            <!-- Bottom Floating Button -->
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; background: linear-gradient(to top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8)); border-top: 1px solid rgba(255,255,255,0.05);">
                <button class="cyber-btn" onclick="claimBonus()" id="btnClaimBonus" style="width: 100%;">
                    <i class="fas fa-gift"></i> CLAIM REWARD (0.00)
                </button>
            </div>
        </div>
    </div>

    <div id="announceModal" class="modal">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); max-width: 400px; width: 90%; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #00f2ff; box-shadow: 0 0 10px #00f2ff;"></div>
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 90%, rgba(0, 242, 255, 0.05) 100%); pointer-events: none;"></div>
            
            <div style="text-align: center; margin-bottom: 20px; position: relative; z-index: 2;">
                <div style="width: 70px; height: 70px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid rgba(0, 242, 255, 0.3);">
                    <i class="fas fa-bullhorn" style="font-size: 2.5rem; color: #00f2ff; animation: swing 3s infinite ease-in-out;"></i>
                </div>
                <h2 style="color: white; margin: 0; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">System Broadcast</h2>
                <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
            </div>
            
            <div class="glass-panel" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">
                <div id="announceBody" style="color: #e2e8f0; font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap;"></div>
            </div>
            
            <button class="cyber-btn" style="width: 100%;" onclick="closeAnnounce()">
                <i class="fas fa-check"></i> ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö
            </button>
        </div>
    </div>

    <script>
        function checkUserBanStatus() {
    if(! currentUser) return;
    
    const isBanned = syncManager.isUserBanned(currentUser.username);
    if(isBanned) {
        showToast('‚ùå ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß', 'error');
        alert('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'); 
        logout();
    }
}
        // --- PWA Logic ---
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installAppBtn');
            if(btn) btn.style.display = 'flex';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    document.getElementById('installAppBtn').style.display = 'none';
                });
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.log('SW failed:', err));
            });
        }

        // Core Logic
        let currentUser = null;
        let balance = 0.00;
        let hashrate = 0.00;
        let currentAction = '';
        let isMining = true;

        window.onload = function() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Referral Code
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if(refCode) {
                localStorage.setItem('pending_ref', refCode);
            }

            const saved = localStorage.getItem('current_user');
            let isValidUser = false;

            if(saved) {
                try {
                    const u = JSON.parse(saved);
                    const allUsers = JSON.parse(localStorage.getItem('mining_users')) || {};
                    if(allUsers[u.username] && allUsers[u.username]. banned) {
                        alert('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß');
                        localStorage.removeItem('current_user');
                        window.location.reload();
                    } else {
                        currentUser = u;
                        document.getElementById('loginModal').style.display = 'none';
                        initApp();
                        isValidUser = true;
                        
                        console.log('üë§ Logged in as:', currentUser.username);
                        console.log('üìä Initial Data:', { balance, hashrate });
                    }
                } catch (e) {
                    console.error('User data corrupted', e);
                    localStorage.removeItem('current_user');
                }
            }
            
            if(!isValidUser) {
                document.getElementById('loginModal'). style.display = 'flex';
            }
        };

                function initApp() {
            // Default Announcement
            if(! localStorage.getItem('mining_announcement')) {
                const defaultAnn = { msg: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Crypto Miner Tycoon! ', date: new Date().toISOString() };
                localStorage. setItem('mining_announcement', JSON.stringify(defaultAnn));
            }

            loadUserData();
            loadSystemSettings();
            const paused = localStorage.getItem('mining_paused') === 'true';
            isMining = !paused;
            updateMiningMode();
            checkExpiration();
            loadShop();
            
            setInterval(miningLoop, 1000);
            setInterval(syncAdmin, 2000);
            renderProfile();
            checkAnnounce();

            // ============ üî¥ SYNC LISTENERS ============
            
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            syncManager.on('user_deleted', (data) => {
                if(currentUser && currentUser.username === data.username) {
                    showToast('‚ùå ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', 'error');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
            syncManager.on('transaction_approved', (data) => {
                if(currentUser && currentUser.username === data.user) {
                    console.log('Transaction approved:', data);
                    
                    const msg = data.status === 'approved' 
                        ? `‚úÖ ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß! ‡∏ø${data.amount.toLocaleString()}`
                        : `‚ùå ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`;
                    
                    showToast(msg, data.status === 'approved' ?  'success' : 'error');
                    
                    if(data.status === 'approved') {
                        // Reload user data
                        loadUserData();
                        updateUI();
                        renderUserTrans();
                        addNotification(msg, data.status === 'approved' ?  'success' : 'error');
                    }
                    
                    if(typeof soundMgr !== 'undefined') {
                        soundMgr.play('emphasis');
                    }
                    if(typeof vibMgr !== 'undefined') {
                        vibMgr.trigger('emphasis');
                    }
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤
            syncManager.on('maintenance_mode_changed', (data) => {
                const overlay = document.getElementById('maintenanceOverlay');
                const msg = data.enabled 
                    ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß.. .'
                    : '‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                
                showToast(msg, data.enabled ? 'warning' : 'success');
                
                if(data.enabled) {
                    overlay. style.display = 'flex';
                } else {
                    overlay.style.display = 'none';
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤
            syncManager.on('maintenance_msg_changed', (msg) => {
                const msgEl = document.getElementById('maintMessage');
                if(msgEl) {
                    msgEl.innerText = msg;
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
            syncManager.on('announcement_posted', (data) => {
                if(data && data.msg) {
                    showToast('üì¢ ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'info');
                    checkAnnounce();
                    
                    // Show new badge
                    const badge = document.getElementById('annBadge');
                    if(badge) badge.style.display = 'block';
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
            syncManager.on('announcement_cleared', () => {
                const annEl = document.getElementById('dashboardAnnounce');
                if(annEl) {
                    annEl.innerText = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ';
                }
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            syncManager. on('shop_updated', () => {
                console.log('Shop updated from admin');
                loadShop();
                checkShopUpdate();
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            syncManager.on('shop_items_updated', (items) => {
                console.log('Shop items updated:', items);
                loadShop();
            });

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
            syncManager.on('password_reset', (data) => {
                if(currentUser && currentUser.username === data.username) {
                    showToast('‚ö†Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'warning');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
            });

            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            syncManager.cleanOldData();

            console.log('‚úÖ App Sync Listeners Registered');
            console.log('Sync Manager Debug:', syncManager.debugInfo());
        }

        function syncAdmin() {
    if(!currentUser) return;
    
    // 1. Check Ban Status
    checkUserBanStatus();

    // 2. Heartbeat
    localStorage.setItem(`last_active_${currentUser.username}`, Date.now());
    
    // 3.  Check Announcement
    checkAnnounce();
    
    // 4.  Check Shop Update
    checkShopUpdate();

    // 5. Check Maintenance
    const maint = localStorage.getItem('mining_maintenance') === 'true';
    const maintMsg = localStorage.getItem('mining_maintenance_msg') || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå... ';
    const overlay = document.getElementById('maintenanceOverlay');
    const bypass = sessionStorage.getItem('maintenance_bypass');
    
    if(maint && bypass !== 'true') {
        overlay.style.display = 'flex';
        document.getElementById('maintMessage').innerText = maintMsg;
    } else {
        overlay.style.display = 'none';
    }

    // 6.  Sync Transactions (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
    let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
    let updated = false;
    trans. forEach(t => {
        if(t.user === currentUser.username && ! t.processed) {
            if(t.status === 'approved' && t.type === 'deposit') { 
                balance += t.amount; 
                updated = true; 
                t.processed = true;
                localStorage.setItem('wallet_badge_deposit', 'true');
                addNotification(`‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à +‡∏ø${t.amount.toLocaleString()}`, 'success');
            }
            else if(t.status === 'rejected' && t.type === 'withdraw') { 
                balance += t.amount; 
                updated = true; 
                t. processed = true;
                localStorage. setItem('wallet_badge_withdraw', 'true');
                addNotification(`‚ùå ‡∏ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, 'error');
            }
            else if(t.status === 'approved' && t.type === 'withdraw') { 
                t.processed = true; 
                updated = true;
                localStorage.setItem('wallet_badge_withdraw', 'true');
                addNotification(`‚úÖ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ø${t.amount.toLocaleString()}`, 'success');
            } 
        }
    });
    if(updated) {
        localStorage.setItem('mining_transactions', JSON.stringify(trans));
        saveData(); 
        updateUI();
        renderUserTrans();
    }
    checkWalletBadges();

    // 7. Verify Data Integrity
    const verification = syncManager.verifyUserData(currentUser.username);
    if(! verification.isValid) {
        console.warn('User data invalid, logging out');
        logout();
    }
}

        function checkWalletBadges() {
            // Deposit Badge
            const dBadge = document.getElementById('depositBadge');
            if(localStorage.getItem('wallet_badge_deposit') === 'true') {
                if(dBadge) dBadge.style.display = 'block';
                document.getElementById('navWalletBadge').style.display = 'block';
            } else {
                if(dBadge) dBadge.style.display = 'none';
            }

            // Withdraw Badge
            const wBadge = document.getElementById('withdrawBadge');
            if(localStorage.getItem('wallet_badge_withdraw') === 'true') {
                if(wBadge) wBadge.style.display = 'block';
                document.getElementById('navWalletBadge').style.display = 'block';
            } else {
                if(wBadge) wBadge.style.display = 'none';
            }

            // If no sub-badges, hide nav badge
            if(localStorage.getItem('wallet_badge_deposit') !== 'true' && localStorage.getItem('wallet_badge_withdraw') !== 'true') {
                document.getElementById('navWalletBadge').style.display = 'none';
            }
        }

        function openWalletModal(type) {
            currentAction = type || 'deposit'; // Default to deposit if not specified
            
            // Clear badges
            if(type === 'deposit') localStorage.removeItem('wallet_badge_deposit');
            if(type === 'withdraw') localStorage.removeItem('wallet_badge_withdraw');
            checkWalletBadges();

            const modal = document.getElementById('walletModal');
            const content = modal.querySelector('.modal-content');
            
            // Base structure with Tabs
            content.innerHTML = `
                <div style="position: absolute; right: 15px; top: 15px; cursor: pointer; color: var(--text-muted); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.05);" onclick="document.getElementById('walletModal').style.display='none'">
                    <i class="fas fa-times"></i>
                </div>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 1px;">Wallet</h2>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 25px; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <button onclick="switchWalletTab('deposit')" id="tabDeposit" class="cyber-btn" style="flex:1; border-radius: 8px; font-size: 0.9rem;">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <button onclick="switchWalletTab('withdraw')" id="tabWithdraw" class="cyber-btn" style="flex:1; border-radius: 8px; font-size: 0.9rem;">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>

                <div id="walletBody"></div>
            `;
            
            modal.style.display='flex';
            switchWalletTab(currentAction);
        }

        function switchWalletTab(type) {
            currentAction = type;
            const body = document.getElementById('walletBody');
            const tabDep = document.getElementById('tabDeposit');
            const tabWit = document.getElementById('tabWithdraw');
            
            // Update Tabs Style
            if(type === 'deposit') {
                tabDep.classList.add('primary');
                tabDep.style.background = 'var(--primary)';
                tabDep.style.color = '#000';
                tabDep.style.boxShadow = '0 0 15px var(--primary-dim)';
                
                tabWit.classList.remove('primary');
                tabWit.style.background = 'transparent';
                tabWit.style.color = 'var(--text-muted)';
                tabWit.style.boxShadow = 'none';
            } else {
                tabWit.classList.add('primary');
                tabWit.style.background = 'var(--warning)';
                tabWit.style.color = '#000';
                tabWit.style.boxShadow = '0 0 15px rgba(255, 204, 0, 0.3)';
                
                tabDep.classList.remove('primary');
                tabDep.style.background = 'transparent';
                tabDep.style.color = 'var(--text-muted)';
                tabDep.style.boxShadow = 'none';
            }

            let users = JSON.parse(localStorage.getItem('mining_users')) || {};
            let u = users[currentUser.username] || {bank: 'N/A', acc: 'N/A', name: 'Guest'};

            if(type === 'deposit') {
                body.innerHTML = `
                    <div class="glass-panel" style="margin-bottom: 20px; text-align: center; padding: 25px;">
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px;">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å (THB)</div>
                        <div style="position: relative; max-width: 200px; margin: 0 auto;">
                            <input type="number" id="walletAmount" class="cyber-input" placeholder="0.00" 
                                   style="font-size: 1.8rem; text-align: center; height: 60px; color: var(--success); font-weight: bold; padding: 0;" 
                                   oninput="updateDepositUI(this.value)">
                        </div>
                        <div style="font-size: 0.75rem; color: var(--warning); margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 40 ‡∏ö‡∏≤‡∏ó
                        </div>
                    </div>

                    <!-- Auto QR Section -->
                    <div id="qrSection" style="display:none; margin-bottom: 20px; animation: slideUp 0.3s ease-out;">
                         <div class="glass-panel" style="border: 1px solid var(--primary); box-shadow: 0 0 15px var(--primary-dim);">
                            <div style="text-align: center; padding: 10px;">
                                <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:15px;">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c5/PromptPay-logo.png" style="height:24px; background:white; padding:4px 8px; border-radius:4px;">
                                    <span style="color:white; font-weight:bold; font-size:1rem;">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
                                </div>
                                <div style="background: white; padding: 10px; display: inline-block; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                                    <img id="qrImage" src="" style="width: 140px; height: 140px; display: block;">
                                </div>
                                <div style="color: var(--text-muted); font-size: 0.8rem;">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary); text-shadow: 0 0 10px var(--primary-dim);"><span id="qrAmount">0.00</span> THB</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ö‡∏à‡∏Å. ‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï ‡πÑ‡∏°‡∏ô‡πå‡πÄ‡∏ô‡∏≠‡∏£‡πå</div>
                            </div>
                         </div>
                    </div>

                    <div style="margin-bottom: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <i class="fas fa-sync fa-spin" style="font-size: 0.7rem;"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    </div>

                    <button id="btnDeposit" class="cyber-btn" onclick="submitDeposit()" style="width: 100%; --btn-bg: var(--success);">
                        <i class="fas fa-qrcode"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                `;
            } else {
                // Withdrawal Tab
                let users = JSON.parse(localStorage.getItem('mining_users'));
                let u = users[currentUser.username];
                let bankHtml = '';
                
                if(!u.bank || !u.acc) {
                    bankHtml = `<div class="glass-panel" style="border-color: var(--danger); background: rgba(255, 0, 85, 0.05); text-align: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: var(--danger); margin-bottom: 10px;"></i>
                        <div style="color: var(--danger); font-weight: bold; margin-bottom: 5px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
                        <button class="cyber-btn" style="font-size: 0.8rem; padding: 8px 20px;" onclick="document.getElementById('walletModal').style.display='none'; showBankModal();">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
                    </div>`;
                } else {
                    bankHtml = `
                        <div class="glass-panel" style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--bg-dark), #1a1a2e); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-university" style="font-size: 1.5rem; color: var(--secondary);"></i>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: white; letter-spacing: 1px;">${formatBankAcc(u.acc)}</div>
                                <div style="font-size: 0.8rem; color: var(--primary);">${u.bank.toUpperCase()} - ${u.name}</div>
                            </div>
                        </div>
                    `;
                }

                body.innerHTML = `
                    ${bankHtml}
                    
                    <div class="glass-panel" style="text-align: center; margin-bottom: 20px; border: 1px solid var(--warning); box-shadow: 0 0 10px rgba(255, 204, 0, 0.1);">
                        <div style="color: var(--text-muted); font-size: 0.85rem;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ</div>
                        <div style="color: var(--warning); font-size: 2rem; font-weight:bold; margin: 5px 0; text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">${balance.toLocaleString('en-US', {minimumFractionDigits: 2})} <span style="font-size: 1rem; color: white;">THB</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 200 ‡∏ö‡∏≤‡∏ó</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
                        <div style="position: relative;">
                            <input type="number" id="walletAmount" class="cyber-input" placeholder="0.00" 
                                   style="padding-right: 80px; font-size: 1.2rem; font-weight:bold; color: white;"
                                   oninput="updateWithdrawUI(this.value)">
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); font-weight: bold; cursor: pointer; font-size: 0.85rem; text-transform: uppercase;" onclick="fillMaxWithdraw()">MAX</span>
                        </div>
                    </div>

                    <div class="glass-panel" style="padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                            <span style="color: var(--text-muted);">‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô</span>
                            <span style="color: white;" id="withdrawBaseAmount">0.00 THB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                            <span style="color: var(--text-muted);">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (3%)</span>
                            <span style="color: var(--danger);" id="withdrawFee">0.00 THB</span>
                        </div>
                        <div style="width: 100%; height: 1px; background: rgba(255,255,255,0.1); margin: 10px 0;"></div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: bold;">
                            <span style="color: var(--text-muted);">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                            <span style="color: var(--success); text-shadow: 0 0 10px var(--success-dim);" id="netWithdrawAmount">0.00 THB</span>
                        </div>
                    </div>

                    <button class="cyber-btn" onclick="submitTransaction()" style="width: 100%; --btn-bg: var(--warning); color: #000;">
                        <i class="fas fa-paper-plane"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                `;
            }
        }

        function updateWithdrawUI(val) {
            const base = document.getElementById('withdrawBaseAmount');
            const fee = document.getElementById('withdrawFee');
            const net = document.getElementById('netWithdrawAmount');
            
            const amt = parseFloat(val);
            
            if(amt && amt > 0) {
                const feeVal = amt * 0.03; // 3% Fee
                const netVal = amt - feeVal;
                
                base.innerText = amt.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
                fee.innerText = feeVal.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
                net.innerText = netVal.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
            } else {
                base.innerText = "0.00 THB";
                fee.innerText = "0.00 THB";
                net.innerText = "0.00 THB";
            }
        }

        function fillMaxWithdraw() {
            const input = document.getElementById('walletAmount');
            input.value = balance;
            updateWithdrawUI(balance);
        }

        function updateDepositUI(val) {
            const info = document.getElementById('depositInfo');
            const disp = document.getElementById('displayAmount');
            const qrSec = document.getElementById('qrSection');
            const qrImg = document.getElementById('qrImage');
            const qrAmt = document.getElementById('qrAmount');
            
            if(val && parseFloat(val) >= 40) {
                if(qrSec) {
                    qrSec.style.display = 'block';
                    qrAmt.innerText = parseFloat(val).toFixed(2);
                    // Using PromptPay.io API with a test number (081-234-5678)
                    qrImg.src = `https://promptpay.io/0812345678/${val}`;
                }
                if(info) {
                    info.style.display = 'block';
                    if(disp) disp.innerText = parseFloat(val).toFixed(2);
                }
            } else {
                if(qrSec) qrSec.style.display = 'none';
                if(info) info.style.display = 'none';
            }
        }

        function openWalletPage() {
            // Clear all wallet badges when viewing history
            localStorage.removeItem('wallet_badge_deposit');
            localStorage.removeItem('wallet_badge_withdraw');
            checkWalletBadges();
            switchPage('walletPage', document.getElementById('navWallet'));
            renderUserTrans();
        }

        function renderUserTrans() {
            const list = document.getElementById('transList');
            if(!list) return;
            
            let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
            // Filter my transactions
            trans = trans.filter(t => t.user === currentUser.username);
            // Sort Newest First
            trans.sort((a,b) => b.timestamp - a.timestamp);
            
            if(trans.length === 0) {
                list.innerHTML = `
                    <div style="text-align:center; color:var(--text-muted); margin-top:50px; padding: 40px;">
                        <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 1px dashed var(--text-muted);">
                            <i class="fas fa-history" style="font-size:2.5rem; opacity:0.5;"></i>
                        </div>
                        <div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            trans.forEach(t => {
                let statusBadge = '';
                if(t.status === 'pending') statusBadge = '<span style="color:var(--warning); background:rgba(255, 204, 0, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(255, 204, 0, 0.2);"><i class="fas fa-clock"></i> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
                else if(t.status === 'approved') statusBadge = '<span style="color:var(--success); background:rgba(0, 255, 157, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(0, 255, 157, 0.2); box-shadow: 0 0 5px rgba(0, 255, 157, 0.2);"><i class="fas fa-check-circle"></i> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
                else statusBadge = '<span style="color:var(--danger); background:rgba(255, 0, 85, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(255, 0, 85, 0.2);"><i class="fas fa-times-circle"></i> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</span>';
                
                let icon = t.type === 'deposit' ? '<i class="fas fa-arrow-down" style="color:var(--success);"></i>' : '<i class="fas fa-arrow-up" style="color:var(--warning);"></i>';
                let iconBg = t.type === 'deposit' ? 'rgba(0, 255, 157, 0.1)' : 'rgba(255, 204, 0, 0.1)';
                let iconBorder = t.type === 'deposit' ? 'var(--success)' : 'var(--warning)';
                
                let title = t.type === 'deposit' ? '‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
                let amountColor = t.type === 'deposit' ? 'var(--success)' : 'var(--warning)';
                let sign = t.type === 'deposit' ? '+' : '-';
                
                // Fee detail text
                let feeDetail = '';
                if(t.type === 'withdraw' && t.fee) {
                    feeDetail = `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: ${t.fee.toLocaleString()}</div>`;
                }

                list.innerHTML += `
                    <div class="glass-panel" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; animation: slideUp 0.3s ease-out;">
                        <div style="display:flex; gap:15px; align-items:center;">
                            <div style="width:45px; height:45px; border-radius:12px; background:${iconBg}; display:flex; align-items:center; justify-content:center; font-size:1.2rem; border: 1px solid ${iconBorder}; box-shadow: 0 0 10px ${iconBg};">
                                ${icon}
                            </div>
                            <div>
                                <div style="font-weight: bold; color: white; font-size:1rem;">${title}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${new Date(t.timestamp).toLocaleString('th-TH')}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: ${amountColor}; font-size:1.1rem; text-shadow: 0 0 10px ${amountColor}40;">${sign}${t.amount.toLocaleString()}</div>
                            ${feeDetail}
                            <div style="margin-top: 6px;">${statusBadge}</div>
                        </div>
                    </div>
                `;
            });
        }

        function miningLoop() {
    checkExpiration();
    autoMiningController();
    
    if(isMining && hashrate > 0) {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ = hashrate ‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        balance += hashrate;
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        if(Math.floor(Date.now() / 10000) % 1 === 0) {
            saveData();
        }
        
        updateUI();
        
        console.log(`‚õèÔ∏è Mining: +${hashrate.toFixed(2)} ‡∏ø | Balance: ${balance. toFixed(2)} ‡∏ø`);
    } else {
        // ‡∏ñ‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î ‡πÅ‡∏ï‡πà hashrate > 0 ‡πÉ‡∏´‡πâ auto restart
        if(hashrate > 0 && !isMining) {
            isMining = true;
            console.log('Auto-restarting mining...');
            updateMiningMode();
        }
    }
}

        function checkAnnounce() {
            try {
                let raw = localStorage.getItem('mining_announcement');
                let ann = null;
                try { ann = raw ? JSON.parse(raw) : null; } catch (_) { ann = raw ? { msg: raw, date: new Date().toISOString() } : null; }
                if(ann && ann.msg) {
                    // Update Dashboard Board
                    const db = document.getElementById('dashboardAnnounce');
                    if(db) db.innerText = ann.msg;

                    const lastAnn = localStorage.getItem('last_ann_seen');
                    if(lastAnn !== ann.date) {
                        const b = document.getElementById('annBadge');
                        if(b) b.style.display = 'block';
                        const l = document.getElementById('annLabel');
                        if(l) { l.innerText = '‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà'; l.style.color = '#ef4444'; }
                    } else {
                        const b = document.getElementById('annBadge');
                        if(b) b.style.display = 'none';
                        const l = document.getElementById('annLabel');
                        if(l) { l.innerText = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; l.style.color = '#aaa'; }
                    }
                }
                
                // Check for Referrer Notifications
                if(currentUser) {
                    let notifs = JSON.parse(localStorage.getItem(`notifications_${currentUser.username}`)) || [];
                    const unread = notifs.filter(n => !n.read);
                    if(unread.length > 0) {
                         // Show Toast or Alert
                         const lastNotif = unread[unread.length-1];
                         
                         // Prevent duplicate toast for same session if needed, or just show last
                         // Simple Implementation: Show Toast
                         showToast(lastNotif.msg, lastNotif.type || 'info');
                         notifs.forEach(n => n.read = true);
                         localStorage.setItem(`notifications_${currentUser.username}`, JSON.stringify(notifs));
                         }
                }

            } catch (e) { console.error(e); }
        }

        function openAnnounceModal() {
            try {
                const ann = JSON.parse(localStorage.getItem('mining_announcement'));
                if(ann && ann.msg) {
                    document.getElementById('announceBody').innerText = ann.msg;
                    document.getElementById('announceModal').style.display = 'flex';
                    // Mark as seen
                    localStorage.setItem('last_ann_seen', ann.date);
                    checkAnnounce(); // Update UI immediately
                } else {
                    alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®');
                }
            } catch(e) { console.error(e); }
        }

        function closeAnnounce() {
            document.getElementById('announceModal').style.display = 'none';
        }

        function updateUI() {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            const incomePerSec = hashrate > 0 ? hashrate : 0;
            
            document.getElementById('balanceDisplay').innerText = 
                `‡∏ø${parseFloat(balance). toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('incomeDisplay').innerText = 
                `+‡∏ø${incomePerSec. toFixed(3)}`;
            document.getElementById('hashrateDisplay').innerText = 
                hashrate.toFixed(1);
            
            autoMiningController();
            updateMiningMode();
        }

        function switchPage(pid, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // --- Auth ---
        function toSignup() { document.getElementById('loginModal').style.display='none'; document.getElementById('signupModal').style.display='flex'; }
        function toLogin() { document.getElementById('signupModal').style.display='none'; document.getElementById('loginModal').style.display='flex'; }
        
        function signup() {
            const u = document.getElementById('regUser').value;
            const p = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            const bank = document.getElementById('regBank').value;
            const acc = document.getElementById('regAcc').value;
            
            if(!u || !p || !name || !acc) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
            let users = JSON.parse(localStorage.getItem('mining_users')) || {};
            if(users[u]) return showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'error');

            users[u] = {
                pass: p, id: Math.floor(100000+Math.random()*900000),
                name: name, bank: bank, acc: acc,
                regDate: new Date().toISOString(), banned: false,
                referrer: null
            };
            localStorage.setItem('mining_users', JSON.stringify(users));
            
            let startBalance = 0;

            // Process Referral
            const pendingRef = localStorage.getItem('pending_ref');
            if(pendingRef) {
                const refId = pendingRef.replace('X','');
                const referrerName = Object.keys(users).find(k => users[k].id == refId);
                if(referrerName) {
                    // Save Referrer Link
                    users[u].referrer = referrerName;
                    localStorage.setItem('mining_users', JSON.stringify(users));

                    let refs = JSON.parse(localStorage.getItem(`mining_referrals_${referrerName}`)) || [];
                    if(!refs.find(r => r.name === u)) {
                        refs.push({
                            name: u,
                            date: new Date().toISOString(),
                            status: 'completed',
                            claimed: false
                        });
                        localStorage.setItem(`mining_referrals_${referrerName}`, JSON.stringify(refs));
                        
                        // Notify Referrer (Mock Notification Logic)
                        let refNotifications = JSON.parse(localStorage.getItem(`notifications_${referrerName}`)) || [];
                        refNotifications.push({
                            msg: `‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà! ${u} ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`,
                            date: new Date().toISOString(),
                            read: false
                        });
                        localStorage.setItem(`notifications_${referrerName}`, JSON.stringify(refNotifications));

                        // Bonus for New User
                        startBalance = 100;
                        let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
                        trans.push({
                            id: Date.now(), user: u, type: 'deposit', amount: 100,
                            status: 'approved', timestamp: Date.now(), processed: true,
                            method: 'referral_bonus', fee: 0, net: 100
                        });
                        localStorage.setItem('mining_transactions', JSON.stringify(trans));
                    }
                }
                localStorage.removeItem('pending_ref');
            }

            // Init Profile
            const pf = { username: u, balance: startBalance, hashrate: 0.0, avatar: null };
            localStorage.setItem(`pf_${u}`, JSON.stringify(pf));
            
            if(startBalance > 0) showToast(`‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏ø${startBalance}`, 'success');
            else showToast('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'success');
            
            toLogin();
        }

        function login() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            let users = JSON.parse(localStorage.getItem('mining_users')) || {};
            if(users[u] && users[u].pass === p) {
                if(users[u].banned) return showToast('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß', 'error');
                currentUser = { username: u };
                localStorage.setItem('current_user', JSON.stringify(currentUser));
                document.getElementById('loginModal').style.display='none';
                initApp();
                showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else { showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); }
        }

        function logout() { localStorage.removeItem('current_user'); location.reload(); }

        // --- Data ---
        function saveData() { if(currentUser) { let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`)); pf.balance = balance; pf.hashrate = hashrate; localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf)); } }
                function loadUserData() {
            let pf = JSON.parse(localStorage.getItem(`pf_${currentUser. username}`));
            if(pf) {
                balance = parseFloat(pf.balance || 0);
                hashrate = parseFloat(pf. hashrate || 0);
                console.log('üìä Loaded Data:', { balance, hashrate });
                
                // ‚úÖ Auto-start mining if hashrate > 0
                if(hashrate > 0) {
                    isMining = true;
                    console.log('üöÄ Auto-starting mining...');
                }
                
                updateUI();
            }
        }
        function renderProfile() {
            let users = JSON.parse(localStorage.getItem('mining_users'));
            let uData = users[currentUser.username];
            let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`));
            
            document.getElementById('headerName').innerText = currentUser.username;
            document.getElementById('headerID').innerText = `ID: ${uData.id}`;
            document.getElementById('settingName').innerText = currentUser.username;
            document.getElementById('settingID').innerText = `ID: ${uData.id}`;
            document.getElementById('myRefCode').innerText = uData.id + "X";
            
            if(pf.avatar) {
                document.getElementById('headerAvatar').innerHTML = `<img src="${pf.avatar}">`;
                document.getElementById('settingAvatar').innerHTML = `<img src="${pf.avatar}">`;
            }
            
            updateNotifBadge();
        }

        function changeProfilePic() {
            const file = document.getElementById('uploadProfile').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`));
                    pf.avatar = e.target.result;
                    localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf));
                    renderProfile();
                }
                reader.readAsDataURL(file);
            }
        }

        // Removed duplicate openWalletModal
        function previewSlip() {
            const file = document.getElementById('slipUpload').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('slipImg').src = e.target.result;
                    document.getElementById('slipPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function submitDeposit() {
            const amt = parseFloat(document.getElementById('walletAmount').value);
            if(!amt || amt < 40) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 40 ‡∏ö‡∏≤‡∏ó', 'warning');
            
            // Simulate Automatic Payment Check
            const btn = document.getElementById('btnDeposit');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô...';
            
            // Play wait sound/vib if needed
            // setTimeout to simulate network check
            setTimeout(() => {
                // Success
                let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
                trans.push({
                    id: Date.now(), 
                    user: currentUser.username, 
                    type: 'deposit', 
                    amount: amt,
                    status: 'approved', 
                    timestamp: Date.now(), 
                    processed: true,
                    method: 'qr_auto'
                });
                localStorage.setItem('mining_transactions', JSON.stringify(trans));
                
                balance += amt;
                saveData(); 
                updateUI();
                
                // Notify User
                showToast(`‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${amt.toLocaleString()} THB`, 'success');
                
                // Reset UI
                btn.disabled = false;
                btn.innerHTML = originalText;
                document.getElementById('walletModal').style.display='none';
                
                // Sound & Vib Success
                if(typeof soundMgr !== 'undefined') soundMgr.play('emphasis');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('emphasis');

                // Add Notification
                addNotification(`‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à +${amt.toLocaleString()} THB`);
                
            }, 3000);
        }

        function submitTransaction() {
            const amt = parseFloat(document.getElementById('walletAmount').value);
            if(!amt) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'warning');
            
            // Deposit is handled by submitDeposit() now
            
            if(currentAction === 'withdraw') {
                let users = JSON.parse(localStorage.getItem('mining_users'));
                let u = users[currentUser.username];
                if(!u.bank || !u.acc) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'warning');
                                //‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô//
                if(amt < 200) return showToast('‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 200 ‡∏ö‡∏≤‡∏ó', 'warning');
                if(amt > 200000) return showToast('‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 200,000 ‡∏ö‡∏≤‡∏ó‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning');
                if(balance < amt) return showToast('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
                
                const fee = amt * 0.03;
                const net = amt - fee;
                
                if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô?\n\n‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô: ‡∏ø${amt.toLocaleString()}\n‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (3%): ‡∏ø${fee.toLocaleString()}\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ‡∏ø${net.toLocaleString()}`)) return;
                
                balance -= amt;
                
                let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
                trans.push({
                    id: Date.now(), user: currentUser.username, type: currentAction, amount: amt,
                    fee: fee, net: net, // Store fee details
                    status: 'pending', timestamp: Date.now(), processed: false
                });
                localStorage.setItem('mining_transactions', JSON.stringify(trans));
                saveData(); updateUI();
                showToast('‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
                document.getElementById('walletModal').style.display='none';
            }
        }

        function formatBankAcc(acc) {
            if(!acc) return '---';
            const cleaned = ('' + acc).replace(/\D/g, '');
            if(cleaned.length === 10) {
                return `${cleaned.substring(0,3)}-${cleaned.substring(3,4)}-${cleaned.substring(4,9)}-${cleaned.substring(9)}`;
            }
            return acc;
        }

        function showBankModal() {
            let users = JSON.parse(localStorage.getItem('mining_users'));
            let u = users[currentUser.username];
            
            const modal = document.getElementById('bankModal');
            const content = modal.querySelector('.modal-content');
            
            // Reset modal content structure if needed
            if(!document.getElementById('myBankInfo')) {
                 // This handles if we are re-rendering inside an existing structure or setting it up
                 // But since we are replacing the innerHTML of the modal content mostly or specific part?
                 // The original code targeted 'myBankInfo' which is inside the modal.
                 // Let's just update the 'myBankInfo' content as the original did.
            }
            
            document.getElementById('myBankInfo').innerHTML = `
                <div class="bank-card ${u.bank}" style="margin-bottom: 25px; position: relative; overflow: hidden; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                    <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;"></div>
                    <i class="fas fa-university bank-logo-watermark" style="opacity: 0.1; font-size: 8rem; position: absolute; bottom: -20px; right: -20px;"></i>
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
                        <div class="bank-chip" style="width: 50px; height: 35px; background: linear-gradient(135deg, #d4af37, #f9e58a); border-radius: 6px; position: relative;">
                            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.2);"></div>
                            <div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: rgba(0,0,0,0.2);"></div>
                        </div>
                        <div style="text-align: right; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                            <div style="font-weight: bold; font-size: 1.1rem;">${u.bank.toUpperCase()}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8;">DEBIT CARD</div>
                        </div>
                    </div>
                    
                    <div style="z-index: 2; position: relative; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                        <div class="bank-number" style="font-size: 1.5rem; letter-spacing: 3px; margin-bottom: 15px; font-family: monospace;">${formatBankAcc(u.acc)}</div>
                        <div class="bank-holder" style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div>
                                <div style="font-size: 0.6rem; opacity: 0.7; margin-bottom: 2px;">CARD HOLDER</div>
                                <div style="font-size: 1rem; text-transform: uppercase;">${u.name}</div>
                            </div>
                            <div style="font-size:1.5rem;">
                                <i class="fab fa-cc-visa"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="cyber-btn" onclick="showBankEdit()" style="width: 100%;">
                    <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            `;
            document.getElementById('bankModal').style.display='flex';
        }

        function showBankEdit() {
            let users = JSON.parse(localStorage.getItem('mining_users'));
            let u = users[currentUser.username];
            
            document.getElementById('myBankInfo').innerHTML = `
                <div class="glass-panel" style="text-align:left; margin-bottom:20px; padding: 25px;">
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                        <div class="custom-select-wrapper" style="position: relative;">
                            <select id="editBank" class="cyber-input" style="width: 100%; appearance: none; cursor: pointer;">
                                <option value="kbank" ${u.bank==='kbank'?'selected':''}>‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
                                <option value="scb" ${u.bank==='scb'?'selected':''}>‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
                                <option value="ktb" ${u.bank==='ktb'?'selected':''}>‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
                                <option value="bbl" ${u.bank==='bbl'?'selected':''}>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
                                <option value="gsb" ${u.bank==='gsb'?'selected':''}>‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); pointer-events: none;"></i>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <input type="tel" id="editAcc" class="cyber-input" value="${u.acc}" placeholder="0123456789" maxlength="10">
                    </div>
                    
                    <div>
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <input type="text" id="editName" class="cyber-input" value="${u.name}">
                    </div>
                </div>
                
                <div style="display:flex; gap:15px;">
                    <button class="cyber-btn" style="flex:1; background: transparent; border-color: var(--text-muted); color: var(--text-muted); box-shadow: none;" onclick="showBankModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="cyber-btn" style="flex:1; --btn-bg: var(--success);" onclick="saveBankInfo()">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            `;
        }

        function saveBankInfo() {
            const bank = document.getElementById('editBank').value;
            const acc = document.getElementById('editAcc').value;
            const name = document.getElementById('editName').value;
            
            if(!acc || !name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            
            let users = JSON.parse(localStorage.getItem('mining_users'));
            users[currentUser.username].bank = bank;
            users[currentUser.username].acc = acc;
            users[currentUser.username].name = name;
            
            localStorage.setItem('mining_users', JSON.stringify(users));
            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            showBankModal();
        }
        function showReferralModal() { 
            document.getElementById('refModal').style.display='flex'; 
            renderReferralUI();
        }

        function renderReferralUI() {
            // Load User Specific Referrals
            let refs = JSON.parse(localStorage.getItem(`mining_referrals_${currentUser.username}`));
            if(!refs) {
                refs = [];
                localStorage.setItem(`mining_referrals_${currentUser.username}`, JSON.stringify(refs));
            }
            
            const list = document.getElementById('refList');
            const pCount = document.getElementById('refPendingCount');
            const cCount = document.getElementById('refCompletedCount');
            
            let pending = 0;
            let completed = 0;
            let bonus = 0;

            list.innerHTML = '';

            if(refs.length === 0) {
                list.innerHTML = `
                    <div class="ref-list-empty" style="text-align: center; padding: 40px 0; color: var(--text-muted);">
                        <div style="width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: 1px dashed var(--text-muted);">
                            <i class="fas fa-user-plus" style="font-size: 2.5rem; opacity: 0.5;"></i>
                        </div>
                        <div style="font-size: 1.1rem; font-weight: bold; color: var(--text-main);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏¥‡∏ç</div>
                        <div style="font-size: 0.85rem;">‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</div>
                    </div>
                `;
            } else {
                refs.forEach(r => {
                    if(r.status === 'pending') pending++;
                    else if(r.status === 'completed') {
                        completed++;
                        if(!r.claimed) bonus += 50; // 50 THB Bonus
                    }
                    
                    let statusColor = r.status === 'completed' ? 'var(--success)' : 'var(--warning)';
                    let statusText = r.status === 'completed' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    let icon = r.status === 'completed' ? 'fa-check' : 'fa-clock';
                    
                    list.innerHTML += `
                        <div class="glass-panel" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; border-radius: 16px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px var(--primary-dim);">
                                    <i class="fas fa-user" style="color: white;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 1rem; font-weight: bold; color: white;">${r.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">${new Date(r.date).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${statusColor}; font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 6px; display: inline-block; border: 1px solid ${statusColor};">
                                    <i class="fas ${icon}"></i> ${statusText}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            pCount.innerText = pending;
            cCount.innerText = completed;
            
            const btn = document.getElementById('btnClaimBonus');
            if(bonus > 0) {
                btn.innerHTML = `<i class="fas fa-gift" style="margin-right:5px;"></i> ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (‡∏ø${bonus.toFixed(2)})`;
                btn.style.background = 'linear-gradient(135deg, var(--success), #00cec9)';
                btn.style.color = '#000';
                btn.style.fontWeight = 'bold';
                btn.style.cursor = 'pointer';
                btn.style.boxShadow = '0 0 15px rgba(0, 255, 157, 0.4)';
                btn.onclick = function() { claimBonus(bonus); };
            } else {
                btn.innerHTML = `<i class="fas fa-gift" style="margin-right:5px;"></i> ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (0.00)`;
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.color = '#777';
                btn.style.cursor = 'not-allowed';
                btn.style.boxShadow = 'none';
                btn.onclick = null;
            }
        }

        function copyRef() {
            const code = document.getElementById('myRefCode').innerText;
            if(!code || code === '---' || code === 'undefinedX') {
                alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
                return;
            }
            
            // Dynamic Link
            const baseUrl = window.location.href.split('?')[0];
            const link = `${baseUrl}?ref=${code}`;
            
            navigator.clipboard.writeText(link);
            showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡πâ‡∏ß!', 'success');
        }

        function claimBonus(amount) {
            if(!amount || amount <= 0) return;
            balance += amount;
            
            let refs = JSON.parse(localStorage.getItem(`mining_referrals_${currentUser.username}`)) || [];
            refs.forEach(r => { if(r.status === 'completed') r.claimed = true; });
            localStorage.setItem(`mining_referrals_${currentUser.username}`, JSON.stringify(refs));
            
            // Record Transaction
            let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
            trans.push({
                id: Date.now(), user: currentUser.username, type: 'deposit', amount: amount,
                status: 'approved', timestamp: Date.now(), processed: true,
                method: 'referral_commission', fee: 0, net: amount
            });
            localStorage.setItem('mining_transactions', JSON.stringify(trans));
                    
                    function saveData() {
            if(currentUser) {
                let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`) || '{}');
                pf.username = currentUser.username;
                pf.balance = parseFloat(balance. toFixed(2));
                pf.hashrate = parseFloat(hashrate.toFixed(2));
                pf.lastUpdate = Date.now();
                
                console.log('üíæ Saving:', pf);
                localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf));
            }
        }
            updateUI();
            renderReferralUI();
            
            // Custom Success Modal (AI Theme)
            const modalId = 'claimSuccessModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10001';
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; text-align:center; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none;"></div>
                    
                    <div style="width: 80px; height: 80px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid #00f2ff; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);">
                        <i class="fas fa-gift" style="font-size: 3rem; color: #00f2ff; animation: bounce 2s infinite;"></i>
                    </div>
                    <h2 style="color: #fff; margin:0 0 5px; text-shadow: 0 0 5px #00f2ff;">SYSTEM GRANT</h2>
                    <p style="color: #94a3b8; margin-bottom: 20px; font-family: monospace;">Referral Bonus Acquired</p>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #00f2ff; margin-bottom: 20px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5); font-family: monospace;">
                        ‡∏ø${amount.toFixed(2)}
                    </div>
                    <button class="btn-action" style="background: rgba(0, 242, 255, 0.1); color: #00f2ff; border: 1px solid #00f2ff; font-weight: bold; border-radius: 8px;" onclick="document.getElementById('${modalId}').remove()">ACKNOWLEDGE</button>
                </div>
            `;
            document.body.appendChild(div);
        }

        // --- Shop ---
        function loadShop() {
            const g = document.getElementById('shopList');
            if(!g) return;
            g.innerHTML = '';
            const disabled = localStorage.getItem('shop_disabled') === 'true';
            const notice = localStorage.getItem('shop_notice');
            let items = JSON.parse(localStorage.getItem('mining_shop_items'));
            const seeded = localStorage.getItem('shop_seeded') === 'true';

            if(disabled) {
                g.innerHTML = `<div class="glass-panel" style="text-align:center; padding: 30px;">
                    <div style="font-size:1.2rem; font-weight:bold; color: var(--warning); margin-bottom: 8px;">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>
                    <div style="color: var(--text-muted);">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</div>
                    ${notice ? `<div style="margin-top:10px; color:#fff;">${notice}</div>` : ''}
                </div>`;
                return;
            }

            if(!items) {
                if(!seeded) {
                    const catalog = [
                        {id: 6, name: "Bitcoin Starter 24h", speed: 0.05, price: 0, tier: 'limited', tag: 'free', icon: 'fa-bitcoin'},
                        {id: 1, name: "GTX 1060 Starter", speed: 0.5, price: 500, tier: 'basic', icon: 'fa-fan'},
                        {id: 7, name: "Titanium Rig Mk1", speed: 12.0, price: 12000, tier: 'mid', tag: 'used', icon: 'fa-hammer'},
                        {id: 2, name: "RTX 3060 Ti", speed: 2.5, price: 2500, tier: 'mid', icon: 'fa-memory'},
                        {id: 3, name: "RTX 4090 Ultimate", speed: 8.0, price: 9500, tier: 'pro', tag: 'hot', icon: 'fa-microchip'},
                        {id: 4, name: "ASIC S19 Pro", speed: 25.0, price: 28000, tier: 'pro', icon: 'fa-server'},
                        {id: 5, name: "Quantum Rig V1", speed: 80.0, price: 85000, tier: 'legendary', tag: 'new', icon: 'fa-atom'},
                    ];
                    localStorage.setItem('mining_shop_items', JSON.stringify(catalog));
                    localStorage.setItem('shop_seeded', 'true');
                    items = catalog;
                } else {
                    items = [];
                }
            }

            if(items.length === 0) {
                g.innerHTML = `<div class="glass-panel" style="text-align:center; padding: 30px;">
                    <div style="font-size:1.2rem; font-weight:bold; color: #fff; margin-bottom: 8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div style="color: var(--text-muted);">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô</div>
                    ${notice ? `<div style="margin-top:10px; color:#fff;">${notice}</div>` : ''}
                </div>`;
                return;
            }

            let activeItems = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
            if(notice) g.innerHTML += `<div class="glass-panel" style="margin-bottom:15px;">${notice}</div>`;

            items.forEach(i => {
                const tagClass = i.tag ? i.tag : '';
                const tagLabel = i.tag ? ({hot:'‡∏Æ‡∏≠‡∏ï', new:'‡πÉ‡∏´‡∏°‡πà', sale:'‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤', best:'‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', used:'‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á', free:'‡∏ü‡∏£‡∏µ'}[i.tag] || i.tag) : null;
                let btnText = '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <i class="fas fa-shopping-cart"></i>';
                let btnState = '';
                let btnStyle = 'margin-top:5px; padding:8px 0; font-size:0.9rem;';
                if(i.id === 6) {
                    const existing = activeItems.find(x => x.id === 6);
                    if(existing) {
                        const timeLeft = Math.max(0, Math.floor((existing.expiresAt - Date.now()) / 1000));
                        const h = Math.floor(timeLeft / 3600);
                        const m = Math.floor((timeLeft % 3600) / 60);
                        btnText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${h}‡∏ä‡∏°. ${m}‡∏ô.`;
                        btnState = 'disabled';
                        btnStyle += 'background: #555; cursor: not-allowed;';
                    } else {
                        btnText = '‡∏£‡∏±‡∏ö‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ <i class="fas fa-gift"></i>';
                        btnStyle += 'background: linear-gradient(135deg, #ffd700, #f1c40f); color: #000; font-weight: 800;';
                    }
                }
                const icon = i.icon || 'fa-microchip';
                const tier = i.tier || 'basic';
                let tierColor = 'var(--primary)';
                if(tier === 'legendary') tierColor = '#f1c40f';
                else if(tier === 'pro') tierColor = '#e056fd';
                else if(tier === 'mid') tierColor = '#00cec9';
                else if(tier === 'basic') tierColor = '#74b9ff';
                else if(tier === 'limited') tierColor = '#ff7675';
                const isUsed = tagClass.includes('used');
                const cardClass = isUsed ? 'shop-card-cyber used' : 'shop-card-cyber';
                g.innerHTML += `
                <div class="${cardClass}" style="--card-color: ${tierColor};">
                    ${tagLabel ? `<div style=\"position: absolute; top: 10px; right: 10px; background: ${tierColor}; color: #000; font-size: 0.6rem; font-weight: bold; padding: 2px 8px; border-radius: 4px;\">${tagLabel}</div>` : ''}
                    <div class="cyber-icon-box" style="border-color: ${tierColor}; box-shadow: 0 0 15px ${tierColor}40;">
                        <i class="fas ${icon}" style="color: ${tierColor};"></i>
                    </div>
                    <h3 style="margin: 10px 0 5px; font-size: 1rem; color: white;">${i.name}</h3>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 5px; color: #94a3b8; font-size: 0.8rem; margin-bottom: 15px;">
                        <i class="fas fa-bolt" style="color: ${tierColor};"></i>
                        <span>+${i.speed} MH/s</span>
                    </div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: white; margin-bottom: 15px; text-shadow: 0 0 10px ${tierColor}80;">
                        ${i.price === 0 ? '‡∏ü‡∏£‡∏µ' : '‡∏ø'+i.price.toLocaleString()}
                    </div>
                    <button class="cyber-btn" onclick="buyItem(${i.price}, ${i.speed}, ${i.id})" ${btnState} style="${btnState ? 'opacity:0.5;cursor:not-allowed;' : ''} border-color: ${tierColor}; color: ${tierColor}; box-shadow: 0 0 10px ${tierColor}20;">
                        ${btnText}
                    </button>
                </div>`;
            });
        }

        let lastKnownShopUpdate = localStorage.getItem('shop_last_update');
        
        function checkShopUpdate() {
            const currentUpdate = localStorage.getItem('shop_last_update');
            const myLastSeen = localStorage.getItem('shop_seen_update');
            
            // Live Update Logic
            if(currentUpdate && currentUpdate !== lastKnownShopUpdate) {
                lastKnownShopUpdate = currentUpdate;
                loadShop(); // Live Reload
                
                // Create Modal Alert for New Item
                const modalId = 'newItemModal';
                if(!document.getElementById(modalId)) {
                    const div = document.createElement('div');
                    div.id = modalId;
                    div.className = 'modal';
                    div.style.display = 'flex';
                    div.style.zIndex = '9999';
                    div.innerHTML = `
                        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; text-align:center; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none;"></div>
                            
                            <i class="fas fa-rocket" style="font-size: 3rem; color: #00f2ff; margin-bottom: 15px; animation: bounce 2s infinite; text-shadow: 0 0 15px rgba(0, 242, 255, 0.5);"></i>
                            <h2 style="color: #fff; margin:0; text-shadow: 0 0 5px #00f2ff;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                            <p style="color: #94a3b8; font-family: monospace; margin-top: 5px;">‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</p>
                            
                            <button class="btn-action" style="background: rgba(0, 242, 255, 0.1); color: #00f2ff; border: 1px solid #00f2ff; font-weight: bold; border-radius: 8px; margin-top: 20px;" onclick="document.getElementById('${modalId}').remove(); openShopPage()">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                            <div style="margin-top:10px; font-size:0.8rem; color: #64748b; cursor:pointer;" onclick="document.getElementById('${modalId}').remove()">‡∏õ‡∏¥‡∏î</div>
                        </div>
                    `;
                    document.body.appendChild(div);
                }
                showToast('‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô', 'success');
            }

            if(currentUpdate && currentUpdate !== myLastSeen) {
                const b1 = document.getElementById('shopBadgeFloat');
                const b2 = document.getElementById('shopBadgeNav');
                if(b1) b1.style.display = 'block';
                if(b2) b2.style.display = 'block';
            } else {
                const b1 = document.getElementById('shopBadgeFloat');
                const b2 = document.getElementById('shopBadgeNav');
                if(b1) b1.style.display = 'none';
                if(b2) b2.style.display = 'none';
            }
        }
        
        function buyItem(p, s, id) {
            if(id === 6) { // Free Bitcoin Starter 24h
                let active = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
                const existing = active.find(x => x.id === 6);
                if(existing) {
                    showToast('‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'warning');
                    return;
                }
                
                // 24 Hours Expiration
                active.push({
                    id: 6, 
                    name: 'Bitcoin Starter 24h',
                    speed: s, 
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000)
                });
                localStorage.setItem(`active_items_${currentUser.username}`, JSON.stringify(active));
                
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° hashrate ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                hashrate += s;
                isMining = true; // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                
                saveData(); 
                updateUI(); 
                loadShop();
                updateMiningMode();
                miningLoop();
                
                try {
                    let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser.username}`)) || [];
                    const itemsC = JSON.parse(localStorage.getItem('mining_shop_items')) || [];
                    const item = itemsC.find(x => x.id === id) || { name: 'Bitcoin Starter 24h', icon: 'fa-bitcoin' };
                    rigs.push({ 
                        id, 
                        name: item.name, 
                        speed: s, 
                        price: 0, 
                        icon: item.icon, 
                        status: 'active', 
                        timestamp: Date.now(), 
                        expiresAt: Date.now() + (24 * 60 * 60 * 1000) 
                    });
                    localStorage. setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                } catch (_) {}
                
                showToast('‚úÖ ‡∏£‡∏±‡∏ö Bitcoin Starter 24h ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!  ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ', 'success');
                addNotification('‚úÖ ‡∏Ç‡∏∏‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß +' + s. toFixed(2) + ' MH/s', 'success');
                
                if(typeof soundMgr !== 'undefined') soundMgr.play('emphasis');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('emphasis');
                return;
            }

            // ‚úÖ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠
            if(balance >= p) {
                balance -= p; 
                hashrate += s; 
                isMining = true; // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                
                saveData(); 
                updateUI(); 
                updateMiningMode();
                
                try {
                    let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser.username}`)) || [];
                    const itemsC = JSON.parse(localStorage.getItem('mining_shop_items')) || [];
                    const item = itemsC.find(x => x.id === id) || { name: 'Rig', icon: 'fa-microchip' };
                    rigs.push({ 
                        id, 
                        name: item.name, 
                        speed: s, 
                        price: p, 
                        icon: item.icon, 
                        status: 'active', 
                        timestamp: Date. now() 
                    });
                    localStorage. setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                } catch (_) {}
                
                miningLoop();
                
                showToast(`‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +${s} MH/s`, 'success');
                addNotification(`üí∞ ‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -‡∏ø${p. toLocaleString()} | +${s. toFixed(2)} MH/s`, 'success');
                
                if(typeof soundMgr !== 'undefined') soundMgr.play('emphasis');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('emphasis');
            } else { 
                showToast('‚ùå ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡∏ï‡πâ‡∏≠‡∏á ‡∏ø' + (p - balance).toFixed(2), 'error');
                if(typeof soundMgr !== 'undefined') soundMgr. play('alert');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('alert');
            }
        }

        function updateMiningMode() {
            const el = document.getElementById('miningMode');
            if(!el) return;
            if(isMining && hashrate > 0) {
                el.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏∏‡∏î';
                el.style.color = 'var(--success)';
                el.style.textShadow = '0 0 10px var(--success)';
            } else {
                el.innerText = '‡∏û‡∏±‡∏Å';
                el.style.color = '#94a3b8';
                el.style.textShadow = 'none';
            }
        }

        function autoMiningController() {
            const paused = localStorage.getItem('mining_paused') === 'true';
            
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏µ hashrate > 0 ‡∏Ñ‡∏ß‡∏£‡∏Ç‡∏∏‡∏î
            if(hashrate > 0 && !paused && !isMining) {
                isMining = true;
                updateMiningMode();
                console. log('üîÑ Auto-resumed mining');
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ hashrate ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
            if(hashrate <= 0 && isMining) {
                isMining = false;
                updateMiningMode();
            }
        }

        function startMining() {
            if(hashrate <= 0) {
                showToast('‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                return;
            }
            
            isMining = true;
            localStorage.setItem('mining_paused', 'false');
            updateMiningMode();
            
            console.log('üü¢ Mining started!  Hashrate:', hashrate);
            miningLoop();
            
            showToast('‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
            addNotification('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î', 'success');
        }

        function stopMining() {
            isMining = false;
            localStorage.setItem('mining_paused', 'true');
            updateMiningMode();
            
            console.log('üî¥ Mining stopped');
            showToast('‚è∏ ‡∏´‡∏¢‡∏∏‡∏î‡∏Ç‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'warning');
            addNotification('‚è∏ ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏∏‡∏î', 'warning');
        }

        function checkExpiration() {
            if(! currentUser) return;
            let active = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
            if(active.length === 0) return;

            let now = Date.now();
            let updatedActive = [];
            let expiredSpeed = 0;
            let hasExpired = false;

            active.forEach(item => {
                if(item.expiresAt > now) {
                    updatedActive.push(item);
                } else {
                    expiredSpeed += item.speed;
                    hasExpired = true;
                }
            });

            if(hasExpired) {
                hashrate = Math.max(0, hashrate - expiredSpeed);
                localStorage.setItem(`active_items_${currentUser. username}`, JSON.stringify(updatedActive));
                
                console.log(`‚è∞ Item expired!  Hashrate: ${hashrate. toFixed(2)}`);
                
                saveData();
                updateUI();
                autoMiningController();
                updateMiningMode();
                
                try {
                    let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser. username}`)) || [];
                    const nowTs = Date.now();
                    rigs. forEach(r => { if(r.expiresAt && r.expiresAt <= nowTs) r.status = 'expired'; });
                    localStorage.setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                } catch (_) {}
                
                loadShop();
                
                showToast('‚è∞ ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ‡πÅ‡∏£‡∏á‡∏Ç‡∏∏‡∏î‡∏•‡∏î‡∏•‡∏á ' + expiredSpeed.toFixed(2) + ' MH/s', 'warning');
                addNotification(`‚è∞ ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ -${expiredSpeed.toFixed(2)} MH/s`, 'warning');
            }
        }

        function openShopPage() {
            // Mark as seen
            const lastUpdate = localStorage.getItem('shop_last_update');
            if(lastUpdate) {
                localStorage.setItem('shop_seen_update', lastUpdate);
            }
            checkShopUpdate(); // Update UI to hide badge
            switchPage('shopPage', document.getElementById('navShop'));
        }

        // --- Sound & Vibration & Monitor ---
        class SoundManager {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.enabled = localStorage.getItem('sound_enabled') === 'true';
                this.type = localStorage.getItem('sound_type') || 'standard'; 
            }

            play(overrideType) {
                if (!this.enabled) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const type = overrideType || this.type;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;
                
                if (type === 'standard' || type === 'alert') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now);
                    osc.frequency.exponentialRampToValueAtTime(440, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'emphasis') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(880, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'rapid') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.1, now);
                    osc.start(now);
                    osc.stop(now + 0.05);
                    
                    const osc2 = this.ctx.createOscillator();
                    const gain2 = this.ctx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(this.ctx.destination);
                    osc2.type = 'triangle';
                    osc2.frequency.setValueAtTime(800, now + 0.1);
                    gain2.gain.setValueAtTime(0.1, now + 0.1);
                    osc2.start(now + 0.1);
                    osc2.stop(now + 0.15);
                } else if (type === 'fast') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(1200, now);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                }
            }
        }

        class VibrationManager {
            constructor() {
                this.enabled = localStorage.getItem('vib_enabled') === 'true';
                this.type = localStorage.getItem('vib_type') || 'standard'; 
            }

            trigger(overrideType) {
                if (!this.enabled || !navigator.vibrate) return;
                const type = overrideType || this.type;
                if (type === 'fast') navigator.vibrate(50);
                else if (type === 'emphasis') navigator.vibrate([100, 50, 100]);
                else if (type === 'alert') navigator.vibrate(200);
                else navigator.vibrate(100); 
            }
        }

        const soundMgr = new SoundManager();
        const vibMgr = new VibrationManager();

        let wakeLock = null;
        async function toggleWakeLock(enable) {
            if ('wakeLock' in navigator) {
                if (enable) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake Lock active');
                    } catch (err) { console.error(err); }
                } else {
                    if (wakeLock !== null) {
                        wakeLock.release();
                        wakeLock = null;
                        console.log('Wake Lock released');
                    }
                }
            }
        }

        function addNotification(msg, type) {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            history.push({
                msg: msg,
                type: type,
                timestamp: Date.now(),
                read: false
            });
            if(history.length > 50) history.shift();
            localStorage.setItem(`history_notifs_${currentUser.username}`, JSON.stringify(history));
            
            // Update Badge
            updateNotifBadge();
        }

        function updateNotifBadge() {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            let unread = history.filter(h => !h.read).length;
            
            const badge = document.getElementById('headerNotifBadge');
            if(badge) {
                if(unread > 0) {
                    badge.style.display = 'block';
                    badge.innerText = unread > 99 ? '99+' : unread;
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function openNotificationHistory() {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            
            // Mark all as read
            let hasUnread = false;
            history.forEach(h => {
                if(!h.read) {
                    h.read = true;
                    hasUnread = true;
                }
            });
            if(hasUnread) {
                localStorage.setItem(`history_notifs_${currentUser.username}`, JSON.stringify(history));
                updateNotifBadge();
            }

            history.sort((a,b) => b.timestamp - a.timestamp);
            
            const modalId = 'notifHistoryModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            let listHtml = '';
            if(history.length === 0) {
                listHtml = `
                    <div style="text-align:center; color:var(--text-muted); padding:40px;">
                        <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px dashed var(--text-muted);">
                            <i class="fas fa-bell-slash" style="font-size:1.5rem; opacity:0.5;"></i>
                        </div>
                        <div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                    </div>`;
            } else {
                history.forEach(h => {
                    let icon = h.type === 'success' ? '<i class="fas fa-check-circle"></i>' : (h.type === 'error' ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-info-circle"></i>');
                    let color = h.type === 'success' ? 'var(--success)' : (h.type === 'error' ? 'var(--danger)' : 'var(--primary)');
                    let bg = h.type === 'success' ? 'rgba(0, 255, 157, 0.1)' : (h.type === 'error' ? 'rgba(255, 0, 85, 0.1)' : 'rgba(0, 242, 255, 0.1)');
                    
                    listHtml += `
                        <div class="glass-panel" style="padding: 15px; margin-bottom: 10px; display:flex; gap:15px; align-items:flex-start; animation: slideUp 0.3s ease-out;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${bg}; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: ${color}; border: 1px solid ${color}; box-shadow: 0 0 10px ${bg}; flex-shrink: 0;">
                                ${icon}
                            </div>
                            <div style="flex:1;">
                                <div style="font-size: 0.95rem; color: var(--text-main); line-height: 1.4;">${h.msg}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; display: flex; align-items: center; gap: 5px;">
                                    <i class="far fa-clock"></i> ${new Date(h.timestamp).toLocaleString('th-TH')}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10000';
            div.innerHTML = `
                <div class="modal-content" style="height: 70vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: rgba(10, 14, 30, 0.95);">
                    <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2);">
                        <div>
                            <h2 style="margin:0; color: var(--primary); text-transform: uppercase; letter-spacing: 1px;">Notification Log</h2>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        </div>
                        <div onclick="document.getElementById('${modalId}').remove()" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.05); cursor: pointer; color: var(--text-muted);">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    
                    <div style="flex:1; overflow-y: auto; padding: 15px;">
                        ${listHtml}
                    </div>
                    
                    <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                        <button class="cyber-btn" style="width: 100%;" onclick="document.getElementById('${modalId}').remove()">
                            <i class="fas fa-check"></i> ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
        }

        function addLiveLog(msg, color = "#00cec9") {
            const mon = document.getElementById('liveMonitorContent');
            if(!mon) return;
            const div = document.createElement('div');
            div.innerText = "> " + msg;
            div.style.color = color;
            div.style.fontFamily = "monospace";
            div.style.fontSize = "0.6rem";
            div.style.fontWeight = "bold";
            div.style.textShadow = `0 0 5px ${color}`;
            mon.appendChild(div);
            if(mon.children.length > 6) mon.removeChild(mon.children[0]);
        }

        function sendAdminLog(msg, type='info') {
            if(!currentUser) return;
            const logs = JSON.parse(localStorage.getItem('mining_live_logs')) || [];
            logs.push({
                timestamp: Date.now(),
                user: currentUser.username,
                msg: msg,
                type: type
            });
            // Keep last 50 logs
            if(logs.length > 50) logs.shift();
            localStorage.setItem('mining_live_logs', JSON.stringify(logs));
        }

        function updateLiveMonitor() {
            const mon = document.getElementById('liveMonitorContent');
            if(!mon) return;
            
            const cmds = [
                "Mining block #" + Math.floor(Math.random()*999999),
                "Verifying hash...",
                "Share accepted (" + (Math.random()*50+10).toFixed(2) + "ms)",
                "Syncing with VPS...",
                "Temperature: " + (Math.random()*10+60).toFixed(1) + "C",
                "Fan Speed: " + Math.floor(Math.random()*20+80) + "%",
                "Calculating nonce...",
                "Peer connected: 192.168.X.X",
                "Network difficulty: " + (Math.random()*100).toFixed(2) + "T"
            ];
            const cmd = cmds[Math.floor(Math.random()*cmds.length)];
            
            // Only add random log if not paused or just randomly
            // We reuse addLiveLog for consistency
            const div = document.createElement('div');
            div.innerText = "> " + cmd;
            div.style.color = "#00cec9";
            div.style.fontFamily = "monospace";
            div.style.fontSize = "0.6rem";
            mon.appendChild(div);
            if(mon.children.length > 6) mon.removeChild(mon.children[0]);
        }

        setInterval(() => {
            if(document.getElementById('liveMonitor')?.style.display === 'block') updateLiveMonitor();
        }, 800);

        function loadSystemSettings() {
            document.getElementById('swSound').checked = soundMgr.enabled;
            document.getElementById('swVib').checked = vibMgr.enabled;
            document.getElementById('swWake').checked = localStorage.getItem('wake_enabled') === 'true';
            document.getElementById('swMonitor').checked = localStorage.getItem('monitor_enabled') === 'true';
            
            if(localStorage.getItem('wake_enabled') === 'true') toggleWakeLock(true);
            if(localStorage.getItem('monitor_enabled') === 'true') document.getElementById('liveMonitor').style.display = 'block';
            
            document.getElementById('selSound').value = soundMgr.type;
            document.getElementById('selVib').value = vibMgr.type;
        }

        function saveSystemSetting(key, value) {
            localStorage.setItem(key, value);
            if(key === 'sound_enabled') soundMgr.enabled = value;
            if(key === 'sound_type') soundMgr.type = value;
            if(key === 'vib_enabled') vibMgr.enabled = value;
            if(key === 'vib_type') vibMgr.type = value;
            if(key === 'wake_enabled') toggleWakeLock(value);
            if(key === 'monitor_enabled') document.getElementById('liveMonitor').style.display = value ? 'block' : 'none';
        }
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `ai-toast ${type}`;
            
            let icon = 'fa-info-circle';
            if(type === 'success') icon = 'fa-check-circle';
            if(type === 'error') icon = 'fa-exclamation-circle';
            if(type === 'warning') icon = 'fa-exclamation-triangle';

            toast.innerHTML = `
                <i class="fas ${icon}" style="font-size: 1.2rem;"></i>
                <div>
                    <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 2px;">SYSTEM NOTIFICATION</div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">${msg}</div>
                </div>
            `;

            container.appendChild(toast);

            if(typeof soundMgr !== 'undefined') {
                if(type === 'error') soundMgr.play('alert');
                else soundMgr.play('standard');
            }
            if(typeof vibMgr !== 'undefined') vibMgr.trigger('standard');

            // Auto remove
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        let clickCount = 0;
        function emergencyExit() {
            clickCount++;
            if(clickCount >= 5) {
                // Override local maintenance check
                sessionStorage.setItem('maintenance_bypass', 'true'); 
                document.getElementById('maintenanceOverlay').style.display = 'none';
                showToast('Emergency Bypass Activated', 'warning');
                clickCount = 0;
            }
        }

        // --- System Sync Loop ---
        setInterval(() => {
            // 1. Update Last Active (Heartbeat)
            if(currentUser) {
                localStorage.setItem(`last_active_${currentUser.username}`, Date.now());
            }

            // 2. Check Maintenance Mode
            const bypass = sessionStorage.getItem('maintenance_bypass');
            const maint = localStorage.getItem('mining_maintenance');
            const overlay = document.getElementById('maintenanceOverlay');
            
            if (maint === 'true' && bypass !== 'true') {
                const msg = localStorage.getItem('mining_maintenance_msg') || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏ö...';
                const msgEl = document.getElementById('maintMessage');
                if(msgEl) msgEl.innerHTML = msg.replace(/\n/g, '<br>');
                if(overlay) overlay.style.display = 'flex';
            } else {
                if(overlay) overlay.style.display = 'none';
            }

            // 3. Update Connection Status
            const statusEl = document.getElementById('miningStatus');
            if(statusEl) {
                if(navigator.onLine) {
                    statusEl.innerHTML = '<i class="fas fa-wifi"></i> CONNECTED';
                    statusEl.style.color = '#00f2ff';
                    statusEl.style.textShadow = '0 0 10px #00f2ff';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> OFFLINE';
                    statusEl.style.color = '#ff7675';
                    statusEl.style.textShadow = 'none';
                }
            }

            // 4. Check User Notifications (Real-time Admin Alerts)
            if(currentUser) {
                let notifs = JSON.parse(localStorage.getItem(`notifications_${currentUser.username}`)) || [];
                let unread = notifs.filter(n => !n.read);
                
                if(unread.length > 0) {
                    unread.forEach(n => {
                        showToast(n.msg, n.type);
                        n.read = true;
                        
                        // Add to local notification history if exists
                        addNotification(n.msg, n.type);
                    });
                    localStorage.setItem(`notifications_${currentUser.username}`, JSON.stringify(notifs));
                    
                    // Sound & Vib
                    if(typeof soundMgr !== 'undefined') soundMgr.play('alert');
                    if(typeof vibMgr !== 'undefined') vibMgr.trigger('alert');
                }
            }

            // 5. Update Announcement
            let _rawAnn = localStorage.getItem('mining_announcement');
            let annData = null;
            try { annData = _rawAnn ? JSON.parse(_rawAnn) : null; } catch (_) { annData = _rawAnn ? { msg: _rawAnn, date: new Date().toISOString() } : null; }
            const annEl = document.getElementById('dashboardAnnounce');
            if(annEl && annData) {
                // Only update if text is different to avoid flicker
                if(annEl.innerText !== annData.msg) {
                    annEl.innerText = annData.msg;
                    // Show badge if new
                    const annBadge = document.getElementById('annBadge');
                    if(annBadge) annBadge.style.display = 'block';
                    
                    // Marquee effect if too long
                    if(annData.msg.length > 40) {
                        annEl.innerHTML = `<marquee scrollamount="5">${annData.msg}</marquee>`;
                    }
                }
            }
        }, 2000);
    </script>
    <div id="toastContainer"></div>
</body>
</html>
