<!DOCTYPE html>
<!-- 
    SYSTEM: Crypto Miner Tycoon
    BACKEND: Hybrid (LocalStorage / MySQL Ready)
    DATABASE SCHEMA: See database.sql
-->
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Miner Tycoon</title>
     <link rel="icon" href="BTC.png" sizes="32x32" />
    <script src="live-sync.js"></script>
    <script>
        // API Base URL Fix for file:// protocol and Live Server
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (typeof url === 'string' && url.startsWith('/api/')) {
                // If running on file protocol
                if (location.protocol === 'file:') {
                    const baseUrl = 'http://localhost:3002';
                    url = baseUrl + url;
                } 
                // If running on a different port (e.g. Live Server on 5500)
                else if (location.port !== '3002') {
                    // Use the same hostname (e.g. IP address) but port 3002
                    const baseUrl = `http://${location.hostname}:3002`;
                    url = baseUrl + url;
                }
            }
            return originalFetch(url, options);
        };
    </script>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="BTC.png" sizes="32x32" />
    <link rel="shortcut icon" type="image/png" href="BTC.png">
    <link rel="apple-touch-icon" href="BTC.png">
    <meta name="theme-color" content="#4e54c8">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=1.2">
    <style>
        /* AI Toast System */
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 11000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .ai-toast { pointer-events: auto; background: rgba(10, 14, 30, 0.95); backdrop-filter: blur(10px); border-left: 4px solid #00f2ff; border-radius: 4px; padding: 15px 20px; color: var(--text-main); box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 15px; min-width: 300px; transform: translateX(100%); animation: slideIn 0.3s ease-out forwards; overflow: hidden; position: relative; }
        .ai-toast::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #00f2ff, transparent); animation: scan 2s linear infinite; }
        .ai-toast.success { border-color: #00b894; }
        .ai-toast.error { border-color: #ff7675; }
        .ai-toast.warning { border-color: #fdcb6e; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { transform: translateX(100%); opacity: 0; } }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* AI Maintenance Overlay */
        .maint-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #00f2ff; font-family: 'Kanit', sans-serif; backdrop-filter: blur(15px); overflow: hidden; }
        .maint-content { text-align: center; position: relative; z-index: 2; padding: 40px; border: 1px solid var(--border); border-radius: 20px; background: var(--bg-panel); box-shadow: 0 0 30px rgba(0, 242, 255, 0.1); max-width: 90%; width: 400px; }
        .maint-icon { font-size: 4rem; margin-bottom: 20px; animation: pulse 2s infinite; text-shadow: 0 0 20px rgba(0, 242, 255, 0.5); }
        .maint-title { font-size: 2rem; font-weight: bold; margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase; background: linear-gradient(90deg, #fff, #00f2ff); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .maint-desc { color: #aaa; font-size: 1rem; line-height: 1.6; }
        .maint-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px); background-size: 30px 30px; pointer-events: none; z-index: 1; }
        .maint-scanline { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: rgba(0, 242, 255, 0.3); opacity: 0.5; animation: scanline 3s linear infinite; pointer-events: none; z-index: 1; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes scanline { 0% { top: -10%; } 100% { top: 110%; } }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check maintenance status
            fetch('/api/maintenance-status')
                .then(response => response.json())
                .then(data => {
                    if (data.maintenance) {
                        // Create and show a maintenance notice
                        const maintenanceNotice = document.createElement('div');
                        maintenanceNotice.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            background-color: #ffc107;
                            color: #333;
                            text-align: center;
                            padding: 15px;
                            font-size: 1.2rem;
                            z-index: 10000;
                            border-bottom: 2px solid #e0a800;
                        `;
                        maintenanceNotice.innerHTML = '<i class="fas fa-tools"></i> <strong>แจ้งเตือน:</strong> ขณะนี้ระบบกำลังอยู่ในช่วงบำรุงรักษา ขออภัยในความไม่สะดวกครับ';
                        document.body.prepend(maintenanceNotice);

                        // Optional: Disable login/register buttons
                        const loginButton = document.querySelector('a[href="login.html"]');
                        if (loginButton) {
                            loginButton.style.pointerEvents = 'none';
                            loginButton.style.opacity = '0.6';
                            loginButton.title = 'ระบบกำลังบำรุงรักษา';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching maintenance status:', error);
                });
        });
    </script>
<style>
        /* Custom Styles for Announcement Card */
        @keyframes borderFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        .ai-announce-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 5px 30px rgba(0, 242, 255, 0.2) !important;
        }
        .modal-content {
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

    <div id="maintenanceOverlay" class="maint-overlay" style="display: none;">
        <div class="maint-grid"></div>
        <div class="maint-scanline"></div>
        <div class="maint-content">
            <i class="fas fa-microchip maint-icon" onclick="emergencyExit()"></i>
            <div class="maint-title">ระบบออฟไลน์</div>
            <div style="color: #00f2ff; font-size: 1.2rem; margin-bottom: 10px; font-weight: bold;">เครื่องขุดรายวันและต่อเดือน</div>
            <p id="maintMessage" class="maint-desc">กำลังอัปเกรดระบบเพื่อประสิทธิภาพที่ดียิ่งขึ้น<br>กรุณารอสักครู่..</p>
            <div style="margin-top: 20px; font-size: 0.8rem; color: rgba(0, 242, 255, 0.5);">ระบบความปลอดภัย AI: ทำงาน</div>
        </div>
    </div>

    <div class="app-container">
        
        <div class="top-header">
    <div class="profile-pill" onclick="openNotificationHistory()">
        <div class="avatar-small" id="headerAvatar"><i class="fas fa-user"></i></div>
        <div>
            <div id="headerName" class="header-name">Guest</div>
            <div id="headerID" class="header-id">ID: ---</div>
        </div>
        <div style="margin-left: 5px; position: relative;">
            <i class="fas fa-bell" style="color: #aaa; font-size: 0.9rem;"></i>
            <div id="headerNotifBadge" class="neon-badge" style="position: absolute; top: -8px; right: -8px; display: none;">0</div>
        </div>
    </div>
    
    <!-- ✅ เพิ่มปุ่ม Refresh ที่นี่ -->
    <div style="display: flex; gap: 15px; align-items: center;">
        <div id="netStatus" style="font-size: 1rem; cursor: help;" title="เครือข่ายความเร็วสูง">
            <i class="fas fa-wifi" style="color: #00ff9d;"></i>
        </div>
        <div style="font-size: 1rem; cursor: pointer; position: relative;" 
             onclick="manualRefresh()" 
             title="รีเฟรชข้อมูล (Ctrl+R)">
            <i class="fas fa-sync" id="refreshIcon"></i>
            <span id="syncStatus" style="position: absolute; top: -5px; right: -5px; width: 8px; height: 8px; background: #00ff9d; border-radius: 50%; box-shadow: 0 0 5px #00ff9d;"></span>
        </div>
        <div style="font-size: 1.2rem;" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
        </div>
    </div>
</div>
                    
        <div class="page active" id="dashboardPage">
            <!-- AI Dashboard Card (Consolidated Stats) -->
            <div class="ai-dashboard-card">
                <div style="position: absolute; top: 15px; right: 15px; z-index: 10;">
                    <button onclick="confirmReset()" style="background: rgba(255, 0, 85, 0.1); border: 1px solid rgba(255, 0, 85, 0.3); color: #ff0055; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;" onmouseover="this.style.background='rgba(255, 0, 85, 0.2)'" onmouseout="this.style.background='rgba(255, 0, 85, 0.1)'" title="รีเซ็ตข้อมูล">
                        <i class="fas fa-redo-alt" style="font-size: 0.8rem;"></i>
                    </button>
                </div>
                <div class="ai-core-visual">
                    <div class="ai-core-inner"></div>
                    <i class="fas fa-microchip" style="font-size: 2rem; color: var(--primary); position: absolute; z-index: 2; filter: drop-shadow(0 0 10px var(--primary));"></i>
                </div>
                <h2 style="margin: 0 0 5px; color: var(--text-main); font-size: 1.5rem; letter-spacing: 1px;">ระบบขุด AI</h2>
                <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 15px;">
                    <div style="font-size: 0.8rem; color: #94a3b8;">สถานะ: <span id="miningStatus" style="color: var(--success); text-shadow: 0 0 10px var(--success);">ออนไลน์</span></div>
                    <div style="font-size: 0.8rem; color: #94a3b8;">โหมด: <span id="miningMode" style="color: #94a3b8;">พัก</span></div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-item">
                        <div class="label">กำลังขุด</div>
                        <div class="value" id="hashrateDisplay">0.0</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">MH/s</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">รายวัน</div>
                        <div class="value" id="dailyProfitDisplay">฿0.00</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">วันนี้</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">ยอดเงิน</div>
                        <div class="value" id="balanceDisplay">฿0.00</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">บาท</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">รายได้</div>
                        <div class="value" id="incomeDisplay">+฿0.00</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">/วินาที</div>
                        <div style="font-size: 0.65rem; color: var(--success); margin-top: 2px; white-space: nowrap;" id="estDailyDisplay">วันละ ฿0.00</div>
                        <div style="font-size: 0.65rem; color: #00f2ff; margin-top: 2px; white-space: nowrap;" id="monthlyTotalDisplay">เดือนละ ฿0.00</div>
                    </div>
                </div>
            </div>

            <!-- Mining Connection Alert (Hidden by default) -->
            <div id="miningConnectionStatus" style="display: none; background: rgba(255, 0, 85, 0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 0, 85, 0.3); margin: 15px 0; animation: slideIn 0.3s ease-out;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 40px; height: 40px; background: rgba(255, 0, 85, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas fa-wifi-slash" style="color: var(--danger); font-size: 1.2rem; animation: pulse 1s infinite;"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: var(--danger); font-size: 0.95rem;">ขาดการเชื่อมต่อเครื่องขุด</div>
                        <div style="font-size: 0.8rem; color: #cbd5e1;">ระบบกำลังพยายามเชื่อมต่อใหม่...</div>
                    </div>
                    <button onclick="reconnectMining()" class="cyber-btn" style="padding: 8px 15px; font-size: 0.8rem; white-space: nowrap; background: var(--danger); border: none; box-shadow: 0 0 10px rgba(255, 0, 85, 0.3);">
                        <i class="fas fa-sync"></i> เชื่อมต่อ
                    </button>
                </div>
            </div>

            // AI Announcement Board
            <div class="ai-announce-card" onclick="openAnnounceModal()" style="cursor: pointer; margin: 20px 0; position: relative; overflow: hidden; border-radius: 16px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(0, 242, 255, 0.2); box-shadow: 0 0 20px rgba(0, 242, 255, 0.1); transition: 0.3s; transform-style: preserve-3d;">
                <!-- Scanline effect -->
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none;"></div>
                <!-- Glowing Border Animation -->
                <div style="position: absolute; inset: 0; border-radius: 16px; padding: 1px; background: linear-gradient(90deg, transparent, #00f2ff, transparent); mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: borderFlow 2s linear infinite;"></div>
                
                <div style="padding: 20px; display: flex; gap: 20px; align-items: center; position: relative; z-index: 2;">
                    <!-- Animated Icon -->
                    <div style="width: 60px; height: 60px; border-radius: 15px; background: rgba(0, 242, 255, 0.08); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(0, 242, 255, 0.3); position: relative; box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);">
                        <i class="fas fa-bullhorn" style="color: #00f2ff; font-size: 1.8rem; animation: pulse 2s infinite;"></i>
                        <div style="position: absolute; top: -3px; right: -3px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; box-shadow: 0 0 10px #ef4444; animation: blink 1s infinite; display: none;" id="annDot"></div>
                    </div>
                    
                    <!-- Content -->
                    <div style="flex: 1; overflow: hidden;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="color: #00f2ff; font-size: 0.75rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 0 8px rgba(0, 242, 255, 0.6);">ประกาศจากระบบ</span>
                            <span id="annBadge" style="display:none; background: linear-gradient(45deg, #ef4444, #f87171); color: var(--text-main); padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: bold; box-shadow: 0 2px 5px rgba(239, 68, 68, 0.4); animation: bounce 1s infinite;">ใหม่</span>
                            <span id="annLabel" style="font-size: 0.7rem; color: #94a3b8; margin-left: auto; display: flex; align-items: center; gap: 5px;">
                                ตรวจสอบ <i class="fas fa-chevron-right" style="font-size: 0.6rem;"></i>
                            </span>
                        </div>
                        <div id="dashboardAnnounce" style="color: #e2e8f0; font-family: 'Kanit', sans-serif; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 0 2px rgba(0,0,0,0.5); font-weight: 300;">
                            รอโหลดข้อมูล...
                        </div>
                    </div>
                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-item" onclick="openShopPage()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem;"><i class="fas fa-shopping-cart"></i></div>
                    <div class="menu-label">ร้านค้า</div>
                    <div id="shopBadgeFloat" class="badge-float" style="display: none;">ใหม่</div>
                </div>
                <div class="menu-item" onclick="openWalletModal('deposit')">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--success); box-shadow: 0 0 10px rgba(0, 255, 157, 0.2);"><i class="fas fa-arrow-circle-down" style="color: var(--success);"></i></div>
                    <div class="menu-label">ฝากเงิน</div>
                    <div id="depositBadge" class="badge-float" style="background: var(--success); display: none;">สำเร็จ</div>
                </div>
                <div class="menu-item" onclick="openWalletModal('withdraw')">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--warning); box-shadow: 0 0 10px rgba(255, 184, 0, 0.2);"><i class="fas fa-arrow-circle-up" style="color: var(--warning);"></i></div>
                    <div class="menu-label">ถอนเงิน</div>
                    <div id="withdrawBadge" class="badge-float" style="background: var(--warning); display: none;">อัปเดต</div>
                </div>
                <div class="menu-item" onclick="showBankModal()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem;"><i class="fas fa-university"></i></div>
                    <div class="menu-label">บัญชีธนาคาร</div>
                </div>
                <div class="menu-item" onclick="showReferralModal()">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--danger); box-shadow: 0 0 10px rgba(255, 0, 85, 0.2);"><i class="fas fa-users" style="color: var(--danger);"></i></div>
                    <div class="menu-label">แนะนำเพื่อน</div>
                    <div class="badge-float" style="background: var(--danger); animation: none; top: -5px; right: -5px;">มาแรง</div>
                </div>
                <div class="menu-item" onclick="switchPage('settingsPage', document.getElementById('navSettings'))">
                    <div class="cyber-icon-box" style="width: 50px; height: 50px; font-size: 1.2rem; border-color: var(--text-muted);"><i class="fas fa-cog" style="color: var(--text-muted);"></i></div>
                    <div class="menu-label">ตั้งค่า</div>
                </div>
            </div>

            <!-- Active Contracts Section -->
            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px;">
                    <div style="font-size: 0.9rem; color: var(--text-main); font-weight: bold; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-file-contract" style="color: var(--primary);"></i>
                        สัญญาการขุด
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);" id="activeContractCount">0 รายการ</div>
                </div>
                <div id="activeContractsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>

            <!-- Server Status -->
            <div style="margin-top: 20px; padding: 15px; background: var(--bg-panel); border-radius: 10px; border: 1px solid var(--border-subtle); margin-bottom: 80px;">
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">สถานะเซิร์ฟเวอร์</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); animation: pulse 2s infinite;"></div>
                    <span style="color: var(--success); font-weight: bold; font-size: 0.9rem;">LIVE SYSTEM</span>
                </div>
                <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 5px;">MySQL Ready (Mode: Hybrid)</div>
            </div>
        </div>

        <div class="page" id="shopPage">
            <h2 style="margin-left: 10px; margin-bottom: 20px; border-left: 4px solid var(--primary); padding-left: 10px; letter-spacing: 1px; color: var(--text-main); text-shadow: 0 0 15px rgba(0,0,0,0.8);">เครื่องขุดสินค้าใหม่ (New Mining Rigs)</h2>
            <div id="shopList" class="shop-grid-new"></div>
        </div>

        <div class="page" id="walletPage">
            <h2>ประวัติธุรกรรม</h2>
            <div id="transList" style="margin-top: 10px;"></div>
        </div>

        <div class="page" id="settingsPage">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 100px; height: 100px; margin: 0 auto; position: relative;">
                    <div class="avatar-small" style="width: 100%; height: 100%; border: 4px solid rgba(255,255,255,0.1);" id="settingAvatar">
                        <i class="fas fa-user" style="font-size: 3rem;"></i>
                    </div>
                    <div onclick="document.getElementById('uploadProfile').click()" style="position: absolute; bottom: 0; right: 0; background: var(--accent); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <i class="fas fa-camera" style="font-size: 0.8rem; color: #000;"></i>
                    </div>
                </div>
                <input type="file" id="uploadProfile" hidden accept="image/*" onchange="changeProfilePic()">
                <h2 id="settingName" style="margin: 10px 0 5px;">ชื่อผู้ใช้</h2>
                <div id="settingID" style="color: var(--text-muted);">ID: ---</div>
                <div style="margin-top: 5px; color: #00b894; font-size: 0.8rem;"><i class="fas fa-circle" style="font-size: 6px;"></i> ออนไลน์</div>
            </div>

            <div class="menu-list-item" onclick="showBankModal()">
                <i class="fas fa-university" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">บัญชีธนาคารของฉัน</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <div id="installAppBtn" class="menu-list-item" style="display: none; background: linear-gradient(90deg, rgba(112, 0, 255, 0.2), rgba(0, 242, 255, 0.2)); border: 1px solid var(--primary);" onclick="installPWA()">
                <i class="fas fa-download" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">ติดตั้งแอปพลิเคชัน</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <div class="menu-list-item" onclick="showRemoteGuide()">
                <i class="fas fa-mobile-alt" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">การเข้าถึงระยะไกล</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <div class="menu-list-item" onclick="showUpdateHistoryModal()">
                <i class="fas fa-history" style="font-size: 1.2rem;"></i>
                <div style="flex: 1;">ประวัติการอัปเดตซอฟต์แวร์</div>
                <i class="fas fa-chevron-right" style="font-size: 1rem; color: var(--text-muted);"></i>
            </div>

            <!-- Referral Card -->
            <div class="menu-list-item" style="background: linear-gradient(135deg, rgba(255, 0, 85, 0.1), rgba(0, 0, 0, 0)); border: 1px solid var(--danger);" onclick="showReferralModal()">
                <div style="display: flex; align-items: center; width: 100%;">
                    <div style="background: rgba(255, 0, 85, 0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 0 10px var(--danger);">
                        <i class="fas fa-user-plus" style="color: var(--danger); margin: 0;"></i>
                    </div>
                    <div style="flex: 1; color: var(--danger);">
                        <div style="font-weight: bold;">ชวนเพื่อนรับรางวัล</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">คุณรับ ฿50 + เพื่อนรับ ฿100</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: var(--danger);"></i>
                </div>
            </div>

            <div style="margin-top: 20px; margin-bottom: 10px; color: var(--text-muted); font-size: 0.8rem; padding-left: 5px;">การตั้งค่าระบบ</div>

            <!-- Theme -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-moon" style="width:20px;"></i> โหมดมืด</div>
                    <div class="switch-sub">เปิดใช้งานธีมสีเข้ม</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swTheme" onchange="saveSystemSetting('theme_dark', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Sound -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-volume-up" style="width:20px;"></i> เสียงเตือน</div>
                    <div class="switch-sub">เสียงแจ้งเตือน</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swSound" onchange="saveSystemSetting('sound_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <select id="selSound" class="input-dark" style="margin-bottom: 15px;" onchange="saveSystemSetting('sound_type', this.value); soundMgr.play(this.value);">
                <option value="standard">มาตรฐาน</option>
                <option value="alert">แจ้งเตือน</option>
                <option value="emphasis">เน้นข้อความ</option>
                <option value="rapid">รัว</option>
                <option value="fast">เร็ว</option>
            </select>

            <!-- Vibration -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-mobile-alt" style="width:20px;"></i> การสั่น</div>
                    <div class="switch-sub">การสั่นตอบสนอง</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swVib" onchange="saveSystemSetting('vib_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <select id="selVib" class="input-dark" style="margin-bottom: 15px;" onchange="saveSystemSetting('vib_type', this.value); vibMgr.trigger(this.value);">
                <option value="standard">มาตรฐาน</option>
                <option value="fast">เร็ว</option>
                <option value="emphasis">เน้น</option>
                <option value="alert">แจ้งเตือน</option>
            </select>

            <!-- Wake Lock -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-sun" style="width:20px;"></i> เปิดหน้าจอตลอดเวลา</div>
                    <div class="switch-sub">เปิดหน้าจอค้างไว้</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swWake" onchange="saveSystemSetting('wake_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Live Monitor -->
            <div class="switch-group">
                <div>
                    <div class="switch-label"><i class="fas fa-desktop" style="width:20px;"></i> จอภาพสถานะสด</div>
                    <div class="switch-sub">แสดง Logs การทำงาน</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="swMonitor" onchange="saveSystemSetting('monitor_enabled', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

    </div>

    <div id="liveMonitor" style="display: none; position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; border-radius: 8px; padding: 10px; z-index: 900; box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin-bottom: 5px;">
            <div style="color: #00f2ff; font-size: 0.7rem; font-weight: bold; letter-spacing: 1px;"><i class="fas fa-terminal"></i> SYSTEM TERMINAL</div>
            <i class="fas fa-times" style="color: var(--text-muted); cursor: pointer; font-size: 0.8rem;" onclick="document.getElementById('liveMonitor').style.display='none'; document.getElementById('swMonitor').checked=false; saveSystemSetting('monitor_enabled', false);"></i>
        </div>
        <div id="liveMonitorContent" style="height: 100px; overflow-y: auto; font-size: 0.65rem; font-family: 'Courier New', monospace;"></div>
    </div>

    <div class="bottom-nav-glass">
        <div class="nav-btn active" id="navHome" onclick="switchPage('dashboardPage', this)">
            <i class="fas fa-home"></i>
            <div class="nav-label">หน้าแรก</div>
        </div>
        <div class="nav-btn" id="navShop" onclick="openShopPage()">
            <div style="position: relative;">
                <i class="fas fa-shopping-cart"></i>
                <div id="shopBadgeNav" class="nav-badge" style="display: none;"></div>
            </div>
            <div class="nav-label">ร้านค้า</div>
        </div>
        <div class="nav-btn" id="navWallet" onclick="openWalletPage()">
            <div style="position: relative;">
                <i class="fas fa-wallet"></i>
                <div id="navWalletBadge" class="nav-badge" style="display: none;"></div>
            </div>
            <div class="nav-label">ธุรกรรม</div>
        </div>
        <div class="nav-btn" id="navSettings" onclick="switchPage('settingsPage', this)">
            <i class="fas fa-cog"></i>
            <div class="nav-label">ตั้งค่า</div>
        </div>
    </div>

    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid rgba(0, 242, 255, 0.3); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);">
                    <i class="fas fa-user-astronaut" style="font-size: 2.5rem; color: #00f2ff;"></i>
                </div>
                <h2 style="color: #00f2ff; margin: 0; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">MINING PRO</h2>
                <div style="font-size: 0.8rem; color: var(--text-muted); letter-spacing: 1px;">ระบบเข้าสู่ใช้งาน</div>
            </div>
            
            <div class="input-group" style="margin-bottom: 15px;">
                <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 5px; margin-left: 5px;">ชื่อผู้ใช้</div>
                <input type="text" id="loginUser" class="cyber-input" placeholder="กรอกไอดีของคุณ">
            </div>
            <div class="input-group" style="margin-bottom: 25px;">
                <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 5px; margin-left: 5px;">รหัสผ่าน</div>
                <input type="password" id="loginPass" class="cyber-input" placeholder="กรอกรหัสผ่าน">
            </div>
            
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <input type="checkbox" id="rememberMe" style="width: 16px; height: 16px; accent-color: #00f2ff; margin-right: 8px; cursor: pointer;">
                <label for="rememberMe" style="color: var(--text-muted); font-size: 0.85rem; cursor: pointer; user-select: none;">จดจำรหัสผ่าน</label>
            </div>

            <button class="cyber-btn" onclick="login()" style="width: 100%; margin-bottom: 15px;">
                <i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบ
            </button>
            
            <div style="text-align: center; font-size: 0.9rem; color: var(--text-muted);">
                ยังไม่มีบัญชี? <span style="color: #00f2ff; cursor: pointer; text-decoration: underline; text-underline-offset: 3px;" onclick="toSignup()">สมัครสมาชิก</span>
            </div>
        </div>
    </div>

    <div id="signupModal" class="modal">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #00f2ff; margin: 0; letter-spacing: 1px;">ลงทะเบียนสมาชิกใหม่</h2>
                <div style="font-size: 0.8rem; color: var(--text-muted);">สร้างบัญชีเพื่อเริ่มขุด</div>
            </div>
            
            <input type="text" id="regUser" class="cyber-input" placeholder="ชื่อผู้ใช้" style="margin-bottom: 10px;">
            <input type="password" id="regPass" class="cyber-input" placeholder="รหัสผ่าน" style="margin-bottom: 10px;">
            
            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;"></div>
            
            <input type="text" id="regName" class="cyber-input" placeholder="ชื่อ-นามสกุล (ชื่อจริง)" style="margin-bottom: 10px;">
            <select id="regBank" class="cyber-input" style="margin-bottom: 10px;">
                <option value="kbank">KBANK - กสิกรไทย</option>
                <option value="scb">SCB - ไทยพาณิชย์</option>
                <option value="ktb">KTB - กรุงไทย</option>
                <option value="bbl">BBL - กรุงเทพ</option>
                <option value="gsb">GSB - ออมสิน</option>
            </select>
            <input type="tel" id="regAcc" class="cyber-input" placeholder="เลขบัญชีธนาคาร" style="margin-bottom: 10px;">
            
            <!-- Referral Code Input -->
            <div style="position: relative; margin-bottom: 20px;">
                <input type="text" id="regRefCode" class="cyber-input" placeholder="รหัสแนะนำเพื่อน (ถ้ามี)" style="padding-right: 40px;">
                <i class="fas fa-ticket-alt" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #00f2ff;"></i>
            </div>
            
            <button class="cyber-btn" onclick="signup()" style="width: 100%; margin-bottom: 15px;">
                <i class="fas fa-user-plus"></i> ยืนยันการสมัคร
            </button>
            
            <div style="text-align: center; font-size: 0.8rem; cursor: pointer; color: var(--text-muted);" onclick="toLogin()">
                <i class="fas fa-arrow-left"></i> กลับไปหน้าเข้าสู่ระบบ
            </div>
        </div>
    </div>

    <div id="referralConfirmModal" class="modal">
        <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #ff0055; box-shadow: 0 0 30px rgba(255, 0, 85, 0.2); text-align: center; max-width: 350px;">
            <div style="width: 70px; height: 70px; background: rgba(255, 0, 85, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 1px solid rgba(255, 0, 85, 0.3); box-shadow: 0 0 15px rgba(255, 0, 85, 0.2);">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ff0055;"></i>
            </div>
            <h3 style="color: #ff0055; margin: 0 0 10px; font-size: 1.3rem; letter-spacing: 1px;">ไม่พบรหัสแนะนำเพื่อน</h3>
            <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 25px; line-height: 1.6;">
                รหัสที่คุณระบุไม่ถูกต้อง หรืออาจถูกยกเลิกไปแล้ว<br>
                <span style="color: var(--text-main); font-weight: bold;">ต้องการสมัครต่อโดยไม่มีผู้แนะนำหรือไม่?</span>
            </p>
            
            <div style="display: flex; gap: 10px;">
                <button class="cyber-btn" onclick="closeReferralConfirm()" style="flex: 1; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--text-muted);">
                    <i class="fas fa-times"></i> ยกเลิก
                </button>
                <button class="cyber-btn" onclick="confirmSignupNoRef()" style="flex: 1; background: linear-gradient(45deg, #ff0055, #ff5e00); box-shadow: 0 0 15px rgba(255, 0, 85, 0.4); border: none;">
                    <i class="fas fa-check"></i> สมัครเลย
                </button>
            </div>
        </div>
    </div>

    <div id="walletModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position: absolute; right: 15px; top: 15px; cursor: pointer;" onclick="document.getElementById('walletModal').style.display='none'"></i>
            <h3 id="walletTitle">ทำรายการ</h3>
            <input type="number" id="walletAmount" class="input-dark" placeholder="ระบุจำนวนเงิน">
            <button class="btn-action" onclick="submitTransaction()">ยืนยัน</button>
        </div>
    </div>

    <div id="bankModal" class="modal">
        <div class="modal-content">
            <i class="fas fa-times" style="position: absolute; right: 15px; top: 15px; cursor: pointer;" onclick="document.getElementById('bankModal').style.display='none'"></i>
            <h3>บัญชีธนาคารของฉัน</h3>
            <div id="myBankInfo"></div>
        </div>
    </div>

    <div id="refModal" class="modal">
        <div class="modal-content" style="padding: 0; overflow: hidden; background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; width: 90%; max-width: 400px; border-radius: 16px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.1);">
            <div style="padding: 15px; max-height: 80vh; overflow-y: auto;">
                <i class="fas fa-times" style="position: absolute; right: 10px; top: 10px; cursor: pointer; z-index: 10; color: var(--text-muted); background: rgba(255,255,255,0.05); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onclick="document.getElementById('refModal').style.display='none'"></i>
                
                <!-- Header Banner -->
                <div class="ref-banner" style="background: linear-gradient(135deg, rgba(0, 242, 255, 0.1) 0%, rgba(0, 242, 255, 0.05) 100%); border: 1px solid rgba(0, 242, 255, 0.2); border-radius: 15px; padding: 15px; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0, 242, 255, 0.1); margin-bottom: 15px;">
                    <div style="position: relative; z-index: 2;">
                        <h2 style="margin: 0; font-size: 1.3rem; color: #00f2ff; font-weight: 800; letter-spacing: 1px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);">เครือข่ายเพื่อน</h2>
                        <p style="margin: 5px 0 10px; font-size: 0.8rem; color: var(--text-muted);">ขยายเครือข่ายการขุดของคุณ</p>
                        <div style="display: inline-block; background: rgba(0, 242, 255, 0.1); padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; color: #00f2ff; border: 1px solid rgba(0, 242, 255, 0.3);">
                            <i class="fas fa-users"></i> โปรแกรมแนะนำเพื่อน
                        </div>
                    </div>
                    <i class="fas fa-network-wired" style="position: absolute; right: -15px; bottom: -20px; font-size: 6rem; color: rgba(0, 242, 255, 0.05); transform: rotate(-20deg);"></i>
                </div>

                <!-- Stats Row -->
                <div class="ref-stats-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="ref-stat-box" style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="color: var(--warning); font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase;">รออนุมัติ</div>
                        <div class="ref-stat-num" id="refPendingCount" style="color: var(--warning); font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">0</div>
                        <div style="font-size: 0.6rem; color: #64748b;">คน</div>
                    </div>
                    <div class="ref-stat-box" style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="color: var(--success); font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase;">ใช้งานอยู่</div>
                        <div class="ref-stat-num" id="refCompletedCount" style="color: var(--success); font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);">0</div>
                        <div style="font-size: 0.6rem; color: #64748b;">คน</div>
                    </div>
                </div>

                <!-- Referral Code Box -->
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px; text-align: center; text-transform: uppercase;">รหัสแนะนำของคุณ</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(0, 242, 255, 0.05); padding: 12px 15px; border-radius: 8px; border: 1px dashed rgba(0, 242, 255, 0.3); position: relative;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #00f2ff; letter-spacing: 3px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.3); font-family: monospace;" id="myRefCode">---</div>
                        <i class="fas fa-copy" style="cursor: pointer; color: #00f2ff; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: rgba(0, 242, 255, 0.1); border: 1px solid rgba(0, 242, 255, 0.3); transition: 0.3s;" onclick="copyRef()" onmouseover="this.style.background='rgba(0,242,255,0.2)'" onmouseout="this.style.background='rgba(0,242,255,0.1)'"></i>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.7rem; color: #64748b;">
                        แตะไอคอนเพื่อคัดลอกลิงก์เชิญ
                    </div>
                </div>

                <!-- Friend List -->
                <div style="text-align: left; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; color: var(--text-main); padding-left: 5px; border-left: 3px solid #00f2ff; padding-left: 10px;">เพื่อนที่เชื่อมต่อ</div>
                <div id="refList" style="min-height: 100px; margin-bottom: 60px;">
                    <!-- Content -->
                </div>
            </div>
            
            <!-- Bottom Floating Button -->
            <div style="position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; background: linear-gradient(to top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.8)); border-top: 1px solid rgba(255,255,255,0.05);">
                <button class="cyber-btn" onclick="claimBonus()" id="btnClaimBonus" style="width: 100%;">
                    <i class="fas fa-gift"></i> รับรางวัล (0.00)
                </button>
            </div>
        </div>
    </div>

    <div id="announceModal" class="modal">
        <div class="modal-content" style="background: rgba(10, 15, 30, 0.98); border: 1px solid #00f2ff; box-shadow: 0 0 50px rgba(0, 242, 255, 0.3); max-width: 450px; width: 95%; position: relative; overflow: hidden; border-radius: 16px;">
            <!-- Decorative Elements -->
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, transparent, #00f2ff, transparent); animation: scan 2s linear infinite;"></div>
            <div style="position: absolute; top: -50px; right: -50px; width: 100px; height: 100px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; filter: blur(40px);"></div>
            <div style="position: absolute; bottom: -50px; left: -50px; width: 100px; height: 100px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; filter: blur(40px);"></div>
            
            <div style="text-align: center; margin-bottom: 25px; position: relative; z-index: 2; padding-top: 10px;">
                <div style="width: 80px; height: 80px; background: rgba(0, 242, 255, 0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid rgba(0, 242, 255, 0.3); box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);">
                    <i class="fas fa-bullhorn" style="font-size: 2.8rem; color: #00f2ff; animation: pulse 2s infinite;"></i>
                </div>
                <h2 style="color: var(--text-main); margin: 0; font-size: 1.8rem; font-weight: 800; letter-spacing: 2px; text-shadow: 0 0 15px rgba(0, 242, 255, 0.6); font-family: 'Kanit', sans-serif;">ประกาศจากระบบ</h2>
                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px; text-transform: uppercase; letter-spacing: 3px;">SYSTEM ANNOUNCEMENT</div>
            </div>
            
            <div class="glass-panel" style="max-height: 60vh; overflow-y: auto; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px;">
                <div id="announceBody" style="color: var(--text-main); font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap; font-weight: 300;"></div>
            </div>
            
            <button class="cyber-btn" style="width: 100%; height: 50px; font-size: 1.1rem; letter-spacing: 1px; background: linear-gradient(90deg, #00f2ff, #00c3ff); color: #000; font-weight: bold; border: none; box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);" onclick="closeAnnounce()">
                <i class="fas fa-check-circle"></i> รับทราบ
            </button>
        </div>
    </div>

    <div id="warningFloatBadge" style="display: none; position: fixed; top: 20%; right: 0; z-index: 9900; background: rgba(255, 0, 85, 0.9); color: var(--text-main); padding: 12px 15px 12px 12px; border-radius: 12px 0 0 12px; box-shadow: -5px 5px 20px rgba(255, 0, 85, 0.4); cursor: pointer; transition: 0.3s; border-left: 3px solid #fff;" onclick="showLastWarning()">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: blink 1s infinite;"></div>
            <i class="fas fa-exclamation-triangle" style="font-size: 1.2rem;"></i>
            <div style="font-size: 0.8rem; font-weight: bold; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); margin-left: 5px; max-height: 60px;">แจ้งเตือน</div>
        </div>
    </div>

    <script>
        let lastShopUpdate = 0; // Global declaration
        let lastWarningData = null;

        function showLastWarning() {
            if(lastWarningData) {
                showSystemWarningModal(lastWarningData.title, lastWarningData.msg);
            }
        }

        function hideWarningBadge() {
            const badge = document.getElementById('warningFloatBadge');
            if(badge) badge.style.display = 'none';
        }

            function manualRefresh() {
        const icon = document.getElementById('refreshIcon');
        icon.style.animation = 'spin 1s linear';
        
        setTimeout(() => {
            icon.style.animation = 'none';
        }, 1000);
        
        console.log('🔄 Manual refresh');
        liveSync.forceRefresh();
        loadUserData();
        updateUI();
        renderUserTrans();
        renderProfile();
        loadShop();
        
        showToast('✅ ข้อมูลรีเฟรชสำเร็จ', 'success');
    }

    // Add spin animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
        function checkUserBanStatus() {
            if(!currentUser) return;
            
            const isBanned = liveSync.isUserBanned(currentUser.username);
            if(isBanned) {
                showToast('❌ บัญชีถูกระงับชั่วคราว', 'error');
                alert('ขออภัย บัญชีถูกระงับชั่วคราว หากต้องการเปิดใช้บริการ กรุณาติดต่อแอดมิน'); 
                logout();
            }
        }
        // --- PWA Logic ---
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installAppBtn');
            if(btn) btn.style.display = 'flex';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    document.getElementById('installAppBtn').style.display = 'none';
                });
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.log('SW failed:', err));
            });
        }

        // Core Logic
        let currentUser = null;
        let balance = 0.00;
        let hashrate = 0.00;
        let dailyProfit = 0.00;
        let lastProfitDate = new Date().toDateString();
        let lastMiningTime = Date.now(); // Track for delta time calculation
        let currentAction = '';
        let isMining = true;
        let clientIP = 'Unknown';
        
        // Fetch IP
        fetch('https://api.ipify.org?format=json')
            .then(r => r.json())
            .then(d => clientIP = d.ip)
            .catch(e => console.log('IP Fetch Error:', e));

        function getDeviceID() {
            let did = localStorage.getItem('device_id');
            if(!did) {
                did = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('device_id', did);
            }
            return did;
        }

        window.onload = function() {
            // ตรวจสอบ Referral Code
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if(refCode) {
                localStorage.setItem('pending_ref', refCode);
            }

            const saved = localStorage.getItem('current_user');
            let isValidUser = false;

            if(saved) {
                try {
                    const u = JSON.parse(saved);
                    const allUsers = JSON.parse(localStorage.getItem('mining_users')) || {};
                    if(allUsers[u.username] && allUsers[u.username]. banned) {
                        alert('ขออภัย บัญชีถูกระงับชั่วคราว');
                        localStorage.removeItem('current_user');
                        window.location.reload();
                    } else {
                        currentUser = u;
                        document.getElementById('loginModal').style.display = 'none';
                        initApp();
                        isValidUser = true;
                        
                        console.log('👤 Logged in as:', currentUser.username);
                        console.log('📊 Initial Data:', { balance, hashrate });
                    }
                } catch (e) {
                    console.error('User data corrupted', e);
                    localStorage.removeItem('current_user');
                }
            }
            
            if(!isValidUser) {
                document.getElementById('loginModal'). style.display = 'flex';
            }
        };
            // ============ 🔴 LIVE SYNC LISTENERS ============

// เมื่อ Admin เปลี่ยนข้อมูลผู้ใช้
liveSync.on('users', (data) => {
    console.log('📡 Users data updated');
    if(currentUser) {
        const isBanned = data[currentUser. username]?.banned;
        if(isBanned) {
            showToast('❌ บัญชีของคุณถูกระงับ', 'error');
            setTimeout(() => logout(), 2000);
        }
    }
});

// เมื่อ Admin เปลี่ยนธุรกรรม
liveSync.on('transactions', (transactions) => {
    console.log('📡 Transactions updated');
    renderUserTrans();
    
    if(currentUser) {
        const myTrans = transactions.filter(t => t.user === currentUser.username);
        myTrans.forEach(t => {
            if(! t.processed && t.status === 'approved') {
                if(t.type === 'deposit') {
                    showToast(`✅ เติมเงิน ฿${t.amount. toLocaleString()} อนุมัติแล้ว! `, 'success');
                    loadUserData();
                    updateUI();
                }
                if(t.type === 'withdraw') {
                    showToast(`✅ ถอนเงิน ฿${t.amount.toLocaleString()} อนุมัติแล้ว!`, 'success');
                }
            }
            if(! t.processed && t.status === 'rejected') {
                showToast(`❌ ธุรกรรมถูกปฏิเสธ`, 'error');
            }
        });
    }
});

// เมื่อ Admin อัปเดตร้านค้า
liveSync. on('shop', (data) => {
    console.log('📡 Shop items updated');
    loadShop();
    showToast('🔄 ร้านค้าได้รับการอัปเดต', 'info');
});

// เมื่อ Admin เปลี่ยนโหมดบำรุงรักษา
liveSync.on('maintenance', (data) => {
    console.log('📡 Maintenance status changed', data);
    let isMaint;
    if (data && typeof data.maintenance !== 'undefined') {
        isMaint = data.maintenance === true || data.maintenance === 'true';
    } else {
        isMaint = localStorage.getItem('mining_maintenance') === 'true';
    }
    
    const overlay = document.getElementById('maintenanceOverlay');
    
    if(isMaint) {
        if(overlay) overlay.style.display = 'flex';
        showToast('⚠️ ระบบปิดปรับปรุง', 'warning');
    } else {
        if(overlay) overlay.style.display = 'none';
        showToast('✅ ระบบพร้อมใช้งาน', 'success');
    }
});

// เมื่อ Admin เปลี่ยนข้อมูลการแนะนำเพื่อน
liveSync.on('referrals_updated', (data) => {
    console.log('📡 Referrals updated');
    if(currentUser && data.username === currentUser.username) {
        renderReferralUI();
        showToast('👥 ข้อมูลการแนะนำเพื่อนมีการเปลี่ยนแปลง', 'info');
        
        // Optional: Check for approved referrals to play success sound
        const refs = data.data || [];
        if(refs.some(r => (r.status === 'approved' || r.status === 'completed') && !r.claimed)) {
             if(typeof soundMgr !== 'undefined') soundMgr.play('success');
             showToast('✅ การแนะนำเพื่อนได้รับการอนุมัติแล้ว!', 'success');
        }
    }
});

// เมื่อ Admin โพสต์ประกาศใหม่
liveSync. on('announcement', (data) => {
    console.log('📡 New announcement');
    checkAnnounce();
    showToast('📢 มีประกาศใหม่จากระบบ', 'info');
    
    const badge = document.getElementById('annBadge');
    if(badge) badge.style.display = 'block';
});

// เมื่อโปรไฟล์ผู้ใช้เปลี่ยน
liveSync.on('profile_updated', (data) => {
    if(currentUser && data.username === currentUser.username) {
        console.log('📡 My profile updated');
        loadUserData();
        updateUI();
        renderProfile();
    }
});

// เมื่อแนะนำเพื่อนเปลี่ยน
liveSync.on('referrals_updated', (data) => {
    if(currentUser && data.username === currentUser.username) {
        console.log('📡 My referrals updated');
        renderReferralUI();
        showToast('👥 มีการเปลี่ยนแปลงในระบบแนะนำเพื่อน', 'info');
    }
});

// เมื่อ Admin ส่งคำสั่ง Force Update (เช่น ลบเครื่องขุด)
liveSync.on('force_update', (data) => {
    if(currentUser && data.username === currentUser.username) {
        console.log('📡 Force update received:', data);
        
        if(data.type === 'rig_deleted') {
                    console.log('⚠️ Rig deleted event processed');
                    isMining = false;
                    
                    // 1. Recalculate & Save Hashrate (Crucial!)
                    let active = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
                    hashrate = active.reduce((sum, item) => sum + (item.speed || 0), 0);
                    saveData();

                    // 2. Refresh Data & UI
                    loadUserData();
                    renderActiveContracts();
                    updateUI();
                    
                    // 2.5 Force Pause UI Update
                    const btnMode = document.getElementById('miningMode');
                    if(btnMode) {
                        btnMode.innerText = 'พัก';
                        btnMode.style.color = '#94a3b8';
                        btnMode.style.textShadow = 'none';
                    }

                    // 3. Notification
                    if(soundMgr) soundMgr.play('alert');
                    
                    setTimeout(() => {
                        const rigName = data.rigName || 'ไม่ระบุชื่อ';
                        const profitShow = dailyProfit ? dailyProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00';
                        
                        if(hashrate > 0) {
                             alert(`⚠️ เครื่องขุด "${rigName}" ถูกลบโดย Admin\n💰 กำไรวันนี้: ฿${profitShow}\n✅ ระบบกำลังเริ่มขุดใหม่ด้วยเครื่องที่เหลือ...`);
                        } else {
                             // Ask to buy more
                             if(confirm(`⚠️ เครื่องขุด "${rigName}" ถูกลบโดย Admin\n💰 กำไรวันนี้: ฿${profitShow}\n⛔ การขุดหยุดลงชั่วคราว\n🛒 ต้องการซื้อเครื่องขุดใหม่หรือไม่?`)) {
                                 openShopPage();
                             }
                        }
                    }, 100);
                }
    }
});

// Manual refresh button
document.addEventListener('keydown', (e) => {
    if(e.ctrlKey && e.key === 'r') {
        e. preventDefault();
        console.log('🔄 Manual refresh requested');
        liveSync.forceRefresh();
        renderUserTrans();
        renderProfile();
        loadShop();
        showToast('🔄 ข้อมูลรีเฟรชแล้ว', 'success');
    }
});

console.log('✅ App Live Sync listeners registered');
console.log('Live Sync Status:', liveSync.getStatus());

        function syncMiningData() {
            if(!currentUser) return;
            
            let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser.username}`)) || [];
            let active = JSON.parse(localStorage.getItem(`active_items_${currentUser.username}`)) || [];
            let shopItems = JSON.parse(localStorage.getItem('mining_shop_items')) || [];
            let changed = false;

            // 1. Recover Rigs from Active Items (if Rigs lost)
            if(rigs.length === 0 && active.length > 0) {
                console.log('♻️ Recovering mining_rigs from active_items');
                rigs = active.map(a => {
                    const shopItem = shopItems.find(i => i.id === a.id) || { icon: 'fa-server', price: 0 };
                    return {
                        id: a.id,
                        name: a.name,
                        speed: a.speed,
                        price: shopItem.price || 0,
                        icon: shopItem.icon || 'fa-server',
                        status: 'active',
                        timestamp: Date.now(), // Estimated
                        expiresAt: a.expiresAt
                    };
                });
                localStorage.setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                changed = true;
            }

            // 2. Sync Active Items from Rigs (Source of Truth)
            // This fixes the issue where paid items weren't added to active_items
            if(rigs.length > 0) {
                // Clean Rigs (Remove 0 speed items)
                const cleanRigs = rigs.filter(r => r.speed > 0);
                if(cleanRigs.length !== rigs.length) {
                    console.log('♻️ Removing 0 speed items from rigs');
                    rigs = cleanRigs;
                    localStorage.setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(rigs));
                    changed = true;
                }

                const now = Date.now();
                // Law Enforced: No Expiration
                // Also remove 0 speed items
                const calculatedActive = rigs
                    .filter(r => r.speed > 0)
                    .map(r => ({
                        id: r.id,
                        name: r.name,
                        speed: r.speed,
                        expiresAt: null // r.expiresAt
                    }));
                
                // Compare arrays (simple stringify check)
                if(JSON.stringify(calculatedActive) !== JSON.stringify(active)) {
                    console.log('♻️ Syncing active_items from mining_rigs (Permanent Mode)');
                    localStorage.setItem(`active_items_${currentUser.username}`, JSON.stringify(calculatedActive));
                    active = calculatedActive;
                    changed = true;
                }
            }

            // 3. Verify Hashrate
            const realHashrate = active.reduce((sum, item) => sum + (item.speed || 0), 0);
            if(Math.abs(hashrate - realHashrate) > 0.0000001) {
                console.log(`♻️ Correcting hashrate: ${hashrate} -> ${realHashrate}`);
                hashrate = realHashrate;
                saveData();
                changed = true;
            }

            if(changed) {
                updateUI();
                renderActiveContracts();
            }
        }

        function initApp() {
            // Default Announcement
            if(! localStorage.getItem('mining_announcement')) {
                const defaultAnn = { msg: 'ยินดีต้อนรับสู่ Crypto Miner Tycoon! ', date: new Date().toISOString() };
                localStorage. setItem('mining_announcement', JSON.stringify(defaultAnn));
            }

            loadUserData();
            loadSystemSettings();
            
            // Sync Data Integrity
            syncMiningData();

            // Auto start if possible
            autoMiningController();
            checkExpiration();
            loadShop();
            
            setInterval(miningLoop, 1000);

            renderProfile();
            checkAnnounce();
            checkShopUpdate();

            // ============ 🔴 SYNC LISTENERS ============
            
            // เมื่อ Admin ลบผู้ใช้
            liveSync.on('user_deleted', (data) => {
                if(currentUser && currentUser.username === data.username) {
                    showToast('❌ บัญชีของคุณถูกลบโดยแอดมิน', 'error');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
            });

            // เมื่อ Admin อนุมัติธุรกรรม
            liveSync.on('transaction_approved', (data) => {
                if(currentUser && currentUser.username === data.user) {
                    console.log('Transaction approved:', data);
                    
                    const msg = data.status === 'approved' 
                        ? `✅ ธุรกรรมอนุมัติแล้ว! ฿${data.amount.toLocaleString()}`
                        : `❌ ธุรกรรมถูกปฏิเสธ`;
                    
                    showToast(msg, data.status === 'approved' ?  'success' : 'error');
                    
                    if(data.status === 'approved') {
                        // Reload user data
                        loadUserData();
                        updateUI();
                        renderUserTrans();
                        addNotification(msg, data.status === 'approved' ?  'success' : 'error');
                    }
                    
                    if(typeof soundMgr !== 'undefined') {
                        soundMgr.play('emphasis');
                    }
                    if(typeof vibMgr !== 'undefined') {
                        vibMgr.trigger('emphasis');
                    }
                }
            });

            // เมื่อเปิด/ปิดโหมดบำรุงรักษา
            liveSync.on('maintenance_mode_changed', (data) => {
                const overlay = document.getElementById('maintenanceOverlay');
                const msg = data.enabled 
                    ? 'ระบบกำลังปิดปรับปรุงชั่วคราว...'
                    : 'ระบบพร้อมใช้งานแล้ว';
                
                showToast(msg, data.enabled ? 'warning' : 'success');
                
                if(data.enabled) {
                    overlay.style.display = 'flex';
                } else {
                    overlay.style.display = 'none';
                }
            });

            // เมื่อ Admin เปลี่ยนข้อความบำรุงรักษา
            liveSync.on('maintenance_msg_changed', (msg) => {
                const msgEl = document.getElementById('maintMessage');
                if(msgEl) {
                    msgEl.innerText = msg;
                }
            });

            // เมื่อ Admin โพสต์ประกาศ
            liveSync.on('announcement_posted', (data) => {
                if(data && data.msg) {
                    showToast('📢 มีประกาศใหม่จากระบบ', 'info');
                    checkAnnounce();
                    
                    // Show new badge
                    const badge = document.getElementById('annBadge');
                    if(badge) badge.style.display = 'block';
                }
            });

            // เมื่อ Admin ล้างประกาศ
            liveSync.on('announcement_cleared', () => {
                const annEl = document.getElementById('dashboardAnnounce');
                if(annEl) {
                    annEl.innerText = 'ไม่มีประกาศในขณะนี้';
                }
            });

            // เมื่อ Admin อัพเดตร้านค้า
            liveSync.on('shop_updated', () => {
                console.log('Shop updated from admin');
                loadShop();
            });

            // เมื่อ Admin ลบสินค้า/เพิ่มสินค้า
            liveSync.on('shop_items_updated', (items) => {
                console.log('Shop items updated:', items);
                loadShop();
            });

            // เมื่อ Admin รีเซ็ตรหัสผ่าน
            liveSync.on('password_reset', (data) => {
                if(currentUser && currentUser.username === data.username) {
                    showToast('⚠️ แอดมินรีเซ็ตรหัสผ่านของคุณแล้ว กรุณาเข้าสู่ระบบใหม่', 'warning');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
            });

            // ล้างข้อมูลเก่า
            liveSync.cleanOldData();

            console.log('✅ App Sync Listeners Registered');
            console.log('Sync Manager Debug:', liveSync.debugInfo());
        }

        async function checkServerNotifications() {
            if(!currentUser) return;
            try {
                const res = await fetch(`/api/user/${currentUser.username}/notifications?unread=true`);
                if(res.ok) {
                    const data = await res.json();
                    if(data.success && data.notifications && data.notifications.length > 0) {
                        for(const n of data.notifications) {
                            // Show Toast
                            showToast(n.message, n.type);
                            
                            // Add to local history
                            addNotification(n.message, n.type);
                            
                            // Special handling for Deposit/Withdraw (Banner)
                            if(n.message.includes('ฝากเงิน') || n.message.includes('ถอนเงิน')) {
                                lastWarningData = { 
                                    title: n.type === 'success' ? 'ทำรายการสำเร็จ' : 'รายการถูกปฏิเสธ', 
                                    msg: n.message 
                                };
                                const badge = document.getElementById('warningFloatBadge');
                                if(badge) {
                                    badge.style.display = 'block';
                                    if(typeof soundMgr !== 'undefined') soundMgr.play(n.type === 'success' ? 'success' : 'alert');
                                }
                            }

                            // Mark as read on server
                            await fetch(`/api/user/notifications/read`, { 
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id: n.id })
                            });
                        }
                    }
                }
            } catch(e) {
                console.error('Error checking notifications:', e);
            }
        }



        function checkWalletBadges() {
            // Deposit Badge
            const dBadge = document.getElementById('depositBadge');
            if(localStorage.getItem('wallet_badge_deposit') === 'true') {
                if(dBadge) dBadge.style.display = 'block';
                document.getElementById('navWalletBadge').style.display = 'block';
            } else {
                if(dBadge) dBadge.style.display = 'none';
            }

            // Withdraw Badge
            const wBadge = document.getElementById('withdrawBadge');
            if(localStorage.getItem('wallet_badge_withdraw') === 'true') {
                if(wBadge) wBadge.style.display = 'block';
                document.getElementById('navWalletBadge').style.display = 'block';
            } else {
                if(wBadge) wBadge.style.display = 'none';
            }

            // If no sub-badges, hide nav badge
            if(localStorage.getItem('wallet_badge_deposit') !== 'true' && localStorage.getItem('wallet_badge_withdraw') !== 'true') {
                document.getElementById('navWalletBadge').style.display = 'none';
            }
        }

        function openWalletModal(type) {
            currentAction = type || 'deposit'; // Default to deposit if not specified
            
            // Clear badges
            if(type === 'deposit') localStorage.removeItem('wallet_badge_deposit');
            if(type === 'withdraw') localStorage.removeItem('wallet_badge_withdraw');
            checkWalletBadges();

            const modal = document.getElementById('walletModal');
            const content = modal.querySelector('.modal-content');
            
            // Base structure with Tabs
            content.innerHTML = `
                <div style="position: absolute; right: 15px; top: 15px; cursor: pointer; color: var(--text-muted); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.05);" onclick="document.getElementById('walletModal').style.display='none'">
                    <i class="fas fa-times"></i>
                </div>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 1px;">Wallet</h2>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">จัดการธุรกรรมการเงิน</div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 25px; padding: 5px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <button onclick="switchWalletTab('deposit')" id="tabDeposit" class="cyber-btn" style="flex:1; border-radius: 8px; font-size: 0.9rem;">ฝากเงิน</button>
                    <button onclick="switchWalletTab('withdraw')" id="tabWithdraw" class="cyber-btn" style="flex:1; border-radius: 8px; font-size: 0.9rem;">ถอนเงิน</button>
                </div>

                <div id="walletBody"></div>
            `;
            
            modal.style.display='flex';
            switchWalletTab(currentAction);
        }

        function switchWalletTab(type) {
            currentAction = type;
            const body = document.getElementById('walletBody');
            const tabDep = document.getElementById('tabDeposit');
            const tabWit = document.getElementById('tabWithdraw');
            
            // Update Tabs Style
            if(type === 'deposit') {
                tabDep.classList.add('primary');
                tabDep.style.background = 'var(--primary)';
                tabDep.style.color = '#000';
                tabDep.style.boxShadow = '0 0 15px var(--primary-dim)';
                
                tabWit.classList.remove('primary');
                tabWit.style.background = 'transparent';
                tabWit.style.color = 'var(--text-muted)';
                tabWit.style.boxShadow = 'none';
            } else {
                tabWit.classList.add('primary');
                tabWit.style.background = 'var(--warning)';
                tabWit.style.color = '#000';
                tabWit.style.boxShadow = '0 0 15px rgba(255, 204, 0, 0.3)';
                
                tabDep.classList.remove('primary');
                tabDep.style.background = 'transparent';
                tabDep.style.color = 'var(--text-muted)';
                tabDep.style.boxShadow = 'none';
            }

            let users = JSON.parse(localStorage.getItem('mining_users')) || {};
            let u = users[currentUser.username] || {bank: 'N/A', acc: 'N/A', name: 'Guest'};

            if(type === 'deposit') {
                body.innerHTML = `
                    <div class="glass-panel" style="margin-bottom: 20px; text-align: center; padding: 25px;">
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px;">ระบุจำนวนเงินที่ต้องการฝาก (THB)</div>
                        <div style="position: relative; max-width: 200px; margin: 0 auto;">
                            <input type="number" id="walletAmount" class="cyber-input" placeholder="0.00" 
                                   style="font-size: 1.8rem; text-align: center; height: 60px; color: var(--success); font-weight: bold; padding: 0;" 
                                   oninput="updateDepositUI(this.value)">
                        </div>
                        <div style="font-size: 0.75rem; color: var(--warning); margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> ขั้นต่ำ 1 บาท
                        </div>
                    </div>

                    <!-- Auto QR Section (Hidden by default) -->
                    <div id="qrSection" style="display:none; animation: slideUp 0.3s ease-out;">
                         
                         <div style="text-align: center; margin-bottom: 15px;">
                            <h3 style="color: var(--primary); margin: 0; text-transform: uppercase; letter-spacing: 1px;">QR Payment AP</h3>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">ระบบชำระเงินอัตโนมัติ</div>
                         </div>

                         <div class="glass-panel" style="border: 1px solid var(--primary); box-shadow: 0 0 15px var(--primary-dim); padding: 20px; position: relative; overflow: hidden;">
                            <!-- Header Info -->
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: var(--text-main); margin-bottom: 5px;">ข้อมูลการชำระเงิน</div>
                                <div style="font-size: 1.2rem; color: var(--success); font-weight: bold;">ยอดชำระเงินทั้งหมด <span id="qrAmountDisplay">0.00</span> บาท</div>
                                <div style="font-size: 0.9rem; color: var(--danger); margin-top: 5px; font-weight: bold;" id="qrTimer">กรุณาชำระภายใน 01:00:00</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;" id="qrExpiry">QR Code นี้ใช้ได้ถึง วันที่ --/--/-- เวลา --:--</div>
                            </div>

                            <!-- QR Code & Bank Info -->
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div id="qrContainer" style="background: white; padding: 10px; display: inline-block; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-bottom: 15px;">
                                    <img id="qrImage" src="" style="width: 180px; height: 180px; display: block;">
                                </div>

                                <!-- Warning -->
                                <div style="color: var(--warning); font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; padding: 0 10px; line-height: 1.4;">
                                    <i class="fas fa-exclamation-triangle"></i> โปรดฝากเงินจากบัญชีธนาคาร ที่เป็นชื่อของคุณเท่านั้น
                                </div>

                                <!-- Transfer Route Info -->
                                <div style="margin-top: 15px;">
                                    <!-- From User -->
                                    <div style="font-size: 0.8rem; color: var(--text-muted); text-align: left; margin-bottom: 5px; padding-left: 5px;">ฝากเงินจากบัญชีธนาคาร</div>
                                    <div id="userBankInfoDisplay" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; text-align: left;">
                                        <!-- Populated by JS -->
                                    </div>


                                </div>
                            </div>

                            <!-- Instructions -->
                            <div style="text-align: left; font-size: 0.8rem; color: #cbd5e1; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="margin-bottom: 8px; font-weight: bold; color: var(--primary);">กรุณาทำตามขั้นตอนที่แนะนำ:</div>
                                <div style="margin-bottom: 4px;">1. แคปหน้าจอ QR Code นี้เพื่อนำไปชำระเงิน</div>
                                <div style="margin-bottom: 4px;">2. เปิดแอปพลิเคชันธนาคารบนอุปกรณ์ของท่าน</div>
                                <div style="margin-bottom: 4px;">3. เลือกเมนู "สแกน" หรือ "QR Code" แล้วเลือกรูปภาพที่แคปไว้</div>
                                <div style="margin-bottom: 4px;">4. ตรวจสอบยอดเงินและทำการโอนเงิน</div>
                                <div style="margin-bottom: 4px;">5. บันทึกสลิป แล้วนำมาอัปโหลดในช่องด้านล่างเพื่อยืนยัน</div>
                                <div style="margin-top: 8px; color: var(--warning); line-height: 1.4;">* กรุณาแนบสลิปทุกครั้งเพื่อความรวดเร็วในการตรวจสอบ</div>
                                <div style="margin-top: 10px; font-size: 0.7rem; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px;">
                                    หมายเหตุ: ช่องทางชำระเงินพร้อมเพย์ใช้ได้กับแอปพลิเคชันธนาคารหรือวอลเล็ตที่รองรับการชำระเงินด้วยพร้อมเพย์เท่านั้น
                                </div>
                            </div>

                            <!-- Slip Upload -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">1. อัปโหลด</div>
                                <div style="font-size: 0.7rem; color: #64748b; margin-bottom: 8px;">รองรับไฟล์ jpg, jpeg และ .png ขนาดไม่เกิน 5 MB</div>
                                <input type="file" id="slipUpload" accept="image/*" class="cyber-input" style="padding: 10px; font-size: 0.9rem; height: auto;" onchange="handleSlipSelect(this)">
                                <div id="slipPreview" style="margin-top:10px; text-align:center; display:none;">
                                    <img id="slipPreviewImg" style="max-width:100%; max-height:200px; border-radius:8px; border:1px solid var(--text-muted);">
                                    <div style="font-size:0.7rem; color:var(--success); margin-top:5px;"><i class="fas fa-check-circle"></i> แนบสลิปแล้ว</div>
                                </div>
                                <div style="text-align: center; font-size: 0.8rem; color: var(--primary); margin-top: 10px; opacity: 0.8;">
                                    แอดมินดูตรวจสอบสลิป/ข้อมูล
                                </div>
                            </div>

                            <!-- Buttons -->
                            <div style="display: flex; gap: 10px;">
                                <button id="btnConfirmPayment" class="cyber-btn" onclick="confirmPayment()" style="width: 100%; opacity: 0.5; cursor: not-allowed; filter: grayscale(100%);" disabled>
                                    <i class="fas fa-check"></i> ยืนยันการชำระเงิน
                                </button>
                            </div>

                         </div>
                    </div>
                `;
            } else {
                // Withdrawal Tab
                let users = JSON.parse(localStorage.getItem('mining_users'));
                let u = users[currentUser.username];
                let bankHtml = '';
                
                if(!u.bank || !u.acc) {
                    bankHtml = `<div class="glass-panel" style="border-color: var(--danger); background: rgba(255, 0, 85, 0.05); text-align: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: var(--danger); margin-bottom: 10px;"></i>
                        <div style="color: var(--danger); font-weight: bold; margin-bottom: 5px;">ยังไม่มีบัญชีธนาคาร</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px;">กรุณาเพิ่มบัญชีธนาคารเพื่อรับเงิน</div>
                        <button class="cyber-btn" style="font-size: 0.8rem; padding: 8px 20px;" onclick="document.getElementById('walletModal').style.display='none'; showBankModal();">เพิ่มบัญชีธนาคาร</button>
                    </div>`;
                } else {
                    bankHtml = `
                        <div class="glass-panel" style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--bg-dark), #1a1a2e); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-university" style="font-size: 1.5rem; color: var(--secondary);"></i>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">โอนเข้าบัญชี</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: var(--text-main); letter-spacing: 1px;">${formatBankAcc(u.acc)}</div>
                                <div style="font-size: 0.8rem; color: var(--primary);">${u.bank.toUpperCase()} - ${u.name}</div>
                            </div>
                        </div>
                    `;
                }

                body.innerHTML = `
                    ${bankHtml}
                    
                    <div class="glass-panel" style="text-align: center; margin-bottom: 20px; border: 1px solid var(--warning); box-shadow: 0 0 10px rgba(255, 204, 0, 0.1);">
                        <div style="color: var(--text-muted); font-size: 0.85rem;">ยอดเงินที่ถอนได้</div>
                        <div style="color: var(--warning); font-size: 2rem; font-weight:bold; margin: 5px 0; text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);">${balance.toLocaleString('en-US', {minimumFractionDigits: 2})} <span style="font-size: 1rem; color: var(--text-main);">THB</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">ถอนขั้นต่ำ 200 บาท</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">ระบุจำนวนเงิน</div>
                        <div style="position: relative;">
                            <input type="number" id="walletAmount" class="cyber-input" placeholder="0.00" 
                                   style="padding-right: 80px; font-size: 1.2rem; font-weight:bold; color: var(--text-main);"
                                   oninput="updateWithdrawUI(this.value)">
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); font-weight: bold; cursor: pointer; font-size: 0.85rem; text-transform: uppercase;" onclick="fillMaxWithdraw()">MAX</span>
                        </div>
                    </div>

                    <div class="glass-panel" style="padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                            <span style="color: var(--text-muted);">ยอดถอน</span>
                            <span style="color: var(--text-main);" id="withdrawBaseAmount">0.00 THB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                            <span style="color: var(--text-muted);">ค่าธรรมเนียม (3%)</span>
                            <span style="color: var(--danger);" id="withdrawFee">0.00 THB</span>
                        </div>
                        <div style="width: 100%; height: 1px; background: rgba(255,255,255,0.1); margin: 10px 0;"></div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: bold;">
                            <span style="color: var(--text-muted);">ได้รับสุทธิ</span>
                            <span style="color: var(--success); text-shadow: 0 0 10px var(--success-dim);" id="netWithdrawAmount">0.00 THB</span>
                        </div>
                    </div>

                    <button class="cyber-btn" onclick="submitTransaction()" style="width: 100%; --btn-bg: var(--warning); color: #000;">
                        <i class="fas fa-paper-plane"></i> แจ้งถอนเงิน
                    </button>
                `;
            }
        }

        function updateWithdrawUI(val) {
            const base = document.getElementById('withdrawBaseAmount');
            const fee = document.getElementById('withdrawFee');
            const net = document.getElementById('netWithdrawAmount');
            
            const amt = parseFloat(val);
            
            if(amt && amt > 0) {
                const feeVal = amt * 0.03; // 3% Fee
                const netVal = amt - feeVal;
                
                base.innerText = amt.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
                fee.innerText = feeVal.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
                net.innerText = netVal.toLocaleString('en-US', {minimumFractionDigits: 2}) + " THB";
            } else {
                base.innerText = "0.00 THB";
                fee.innerText = "0.00 THB";
                net.innerText = "0.00 THB";
            }
        }

        function fillMaxWithdraw() {
            const input = document.getElementById('walletAmount');
            input.value = balance;
            updateWithdrawUI(balance);
        }

        let depositTimerInterval = null;

        async function updateDepositUI(val) {
            const qrSec = document.getElementById('qrSection');
            const qrImg = document.getElementById('qrImage');
            const qrContainer = document.getElementById('qrContainer');
            const qrAmtDisp = document.getElementById('qrAmountDisplay');
            const bankInfoDisp = document.getElementById('adminBankInfoDisplay');
            const userBankDisp = document.getElementById('userBankInfoDisplay');
            
            if(val && parseFloat(val) >= 1) {
                if(qrSec) {
                    qrSec.style.display = 'block';
                    
                    const amt = parseFloat(val).toFixed(2);
                    if(qrAmtDisp) qrAmtDisp.innerText = amt;
                    
                    // Get Admin Bank Settings from API
                    const settingsRes = await fetch('/api/admin/settings');
                    const settings = await settingsRes.json();

                    const bankName = settings.admin_bank_name || 'Krungsri Bank';
                    const bankNum = settings.admin_bank_number || '004-717-6082';
                    const accName = settings.admin_acc_name || 'Suphachai Ruedet';
                    
                    const cleanNum = bankNum.replace(/[^0-9]/g, '');
                    
                    // Validate PromptPay ID (Mobile: 10 digits starting with 06,08,09 OR ID Card: 13 digits)
                    const isMobile = /^0[689]\d{8}$/.test(cleanNum);
                    const isIDCard = /^\d{13}$/.test(cleanNum);
                    const isPromptPay = isMobile || isIDCard;

                    if(bankNum && isPromptPay) {
                        if(qrContainer) qrContainer.style.display = 'inline-block';
                        if(qrImg) {
                            qrImg.style.display = 'block';
                            qrImg.src = `https://promptpay.io/${cleanNum}/${val}`;
                        }
                    } else {
                        // Fallback for Bank Account (Manual Transfer)
                        if(qrContainer) qrContainer.style.display = 'none';
                        if(qrImg) qrImg.style.display = 'none';
                    }

                    // Always Show Admin Bank Info (Destination) for Manual Check
                    // Use existing container or inject new one if missing
                    let destContainer = document.getElementById('manualTransferInfo');
                    if(!destContainer) {
                         destContainer = document.createElement('div');
                         destContainer.id = 'manualTransferInfo';
                         destContainer.style.marginTop = '15px';
                         if(qrSec) qrSec.querySelector('.modal-body') ? qrSec.querySelector('.modal-body').appendChild(destContainer) : qrSec.appendChild(destContainer);
                    }
                    
                    // We need to find where to put this info. Ideally replacing the hidden QR or below it.
                    // Let's look for 'qrSection' structure in previous reads.
                    // The qrSection contains qrContainer.
                    
                    if(!isPromptPay && bankNum) {
                        // Determine Bank Color & Icon
                        let bankColor = 'var(--primary)';
                        let bankIcon = 'fa-university';
                        const bName = bankName.toLowerCase();
                        
                        if(bName.includes('krungsri') || bName.includes('bay')) { bankColor = '#fec43b'; } // Yellow
                        else if(bName.includes('kbank') || bName.includes('kasikorn')) { bankColor = '#138f2d'; } // Green
                        else if(bName.includes('scb')) { bankColor = '#4e2e7f'; } // Purple
                        else if(bName.includes('ktb') || bName.includes('krungthai')) { bankColor = '#1ba5e1'; } // Light Blue
                        else if(bName.includes('bbl') || bName.includes('bangkok')) { bankColor = '#1e4598'; } // Dark Blue
                        else if(bName.includes('gsb')) { bankColor = '#eb198d'; } // Pink
                        else if(bName.includes('ttb')) { bankColor = '#0056b8'; } // Blue

                        // Show Big Manual Transfer Box
                        if(qrContainer) {
                            qrContainer.style.display = 'block'; // Use container for text
                            qrContainer.innerHTML = `
                                <div style="padding: 25px 20px; background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%); border-radius: 16px; border: 1px solid ${bankColor}; box-shadow: 0 0 20px ${bankColor}40; position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: ${bankColor}; opacity: 0.1; border-radius: 50%; filter: blur(20px);"></div>
                                    
                                    <div style="color: var(--warning); font-size: 0.85rem; margin-bottom: 15px; background: rgba(255, 193, 7, 0.1); padding: 8px; border-radius: 8px; display: inline-block;">
                                        <i class="fas fa-info-circle"></i> ไม่สามารถสร้าง QR Code ได้ (ไม่ใช่เบอร์พร้อมเพย์)
                                    </div>
                                    
                                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">กรุณาโอนเงินมาที่บัญชี</div>
                                    
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
                                        <i class="fas ${bankIcon}" style="font-size: 1.5rem; color: ${bankColor};"></i>
                                        <div style="font-size: 1.4rem; font-weight: bold; color: ${bankColor}; text-shadow: 0 0 10px ${bankColor}60;">${bankName}</div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; background: rgba(0,0,0,0.4); padding: 12px; border-radius: 12px; margin: 15px 0; border: 1px dashed ${bankColor}60;">
                                        <div style="font-size: 1.6rem; font-weight: bold; color: var(--text-main); letter-spacing: 2px; user-select: all; font-family: monospace;" id="manualBankNum">${bankNum}</div>
                                        <button class="cyber-btn" id="btnCopyBank" style="padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: ${bankColor}20; border: 1px solid ${bankColor}; color: ${bankColor};" 
                                            onclick="copyBankNum(this, '${bankNum}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>

                                    <div style="font-size: 1.1rem; color: var(--text-main); font-weight: 500;">${accName}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">ชื่อบัญชี</div>
                                </div>
                            `;
                        }
                    } else if (qrContainer) {
                        // Reset if it was changed
                        if(!qrContainer.querySelector('img')) {
                             qrContainer.innerHTML = `<img id="qrImage" src="" style="width: 100%; height: auto; border-radius: 8px; display: block;">`;
                             // Re-get img ref
                             const newImg = document.getElementById('qrImage');
                             if(newImg) newImg.src = `https://promptpay.io/${cleanNum}/${val}`;
                        }
                    }

                    // Show User Bank Info (Source)
                    if(userBankDisp) {
                        const users = JSON.parse(localStorage.getItem('mining_users')) || {};
                        // Ensure currentUser is available (it is a global variable in this scope)
                        const u = (typeof currentUser !== 'undefined' && currentUser) ? (users[currentUser.username] || {}) : {};
                        
                        if(u.bank && u.acc) {
                            userBankDisp.innerHTML = `
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="font-weight:bold; font-size:1rem; color: var(--warning); text-transform:uppercase;">${u.bank.toUpperCase()}</div>
                                    <div style="font-size:0.8rem; color:var(--text-muted);">บัญชีของคุณ</div>
                                </div>
                                <div style="font-size:1.1rem; font-weight:bold; color:var(--text-main); letter-spacing:1px; margin: 2px 0;">${u.acc}</div>
                                <div style="font-size:0.85rem; color:var(--text-muted);">${u.name}</div>
                            `;
                        } else {
                             userBankDisp.innerHTML = `
                                <div style="color: var(--danger); font-size: 0.9rem; text-align: center; padding: 10px;">
                                    <i class="fas fa-exclamation-circle"></i> กรุณาเพิ่มบัญชีธนาคารของคุณก่อนทำรายการ
                                </div>
                            `;
                        }
                    }

                    // Show Admin Bank Info (Destination)
                    if(bankInfoDisp) {
                        bankInfoDisp.style.display = 'block'; // Always show the container
                        let infoHtml = '';

                        if(bankName.toLowerCase() === 'promptpay') {
                            infoHtml = `
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="font-weight:bold; font-size:1rem; color: var(--success);">PROMPTPAY</div>
                                    <img src="https://www.logo.wine/a/logo/PromptPay/PromptPay-Logo.wine.svg" style="width: 60px; height: auto; filter: invert(1) opacity(0.8);">
                                </div>
                                <div style="font-size:1.2rem; font-weight:bold; color:var(--text-main); letter-spacing:1px; margin: 2px 0;">${bankNum}</div>
                                <div style="font-size:0.9rem; color:var(--text-main);">${accName}</div>
                            `;
                        } else {
                            infoHtml = `
                                <div style="font-weight:bold; font-size:1.1rem; color: var(--secondary); text-transform:uppercase;">${bankName.toUpperCase()}</div>
                                <div style="font-size:1.2rem; font-weight:bold; color:var(--text-main); letter-spacing:1px; margin: 2px 0;">${bankNum}</div>
                                <div style="font-size:0.9rem; color:var(--text-main);">${accName}</div>
                            `;
                        }
                        bankInfoDisp.innerHTML = infoHtml;
                    }
                    
                    // Start Timer if not running
                    startQRTimer();
                }
            } else {
                if(qrSec) qrSec.style.display = 'none';
                stopQRTimer();
            }
        }

        function startQRTimer() {
            if(depositTimerInterval) clearInterval(depositTimerInterval);
            
            // Set 1 hour from now
            const now = new Date();
            const expireTime = new Date(now.getTime() + 60 * 60 * 1000);
            
            // Update Expiry Date Text
            const expiryEl = document.getElementById('qrExpiry');
            if(expiryEl) {
                const dateStr = expireTime.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const timeStr = expireTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                expiryEl.innerText = `QR Code นี้ใช้ได้ถึง วันที่ ${dateStr} เวลา ${timeStr}`;
            }

            const timerEl = document.getElementById('qrTimer');
            
            // Update immediately
            updateTimerDisplay(expireTime, timerEl);

            depositTimerInterval = setInterval(() => {
                updateTimerDisplay(expireTime, timerEl);
            }, 1000);
        }

        function updateTimerDisplay(expireTime, timerEl) {
            const diff = expireTime - Date.now();
            if(diff <= 0) {
                clearInterval(depositTimerInterval);
                if(timerEl) timerEl.innerText = "หมดเวลาการชำระเงิน";
                return;
            }
            
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            
            if(timerEl) timerEl.innerText = `กรุณาชำระภายใน ${h} ชั่วโมง ${m} นาที ${s} วินาที`;
        }

        function stopQRTimer() {
            if(depositTimerInterval) clearInterval(depositTimerInterval);
            const timerEl = document.getElementById('qrTimer');
            if(timerEl) timerEl.innerText = "กรุณาชำระภายใน 01:00:00";
        }

        function copyBankNum(btn, num) {
            navigator.clipboard.writeText(num).then(() => {
                showToast('คัดลอกเลขบัญชีแล้ว', 'success');
                
                // Visual Feedback
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.add('btn-success-anim'); // Optional class if needed
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-success-anim');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed', err);
                showToast('ไม่สามารถคัดลอกได้', 'error');
            });
        }

        function handleSlipSelect(input) {
            const btn = document.getElementById('btnConfirmPayment');
            const preview = document.getElementById('slipPreview');
            const previewImg = document.getElementById('slipPreviewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // Enable button
                    if(btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.style.filter = 'none';
                    }
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
                // Disable button
                if(btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.style.filter = 'grayscale(100%)';
                }
            }
        }

        function confirmPayment() {
             const amtInput = document.getElementById('walletAmount');
             const val = parseFloat(amtInput.value);
             const slipInput = document.getElementById('slipUpload');
             
             if(!val || val < 1) return showToast('ยอดเงินไม่ถูกต้อง (ขั้นต่ำ 1 บาท)', 'error');
             
             if (!slipInput || !slipInput.files || slipInput.files.length === 0) {
                 return showToast('กรุณาแนบสลิปการโอนเงินก่อนยืนยัน', 'error');
             }
             
             const file = slipInput.files[0];
             const reader = new FileReader();
             
             reader.onload = async function(e) {
                 const slipBase64 = e.target.result;
                 
                 try {
                     const res = await fetch('/api/transactions/deposit', {
                         method: 'POST',
                         headers: {'Content-Type': 'application/json'},
                         body: JSON.stringify({
                             username: currentUser.username,
                             amount: val,
                             slip: slipBase64
                         })
                     });
                     const data = await res.json();
                     
                     if(data.success) {
                         showToast('แจ้งชำระเงินเรียบร้อย รอการตรวจสอบ', 'success');
                         document.getElementById('walletModal').style.display = 'none';
                         
                         // Clear inputs
                         amtInput.value = '';
                         slipInput.value = '';
                         updateDepositUI(0);
                         
                         // Refresh Trans List
                         renderUserTrans();
                     } else {
                         showToast('เกิดข้อผิดพลาด: ' + (data.error || 'Unknown'), 'error');
                     }
                 } catch(err) {
                     console.error(err);
                     showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
                 }
             };
             
             reader.onerror = function() {
                 showToast('เกิดข้อผิดพลาดในการอ่านไฟล์รูปภาพ', 'error');
             };
             
             reader.readAsDataURL(file);
        }

        function openWalletPage() {
            // Clear all wallet badges when viewing history
            localStorage.removeItem('wallet_badge_deposit');
            localStorage.removeItem('wallet_badge_withdraw');
            checkWalletBadges();
            switchPage('walletPage', document.getElementById('navWallet'));
            renderUserTrans();
        }

        async function renderUserTrans() {
            const list = document.getElementById('transList');
            if(!list) return;
            
            try {
                const res = await fetch(`/api/user/${currentUser.username}/transactions`);
                const data = await res.json();
                let trans = data.transactions || [];
                
                // Sort Newest First
                trans.sort((a,b) => (b.timestamp || b.date || 0) - (a.timestamp || a.date || 0));
                
                if(trans.length === 0) {
                    list.innerHTML = `
                        <div style="text-align:center; color:var(--text-muted); margin-top:50px; padding: 40px;">
                            <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 1px dashed var(--text-muted);">
                                <i class="fas fa-history" style="font-size:2.5rem; opacity:0.5;"></i>
                            </div>
                            <div>ไม่มีรายการธุรกรรม</div>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = '';
                trans.forEach(t => {
                    let statusBadge = '';
                    if(t.status === 'pending') statusBadge = '<span style="color:var(--warning); background:rgba(255, 204, 0, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(255, 204, 0, 0.2);"><i class="fas fa-clock"></i> รอตรวจสอบ</span>';
                    else if(t.status === 'approved') statusBadge = '<span style="color:var(--success); background:rgba(0, 255, 157, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(0, 255, 157, 0.2); box-shadow: 0 0 5px rgba(0, 255, 157, 0.2);"><i class="fas fa-check-circle"></i> สำเร็จ</span>';
                    else statusBadge = '<span style="color:var(--danger); background:rgba(255, 0, 85, 0.1); padding:4px 10px; border-radius:6px; font-size:0.7rem; border:1px solid rgba(255, 0, 85, 0.2);"><i class="fas fa-times-circle"></i> ปฏิเสธ</span>';
                    
                    let icon = t.type === 'deposit' ? '<i class="fas fa-arrow-down" style="color:var(--success);"></i>' : '<i class="fas fa-arrow-up" style="color:var(--warning);"></i>';
                    let iconBg = t.type === 'deposit' ? 'rgba(0, 255, 157, 0.1)' : 'rgba(255, 204, 0, 0.1)';
                    let iconBorder = t.type === 'deposit' ? 'var(--success)' : 'var(--warning)';
                    
                    let title = t.type === 'deposit' ? 'ฝากเงิน' : 'ถอนเงิน';
                    let amountColor = t.type === 'deposit' ? 'var(--success)' : 'var(--warning)';
                    let sign = t.type === 'deposit' ? '+' : '-';
                    
                    // Fee detail text
                    let feeDetail = '';
                    let displayAmount = parseFloat(t.amount);
                    let displayLabel = `฿${displayAmount.toLocaleString()}`;
                    
                    if(t.net_amount && t.net_amount !== t.amount) {
                         const net = parseFloat(t.net_amount);
                         const fee = parseFloat(t.fee || 0);
                         
                         if(t.type === 'deposit') {
                             feeDetail = `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">ค่าธรรมเนียม: -฿${fee.toLocaleString()} (เข้าบัญชี: ฿${net.toLocaleString()})</div>`;
                             // Show NET amount for deposit success
                             if(t.status === 'approved') {
                                 displayLabel = `฿${net.toLocaleString()}`;
                             }
                         } else if (t.type === 'withdraw') {
                             feeDetail = `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">ค่าธรรมเนียม: -฿${fee.toLocaleString()} (รับจริง: ฿${net.toLocaleString()})</div>`;
                         }
                    } else if(t.type === 'withdraw' && t.fee) {
                         // Fallback for old data
                        feeDetail = `<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 2px;">ค่าธรรมเนียม: ${parseFloat(t.fee).toLocaleString()}</div>`;
                    }

                    list.innerHTML += `
                        <div class="glass-panel" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; animation: slideUp 0.3s ease-out;">
                            <div style="display:flex; gap:15px; align-items:center;">
                                <div style="width:45px; height:45px; border-radius:12px; background:${iconBg}; display:flex; align-items:center; justify-content:center; font-size:1.2rem; border: 1px solid ${iconBorder}; box-shadow: 0 0 10px ${iconBg};">
                                    ${icon}
                                </div>
                                <div>
                                    <div style="font-weight: bold; color: var(--text-main); font-size:1rem;">${title}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                                        <i class="far fa-calendar-alt"></i> ${new Date(t.timestamp || t.date).toLocaleDateString('th-TH', {day: 'numeric', month: 'short', year: '2-digit'})} 
                                        <i class="far fa-clock" style="margin-left:5px;"></i> ${new Date(t.timestamp || t.date).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: ${amountColor}; font-size:1.1rem; text-shadow: 0 0 10px ${amountColor}40;">${sign}${displayLabel}</div>
                                ${feeDetail}
                                <div style="margin-top: 6px;">${statusBadge}</div>
                            </div>
                        </div>
                    `;
                });
            } catch(e) {
                console.error(e);
                showToast('ไม่สามารถโหลดข้อมูลธุรกรรมได้', 'error');
            }
        }

        function miningLoop() {
            // Update Online Status (Heartbeat)
            if (currentUser && currentUser.username) {
                let users = JSON.parse(localStorage.getItem('mining_users')) || {};
                if (users[currentUser.username]) {
                    users[currentUser.username].last_active = Date.now();
                    // Only save if changed significantly to avoid IO thrashing? 
                    // Actually, for "Online" status we need frequent updates.
                    // But saving to LS every 1s is heavy. 
                    // Let's do it every 5s or if balance changes.
                    // But mining changes balance every tick (1s).
                    // So we are already saving every 1s in saveData().
                    // Just updating the object here is fine, saveData() handles the write.
                    currentUser.last_active = Date.now();
                }
            }

            // checkExpiration(); // Disabled: No expiration (Law Enforced)
            autoMiningController();
            
            // Check for new day reset
            if(lastProfitDate !== new Date().toDateString()) {
                dailyProfit = 0;
                lastProfitDate = new Date().toDateString();
                saveData();
                showToast('🌤️ เช้าวันใหม่! รีเซ็ตยอดรายวันแล้ว', 'info');
            }
            
            if(isMining && hashrate > 0) {
                // Real-Time Idle: Calculate based on time delta (Profit Per Second)
                const now = Date.now();
                // If lastMiningTime is too old (e.g. > 5s) or future, reset it to avoid huge jumps/negative
                // But we handle offline profit separately on load.
                // During runtime, if tab sleeps, this handles catch-up naturally.
                // However, to prevent double counting with offline profit on load, we rely on loadUserData setting initial state.
                // But here we need to ensure lastMiningTime is tracked.
                
                if(!lastMiningTime) lastMiningTime = now;
                
                const deltaSeconds = (now - lastMiningTime) / 1000;
                
                // Only process if delta is reasonable (e.g. > 0.01s)
                if(deltaSeconds > 0) {
                     const profit = hashrate * deltaSeconds;
                     balance += profit;
                     dailyProfit += profit;
                     
                     // Update last time
                     lastMiningTime = now;
                }
                
                // บันทึกทุก 10 วินาที
                if(Math.floor(Date.now() / 1000) % 10 === 0) {
                    saveData();
                }
                
                updateUI();
                
                // console.log(`⛏️ Mining: +${hashrate.toFixed(2)} ฿/s | Balance: ${balance.toFixed(2)} ฿`);
            } else {
                // Keep time updated even if not mining, to avoid jump when starting
                lastMiningTime = Date.now();
            }
        }

        function showOfflineProfitModal(profit, seconds) {
            const modalId = 'offlineProfitModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            // Format duration
            let duration = '';
            if(seconds < 60) duration = `${Math.floor(seconds)} วินาที`;
            else if(seconds < 3600) duration = `${Math.floor(seconds/60)} นาที`;
            else duration = `${(seconds/3600).toFixed(1)} ชั่วโมง`;
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10002';
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="background: rgba(10, 15, 30, 0.98); border: 1px solid var(--success); text-align:center; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 0 30px rgba(0, 255, 157, 0.2); animation: slideUp 0.3s ease-out;">
                    <div style="width: 80px; height: 80px; background: rgba(0, 255, 157, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid var(--success); box-shadow: 0 0 15px rgba(0, 255, 157, 0.3);">
                        <i class="fas fa-moon" style="font-size: 3rem; color: var(--success); animation: pulse 2s infinite;"></i>
                    </div>
                    <h2 style="color: var(--success); margin:0 0 5px; text-shadow: 0 0 10px rgba(0, 255, 157, 0.5);">ยินดีต้อนรับกลับ!</h2>
                    <p style="color: #94a3b8; margin-bottom: 20px;">ระบบขุดทำงานต่อเนื่องเป็นเวลา ${duration}</p>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="font-size: 0.8rem; color: #aaa;">รายได้ที่ได้รับ (Log-in Bonus)</div>
                        <div style="font-size: 2rem; font-weight: bold; color: var(--success); text-shadow: 0 0 10px rgba(0, 255, 157, 0.5);">
                            +฿${profit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </div>
                    </div>
                    
                    <button class="cyber-btn" style="width: 100%; --btn-bg: var(--success);" onclick="document.getElementById('${modalId}').remove()">
                        รับทราบ
                    </button>
                </div>
            `;
            document.body.appendChild(div);
            if(typeof soundMgr !== 'undefined') soundMgr.play('success');
        }

        function checkAnnounce() {
            try {
                let raw = localStorage.getItem('mining_announcement');
                let ann = null;
                try { ann = raw ? JSON.parse(raw) : null; } catch (_) { ann = raw ? { msg: raw, date: new Date().toISOString() } : null; }
                
                const db = document.getElementById('dashboardAnnounce');
                const badge = document.getElementById('annBadge');
                const label = document.getElementById('annLabel');

                if(ann && ann.msg) {
                    // Update Dashboard Board
                    if(db) db.innerText = ann.msg;

                    const lastAnn = localStorage.getItem('last_ann_seen');
                    
                    // Auto-show logic: If new announcement (different date/id)
                    if(lastAnn !== ann.date) {
                        if(badge) badge.style.display = 'block';
                        if(label) { label.innerText = 'มีประกาศใหม่'; label.style.color = '#ef4444'; }
                        
                        // Auto open modal with a slight delay for better UX
                        // Check if modal is not already open
                        const modal = document.getElementById('announceModal');
                        if(modal && modal.style.display !== 'flex') {
                            setTimeout(() => {
                                openAnnounceModal();
                            }, 500); 
                        }
                    } else {
                        if(badge) badge.style.display = 'none';
                        if(label) { label.innerText = 'ตรวจสอบ'; label.style.color = '#aaa'; }
                    }
                } else {
                    // No announcement
                    if(db) db.innerText = 'ไม่มีประกาศในขณะนี้';
                    if(badge) badge.style.display = 'none';
                    if(label) { label.innerText = 'ว่าง'; label.style.color = '#aaa'; }
                }
                
                // Check for Referrer Notifications
                if(currentUser) {
                    let notifs = JSON.parse(localStorage.getItem(`notifications_${currentUser.username}`)) || [];
                    const unread = notifs.filter(n => !n.read);
                    if(unread.length > 0) {
                         // Show Toast or Alert
                         const lastNotif = unread[unread.length-1];
                         
                         // Prevent duplicate toast for same session if needed, or just show last
                         // Simple Implementation: Show Toast
                         showToast(lastNotif.msg, lastNotif.type || 'info');
                         notifs.forEach(n => n.read = true);
                         localStorage.setItem(`notifications_${currentUser.username}`, JSON.stringify(notifs));
                         }
                }

            } catch (e) { console.error(e); }
        }

        function openAnnounceModal() {
            try {
                const ann = JSON.parse(localStorage.getItem('mining_announcement'));
                if(ann && ann.msg) {
                    document.getElementById('announceBody').innerText = ann.msg;
                    document.getElementById('announceModal').style.display = 'flex';
                    // Mark as seen
                    localStorage.setItem('last_ann_seen', ann.date);
                    checkAnnounce(); // Update UI immediately
                } else {
                    alert('ยังไม่มีประกาศ');
                }
            } catch(e) { console.error(e); }
        }

        function closeAnnounce() {
            document.getElementById('announceModal').style.display = 'none';
        }



        function renderActiveContracts() {
            const list = document.getElementById('activeContractsList');
            const countEl = document.getElementById('activeContractCount');
            if(!list) return;

            let rigs = JSON.parse(localStorage.getItem(`mining_rigs_${currentUser.username}`)) || [];
            
            // Filter active rigs
            // Law Enforced: All rigs are permanent, ignore expiresAt
            const activeRigs = rigs; // .filter(r => !r.expiresAt || r.expiresAt > now);
            
            if(countEl) countEl.innerText = `${activeRigs.length} รายการ`;

            if(activeRigs.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; color: var(--text-muted); font-size: 0.8rem;">ไม่มีสัญญาการขุดที่ใช้งานอยู่</div>`;
                return;
            }
            
            let html = '';
            // Sort by expiry (shortest first), then permanent
            activeRigs.sort((a, b) => {
                if(a.expiresAt && b.expiresAt) return a.expiresAt - b.expiresAt;
                if(a.expiresAt) return -1;
                return 1;
            });

            activeRigs.forEach(r => {
                let timeLeft = 'ถาวร (ถูกกฎหมาย)';
                let statusColor = 'var(--success)';
                
                if(r.status === 'paused') {
                    timeLeft = '⛔ พักการขุด';
                    statusColor = '#fbbf24'; // Warning yellow
                } 
                /* Expiration Disabled
                else if(r.expiresAt) {
                    const diff = r.expiresAt - now;
                    // ... logic removed ...
                }
                */

                const daily = r.speed * 86400;
                const dateStr = r.timestamp ? new Date(r.timestamp).toLocaleDateString('th-TH') : '';

                html += `
                <div style="background: var(--bg-panel); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 15px;">
                    <div class="cyber-icon-box" style="width: 40px; height: 40px; font-size: 1rem; --card-color: ${statusColor}; border-color: ${statusColor}; box-shadow: 0 0 10px ${statusColor}20;">
                        <i class="fas ${r.icon || 'fa-server'}" style="color: ${statusColor};"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="font-weight: bold; font-size: 0.9rem; color: var(--text-main);">${r.name}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.75rem; color: var(--text-muted);">
                            <div>Speed: <span style="color: var(--text-main);">${r.speed} MH/s</span></div>
                            <div>${dateStr}</div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--success); margin-top: 2px;">
                            ≈ ฿${daily.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 4})}/วัน
                        </div>
                    </div>
                </div>
                `;
            });
            
            if(list.innerHTML !== html) {
                list.innerHTML = html;
            }
        }

        function updateUI() {
            renderActiveContracts();
            // แสดงรายได้ต่อวินาที
            const incomePerSec = hashrate > 0 ? hashrate : 0;
            
            document.getElementById('balanceDisplay').innerText = 
                `฿${parseFloat(balance).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            // Dynamic precision for income display
            let incomePrecision = 3;
            if(incomePerSec > 0 && incomePerSec < 0.001) incomePrecision = 6;

            document.getElementById('incomeDisplay').innerText = 
                `+฿${incomePerSec.toFixed(incomePrecision)}`;
            
            // Update Estimated Daily Profit
            const dailyEst = incomePerSec * 86400;
            const estEl = document.getElementById('estDailyDisplay');
            if(estEl) {
                const opts = dailyEst < 100 
                    ? {minimumFractionDigits: 2, maximumFractionDigits: 4}
                    : {maximumFractionDigits: 0};
                estEl.innerText = `วันละ ฿${dailyEst.toLocaleString('en-US', opts)}`;
            }

            // Update Monthly Profit (Including Today)
            const monthlyTotal = (incomePerSec * 2592000) + dailyProfit;
            const monthlyEl = document.getElementById('monthlyTotalDisplay');
            if(monthlyEl) {
                const opts = monthlyTotal < 100 
                    ? {minimumFractionDigits: 2, maximumFractionDigits: 4}
                    : {maximumFractionDigits: 0};
                monthlyEl.innerText = `เดือนละ ฿${monthlyTotal.toLocaleString('en-US', opts)}`;
            }

            // Dynamic precision for hashrate
            let hashratePrecision = 1;
            if(hashrate > 0 && hashrate < 0.1) hashratePrecision = 6;

            document.getElementById('hashrateDisplay').innerText = 
                hashrate.toFixed(hashratePrecision);
            
            // Update Daily Profit Display
            const dailyEl = document.getElementById('dailyProfitDisplay');
            if(dailyEl) {
                dailyEl.innerText = `฿${dailyProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 4})}`;
            }
            
            autoMiningController();
            updateMiningMode();
        }

        function switchPage(pid, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pid).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // --- Auth ---
        let pendingSignupData = null;

        function toSignup() { 
            document.getElementById('loginModal').style.display='none'; 
            document.getElementById('signupModal').style.display='flex'; 
            
            // Auto-fill Referral Code
            const pendingRef = localStorage.getItem('pending_ref');
            if(pendingRef) {
                document.getElementById('regRefCode').value = pendingRef;
            }
        }
        function toLogin() { document.getElementById('signupModal').style.display='none'; document.getElementById('loginModal').style.display='flex'; }
        
        async function signup() {
            const u = document.getElementById('regUser').value;
            const p = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            const bank = document.getElementById('regBank').value;
            const acc = document.getElementById('regAcc').value;
            const manualRef = document.getElementById('regRefCode').value;
            
            if(!u || !p || !name || !acc) return showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
            
            // Note: Backend will check for duplicate username
            
            const userData = { u, p, name, bank, acc };

            // --- Referral Logic ---
            let refId = null;

            // 1. Resolve ID
            if(manualRef && manualRef.trim().length > 0) {
                refId = manualRef.trim().replace(/x/i, ''); 
            } else {
                const pendingRef = localStorage.getItem('pending_ref');
                if(pendingRef) refId = pendingRef.replace(/x/i, '');
            }

            // 2. Validate via API
            if(refId) {
                try {
                    const res = await fetch(`/api/check-referral/${refId}`);
                    const json = await res.json();
                    
                    if(json.valid) {
                        // Pass the referrer's username or ID. 
                        // For consistency with legacy code, we might use username, 
                        // but 'referrer_id' implies ID. Let's use the ID from the response.
                        completeRegistration(userData, json.referrer.id);
                    } else {
                        // Invalid ID
                        if(manualRef && manualRef.trim().length > 0) {
                            // SHOW CUSTOM MODAL
                            pendingSignupData = userData;
                            document.getElementById('referralConfirmModal').style.display = 'flex';
                        } else {
                            // URL ref invalid -> ignore and register
                             completeRegistration(userData, null);
                        }
                    }
                } catch(err) {
                    console.error(err);
                    showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
                }
            } else {
                 completeRegistration(userData, null);
            }
        }

        function closeReferralConfirm() {
            document.getElementById('referralConfirmModal').style.display = 'none';
            pendingSignupData = null;
        }

        function confirmSignupNoRef() {
            if(pendingSignupData) {
                completeRegistration(pendingSignupData, null);
                closeReferralConfirm();
            }
        }

        async function completeRegistration(data, referrerId) {
             const { u, p, name, bank, acc } = data;
             
             try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: u,
                        password: p,
                        name,
                        bank,
                        acc,
                        referrer_id: referrerId, // Can be null
                        ip: clientIP || 'Unknown',
                        deviceId: getDeviceID() || 'Unknown'
                    })
                });
                
                const json = await res.json();
                
                if(!json.success) {
                    return showToast(json.error || 'การสมัครสมาชิกส้มเหลว', 'error');
                }

                // --- Sync to LocalStorage (Hybrid Mode) ---
                // We mirror the backend data to local storage so the rest of the app works
                let users = JSON.parse(localStorage.getItem('mining_users')) || {};
                const newUser = json.user;
                
                users[u] = {
                    pass: p, // Note: In real app, don't store plain pass. Backend has it now.
                    id: newUser.id,
                    name: name, bank: bank, acc: acc,
                    regDate: newUser.regDate, banned: false,
                    referrer: referrerId, // Store ID now
                    ip: clientIP,
                    deviceId: getDeviceID()
                };
                localStorage.setItem('mining_users', JSON.stringify(users));
                
                // Initialize Profile in LocalStorage
                const pf = { username: u, balance: 0, hashrate: 0.0, avatar: null };
                localStorage.setItem(`pf_${u}`, JSON.stringify(pf));

                localStorage.removeItem('pending_ref');
                
                showToast('สมัครสมาชิกสำเร็จ! ข้อมูลถูกบันทึกในระบบหลังบ้านแล้ว', 'success');
                toLogin();

             } catch(err) {
                 console.error(err);
                 showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ Server', 'error');
             }
        }

        function checkRememberedUser() {
            const remUser = localStorage.getItem('remember_user');
            const remPass = localStorage.getItem('remember_pass');
            if(remUser && remPass) {
                document.getElementById('loginUser').value = remUser;
                document.getElementById('loginPass').value = remPass;
                document.getElementById('rememberMe').checked = true;
            }
        }

        async function login() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const remember = document.getElementById('rememberMe').checked;
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                
                if(data.success) {
                    const user = data.user;
                    if(user.status === 'banned') return showToast('ขออภัย บัญชีถูกระงับชั่วคราว', 'error');
                    if(user.status === 'pending') return showToast('บัญชีรอการอนุมัติจากแอดมิน', 'warning');
                    
                    currentUser = { 
                        username: user.username,
                        id: user.id,
                        referrer_id: user.referrer_id
                    };
                    localStorage.setItem('current_user', JSON.stringify(currentUser));
                    
                    // Remember Me Logic
                    if(remember) {
                        localStorage.setItem('remember_user', u);
                        localStorage.setItem('remember_pass', p);
                    } else {
                        localStorage.removeItem('remember_user');
                        localStorage.removeItem('remember_pass');
                    }
                    
                    // Cache initial profile data
                    let pf = JSON.parse(localStorage.getItem(`pf_${user.username}`)) || {};
                    pf.balance = user.balance || 0;
                    pf.hashrate = user.hashrate || 0;
                    localStorage.setItem(`pf_${user.username}`, JSON.stringify(pf));

                    document.getElementById('loginModal').style.display='none';
                    initApp();
                    showToast('เข้าสู่ระบบสำเร็จ', 'success');
                } else {
                    showToast(data.error || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', 'error');
                }
            } catch(e) {
                console.error(e);
                showToast('Connection Error', 'error');
            }
        }

        function logout() { localStorage.removeItem('current_user'); location.reload(); }

        // --- Data ---
        async function saveData() { 
            if(currentUser) { 
                let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`)) || {}; 
                pf.balance = balance; 
                pf.hashrate = hashrate; 
                pf.dailyProfit = dailyProfit;
                pf.lastProfitDate = lastProfitDate;
                pf.lastMiningTime = Date.now(); // Save timestamp
                localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf)); 
                
                // Sync to Backend
                try {
                    fetch('/api/user/sync', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            username: currentUser.username,
                            balance: balance,
                            hashrate: hashrate
                        })
                    }).catch(e => console.error('Sync Error', e));
                } catch(e) {}
            } 
        }
        async function loadUserData() {
            // 1. Load LocalStorage Data FIRST (Primary Source for Hot Data)
            let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`));
            if(pf) {
                balance = parseFloat(pf.balance || 0);
                hashrate = parseFloat(pf.hashrate || 0);
                dailyProfit = parseFloat(pf.dailyProfit || 0);
                lastProfitDate = pf.lastProfitDate || new Date().toDateString();
            }

            // 2. Try fetch from backend (Secondary / Backup)
            try {
                const res = await fetch(`/api/user/${currentUser.username}`);
                if(res.ok) {
                    const data = await res.json();
                    if(data.user) {
                        const u = data.user;
                        
                        // If local data is missing, use backend
                        if(!pf) {
                            balance = parseFloat(u.balance || 0);
                            hashrate = parseFloat(u.hashrate || 0);
                            // Initialize local
                            pf = {
                                balance: balance,
                                hashrate: hashrate,
                                dailyProfit: 0,
                                lastProfitDate: new Date().toDateString(),
                                lastMiningTime: Date.now()
                            };
                            localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf));
                        } else {
                            // If backend balance is significantly higher (e.g. top-up from another device), take it?
                            // But user said "don't reset". So we prioritize local accumulation.
                            // However, we should sync rigs.
                            if(u.rigs) {
                                localStorage.setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(u.rigs));
                            }
                        }
                    }
                }
            } catch(e) { console.error('Backend Load Error:', e); }

            // 3. Process Logic
            if(pf || balance > 0) {
                // Check for New Day Reset FIRST
                if(lastProfitDate !== new Date().toDateString()) {
                    dailyProfit = 0;
                    lastProfitDate = new Date().toDateString();
                    saveData();
                }

                // Offline Profit Calculation (Log-in Bonus)
                if(pf && pf.lastMiningTime && hashrate > 0) {
                    const now = Date.now();
                    const diffSeconds = (now - pf.lastMiningTime) / 1000;
                    
                    // If offline for more than 10 seconds
                    if(diffSeconds > 10) {
                        const offlineProfit = diffSeconds * hashrate;
                        if(offlineProfit > 0) {
                            balance += offlineProfit;
                            dailyProfit += offlineProfit;
                            saveData(); // Save immediately
                            
                            // Update global lastMiningTime to prevent double counting
                            lastMiningTime = now;
                            
                            console.log(`💤 Offline for ${diffSeconds.toFixed(1)}s, Earned: ${offlineProfit.toFixed(2)}`);
                            
                            // Show Modal
                            setTimeout(() => {
                                showOfflineProfitModal(offlineProfit, diffSeconds);
                            }, 1000);
                        }
                    }
                }

                console.log('📊 Loaded Data:', { balance, hashrate, dailyProfit });
                
                if(hashrate > 0) {
                    isMining = true;
                    console.log('🚀 Auto-starting mining...');
                }
                
                updateUI();
            }
        }
        /* CSS injected via JS to avoid clutter */
        function renderProfile() {
            // Use currentUser directly (assuming it has id)
            if(!currentUser) return;
            
            const id = currentUser.id || '???';
            let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`)) || {};
            
            document.getElementById('headerName').innerText = currentUser.username;
            document.getElementById('headerID').innerText = `ID: ${id}`;
            document.getElementById('settingName').innerText = currentUser.username;
            document.getElementById('settingID').innerText = `ID: ${id}`;
            document.getElementById('myRefCode').innerText = id + "X";
            
            if(pf.avatar) {
                document.getElementById('headerAvatar').innerHTML = `<img src="${pf.avatar}">`;
                document.getElementById('settingAvatar').innerHTML = `<img src="${pf.avatar}">`;
            }
            
            updateNotifBadge();
        }

        function changeProfilePic() {
            const file = document.getElementById('uploadProfile').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`));
                    pf.avatar = e.target.result;
                    localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf));
                    renderProfile();
                }
                reader.readAsDataURL(file);
            }
        }

        // Removed duplicate openWalletModal
        function previewSlip() {
            const file = document.getElementById('slipUpload').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('slipImg').src = e.target.result;
                    document.getElementById('slipPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function submitDeposit() {
            const amt = parseFloat(document.getElementById('walletAmount').value);
            if(!amt || amt < 40) return showToast('กรุณาระบุยอดเงินขั้นต่ำ 40 บาท', 'warning');
            
            // Simulate Automatic Payment Check
            const btn = document.getElementById('btnDeposit');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> กำลังตรวจสอบยอดเงิน...';
            
            // Play wait sound/vib if needed
            // setTimeout to simulate network check
            setTimeout(() => {
                // Success
                let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
                trans.push({
                    id: Date.now(), 
                    user: currentUser.username, 
                    type: 'deposit', 
                    amount: amt,
                    status: 'approved', 
                    timestamp: Date.now(), 
                    processed: true,
                    method: 'qr_auto'
                });
                localStorage.setItem('mining_transactions', JSON.stringify(trans));
                
                balance += amt;
                saveData(); 
                updateUI();
                
                // Notify User
                showToast(`ทำรายการสำเร็จ! ได้รับเงิน ${amt.toLocaleString()} THB`, 'success');
                
                // Reset UI
                btn.disabled = false;
                btn.innerHTML = originalText;
                document.getElementById('walletModal').style.display='none';
                
                // Sound & Vib Success
                if(typeof soundMgr !== 'undefined') soundMgr.play('emphasis');
                if(typeof vibMgr !== 'undefined') vibMgr.trigger('emphasis');

                // Add Notification
                addNotification(`เติมเงินสำเร็จ +${amt.toLocaleString()} THB`);
                
            }, 3000);
        }

        async function submitTransaction() {
            const amt = parseFloat(document.getElementById('walletAmount').value);
            if(!amt) return showToast('กรุณาระบุจำนวนเงิน', 'warning');
            
            // Deposit is handled by confirmPayment
            
            if(currentAction === 'withdraw') {
                let users = JSON.parse(localStorage.getItem('mining_users')) || {};
                let u = users[currentUser.username];
                if(!u || !u.bank || !u.acc) return showToast('กรุณาเพิ่มบัญชีธนาคารก่อนถอนเงิน', 'warning');

                if(amt < 200) return showToast('ถอนขั้นต่ำ 200 บาท', 'warning');
                if(amt > 200000) return showToast('ถอนได้ไม่เกิน 200,000 บาทต่อครั้ง', 'warning');
                if(balance < amt) return showToast('ยอดเงินคงเหลือไม่เพียงพอ', 'error');
                
                const fee = amt * 0.03;
                const net = amt - fee;
                
                if(!confirm(`ยืนยันการถอนเงิน?\n\nยอดถอน: ฿${amt.toLocaleString()}\nค่าธรรมเนียม (3%): ฿${fee.toLocaleString()}\nได้รับสุทธิ: ฿${net.toLocaleString()}`)) return;
                
                try {
                    const res = await fetch('/api/transactions/withdraw', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            username: currentUser.username,
                            amount: amt,
                            bank: u.bank,
                            account: u.acc
                        })
                    });
                    
                    const data = await res.json();
                    
                    if(data.success) {
                        balance -= amt;
                        saveData(); 
                        updateUI();
                        renderUserTrans();
                        showToast('ทำรายการสำเร็จ รอแอดมินอนุมัติ', 'success');
                        document.getElementById('walletModal').style.display='none';
                    } else {
                        showToast('Error: ' + data.error, 'error');
                    }
                } catch(e) {
                    console.error(e);
                    showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
                }
            }
        }

        function formatBankAcc(acc) {
            if(!acc) return '---';
            const cleaned = ('' + acc).replace(/\D/g, '');
            if(cleaned.length === 10) {
                return `${cleaned.substring(0,3)}-${cleaned.substring(3,4)}-${cleaned.substring(4,9)}-${cleaned.substring(9)}`;
            }
            return acc;
        }

        function showBankModal() {
            let users = JSON.parse(localStorage.getItem('mining_users'));
            let u = users[currentUser.username];
            
            const modal = document.getElementById('bankModal');
            const content = modal.querySelector('.modal-content');
            
            // Reset modal content structure if needed
            if(!document.getElementById('myBankInfo')) {
                 // This handles if we are re-rendering inside an existing structure or setting it up
                 // But since we are replacing the innerHTML of the modal content mostly or specific part?
                 // The original code targeted 'myBankInfo' which is inside the modal.
                 // Let's just update the 'myBankInfo' content as the original did.
            }
            
            document.getElementById('myBankInfo').innerHTML = `
                <div class="bank-card ${u.bank}" style="margin-bottom: 25px; position: relative; overflow: hidden; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                    <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;"></div>
                    <i class="fas fa-university bank-logo-watermark" style="opacity: 0.1; font-size: 8rem; position: absolute; bottom: -20px; right: -20px;"></i>
                    
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
                        <div class="bank-chip" style="width: 50px; height: 35px; background: linear-gradient(135deg, #d4af37, #f9e58a); border-radius: 6px; position: relative;">
                            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.2);"></div>
                            <div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: rgba(0,0,0,0.2);"></div>
                        </div>
                        <div style="text-align: right; color: var(--text-main); text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                            <div style="font-weight: bold; font-size: 1.1rem;">${u.bank.toUpperCase()}</div>
                            <div style="font-size: 0.7rem; opacity: 0.8;">บัตรเดบิต</div>
                        </div>
                    </div>
                    
                    <div style="z-index: 2; position: relative; color: var(--text-main); text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                        <div class="bank-number" style="font-size: 1.5rem; letter-spacing: 3px; margin-bottom: 15px; font-family: monospace;">${formatBankAcc(u.acc)}</div>
                        <div class="bank-holder" style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div>
                                <div style="font-size: 0.6rem; opacity: 0.7; margin-bottom: 2px;">ชื่อผู้ถือบัตร</div>
                                <div style="font-size: 1rem; text-transform: uppercase;">${u.name}</div>
                            </div>
                            <div style="font-size:1.5rem;">
                                <i class="fab fa-cc-visa"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="cyber-btn" onclick="showBankEdit()" style="width: 100%;">
                    <i class="fas fa-edit"></i> แก้ไขข้อมูล
                </button>
            `;
            document.getElementById('bankModal').style.display='flex';
        }

        function showBankEdit() {
            let users = JSON.parse(localStorage.getItem('mining_users'));
            let u = users[currentUser.username];
            
            document.getElementById('myBankInfo').innerHTML = `
                <div class="glass-panel" style="text-align:left; margin-bottom:20px; padding: 25px;">
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">เลือกธนาคาร</label>
                        <div class="custom-select-wrapper" style="position: relative;">
                            <select id="editBank" class="cyber-input" style="width: 100%; appearance: none; cursor: pointer;">
                                <option value="kbank" ${u.bank==='kbank'?'selected':''}>กสิกรไทย (KBANK)</option>
                                <option value="scb" ${u.bank==='scb'?'selected':''}>ไทยพาณิชย์ (SCB)</option>
                                <option value="ktb" ${u.bank==='ktb'?'selected':''}>กรุงไทย (KTB)</option>
                                <option value="bbl" ${u.bank==='bbl'?'selected':''}>กรุงเทพ (BBL)</option>
                                <option value="gsb" ${u.bank==='gsb'?'selected':''}>ออมสิน (GSB)</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); pointer-events: none;"></i>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">เลขที่บัญชี</label>
                        <input type="tel" id="editAcc" class="cyber-input" value="${u.acc}" placeholder="0123456789" maxlength="10">
                    </div>
                    
                    <div>
                        <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:8px;">ชื่อบัญชี</label>
                        <input type="text" id="editName" class="cyber-input" value="${u.name}">
                    </div>
                </div>
                
                <div style="display:flex; gap:15px;">
                    <button class="cyber-btn" style="flex:1; background: transparent; border-color: var(--text-muted); color: var(--text-muted); box-shadow: none;" onclick="showBankModal()">ยกเลิก</button>
                    <button class="cyber-btn" style="flex:1; --btn-bg: var(--success);" onclick="saveBankInfo()">
                        <i class="fas fa-save"></i> บันทึก
                    </button>
                </div>
            `;
        }

        function saveBankInfo() {
            const bank = document.getElementById('editBank').value;
            const acc = document.getElementById('editAcc').value;
            const name = document.getElementById('editName').value;
            
            if(!acc || !name) return alert('กรุณากรอกข้อมูลให้ครบ');
            
            let users = JSON.parse(localStorage.getItem('mining_users'));
            users[currentUser.username].bank = bank;
            users[currentUser.username].acc = acc;
            users[currentUser.username].name = name;
            
            localStorage.setItem('mining_users', JSON.stringify(users));
            alert('บันทึกข้อมูลเรียบร้อย');
            showBankModal();
        }
        function showReferralModal() { 
            document.getElementById('refModal').style.display='flex'; 
            renderReferralUI();
        }

        async function renderReferralUI() {
            try {
                // Fetch Referrals from Server
                const res = await fetch(`/api/user/${currentUser.username}/referrals`);
                const data = await res.json();
                
                const list = document.getElementById('refList');
                const pCount = document.getElementById('refPendingCount');
                const cCount = document.getElementById('refCompletedCount');
                const myCode = document.getElementById('myRefCode');
                
                if(myCode) myCode.innerText = currentUser.id;

                let refs = [];
                if (data.success && data.referrals) {
                    refs = data.referrals;
                }

                let totalRefs = refs.length;
                let totalBonus = totalRefs * 50;

                // Update Stats
                if(pCount) {
                    // All referrals are auto-approved, so pending is 0
                    pCount.innerText = '0'; 
                }
                if(cCount) cCount.innerText = totalRefs;

                // Clear List
                list.innerHTML = '';

                if (refs.length === 0) {
                    list.innerHTML = `
                        <div class="ref-list-empty" style="text-align: center; padding: 40px 0; color: var(--text-muted);">
                            <div style="width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: 1px dashed var(--text-muted);">
                                <i class="fas fa-user-plus" style="font-size: 2.5rem; opacity: 0.5;"></i>
                            </div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: var(--text-main);">ยังไม่มีเพื่อนที่เชิญ</div>
                            <div style="font-size: 0.85rem;">แชร์รหัสของคุณให้เพื่อนเพื่อเริ่มรับรายได้</div>
                        </div>
                    `;
                } else {
                    // Sort by date desc
                    refs.sort((a, b) => new Date(b.regDate) - new Date(a.regDate));
                    
                    refs.forEach(r => {
                        const date = new Date(r.regDate).toLocaleDateString('th-TH');
                        const time = new Date(r.regDate).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                        
                        list.innerHTML += `
                            <div class="glass-panel" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; border-radius: 16px;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px var(--primary-dim);">
                                        <i class="fas fa-user" style="color: var(--text-main);"></i>
                                    </div>
                                    <div>
                                        <div style="font-size: 1rem; font-weight: bold; color: var(--text-main);">${r.username}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">สมัครเมื่อ: ${date} ${time}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: var(--success); font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 6px; display: inline-block; border: 1px solid var(--success);">
                                        <i class="fas fa-check"></i> สำเร็จ
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--success); margin-top: 4px;">+฿50.00</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Update Button to show Total Earnings (Non-clickable)
                const btn = document.getElementById('btnClaimBonus');
                if(btn) {
                    if(totalBonus > 0) {
                        btn.innerHTML = `<i class="fas fa-coins" style="margin-right:5px;"></i> รายได้รวม: ฿${totalBonus.toLocaleString()}`;
                        btn.style.background = 'linear-gradient(135deg, #f1c40f, #f39c12)';
                        btn.style.color = 'var(--text-main)';
                        btn.style.fontWeight = 'bold';
                        btn.style.cursor = 'default';
                        btn.style.boxShadow = '0 0 15px rgba(241, 196, 15, 0.4)';
                        btn.onclick = null;
                    } else {
                        btn.innerHTML = `<i class="fas fa-gift" style="margin-right:5px;"></i> ยังไม่มีรายได้`;
                        btn.style.background = 'rgba(255,255,255,0.1)';
                        btn.style.color = 'var(--text-muted)';
                        btn.style.cursor = 'not-allowed';
                        btn.style.boxShadow = 'none';
                        btn.onclick = null;
                    }
                }

            } catch (e) {
                console.error('Ref Render Error:', e);
            }
        }

        function copyRef() {
            const code = document.getElementById('myRefCode').innerText;
            if(!code || code === '---' || code === 'undefinedX') {
                alert('กำลังโหลดข้อมูล กรุณารอสักครู่...');
                return;
            }
            
            // Dynamic Link
            const baseUrl = window.location.href.split('?')[0];
            const link = `${baseUrl}?ref=${code}`;
            
            navigator.clipboard.writeText(link);
            showToast('คัดลอกลิงก์แนะนำแล้ว!', 'success');
        }

        function claimBonus(amount) {
            if(!amount || amount <= 0) return;
            balance += amount;
            
            let refs = JSON.parse(localStorage.getItem(`mining_referrals_${currentUser.username}`)) || [];
            refs.forEach(r => { if(r.status === 'completed' || r.status === 'approved') r.claimed = true; });
            localStorage.setItem(`mining_referrals_${currentUser.username}`, JSON.stringify(refs));
            
            // Record Transaction
            let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
            trans.push({
                id: Date.now(), user: currentUser.username, type: 'deposit', amount: amount,
                status: 'approved', timestamp: Date.now(), processed: true,
                method: 'referral_commission', fee: 0, net: amount
            });
            localStorage.setItem('mining_transactions', JSON.stringify(trans));
                    
            saveData();
            updateUI();
            renderReferralUI();
            
            // Custom Success Modal (AI Theme)
            const modalId = 'claimSuccessModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10001';
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="background: rgba(15, 23, 42, 0.95); border: 1px solid #00f2ff; text-align:center; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent 50%, rgba(0, 242, 255, 0.02) 50%); background-size: 100% 4px; pointer-events: none;"></div>
                    
                    <div style="width: 80px; height: 80px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid #00f2ff; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);">
                        <i class="fas fa-gift" style="font-size: 3rem; color: #00f2ff; animation: bounce 2s infinite;"></i>
                    </div>
                    <h2 style="color: var(--text-main); margin:0 0 5px; text-shadow: 0 0 5px #00f2ff;">รางวัลจากระบบ</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px; font-family: monospace;">ได้รับโบนัสการแนะนำเพื่อน</p>
                    <div style="font-size: 2.5rem; font-weight: bold; color: #00f2ff; margin-bottom: 20px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5); font-family: monospace;">
                        ฿${amount.toFixed(2)}
                    </div>
                    <button class="btn-action" style="background: rgba(0, 242, 255, 0.1); color: #00f2ff; border: 1px solid #00f2ff; font-weight: bold; border-radius: 8px;" onclick="document.getElementById('${modalId}').remove()">รับทราบ</button>
                </div>
            `;
            document.body.appendChild(div);
        }

        // --- Shop ---
        let currentShopTab = 0;

        function switchShopTab(id) {
            currentShopTab = id;
            loadShop();
        }

        async function loadShop() {
            const g = document.getElementById('shopList');
            if(!g) return;
            
            // Inject Tabs if missing
            let tabContainer = document.getElementById('shopTabs');
            if (!tabContainer) {
                tabContainer = document.createElement('div');
                tabContainer.id = 'shopTabs';
                tabContainer.className = 'shop-tabs';
                tabContainer.style.display = 'flex';
                tabContainer.style.overflowX = 'auto';
                tabContainer.style.gap = '10px';
                tabContainer.style.marginBottom = '20px';
                tabContainer.style.paddingBottom = '10px';
                // Scrollbar styling for tabs
                const style = document.createElement('style');
                style.innerHTML = `
                    #shopTabs::-webkit-scrollbar { height: 4px; }
                    #shopTabs::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 2px; }
                    #shopTabs::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
                `;
                document.head.appendChild(style);
                
                g.parentNode.insertBefore(tabContainer, g);
            }

            // Render Tabs
            const tabs = [
                { id: 0, label: 'ทั้งหมด' },
                { id: 1, label: 'Lv.1-20 (Basic)' },
                { id: 2, label: 'Lv.21-40 (Mid)' },
                { id: 3, label: 'Lv.41-60 (High)' },
                { id: 4, label: 'Lv.61-80 (Pro)' },
                { id: 5, label: 'Lv.81-100 (Legend)' }
            ];
            
            tabContainer.innerHTML = tabs.map(t => `
                <button onclick="switchShopTab(${t.id})" 
                    class="cyber-btn" 
                    style="padding: 6px 16px; font-size: 0.85rem; white-space: nowrap; ${currentShopTab === t.id ? 'background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary); border-color: var(--primary);' : 'background: var(--glass); color: var(--text-muted); border-color: var(--border-subtle);'} border-radius: 20px; flex-shrink: 0; transition: all 0.3s;">
                    ${t.label}
                </button>
            `).join('');

            g.innerHTML = ''; // Clear current
            
            try {
                const res = await fetch('/api/shop/items');
                const data = await res.json();
                
                if(data.disabled) {
                    g.innerHTML = `<div class="glass-panel" style="text-align:center; padding: 30px; grid-column: 1/-1;">
                        <div style="font-size:1.2rem; font-weight:bold; color: var(--warning); margin-bottom: 8px;">ร้านค้าปรับปรุง</div>
                        <div style="color: var(--text-muted);">กรุณากลับมาใหม่ภายหลัง</div>
                        ${data.notice ? `<div style="margin-top:10px; color:var(--text-main);">${data.notice}</div>` : ''}
                    </div>`;
                    return;
                }
                
                let items = data.items;
                if(!items || items.length === 0) {
                    g.innerHTML = `<div class="glass-panel" style="text-align:center; padding: 30px; grid-column: 1/-1;">
                        <div style="font-size:1.2rem; font-weight:bold; color: var(--text-main); margin-bottom: 8px;">ยังไม่มีสินค้า</div>
                        <div style="color: var(--text-muted);">แอดมินแจ้งระบบเชื่อมต่อให้ร้านค่าเครื่องเข้ามาใหม่ก่อน</div>
                        ${data.notice ? `<div style="margin-top:10px; color:var(--text-main);">${data.notice}</div>` : ''}
                    </div>`;
                    return;
                }

                if(data.notice) g.innerHTML += `<div class="glass-panel" style="margin-bottom:15px; grid-column: 1/-1;">${data.notice}</div>`;
                
                // Filter Logic
                if (currentShopTab === 1) items = items.filter(i => i.id >= 1 && i.id <= 20);
                else if (currentShopTab === 2) items = items.filter(i => i.id >= 21 && i.id <= 40);
                else if (currentShopTab === 3) items = items.filter(i => i.id >= 41 && i.id <= 60);
                else if (currentShopTab === 4) items = items.filter(i => i.id >= 61 && i.id <= 80);
                else if (currentShopTab === 5) items = items.filter(i => i.id >= 81 && i.id <= 100);

                if(items.length === 0) {
                     g.innerHTML += `<div class="glass-panel" style="text-align:center; padding: 40px; grid-column: 1/-1;">
                        <i class="fas fa-search" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 15px;"></i>
                        <div style="font-size:1.1rem; color: var(--text-main);">ไม่พบสินค้าในหมวดนี้</div>
                    </div>`;
                    return;
                }

                items.forEach(i => {
                    const tagClass = i.tag ? i.tag : '';
                    const tagLabel = i.tag ? ({hot:'ฮอต', new:'ใหม่', sale:'ลดราคา', best:'แนะนำ', used:'มือสอง', free:'ฟรี'}[i.tag] || i.tag) : null;
                    let btnText = 'ซื้อสินค้า <i class="fas fa-shopping-cart"></i>';
                    let btnState = '';
                    
                    const icon = i.icon || 'fa-microchip';
                    const tier = i.tier || 'basic';
                    let tierColor = 'var(--primary)';
                    if(tier === 'legendary') tierColor = '#f1c40f';
                    else if(tier === 'pro') tierColor = '#e056fd';
                    else if(tier === 'mid') tierColor = '#00cec9';
                    else if(tier === 'basic') tierColor = '#74b9ff';
                    else if(tier === 'limited') tierColor = '#ff7675';
                    else if(tier === 'god') tierColor = '#ff0000';
                    
                    const isUsed = tagClass.includes('used');
                    const cardClass = isUsed ? 'shop-card-cyber used' : 'shop-card-cyber';
                    
                    // Monthly Income Calculation for Display
                    // Based on formula: Speed (Baht/s) * 30 * 24 * 3600
                    const monthlyIncome = i.speed * 2592000;
                    
                    // Dynamic Display Logic for Extreme Values (Lv.100 The Singularity)
                    const isMaxPrice = i.price >= 9999999999999;
                    const isInfiniteIncome = monthlyIncome >= 9999999999999;
                    
                    const priceDisplay = isMaxPrice ? 'MAX' : (i.price === 0 ? 'ฟรี (ถาวร)' : '฿'+i.price.toLocaleString() + ' (ถาวร)');
                    const dailyIncomeDisplay = isInfiniteIncome ? 'Infinite' : '฿' + (i.speed * 86400).toLocaleString(undefined, {maximumFractionDigits:0});
                    const monthlyIncomeDisplay = isInfiniteIncome ? 'Infinite' : '฿' + monthlyIncome.toLocaleString(undefined, {maximumFractionDigits:0});

                    g.innerHTML += `
                    <div class="${cardClass}" style="--card-color: ${tierColor};">
                        ${tagLabel ? `<div style=\"position: absolute; top: 10px; right: 10px; background: ${tierColor}; color: #000; font-size: 0.6rem; font-weight: bold; padding: 2px 8px; border-radius: 4px;\">${tagLabel}</div>` : ''}
                        <div class="cyber-icon-box" style="border-color: ${tierColor}; box-shadow: 0 0 15px ${tierColor}40;">
                            <i class="fas ${icon}" style="color: ${tierColor};"></i>
                        </div>
                        <h3 style="margin: 10px 0 5px; font-size: 1rem; color: var(--text-main);">${i.name}</h3>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 5px; color: #94a3b8; font-size: 0.8rem;">
                                <i class="fas fa-bolt" style="color: ${tierColor};"></i>
                                <span>รายได้/วัน: ${dailyIncomeDisplay}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--success); text-shadow: 0 0 5px rgba(0,255,157,0.3);">
                                รายได้/เดือน: ${monthlyIncomeDisplay}
                            </div>
                        </div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--text-main); margin-bottom: 15px; text-shadow: 0 0 10px ${tierColor}80;">
                            ${priceDisplay}
                        </div>
                        <button class="cyber-btn" onclick="buyItem(${i.price}, ${i.speed}, ${i.id})" ${btnState} style="${btnState ? 'opacity:0.5;cursor:not-allowed;' : ''} border-color: ${tierColor}; color: ${tierColor}; box-shadow: 0 0 10px ${tierColor}20;">
                            ${isMaxPrice ? 'ไม่สามารถซื้อได้' : btnText}
                        </button>
                    </div>`;
                });
            } catch(e) {
                console.error(e);
                g.innerHTML = '<div style="text-align:center; color:red;">Connection Error</div>';
            }
        }


        
        async function buyItem(p, s, id) {
            if(!currentUser) return showToast('กรุณาเข้าสู่ระบบ', 'error');
            
            const btn = event ? event.target : null;
            if(btn) btn.disabled = true;

            try {
                const res = await fetch('/api/shop/buy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser.username, itemId: id })
                });
                const data = await res.json();
                
                if(data.success) {
                    // Update Local User
                    currentUser.balance = data.user.balance;
                    currentUser.hashrate = data.user.hashrate;
                    currentUser.rigs = data.user.rigs;
                    
                    // Sync LocalStorage for persistence (optional but good for offline-first feel)
                    localStorage.setItem('current_user', JSON.stringify(currentUser));
                    let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`)) || {};
                    pf.balance = currentUser.balance;
                    pf.hashrate = currentUser.hashrate;
                    localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf));
                    
                    // Update Rigs LocalStorage
                    if(currentUser.rigs) {
                        localStorage.setItem(`mining_rigs_${currentUser.username}`, JSON.stringify(currentUser.rigs));
                    }
                    
                    updateUI();
                    showToast(`✅ สั่งซื้อสำเร็จ!`, 'success');
                    addNotification(`💰 ซื้ออุปกรณ์สำเร็จ`, 'success');
                    
                    if(typeof soundMgr !== 'undefined') soundMgr.play('emphasis');
                    if(typeof vibMgr !== 'undefined') vibMgr.trigger('emphasis');
                } else {
                    showToast('❌ ' + (data.error || 'การสั่งซื้อล้มเหลว'), 'error');
                    if(typeof soundMgr !== 'undefined') soundMgr.play('alert');
                    if(typeof vibMgr !== 'undefined') vibMgr.trigger('alert');
                }
            } catch(e) {
                console.error(e);
                showToast('Connection Error', 'error');
            } finally {
                if(btn) btn.disabled = false;
            }
        }

        function updateMiningMode() {
            const el = document.getElementById('miningMode');
            if(!el) return;
            if(isMining && hashrate > 0) {
                el.innerText = 'กำลังขุด';
                el.style.color = 'var(--success)';
                el.style.textShadow = '0 0 10px var(--success)';
            } else {
                el.innerText = 'พัก';
                el.style.color = '#94a3b8';
                el.style.textShadow = 'none';
            }
        }

        function autoMiningController() {
            // Pure automatic mining based on hashrate
            if(hashrate > 0 && !isMining) {
                isMining = true;
                updateMiningMode();
                console.log('🔄 Auto-started mining');
            } else if(hashrate <= 0 && isMining) {
                isMining = false;
                updateMiningMode();
                console.log('🛑 Auto-stopped mining (No hashrate)');
            }
        }

        function startMining() {
            console.warn('Manual start is disabled. System is fully automatic.');
            autoMiningController();
        }

        function stopMining() {
            console.warn('Manual stop is disabled. System is fully automatic.');
            autoMiningController();
        }

        function checkExpiration() {
            // Disabled by Law: No Expiration
            return;
        }

        function checkShopUpdate() {
            const last = localStorage.getItem('shop_last_update');
            const seen = localStorage.getItem('shop_seen_update');
            const show = last && (!seen || parseInt(last) > parseInt(seen));
            
            const badgeNav = document.getElementById('shopBadgeNav');
            if (badgeNav) badgeNav.style.display = show ? 'block' : 'none';
            
            const badgeFloat = document.getElementById('shopBadgeFloat');
            if (badgeFloat) badgeFloat.style.display = show ? 'block' : 'none';
        }

        function openShopPage() {
            // Mark as seen
            const lastUpdate = localStorage.getItem('shop_last_update');
            if(lastUpdate) {
                localStorage.setItem('shop_seen_update', lastUpdate);
            }
            checkShopUpdate(); // Update UI to hide badge
            switchPage('shopPage', document.getElementById('navShop'));
            loadShop();
        }

        // --- Sound & Vibration & Monitor ---
        class SoundManager {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.enabled = localStorage.getItem('sound_enabled') === 'true';
                this.type = localStorage.getItem('sound_type') || 'standard'; 
            }

            play(overrideType) {
                if (!this.enabled) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const type = overrideType || this.type;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;
                
                if (type === 'standard' || type === 'alert') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now);
                    osc.frequency.exponentialRampToValueAtTime(440, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'emphasis') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(880, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'rapid') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.1, now);
                    osc.start(now);
                    osc.stop(now + 0.05);
                    
                    const osc2 = this.ctx.createOscillator();
                    const gain2 = this.ctx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(this.ctx.destination);
                    osc2.type = 'triangle';
                    osc2.frequency.setValueAtTime(800, now + 0.1);
                    gain2.gain.setValueAtTime(0.1, now + 0.1);
                    osc2.start(now + 0.1);
                    osc2.stop(now + 0.15);
                } else if (type === 'fast') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(1200, now);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                }
            }
        }

        class VibrationManager {
            constructor() {
                this.enabled = localStorage.getItem('vib_enabled') === 'true';
                this.type = localStorage.getItem('vib_type') || 'standard'; 
            }

            trigger(overrideType) {
                if (!this.enabled || !navigator.vibrate) return;
                const type = overrideType || this.type;
                if (type === 'fast') navigator.vibrate(50);
                else if (type === 'emphasis') navigator.vibrate([100, 50, 100]);
                else if (type === 'alert') navigator.vibrate(200);
                else navigator.vibrate(100); 
            }
        }

        const soundMgr = new SoundManager();
        const vibMgr = new VibrationManager();

        let wakeLock = null;
        async function toggleWakeLock(enable) {
            if ('wakeLock' in navigator) {
                if (enable) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake Lock active');
                    } catch (err) { console.error(err); }
                } else {
                    if (wakeLock !== null) {
                        wakeLock.release();
                        wakeLock = null;
                        console.log('Wake Lock released');
                    }
                }
            }
        }

        function addNotification(msg, type) {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            history.push({
                msg: msg,
                type: type,
                timestamp: Date.now(),
                read: false
            });
            if(history.length > 50) history.shift();
            localStorage.setItem(`history_notifs_${currentUser.username}`, JSON.stringify(history));
            
            // Update Badge
            updateNotifBadge();
        }

        function updateNotifBadge() {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            let unread = history.filter(h => !h.read).length;
            
            const badge = document.getElementById('headerNotifBadge');
            if(badge) {
                if(unread > 0) {
                    badge.style.display = 'block';
                    badge.innerText = unread > 99 ? '99+' : unread;
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function openNotificationHistory() {
            let history = JSON.parse(localStorage.getItem(`history_notifs_${currentUser.username}`)) || [];
            
            // Mark all as read
            let hasUnread = false;
            history.forEach(h => {
                if(!h.read) {
                    h.read = true;
                    hasUnread = true;
                }
            });
            if(hasUnread) {
                localStorage.setItem(`history_notifs_${currentUser.username}`, JSON.stringify(history));
                updateNotifBadge();
            }

            history.sort((a,b) => b.timestamp - a.timestamp);
            
            const modalId = 'notifHistoryModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            let listHtml = '';
            if(history.length === 0) {
                listHtml = `
                    <div style="text-align:center; color:var(--text-muted); padding:40px;">
                        <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px dashed var(--text-muted);">
                            <i class="fas fa-bell-slash" style="font-size:1.5rem; opacity:0.5;"></i>
                        </div>
                        <div>ไม่มีประวัติการแจ้งเตือน</div>
                    </div>`;
            } else {
                history.forEach(h => {
                    let icon = h.type === 'success' ? '<i class="fas fa-check-circle"></i>' : (h.type === 'error' ? '<i class="fas fa-times-circle"></i>' : '<i class="fas fa-info-circle"></i>');
                    let color = h.type === 'success' ? 'var(--success)' : (h.type === 'error' ? 'var(--danger)' : 'var(--primary)');
                    let bg = h.type === 'success' ? 'rgba(0, 255, 157, 0.1)' : (h.type === 'error' ? 'rgba(255, 0, 85, 0.1)' : 'rgba(0, 242, 255, 0.1)');
                    
                    listHtml += `
                        <div class="glass-panel" style="padding: 15px; margin-bottom: 10px; display:flex; gap:15px; align-items:flex-start; animation: slideUp 0.3s ease-out;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${bg}; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: ${color}; border: 1px solid ${color}; box-shadow: 0 0 10px ${bg}; flex-shrink: 0;">
                                ${icon}
                            </div>
                            <div style="flex:1;">
                                <div style="font-size: 0.95rem; color: var(--text-main); line-height: 1.4;">${h.msg}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; display: flex; align-items: center; gap: 5px;">
                                    <i class="far fa-clock"></i> ${new Date(h.timestamp).toLocaleString('th-TH')}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10000';
            div.innerHTML = `
                <div class="modal-content" style="height: 70vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: rgba(10, 14, 30, 0.95);">
                    <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2);">
                        <div>
                            <h2 style="margin:0; color: var(--primary); text-transform: uppercase; letter-spacing: 1px;">Notification Log</h2>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">ประวัติการแจ้งเตือนระบบ</div>
                        </div>
                        <div onclick="document.getElementById('${modalId}').remove()" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.05); cursor: pointer; color: var(--text-muted);">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    
                    <div style="flex:1; overflow-y: auto; padding: 15px;">
                        ${listHtml}
                    </div>
                    
                    <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                        <button class="cyber-btn" style="width: 100%;" onclick="document.getElementById('${modalId}').remove()">
                            <i class="fas fa-check"></i> ปิดหน้าต่าง
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
        }

        function addLiveLog(msg, color = "#00cec9") {
            const mon = document.getElementById('liveMonitorContent');
            if(!mon) return;
            const div = document.createElement('div');
            div.innerText = "> " + msg;
            div.style.color = color;
            div.style.fontFamily = "monospace";
            div.style.fontSize = "0.6rem";
            div.style.fontWeight = "bold";
            div.style.textShadow = `0 0 5px ${color}`;
            mon.appendChild(div);
            if(mon.children.length > 6) mon.removeChild(mon.children[0]);
        }

        function sendAdminLog(msg, type='info') {
            if(!currentUser) return;
            const logs = JSON.parse(localStorage.getItem('mining_live_logs')) || [];
            logs.push({
                timestamp: Date.now(),
                user: currentUser.username,
                msg: msg,
                type: type
            });
            // Keep last 50 logs
            if(logs.length > 50) logs.shift();
            localStorage.setItem('mining_live_logs', JSON.stringify(logs));
        }

        function updateLiveMonitor() {
            const mon = document.getElementById('liveMonitorContent');
            if(!mon) return;
            
            const cmds = [
                { text: "Mining block #" + Math.floor(Math.random()*999999), color: "#00cec9" },
                { text: "Verifying hash... [OK]", color: "#00ff00" },
                { text: "Share accepted (" + (Math.random()*50+10).toFixed(2) + "ms)", color: "#00ff00" },
                { text: "Syncing with VPS node...", color: "#74b9ff" },
                { text: "GPU Temperature: " + (Math.random()*10+60).toFixed(1) + "C", color: "#ff7675" },
                { text: "Fan Speed: " + Math.floor(Math.random()*20+80) + "%", color: "#dfe6e9" },
                { text: "Calculating nonce solution...", color: "#a29bfe" },
                { text: "New Peer connected: 192.168." + Math.floor(Math.random()*255) + "." + Math.floor(Math.random()*255), color: "#fab1a0" },
                { text: "Network difficulty: " + (Math.random()*100).toFixed(2) + " TH/s", color: "#fdcb6e" },
                { text: "Allocating DAG buffer...", color: "#636e72" },
                { text: "Receiving new job...", color: "#0984e3" }
            ];
            const cmd = cmds[Math.floor(Math.random()*cmds.length)];
            
            const div = document.createElement('div');
            div.innerText = "> " + cmd.text;
            div.style.color = cmd.color;
            div.style.fontFamily = "monospace";
            div.style.fontSize = "0.7rem"; // Slightly larger for readability
            div.style.marginBottom = "2px";
            mon.appendChild(div);
            if(mon.children.length > 8) mon.removeChild(mon.children[0]); // Show more lines
        }

        setInterval(() => {
            if(document.getElementById('liveMonitor')?.style.display === 'block') updateLiveMonitor();
        }, 800);

        function loadSystemSettings() {
            // Theme
            const swTheme = document.getElementById('swTheme');
            const isDark = localStorage.getItem('theme_dark') !== 'false'; // Default true
            if(swTheme) swTheme.checked = isDark;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');

            const swSound = document.getElementById('swSound');
            if(swSound) swSound.checked = soundMgr.enabled;

            const swVib = document.getElementById('swVib');
            if(swVib) swVib.checked = vibMgr.enabled;

            const swWake = document.getElementById('swWake');
            if(swWake) swWake.checked = localStorage.getItem('wake_enabled') === 'true';

            const swMonitor = document.getElementById('swMonitor');
            if(swMonitor) swMonitor.checked = localStorage.getItem('monitor_enabled') === 'true';
            
            if(localStorage.getItem('wake_enabled') === 'true') toggleWakeLock(true);
            if(localStorage.getItem('monitor_enabled') === 'true') {
                const liveMonitor = document.getElementById('liveMonitor');
                if(liveMonitor) liveMonitor.style.display = 'block';
            }
            
            const selSound = document.getElementById('selSound');
            if(selSound) selSound.value = soundMgr.type;

            const selVib = document.getElementById('selVib');
            if(selVib) selVib.value = vibMgr.type;
        }

        function confirmReset() {
            if(confirm('⚠️ คำเตือน: คุณต้องการรีเซ็ตข้อมูลการขุดทั้งหมดใช่หรือไม่?\n- เงินทั้งหมดจะหายไป\n- เครื่องขุดทั้งหมดจะถูกลบ')) {
                resetUserData();
            }
        }

        function resetUserData() {
            if(!currentUser) return;
            
            // 1. Reset Memory
            balance = 0;
            hashrate = 0;
            dailyProfit = 0;
            isMining = false;
            
            // 2. Clear Storage
            localStorage.removeItem(`mining_rigs_${currentUser.username}`);
            localStorage.removeItem(`active_items_${currentUser.username}`);
            
            // 3. Reset Profile
            let pf = JSON.parse(localStorage.getItem(`pf_${currentUser.username}`)) || {};
            pf.balance = 0;
            pf.hashrate = 0;
            pf.dailyProfit = 0;
            localStorage.setItem(`pf_${currentUser.username}`, JSON.stringify(pf));
            
            // 4. Update UI
            updateUI();
            renderActiveContracts();
            
            showToast('✅ รีเซ็ตข้อมูลเรียบร้อย', 'success');
            
            // 5. Stop Mining Loop (it will restart if hashrate > 0, but now it is 0)
            if(soundMgr) soundMgr.play('alert');
        }

        function saveSystemSetting(key, value) {
            localStorage.setItem(key, value);
            if(key === 'theme_dark') {
                document.documentElement.setAttribute('data-theme', value ? 'dark' : 'light');
            }
            if(key === 'sound_enabled') soundMgr.enabled = value;
            if(key === 'sound_type') soundMgr.type = value;
            if(key === 'vib_enabled') vibMgr.enabled = value;
            if(key === 'vib_type') vibMgr.type = value;
            if(key === 'wake_enabled') toggleWakeLock(value);
            if(key === 'monitor_enabled') document.getElementById('liveMonitor').style.display = value ? 'block' : 'none';
        }
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            // Check for duplicates
            const existingToasts = container.querySelectorAll('.ai-toast');
            for(let t of existingToasts) {
                if(t.innerText.includes(msg)) {
                    // Reset timer or just return
                    return;
                }
            }
            
            const toast = document.createElement('div');
            toast.className = `ai-toast ${type}`;
            
            let icon = 'fa-info-circle';
            if(type === 'success') icon = 'fa-check-circle';
            if(type === 'error') icon = 'fa-exclamation-circle';
            if(type === 'warning') icon = 'fa-exclamation-triangle';

            toast.innerHTML = `
                <i class="fas ${icon}" style="font-size: 1.2rem;"></i>
                <div>
                    <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 2px;">การแจ้งเตือนระบบ</div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">${msg}</div>
                </div>
            `;

            container.appendChild(toast);

            if(typeof soundMgr !== 'undefined') {
                if(type === 'error') soundMgr.play('alert');
                else soundMgr.play('standard');
            }
            if(typeof vibMgr !== 'undefined') vibMgr.trigger('standard');

            // Auto remove
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        let clickCount = 0;
        function emergencyExit() {
            clickCount++;
            if(clickCount >= 5) {
                // Override local maintenance check
                sessionStorage.setItem('maintenance_bypass', 'true'); 
                document.getElementById('maintenanceOverlay').style.display = 'none';
                showToast('เปิดใช้งานโหมดฉุกเฉิน', 'warning');
                clickCount = 0;
            }
        }

        function reconnectMining() {
            const btn = document.querySelector('#miningConnectionStatus button');
            if(btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> เชื่อมต่อ...';
                btn.disabled = true;
                
                setTimeout(() => {
                    manualRefresh(); // Use existing refresh function
                    
                    // Force check connection immediately
                    if(navigator.onLine) {
                        document.getElementById('miningConnectionStatus').style.display = 'none';
                        showToast('เชื่อมต่อระบบสำเร็จ', 'success');
                    } else {
                        showToast('ไม่สามารถเชื่อมต่อได้ กรุณาตรวจสอบอินเทอร์เน็ต', 'error');
                    }
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 800);
            }
        }

        // Initial check
        checkRememberedUser();

        // --- System Sync Loop ---
        function updateConnectionStatus() {


            // 2. Check Maintenance Mode (Moved to dedicated poller)
            // This block removed to prevent conflict with API-based check

            // 3. Update Connection Status
            const statusEl = document.getElementById('miningStatus');
            const alertEl = document.getElementById('miningConnectionStatus');
            
            if(statusEl) {
                if(navigator.onLine) {
                    statusEl.innerHTML = '<i class="fas fa-wifi"></i> เชื่อมต่อแล้ว (สด)';
                    statusEl.style.color = '#00f2ff';
                    statusEl.style.textShadow = '0 0 10px #00f2ff';
                    if(alertEl) alertEl.style.display = 'none';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-wifi-slash"></i> ขาดการเชื่อมต่อ';
                    statusEl.style.color = '#ff7675';
                    statusEl.style.textShadow = 'none';
                    if(alertEl) alertEl.style.display = 'block';
                }
            }

            // 4. Check User Notifications (Real-time Admin Alerts)
            if(currentUser) {
                let notifs = JSON.parse(localStorage.getItem(`notifications_${currentUser.username}`)) || [];
                let unread = notifs.filter(n => !n.read);
                
                if(unread.length > 0) {
                    unread.forEach(n => {
                        showToast(n.msg, n.type);
                        n.read = true;
                        
                        // Add to local notification history if exists
                        addNotification(n.msg, n.type);
                    });
                    localStorage.setItem(`notifications_${currentUser.username}`, JSON.stringify(notifs));
                    
                    // Sound & Vib
                    if(typeof soundMgr !== 'undefined') soundMgr.play('alert');
                    if(typeof vibMgr !== 'undefined') vibMgr.trigger('alert');
                }
            }

            // 5. Update Announcement
            let _rawAnn = localStorage.getItem('mining_announcement');
            let annData = null;
            try { annData = _rawAnn ? JSON.parse(_rawAnn) : null; } catch (_) { annData = _rawAnn ? { msg: _rawAnn, date: new Date().toISOString() } : null; }
            const annEl = document.getElementById('dashboardAnnounce');
            if(annEl && annData) {
                // Only update if text is different to avoid flicker
                if(annEl.innerText !== annData.msg) {
                    annEl.innerText = annData.msg;
                    // Show badge if new
                    const annBadge = document.getElementById('annBadge');
                    if(annBadge) annBadge.style.display = 'block';
                    
                    // Marquee effect if too long
                    if(annData.msg.length > 40) {
                        annEl.innerHTML = `<marquee scrollamount="5">${annData.msg}</marquee>`;
                    }
                }
            }
        }

        // --- Global Maintenance & Sync Check (Polls API) ---


        async function checkGlobalMaintenance() {
            try {
                const res = await fetch('/api/admin/settings');
                if(res.ok) {
                    const settings = await res.json();
                    
                    // 1. Maintenance Mode
                    const maint = settings.maintenance === true;
                    const maintMsg = settings.maintenance_msg || 'กำลังอัปเกรดเซิร์ฟเวอร์... ';
                    const overlay = document.getElementById('maintenanceOverlay');
                    const bypass = sessionStorage.getItem('maintenance_bypass');
                    
                    if(maint && bypass !== 'true') {
                        if(overlay) {
                             overlay.style.display = 'flex';
                             const msgEl = document.getElementById('maintMessage');
                             if(msgEl) msgEl.innerText = maintMsg;
                        }
                    } else {
                        if(overlay) overlay.style.display = 'none';
                    }

                    // 2. Shop Sync Check
                    if(settings.last_shop_update) {
                        if(lastShopUpdate === 0) {
                            // First load - Sync immediately to be safe
                            lastShopUpdate = settings.last_shop_update;
                            localStorage.setItem('shop_last_update', lastShopUpdate);
                            loadShop(); 
                            checkShopUpdate();
                        } else if(settings.last_shop_update > lastShopUpdate) {
                            console.log('Shop update detected');
                            lastShopUpdate = settings.last_shop_update;
                            localStorage.setItem('shop_last_update', lastShopUpdate);
                            loadShop();
                            showToast('ร้านค้ามีการอัปเดตสินค้าใหม่', 'info');
                            checkShopUpdate();
                        }
                    }

                    // 2.5 Announcement Sync
                    if (settings.system_announcement_active === 'true' && settings.system_announcement) {
                        const currentAnnRaw = localStorage.getItem('mining_announcement');
                        let currentAnn = null;
                        try { currentAnn = currentAnnRaw ? JSON.parse(currentAnnRaw) : null; } catch(e) {}
                        
                        // If content changed or no current announcement
                        if (!currentAnn || currentAnn.msg !== settings.system_announcement) {
                            const newAnn = {
                                msg: settings.system_announcement,
                                date: new Date().toISOString()
                            };
                            localStorage.setItem('mining_announcement', JSON.stringify(newAnn));
                            checkAnnounce(); // Update UI
                            console.log('📢 Announcement synced from server');
                        }
                    } else {
                        // If disabled on server, remove local
                        if(localStorage.getItem('mining_announcement')) {
                            localStorage.removeItem('mining_announcement');
                            checkAnnounce(); // Update UI (clears it)
                            console.log('📢 Announcement cleared by server');
                        }
                    }

                    // 3. Update Connection Status (Server Reachable)
                    isServerReachable = true;

                    // --- User Sync (Consolidated) ---
                    if(currentUser) {
                         checkServerNotifications();
                         checkUserBanStatus();
                         
                         // Heartbeat
                         localStorage.setItem(`last_active_${currentUser.username}`, Date.now());

                         // Transaction Sync
                         let trans = JSON.parse(localStorage.getItem('mining_transactions')) || [];
                         let updated = false;
                         trans.forEach(t => {
                             if(t.user === currentUser.username && !t.processed) {
                                 if(t.status === 'approved' && t.type === 'deposit') { 
                                     balance += t.amount; 
                                     updated = true; 
                                     t.processed = true;
                                     localStorage.setItem('wallet_badge_deposit', 'true');
                                     addNotification(`✅ เติมเงินสำเร็จ +฿${t.amount.toLocaleString()}`, 'success');
                                 }
                                 else if(t.status === 'rejected' && t.type === 'withdraw') { 
                                     balance += t.amount; 
                                     updated = true; 
                                     t.processed = true;
                                     localStorage.setItem('wallet_badge_withdraw', 'true');
                                     addNotification(`❌ ถอนไม่ผ่าน เงินคืนแล้ว`, 'error');
                                 }
                                 else if(t.status === 'approved' && t.type === 'withdraw') { 
                                     t.processed = true; 
                                     updated = true;
                                     localStorage.setItem('wallet_badge_withdraw', 'true');
                                     addNotification(`✅ ถอนเงินสำเร็จ ฿${t.amount.toLocaleString()}`, 'success');
                                 } 
                             }
                         });
                         
                         if(updated) {
                             localStorage.setItem('mining_transactions', JSON.stringify(trans));
                             saveData(); 
                             updateUI();
                             renderUserTrans();
                         }
                         checkWalletBadges();

                         // Data Integrity
                         if(typeof liveSync !== 'undefined' && liveSync.verifyUserData) {
                             const verification = liveSync.verifyUserData(currentUser.username);
                             if(!verification.isValid) {
                                 console.warn('User data invalid, logging out');
                                 logout();
                             }
                         }
                    }

                }
            } catch(e) { 
                // Connection Error
                console.error('Connection Lost:', e);
                isServerReachable = false;
            }
        }
        
        // Check immediately and every 3 seconds (Consolidated)
        checkGlobalMaintenance();
        setInterval(checkGlobalMaintenance, 3000);

        // Start Loop (Fast 500ms)
        updateConnectionStatus();
        setInterval(updateConnectionStatus, 500);

        // Real-time Force Update Listener
        liveSync.on('force_update', (data) => {
            if(!currentUser || !data) return;
            
            if(data.username === currentUser.username) {
                console.log('⚡ Force Update Received:', data);
                
                if(data.type === 'rig_paused' || data.type === 'rig_resumed' || data.type === 'rig_deleted') {
                    // Show Toast Immediately
                    if(data.msg) showToast(data.msg, data.type === 'rig_paused' || data.type === 'rig_deleted' ? 'warning' : 'success');
                    
                    // Special Warning Modal for Paused/Deleted
                    if(data.type === 'rig_paused') {
                         showSystemWarningModal('⚠️ แจ้งเตือนการระงับการขุด', data.msg || 'เครื่องขุดของคุณถูกพักการใช้งานโดยแอดมิน');
                    }

                    // Play sound
                    if(typeof soundMgr !== 'undefined') {
                        soundMgr.play(data.type === 'rig_resumed' ? 'success' : 'alert');
                    }

                    // Refresh Data
                    loadUserData();
                    
                    // Refresh UI if on mining page
                    if(currentAction === 'mining') {
                         // Force re-render of rig list
                         updateUI();
                    }
                }
            }
        });

        // Network Status Monitor
        function updateNetworkStatus() {
            const status = document.getElementById('netStatus');
            if(!status) return;
            const icon = status.querySelector('i');
            
            if(navigator.onLine) {
                icon.className = 'fas fa-wifi';
                icon.style.color = '#00ff9d';
                icon.parentElement.title = "เชื่อมต่อเครือข่ายความเร็วสูง (High Speed Internet)";
                
                // Auto reconnect live sync if needed
                if(typeof liveSync !== 'undefined' && liveSync.status === 'disconnected') {
                    liveSync.connect();
                }
            } else {
                icon.className = 'fas fa-wifi-slash';
                icon.style.color = '#ff0055';
                icon.parentElement.title = "ขาดการเชื่อมต่ออินเทอร์เน็ต (Offline)";
                showToast('ขาดการเชื่อมต่ออินเทอร์เน็ต', 'error');
            }
        }
        window.addEventListener('online', () => {
            updateNetworkStatus();
            showToast('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success');
        });
        window.addEventListener('offline', updateNetworkStatus);
        // Init check
        setTimeout(updateNetworkStatus, 1000);

        // Manual Refresh
        function manualRefresh() {
            const icon = document.getElementById('refreshIcon');
            if(icon) icon.classList.add('fa-spin');
            
            // 1. Sync Data
            if(currentUser) {
                loadUserData().then(() => {
                    // 2. Refresh UI
                    updateUI();
                    renderActiveContracts();
                    
                    // 3. Force Live Sync Check
                    if(typeof liveSync !== 'undefined') {
                        liveSync.forceCheck();
                    }
                    
                    // 4. Play Sound
                    if(typeof soundMgr !== 'undefined') {
                        soundMgr.play('click');
                    }
                    
                    showToast('รีเฟรชข้อมูลล่าสุดแล้ว', 'success');
                    
                    setTimeout(() => {
                        if(icon) icon.classList.remove('fa-spin');
                    }, 1000);
                }).catch(() => {
                    showToast('ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้', 'error');
                    if(icon) icon.classList.remove('fa-spin');
                });
            } else {
                 location.reload();
            }
        }

        function showSystemWarningModal(title, msg) {
            // Store for recall
            lastWarningData = { title, msg };
            
            // Show floating badge
            const badge = document.getElementById('warningFloatBadge');
            if(badge) {
                badge.style.display = 'block';
                badge.classList.add('shake');
                setTimeout(() => badge.classList.remove('shake'), 500);
            }

            const modalId = 'sysWarningModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10002'; // Higher than others
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="background: rgba(20, 10, 10, 0.98); border: 1px solid var(--danger); text-align:center; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 0 30px rgba(255, 0, 0, 0.3); position: relative; overflow: hidden; animation: slideUp 0.3s ease-out;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 0, 0, 0.05) 10px, rgba(255, 0, 0, 0.05) 20px); pointer-events: none;"></div>
                    
                    <div style="width: 80px; height: 80px; background: rgba(255, 0, 0, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid var(--danger); box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger); animation: pulse 1s infinite;"></i>
                    </div>
                    <h2 style="color: var(--danger); margin:0 0 10px; text-shadow: 0 0 10px rgba(255, 0, 0, 0.3);">${title}</h2>
                    <p style="color: #e2e8f0; margin-bottom: 25px; line-height: 1.5;">${msg}</p>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="cyber-btn" style="flex: 1; --btn-bg: #334155; border: none; color: var(--text-main);" onclick="document.getElementById('${modalId}').remove()">
                            ปิดหน้าต่าง
                        </button>
                        <button class="cyber-btn" style="flex: 1; --btn-bg: var(--danger); border: none; color: var(--text-main);" onclick="hideWarningBadge(); document.getElementById('${modalId}').remove()">
                            รับทราบ (ลบแจ้งเตือน)
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
            
            if(typeof vibMgr !== 'undefined') vibMgr.trigger('alert');
        }

        function showRemoteGuide() {
            const modalId = 'remoteGuideModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();
            
            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10005';
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="max-width: 350px; background: rgba(10, 14, 30, 0.95); border: 1px solid var(--primary); text-align:center; border-radius: 16px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); animation: slideUp 0.3s ease-out;">
                    <div style="width: 70px; height: 70px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);">
                        <i class="fas fa-mobile-alt" style="font-size: 2rem; color: var(--primary);"></i>
                    </div>
                    <h2 style="color: var(--primary); margin: 0 0 15px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.3);">การเข้าถึงระยะไกล</h2>
                    
                    <div style="text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="color: var(--text-main); margin: 0 0 5px;"><i class="fas fa-download" style="color: var(--success);"></i> 1. ติดตั้งแอปพลิเคชัน</h4>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0 0 10px; padding-left: 20px;">หากต้องการใช้อุปกรณ์มือถือเพื่อเข้าถึงจากระยะไกล ให้ดาวน์โหลดแอป <strong>Chrome Remote Desktop</strong> จาก Google Play Store หรือ App Store</p>
                        
                        <h4 style="color: var(--text-main); margin: 0 0 5px;"><i class="fas fa-desktop" style="color: var(--warning);"></i> 2. เชื่อมต่อ</h4>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0; padding-left: 20px;">เข้าสู่ระบบด้วยบัญชี Google เดียวกันเพื่อควบคุมเครื่องขุดของคุณได้ทุกที่</p>
                    </div>
                    
                    <button class="cyber-btn" style="width: 100%;" onclick="document.getElementById('${modalId}').remove()">
                        เข้าใจแล้ว
                    </button>
                </div>
            `;
            document.body.appendChild(div);
        }

        function showUpdateHistoryModal() {
            const modalId = 'updateHistoryModal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();

            const updates = [
                {
                    version: 'v1.3.0',
                    date: '14/12/2025',
                    changes: [
                        'เพิ่มระบบแจ้งเตือนแอดมินแบบ Real-time (LiveSync)',
                        'ปรับปรุงการเชื่อมต่อ WiFi/Cellular (Data Saver)',
                        'แสดงสถานะออนไลน์ของผู้ใช้ (Online Status)',
                        'ประวัติธุรกรรมแสดงวันที่และเวลาละเอียด',
                        'แก้ไขการแสดงผลโหมดมืด (Dark Mode)'
                    ]
                },
                {
                    version: 'v1.2.5',
                    date: '08/12/2025',
                    changes: [
                        'เพิ่มระบบแจ้งเตือนเมื่อฝาก/ถอนสำเร็จ',
                        'ปรับปรุงการแสดงผลความเร็วการขุดให้แม่นยำขึ้น',
                        'แก้ไขบั๊กการแจ้งเตือนซ้ำ',
                        'เพิ่มหน้าประวัติการอัปเดตซอฟต์แวร์'
                    ]
                },
                {
                    version: 'v1.2.0',
                    date: '01/12/2025',
                    changes: [
                        'เพิ่มระบบ AI Mining Boost',
                        'ปรับปรุงหน้าต่างร้านค้าใหม่',
                        'เพิ่มประสิทธิภาพความปลอดภัย'
                    ]
                },
                {
                    version: 'v1.1.0',
                    date: '15/11/2025',
                    changes: [
                        'เปิดใช้งานระบบแนะนำเพื่อน',
                        'เพิ่มช่องทางการถอนเงิน',
                        'ปรับปรุง UI ให้ทันสมัยขึ้น'
                    ]
                },
                {
                    version: 'v1.0.0',
                    date: '01/11/2025',
                    changes: [
                        'เปิดตัวระบบขุดเหรียญจำลอง',
                        'ระบบร้านค้าและคลังสินค้า',
                        'ระบบกระเป๋าเงิน'
                    ]
                }
            ];
            
            let htmlList = '';
            updates.forEach((u, index) => {
                htmlList += `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 10px; text-align: left; border-left: 3px solid ${index === 0 ? 'var(--success)' : 'var(--text-muted)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: bold; color: ${index === 0 ? 'var(--success)' : 'var(--text-main)'}; font-size: 1.1rem;">${u.version}</span>
                            <span style="font-size: 0.8rem; color: var(--text-muted);">${u.date}</span>
                        </div>
                        <ul style="margin: 0; padding-left: 20px; color: #cbd5e1; font-size: 0.9rem;">
                            ${u.changes.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            const div = document.createElement('div');
            div.id = modalId;
            div.className = 'modal';
            div.style.display = 'flex';
            div.style.zIndex = '10005';
            div.innerHTML = `
                <div class="modal-content ai-card-border" style="width: 90%; max-width: 450px; max-height: 80vh; display: flex; flex-direction: column; background: rgba(10, 14, 30, 0.98); border: 1px solid var(--primary); text-align:center; border-radius: 16px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); animation: slideUp 0.3s ease-out;">
                    <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="width: 60px; height: 60px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);">
                            <i class="fas fa-history" style="font-size: 1.8rem; color: var(--primary);"></i>
                        </div>
                        <h2 style="color: var(--primary); margin: 0; text-shadow: 0 0 10px rgba(0, 242, 255, 0.3);">ประวัติการอัปเดต</h2>
                        <p style="margin: 5px 0 0; color: #94a3b8; font-size: 0.8rem;">Software Update History</p>
                    </div>
                    
                    <div style="flex: 1; overflow-y: auto; padding: 20px;">
                        ${htmlList}
                    </div>
                    
                    <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button class="cyber-btn" style="width: 100%;" onclick="document.getElementById('${modalId}').remove()">
                            ปิดหน้าต่าง
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(div);
        }
    </script>
    <div id="toastContainer"></div>
    <!-- Referral Check Script -->
    <script>
        (function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                if (refCode) {
                    localStorage.setItem('pending_ref', refCode);
                    console.log('Ref code saved:', refCode);
                    
                    // Optional: Clean URL
                    const newUrl = window.location.href.split('?')[0];
                    window.history.replaceState({}, document.title, newUrl);
                }
            } catch (e) {
                console.error('Ref Check Error:', e);
            }
        })();
    </script>
</body>
</html>
