<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Cyber Command</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #ff0055;
            --success: #00ff9d;
            --warning: #ffcc00;
            --danger: #ff0055;
            --bg-dark: #050510;
            --bg-panel: rgba(15, 20, 35, 0.85);
            --text-main: #e0e6ed;
            --text-muted: #94a3b8;
            --border: rgba(0, 242, 255, 0.2);
            --neon-glow: 0 0 10px rgba(0, 242, 255, 0.5);
            --glass: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            font-family: 'Kanit', sans-serif; 
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(5, 5, 16, 0.9), rgba(5, 5, 16, 0.9)),
                repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0, 242, 255, 0.03) 1px, rgba(0, 242, 255, 0.03) 2px),
                repeating-linear-gradient(90deg, transparent, transparent 1px, rgba(0, 242, 255, 0.03) 1px, rgba(0, 242, 255, 0.03) 2px);
            background-size: 100% 100%, 20px 20px, 20px 20px;
            color: var(--text-main); 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }

        .sidebar { 
            width: 260px; 
            background: rgba(10, 15, 30, 0.95); 
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border);
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            z-index: 100;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5);
        }

        .brand { 
            font-size: 1.8rem; 
            color: var(--primary); 
            font-weight: bold; 
            margin-bottom: 30px; 
            text-align: center; 
            text-shadow: var(--neon-glow);
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .menu-item { 
            padding: 12px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: var(--text-muted);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .menu-item:hover, .menu-item.active { 
            background: rgba(0, 242, 255, 0.1); 
            color: var(--primary); 
            border-color: var(--border);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
            transform: translateX(5px);
        }

        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }
        
        .content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }

        .card { 
            background: var(--bg-panel); 
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            padding: 25px; 
            border-radius: 16px; 
            margin-bottom: 25px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); 
            transition: transform 0.3s, box-shadow 0.3s; 
            position: relative;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -1px; left: -1px; right: -1px; bottom: -1px;
            border-radius: 16px;
            background: linear-gradient(45deg, transparent 40%, rgba(0, 242, 255, 0.1) 50%, transparent 60%);
            z-index: -1;
            pointer-events: none;
        }

        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 40px rgba(0, 242, 255, 0.1); 
        }
        
        h2 {
            color: var(--text-main);
            margin-top: 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            display: inline-block;
            text-shadow: 0 0 10px rgba(255,255,255,0.1);
        }

        /* Tables */
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; margin-top: 15px; }
        th { 
            text-align: left; 
            padding: 15px; 
            color: var(--primary); 
            text-transform: uppercase; 
            font-size: 0.8rem; 
            letter-spacing: 1px; 
            background: rgba(0, 242, 255, 0.05);
            border-radius: 5px;
        }
        td { 
            padding: 15px; 
            background: rgba(255,255,255,0.02); 
            color: #e2e8f0; 
            border-top: 1px solid rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        tr td:first-child { border-left: 1px solid rgba(255,255,255,0.05); border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        tr td:last-child { border-right: 1px solid rgba(255,255,255,0.05); border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        tr:hover td { background: rgba(255,255,255,0.05); }
        
        /* Forms */
        .search-bar, .cyber-input { 
            width: 100%; 
            padding: 12px 15px; 
            background: rgba(0,0,0,0.4); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            color: white; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            outline: none;
            transition: 0.3s;
        }
        .search-bar:focus, .cyber-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
        }
        
        /* Buttons */
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.85rem; margin-right: 5px; transition: 0.3s; font-weight: 500; }
        .btn-green { background: linear-gradient(45deg, #059669, #10b981); box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .btn-red { background: linear-gradient(45deg, #b91c1c, #ef4444); box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
        .btn-warning { background: linear-gradient(45deg, #d97706, #f59e0b); box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        .btn-gray { background: #475569; }
        .btn-primary { background: linear-gradient(45deg, #0284c7, #0ea5e9); box-shadow: 0 0 10px rgba(14, 165, 233, 0.3); }
        
        .btn-sm:hover { transform: translateY(-2px); filter: brightness(1.2); }

        .section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Badges */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; border: 1px solid transparent; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }
        .badge-success { background: rgba(16, 185, 129, 0.15); color: #10b981; border-color: rgba(16, 185, 129, 0.3); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border-color: rgba(59, 130, 246, 0.3); }
        
        .nav-badge { background: var(--accent); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: auto; box-shadow: 0 0 8px var(--accent); animation: pulse-neon 2s infinite; }
        
        @keyframes pulse-neon {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(255, 0, 85, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); }
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; border: 1px solid #475569; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); border-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); box-shadow: 0 0 10px white; }

        /* Toast */
        .ai-toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .ai-toast {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--primary);
            color: #e2e8f0;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            display: flex; align-items: center; gap: 15px;
            min-width: 320px;
            animation: slideIn 0.3s ease-out forwards;
            backdrop-filter: blur(10px);
            border-left: 4px solid var(--primary);
        }
        .ai-toast.success { border-left-color: var(--success); border-color: var(--success); box-shadow: 0 0 20px rgba(0, 255, 157, 0.2); }
        .ai-toast.error { border-left-color: var(--danger); border-color: var(--danger); box-shadow: 0 0 20px rgba(255, 0, 85, 0.2); }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -280px; top: 0; height: 100%; z-index: 1000; transition: 0.3s; }
            .sidebar.show { left: 0; }
            .content { padding: 15px; width: 100%; }
            .menu-toggle { display: block !important; position: fixed; top: 15px; right: 15px; z-index: 1001; background: var(--primary); color: #000; border: none; padding: 10px; border-radius: 8px; box-shadow: 0 0 15px var(--primary); }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; backdrop-filter: blur(3px); }
            .overlay.show { display: block; }
        }
        .menu-toggle { display: none; }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    <div class="overlay" onclick="toggleSidebar()"></div>
    <div class="ai-toast-container" id="toastContainer"></div>

    <div class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-robot"></i> ผู้ดูแลระบบ
        </div>
        <div class="menu-item active" onclick="nav('dashboard', this)"><i class="fas fa-chart-pie"></i> แดชบอร์ด</div>
        <div class="menu-item" onclick="nav('monitor', this)">
            <i class="fas fa-satellite-dish"></i> ระบบเชื่อมสด
            <span id="navMonitorBadge" class="nav-badge" style="display:none;">0</span>
        </div>
        <div class="menu-item" onclick="nav('users', this)"><i class="fas fa-users"></i> ผู้ใช้</div>
        <div class="menu-item" onclick="nav('mining', this)"><i class="fas fa-microchip"></i> เครื่องขุด</div>
        <div class="menu-item" onclick="nav('shop', this)"><i class="fas fa-shopping-cart"></i> ร้านค้า</div>
        <div class="menu-item" onclick="nav('referrals', this)">
            <i class="fas fa-user-friends"></i> แนะนำเพื่อน 
            <span id="navReferralBadge" class="nav-badge" style="display:none;">0</span>
        </div>
        <div class="menu-item" onclick="nav('trans', this)" id="menuTrans">
            <i class="fas fa-exchange-alt"></i> ธุรกรรม 
            <span id="navTransBadge" class="nav-badge" style="display:none;">0</span>
        </div>
        <div class="menu-item" onclick="nav('announce', this)"><i class="fas fa-bullhorn"></i> ระบบ</div>

        <div style="margin-top: auto; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; border: 1px solid var(--border);">
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">สถานะเซิร์ฟเวอร์</div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); animation: pulse 2s infinite;"></div>
                <span style="color: var(--success); font-weight: bold; font-size: 0.9rem;">LIVE SYSTEM</span>
            </div>
            <div style="font-size: 0.65rem; color: #aaa; margin-top: 5px;">MySQL Ready (Mode: Simulation)</div>
        </div>
    </div>

    <div class="content">
        
        <!-- Top Header -->
        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05);">
            <a href="index.html" target="_blank" style="text-decoration: none; margin-right: 20px;">
                <button style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i class="fas fa-globe"></i> ไปหน้าแอป
                </button>
            </a>

            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; font-size: 1.2rem; box-shadow: 0 0 10px rgba(0, 255, 157, 0.3);">
                    A
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: bold; font-size: 1rem; color: white; line-height: 1.2;">Admin</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">ผู้ดูแลระบบ</div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <h2><i class="fas fa-tachometer-alt"></i> ภาพรวม</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 30px;">
                
                <div class="card" style="border-left: 4px solid #10b981; margin: 0;">
                    <div style="font-size: 0.9rem; color: #94a3b8;">ยอดฝากรวม</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-top: 5px; color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);" id="dashDeposit">฿0.00</div>
                    <i class="fas fa-arrow-down" style="position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.1; color: #10b981;"></i>
                </div>

                <div class="card" style="border-left: 4px solid #ef4444; margin: 0;">
                    <div style="font-size: 0.9rem; color: #94a3b8;">ยอดถอนรวม</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-top: 5px; color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);" id="dashWithdraw">฿0.00</div>
                    <i class="fas fa-arrow-up" style="position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.1; color: #ef4444;"></i>
                </div>

                <div class="card" style="border-left: 4px solid #3b82f6; margin: 0;">
                    <div style="font-size: 0.9rem; color: #94a3b8;">กำไรสุทธิ</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-top: 5px; color: #3b82f6; text-shadow: 0 0 10px rgba(59, 130, 246, 0.3);" id="dashNet">฿0.00</div>
                    <i class="fas fa-wallet" style="position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.1; color: #3b82f6;"></i>
                </div>

                <div class="card" style="border-left: 4px solid #f59e0b; margin: 0;">
                    <div style="font-size: 0.9rem; color: #94a3b8;">ผู้ใช้ทั้งหมด</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-top: 5px; color: #f59e0b; text-shadow: 0 0 10px rgba(245, 158, 11, 0.3);" id="dashUsers">0</div>
                    <i class="fas fa-users" style="position: absolute; right: 20px; top: 20px; font-size: 2rem; opacity: 0.1; color: #f59e0b;"></i>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0; color: var(--warning);"><i class="fas fa-tools"></i> โหมดบำรุงรักษา</h3>
                        <p style="color: #94a3b8; margin: 5px 0 0;">เปิดโหมดบำรุงรักษา (ผู้ใช้ไม่สามารถเข้าใช้งาน)</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="maintSwitch" onchange="toggleMaint()">
                        <span class="slider round"></span>
                    </label>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; border: 1px solid var(--border);">
                    <label style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px; display: block;">ข้อความบำรุงรักษา</label>
                    <textarea id="maintMsg" class="search-bar" style="height: 80px; resize: none;" placeholder="ระบบกำลังบำรุงรักษา..."></textarea>
                    <button onclick="saveMaintMsg()" class="btn-sm btn-green" style="width: 100%; padding: 12px; margin-top: 10px;">
                        <i class="fas fa-save"></i> บันทึกข้อความ
                    </button>
                </div>
            </div>
        </div>

        <!-- Monitor (Live Alert System) -->
        <div id="monitor" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 20px;">
                <h2 style="border: none; margin: 0;"><i class="fas fa-satellite-dish"></i> ศูนย์ควบคุมสด (Live Command)</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="liveIndicator" style="display: flex; align-items: center; gap: 8px; background: rgba(16, 185, 129, 0.1); padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.3);">
                        <div class="pulse-dot" style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px #10b981;"></div>
                        <span style="color: #10b981; font-size: 0.8rem; font-weight: bold;">LIVE</span>
                    </div>
                    <button onclick="toggleSound()" id="btnSound" class="btn-sm btn-gray" style="margin: 0;"><i class="fas fa-volume-mute"></i></button>
                </div>
            </div>

            <!-- Alerts Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <div class="card" style="margin: 0; border-left: 4px solid #f59e0b; background: linear-gradient(45deg, rgba(245, 158, 11, 0.05), transparent);">
                    <div style="color: #f59e0b; font-size: 0.9rem; font-weight: bold;">รอตรวจสอบ (Pending)</div>
                    <div style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;" id="monitorPendingCount">0</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">รายการที่ต้องอนุมัติ</div>
                </div>
                <div class="card" style="margin: 0; border-left: 4px solid #ef4444; background: linear-gradient(45deg, rgba(239, 68, 68, 0.05), transparent);">
                    <div style="color: #ef4444; font-size: 0.9rem; font-weight: bold;">แจ้งเตือนความเสี่ยง (Fraud)</div>
                    <div style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;" id="monitorFraudCount">0</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">IP ซ้ำ / สแปม</div>
                </div>
                <div class="card" style="margin: 0; border-left: 4px solid #3b82f6; background: linear-gradient(45deg, rgba(59, 130, 246, 0.05), transparent);">
                    <div style="color: #3b82f6; font-size: 0.9rem; font-weight: bold;">ผู้ใช้ออนไลน์ (Online)</div>
                    <div style="font-size: 2.5rem; font-weight: bold; margin-top: 5px;" id="monitorOnlineCount">1</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">เชื่อมต่ออยู่ในขณะนี้</div>
                </div>
            </div>

            <!-- Live Feed -->
            <div class="card">
                <h3 style="color: var(--primary); margin-top: 0; display: flex; justify-content: space-between;">
                    <span><i class="fas fa-stream"></i> รายการแจ้งเตือนล่าสุด</span>
                    <button onclick="clearAllAlerts()" class="btn-sm btn-gray" style="font-size: 0.7rem;">ล้างทั้งหมด</button>
                </h3>
                <div id="monitorFeed" style="max-height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                    <!-- Dynamic Content -->
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">ไม่มีการแจ้งเตือนใหม่</div>
                </div>
            </div>
        </div>

        <!-- Users -->
        <div id="users" class="section">
            <h2><i class="fas fa-users"></i> จัดการผู้ใช้</h2>
            <div class="card">
                <input type="text" id="searchUser" class="search-bar" placeholder="ค้นหาชื่อผู้ใช้, อีเมล..." onkeyup="filterUsers()">
                <div style="overflow-x: auto;">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>รูปโปรไฟล์</th>
                                <th>ผู้ใช้</th>
                                <th>ยอดเงิน</th>
                                <th>เครื่องขุด</th>
                                <th>สถานะ</th>
                                <th>การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Mining Rigs (User's Rigs) -->
        <div id="mining" class="section">
            <h2><i class="fas fa-server"></i> เครื่องขุดของผู้ใช้</h2>
            <div class="card">
                <div style="overflow-x: auto;">
                    <table id="miningTable">
                        <thead>
                            <tr>
                                <th>ผู้ใช้</th>
                                <th>ชื่อเครื่อง</th>
                                <th>ความเร็ว</th>
                                <th>เวลาที่เหลือ</th>
                                <th>สถานะ</th>
                                <th>การเชื่อมต่อ</th>
                                <th>การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Shop Management -->
        <div id="shop" class="section">
            <h2><i class="fas fa-shopping-cart"></i> จัดการร้านค้า</h2>
            
            <div class="card">
                <h3 style="color: var(--primary); margin-top: 0;">เพิ่มสินค้าใหม่</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <input type="text" id="shopName" class="search-bar" placeholder="ชื่อสินค้า">
                    <input type="number" id="shopPrice" class="search-bar" placeholder="ราคา (บาท)">
                    <input type="number" id="shopSpeed" class="search-bar" placeholder="ความเร็ว (MH/s)">
                    <select id="shopIcon" class="search-bar">
                        <option value="fa-microchip">Microchip</option>
                        <option value="fa-server">Server</option>
                        <option value="fa-hdd">HDD</option>
                        <option value="fa-memory">Memory</option>
                        <option value="fa-fan">Fan</option>
                    </select>
                    <select id="shopTag" class="search-bar">
                        <option value="">ไม่มีแท็ก</option>
                        <option value="hot">HOT</option>
                        <option value="new">NEW</option>
                        <option value="sale">SALE</option>
                        <option value="best">BEST</option>
                        <option value="used">USED (มือสอง)</option>
                    </select>
                </div>
                <button onclick="addShopItem()" class="btn-sm btn-primary" style="width: 100%; padding: 12px; margin-top: 10px;">
                    <i class="fas fa-plus"></i> เพิ่มสินค้าเข้าร้าน
                </button>
            </div>

            <div class="card">
                <h3 style="color: var(--primary); margin-top: 0;">สินค้าปัจจุบัน</h3>
                <div style="overflow-x: auto;">
                    <table id="shopTable">
                        <thead>
                            <tr>
                                <th>ชื่อ</th>
                                <th>ราคา</th>
                                <th>ความเร็ว</th>
                                <th>แท็ก</th>
                                <th>การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3 style="color: var(--primary); margin-top: 0;">ควบคุมร้านค้า</h3>
                <textarea id="shopNotice" class="search-bar" placeholder="ประกาศร้านค้า..."></textarea>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="saveShopNotice()" class="btn-sm btn-primary" style="flex:1; padding: 10px;">
                        <i class="fas fa-save"></i> บันทึกประกาศ
                    </button>
                    <button onclick="disableShop()" class="btn-sm btn-red" style="flex:1; padding: 10px;">
                        <i class="fas fa-store-slash"></i> ปิดร้านชั่วคราว
                    </button>
                    <button onclick="enableShop()" class="btn-sm btn-green" style="flex:1; padding: 10px;">
                        <i class="fas fa-store"></i> เปิดร้าน
                    </button>
                </div>
                <button onclick="clearShopItems()" class="btn-sm btn-red" style="width: 100%; padding: 12px;">
                    <i class="fas fa-trash"></i> ล้างสินค้าทั้งหมด
                </button>
            </div>
        </div>

        <!-- Referrals -->
        <div id="referrals" class="section">
            <h2><i class="fas fa-user-friends"></i> คำขอแนะนำเพื่อน</h2>
            <div class="card">
                <div style="overflow-x: auto;">
                    <table id="referralTable">
                        <thead>
                            <tr>
                                <th>วันที่/เวลา</th>
                                <th>ผู้แนะนำ (Upline)</th>
                                <th>ผู้สมัคร (Downline)</th>
                                <th>สถานะ</th>
                                <th>ข้อมูลตรวจสอบ (IP/Device)</th>
                                <th>การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transactions -->
        <div id="trans" class="section">
            <h2><i class="fas fa-exchange-alt"></i> ธุรกรรม</h2>
            
            <div class="card">
                <h3 style="color: var(--primary); margin-top: 0;"><i class="fas fa-university"></i> ตั้งค่าบัญชีรับเงิน (Admin Bank)</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.9rem;">ธนาคาร</label>
                        <select id="adminBankName" class="cyber-input">
                            <option value="kbank">กสิกรไทย (KBANK)</option>
                            <option value="scb">ไทยพาณิชย์ (SCB)</option>
                            <option value="ktb">กรุงไทย (KTB)</option>
                            <option value="bbl">กรุงเทพ (BBL)</option>
                            <option value="gsb">ออมสิน (GSB)</option>
                            <option value="ttb">ทีทีบี (ttb)</option>
                            <option value="promptpay">พร้อมเพย์ (PromptPay)</option>
                        </select>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 0.9rem;">เลขบัญชี / เบอร์โทร</label>
                        <input type="text" id="adminBankNumber" class="cyber-input" placeholder="xxx-x-xxxxx-x">
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                     <label style="color: var(--text-muted); font-size: 0.9rem;">ชื่อบัญชี</label>
                    <input type="text" id="adminAccName" class="cyber-input" placeholder="ชื่อบัญชีที่ใช้รับเงิน">
                </div>

                <button onclick="savePaymentSettings()" class="btn-sm btn-green" style="width: 100%; padding: 12px;">
                    <i class="fas fa-save"></i> บันทึกข้อมูลบัญชี
                </button>
            </div>

            <div class="card">
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <button onclick="filterTrans('all')" class="btn-sm btn-primary">ทั้งหมด</button>
                    <button onclick="filterTrans('pending')" class="btn-sm btn-warning" style="background: #f59e0b;">รอตรวจสอบ</button>
                    <button onclick="filterTrans('approved')" class="btn-sm btn-green">อนุมัติแล้ว</button>
                    <button onclick="filterTrans('rejected')" class="btn-sm btn-red">ปฏิเสธ</button>
                    
                    <div style="flex-grow: 1;"></div>
                    
                    <button onclick="clearTransactions()" class="btn-sm btn-red" style="background: #dc2626; border: 1px solid rgba(255,255,255,0.2);">
                        <i class="fas fa-trash"></i> ล้างข้อมูล
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="transTable">
                        <thead>
                            <tr>
                                <th>วันที่</th>
                                <th>ผู้ใช้</th>
                                <th>ประเภท</th>
                                <th>จำนวนเงิน</th>
                                <th>สลิป/ข้อมูล</th>
                                <th>สถานะ</th>
                                <th>การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Announcements -->
        <div id="announce" class="section">
            <h2><i class="fas fa-bullhorn"></i> ประกาศ</h2>
            <div class="card">
                <textarea id="announceText" class="search-bar" style="height: 100px;" placeholder="พิมพ์ข้อความประกาศ..."></textarea>
                <button onclick="postAnnounce()" class="btn-sm btn-primary" style="width: 100%; padding: 12px;">
                    <i class="fas fa-paper-plane"></i> เผยแพร่ประกาศ
                </button>
                
                <div style="margin-top: 20px;">
                    <h3 style="color: var(--text-muted); font-size: 1rem;">ประกาศที่ใช้งานอยู่</h3>
                    <div id="currentAnnounce" style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 3px solid var(--primary); color: white;">
                        - ไม่มีประกาศที่ใช้งานอยู่ -
                    </div>
                    <button onclick="clearAnnounce()" class="btn-sm btn-red" style="margin-top: 10px;">ล้างประกาศ</button>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3 style="color: var(--danger);"><i class="fas fa-trash-alt"></i> รีเซ็ตระบบ</h3>
                <p style="color: var(--text-muted);">ล้างข้อมูลผู้ใช้ ธุรกรรม และการขุดทั้งหมด</p>
                <button onclick="resetSystem()" class="btn-sm btn-red" style="width: 100%; padding: 12px;">
                    ล้างข้อมูลทั้งหมด
                </button>
            </div>
        </div>

    </div>

    <!-- Image Modal -->
    <div id="imgModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
        <img id="modalImg" src="" style="max-width: 90%; max-height: 60vh; border: 2px solid var(--primary); box-shadow: 0 0 30px var(--primary); border-radius: 8px;">
        
        <!-- User Bank Details -->
        <div id="modalBankInfo" style="margin-top: 20px; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--border); padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
             <h4 style="color: var(--primary); margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
                 <i class="fas fa-info-circle"></i> ข้อมูลบัญชีผู้ใช้
             </h4>
             <div id="modalBankContent" style="font-size: 0.9rem; color: #e2e8f0; display: grid; gap: 8px;">
                 <!-- Dynamic Content -->
             </div>
        </div>

        <button onclick="document.getElementById('imgModal').style.display='none'" class="btn-sm btn-red" style="margin-top: 20px; padding: 10px 30px; font-size: 1.2rem;">ปิด</button>
    </div>

    <!-- Admin Login Overlay -->
    <div id="adminLogin" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050510; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <div style="text-align: center; margin-bottom: 30px;">
            <i class="fas fa-user-shield" style="font-size: 4rem; color: var(--primary); text-shadow: 0 0 20px var(--primary);"></i>
            <h1 style="color: var(--primary); margin: 15px 0; letter-spacing: 2px;">SYSTEM ADMIN</h1>
            <div style="color: var(--text-muted);">เข้าสู่ระบบจัดการหลังบ้าน</div>
        </div>
        <div style="background: rgba(255,255,255,0.05); padding: 30px; border-radius: 16px; border: 1px solid var(--border); width: 300px; text-align: center;">
            <input type="password" id="adminPin" placeholder="Enter Access PIN" style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; font-size: 1.2rem; text-align: center; margin-bottom: 20px; outline: none;">
            <button onclick="checkAdminLogin()" class="btn-sm btn-primary" style="width: 100%; padding: 12px; font-size: 1rem;">ACCESS SYSTEM</button>
        </div>
        <div style="margin-top: 20px; color: var(--danger); font-size: 0.9rem; opacity: 0;" id="loginError">
            <i class="fas fa-exclamation-circle"></i> รหัสผ่านไม่ถูกต้อง
        </div>
    </div>

    <script src="live-sync.js"></script>
    <script>
        // Admin Login Logic
        function checkAdminLogin() {
            const pin = document.getElementById('adminPin').value;
            // Default PIN: 8888 or admin123
            if(pin === '8888' || pin === 'admin123') {
                document.getElementById('adminLogin').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('adminLogin').style.display = 'none';
                }, 500);
                sessionStorage.setItem('admin_logged_in', 'true');
            } else {
                const err = document.getElementById('loginError');
                err.style.opacity = '1';
                err.classList.add('shake');
                setTimeout(() => err.classList.remove('shake'), 500);
            }
        }

        // Check session on load
        if(sessionStorage.getItem('admin_logged_in') === 'true') {
            document.getElementById('adminLogin').style.display = 'none';
        }

        // Enter key support
        document.getElementById('adminPin').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkAdminLogin();
            }
        });

        // Check if LiveSync is loaded from live-sync.js
        if (typeof liveSync === 'undefined') {
            console.error('LiveSync not loaded properly');
            // Fallback to prevent crashes
            window.liveSync = { 
                broadcast: () => console.log('LiveSync disabled (fallback)'), 
                on: () => {},
                getStatus: () => 'disabled'
            };
        }

        // Navigation
        function nav(id, el) {
            // Safety check for target section
            const target = document.getElementById(id);
            if (!target) {
                console.error('Section not found:', id);
                return;
            }

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            target.classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            
            if(el) {
                el.classList.add('active');
            }
            
            // Refresh specific sections
            if(id === 'dashboard') renderDashboard();
            if(id === 'users') renderUsers();
            if(id === 'mining') renderMining();
            if(id === 'shop') renderShop();
            if(id === 'trans') renderTrans();
            if(id === 'referrals') renderReferrals();
            if(id === 'monitor') updateMonitor();
        }

        // Toast
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `ai-toast ${type}`;
            toast.innerHTML = `
                <div style="flex-shrink: 0;">
                    ${type === 'success' ? '<i class="fas fa-check-circle" style="color:var(--success); font-size:1.5rem;"></i>' : 
                      type === 'error' ? '<i class="fas fa-exclamation-circle" style="color:var(--danger); font-size:1.5rem;"></i>' :
                      '<i class="fas fa-info-circle" style="color:var(--primary); font-size:1.5rem;"></i>'}
                </div>
                <div>
                    <div style="font-weight: bold; margin-bottom: 2px;">ระบบแจ้งเตือน</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">${msg}</div>
                </div>
            `;
            container.appendChild(toast);
            
            // Sound effect
            if(type === 'error') {
                // Error sound
            }
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- CORE FUNCTIONS ---

        // Dashboard
        async function renderDashboard() {
            try {
                const [resUsers, resTrans, resSettings] = await Promise.all([
                    fetch('/api/admin/users'),
                    fetch('/api/admin/transactions'),
                    fetch('/api/admin/settings')
                ]);
                
                const users = await resUsers.json();
                const trans = await resTrans.json();
                const settings = await resSettings.json();
                
                // 1. Users
                const userCount = Object.keys(users).length;
                document.getElementById('dashUsers').innerText = userCount;

                // 2. Financials
                let deposit = trans.filter(t => t.type === 'deposit' && t.status === 'approved').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                let withdraw = trans.filter(t => t.type === 'withdraw' && t.status === 'approved').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                document.getElementById('dashDeposit').innerText = '฿' + deposit.toLocaleString();
                document.getElementById('dashWithdraw').innerText = '฿' + withdraw.toLocaleString();
                document.getElementById('dashNet').innerText = '฿' + (deposit - withdraw).toLocaleString();
                
                // Maint Status
                const maint = settings.maintenance === true || settings.maintenance === 'true';
                document.getElementById('maintSwitch').checked = maint;
                document.getElementById('maintMsg').value = settings.maintenance_msg || '';

            } catch(err) { console.error('Dashboard Error:', err); }
        }

        // Maintenance
        async function toggleMaint() {
            const status = document.getElementById('maintSwitch').checked;
            try {
                await fetch('/api/admin/settings', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ maintenance: status })
                });
                showToast(status ? 'เปิดโหมดบำรุงรักษาแล้ว' : 'ปิดโหมดบำรุงรักษาแล้ว', 'warning');
            } catch(e) { showToast('เกิดข้อผิดพลาดในการบันทึก', 'error'); }
        }
        
        async function saveMaintMsg() {
            const msg = document.getElementById('maintMsg').value;
            try {
                await fetch('/api/admin/settings', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ maintenance_msg: msg })
                });
                showToast('บันทึกข้อความบำรุงรักษาแล้ว', 'success');
            } catch(e) { showToast('เกิดข้อผิดพลาดในการบันทึก', 'error'); }
        }

        // Users
        function filterUsers() {
            const term = document.getElementById('searchUser').value.toLowerCase();
            renderUsers(term);
        }

        async function renderUsers(filter = '') {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();
                
                const tb = document.querySelector('#usersTable tbody');
                tb.innerHTML = '';
                
                Object.keys(users).forEach(username => {
                    if(filter && !username.toLowerCase().includes(filter)) return;
                    
                    const u = users[username];
                    const avatar = u.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`;
                    const balance = u.balance || 0;
                    const rigsCount = u.rigs ? u.rigs.length : 0; 
                    
                    let tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${(u.id || '').toString().substr(-6)}</td>
                        <td><img src="${avatar}" style="width:30px; height:30px; border-radius:50%;"></td>
                        <td style="font-weight: bold; color: var(--primary);">${username}</td>
                        <td>฿${parseFloat(balance).toLocaleString()}</td>
                        <td>${rigsCount} เครื่อง</td>
                        <td><span class="badge badge-success">ปกติ</span></td>
                        <td>
                            <button onclick="resetUserPass('${username}')" class="btn-sm btn-warning"><i class="fas fa-key"></i></button>
                            <button onclick="deleteUser('${username}')" class="btn-sm btn-red"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tb.appendChild(tr);
                });
            } catch(err) {
                console.error('Load Users Error:', err);
                showToast('ไม่สามารถโหลดข้อมูลผู้ใช้ได้', 'error');
            }
        }
        
        async function resetUserPass(user) {
            if(confirm(`รีเซ็ตรหัสผ่านของ ${user} เป็น '123456'?`)) {
                try {
                    const res = await fetch('/api/admin/reset-password', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username: user, password: '123456' })
                    });
                    const data = await res.json();
                    if(data.success) showToast('รีเซ็ตรหัสผ่านแล้ว', 'success');
                    else showToast('Error: ' + data.error, 'error');
                } catch(e) { showToast('Connection Error', 'error'); }
            }
        }
        
        async function deleteUser(user) {
            if(confirm(`ยืนยันการลบผู้ใช้ ${user}? ข้อมูลทั้งหมดจะหายไป!`)) {
                try {
                    const res = await fetch('/api/admin/delete-user', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username: user })
                    });
                    const data = await res.json();
                    if(data.success) {
                        showToast('ลบผู้ใช้เรียบร้อย', 'success');
                        renderUsers();
                        renderDashboard();
                    } else showToast('Error: ' + data.error, 'error');
                } catch(e) { showToast('Connection Error', 'error'); }
            }
        }


        // Mining Management (All Users Rigs)
        async function renderMining() {
            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();
                
                const tb = document.querySelector('#miningTable tbody');
                tb.innerHTML = '';
                
                Object.values(users).forEach(u => {
                    if(u.rigs && u.rigs.length > 0) {
                        u.rigs.forEach(r => {
                            let tr = document.createElement('tr');
                            
                            // Calculate Time Left
                            let timeLeft = '-';
                            if(r.expiresAt) {
                                const diff = r.expiresAt - Date.now();
                                if(diff > 0) {
                                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                    timeLeft = `${days} วัน`;
                                } else {
                                    timeLeft = 'หมดอายุ';
                                }
                            } else {
                                timeLeft = 'ถาวร';
                            }

                            tr.innerHTML = `
                                <td style="color: var(--primary);">${u.username}</td>
                                <td><i class="fas ${r.icon}"></i> ${r.name}</td>
                                <td>${r.speed} MH/s</td>
                                <td>${timeLeft}</td>
                                <td><span class="badge badge-success">Active</span></td>
                                <td><div style="width:8px;height:8px;background:#00ff9d;border-radius:50%;box-shadow:0 0 5px #00ff9d;"></div></td>
                                <td>
                                    <button onclick="deleteUserRig('${u.username}', '${r.name}')" class="btn-sm btn-red"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            tb.appendChild(tr);
                        });
                    }
                });
            } catch(err) {
                console.error('Load Mining Error:', err);
                showToast('ไม่สามารถโหลดข้อมูลเครื่องขุดได้', 'error');
            }
        }
        
        async function deleteUserRig(user, rigName) {
            if(confirm(`ลบเครื่องขุด ${rigName} ของ ${user}?`)) {
                try {
                    const res = await fetch('/api/admin/delete-rig', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username: user, rigName })
                    });
                    const data = await res.json();
                    if(data.success) {
                        renderMining();
                        showToast(`ลบเครื่อง ${rigName} ของ ${user} แล้ว`, 'success');
                    } else {
                        showToast('Error: ' + data.error, 'error');
                    }
                } catch(e) { showToast('Connection Error', 'error'); }
            }
        }

        // Shop
        async function renderShop() {
            try {
                const res = await fetch('/api/shop/items');
                const items = await res.json();
                
                const tb = document.querySelector('#shopTable tbody');
                tb.innerHTML = '';
                
                items.forEach(i => {
                    let tr = document.createElement('tr');
                    let tagBadge = i.tag ? `<span class="badge badge-info">${i.tag}</span>` : '-';
                    if(i.tag === 'used') tagBadge = `<span class="badge badge-warning" style="border-color: #cd7f32; color: #cd7f32;">USED</span>`;
                    
                    tr.innerHTML = `
                        <td><i class="fas ${i.icon}" style="margin-right: 5px; color: var(--primary);"></i> ${i.name}</td>
                        <td>฿${i.price.toLocaleString()}</td>
                        <td>${i.speed} MH/s</td>
                        <td>${tagBadge}</td>
                        <td>
                            <button onclick="deleteShopItem(${i.id})" class="btn-sm btn-red"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tb.appendChild(tr);
                });
            } catch(err) {
                console.error('Load Shop Error:', err);
            }
        }

        async function addShopItem() {
            const name = document.getElementById('shopName').value;
            const price = parseFloat(document.getElementById('shopPrice').value);
            const speed = parseFloat(document.getElementById('shopSpeed').value);
            const icon = document.getElementById('shopIcon').value;
            const tag = document.getElementById('shopTag').value;

            if(name && !isNaN(price) && !isNaN(speed)) {
                try {
                    const res = await fetch('/api/admin/shop/items', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ name, price, speed, icon, tag })
                    });
                    const data = await res.json();
                    
                    if(data.success) {
                        renderShop();
                        showToast('เพิ่มสินค้าแล้ว', 'success');
                        // Clear inputs
                        document.getElementById('shopName').value = '';
                        document.getElementById('shopPrice').value = '';
                        document.getElementById('shopSpeed').value = '';
                    } else {
                        showToast('Error: ' + data.error, 'error');
                    }
                } catch(e) { showToast('Connection Error', 'error'); }
            } else {
                showToast('กรุณากรอกข้อมูลให้ครบและถูกต้อง', 'error');
            }
        }

        async function deleteShopItem(id) {
            if(confirm('ลบสินค้านี้หรือไม่?')) {
                try {
                    const res = await fetch('/api/admin/delete-shop-item', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id })
                    });
                    const data = await res.json();
                    if(data.success) {
                        renderShop();
                        showToast('ลบสินค้าแล้ว', 'success');
                    } else showToast('Error: ' + data.error, 'error');
                } catch(e) { showToast('Connection Error', 'error'); }
            }
        }

        // Referrals
        async function renderReferrals() {
            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();
                
                const tb = document.querySelector('#referralTable tbody');
                tb.innerHTML = '';
                
                let allRefs = [];
                const userArray = Object.values(users);
                
                // Map ID to Username for Referrer lookup
                const idToUsername = {};
                userArray.forEach(u => { if(u.id) idToUsername[u.id] = u.username; });
                
                // Build Referral List from Users who have referrer_id
                userArray.forEach(u => {
                    if(u.referrer_id) {
                        const referrerName = idToUsername[u.referrer_id] || `ID:${u.referrer_id}`;
                        allRefs.push({
                            date: u.regDate,
                            referrer: referrerName,
                            name: u.username,
                            status: u.status || 'pending',
                            ip: u.ip || 'Unknown',
                            deviceId: u.deviceId || 'Unknown'
                        });
                    }
                });

                // Sort by Date Descending
                allRefs.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Fraud Detection Map
                const ipCounts = {};
                const deviceCounts = {};
                allRefs.forEach(r => {
                    if(r.ip && r.ip !== 'Unknown') ipCounts[r.ip] = (ipCounts[r.ip] || 0) + 1;
                    if(r.deviceId && r.deviceId !== 'Unknown') deviceCounts[r.deviceId] = (deviceCounts[r.deviceId] || 0) + 1;
                });

                let pendingCount = allRefs.filter(r => r.status === 'pending').length;
                const badge = document.getElementById('navReferralBadge');
                if(badge) {
                    badge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
                    badge.innerText = pendingCount;
                }

                if(allRefs.length === 0) {
                    tb.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">ไม่พบข้อมูลการแนะนำ</td></tr>';
                    return;
                }

                allRefs.forEach(r => {
                    let tr = document.createElement('tr');
                    
                    // Fraud Check
                    let isFraudIP = (ipCounts[r.ip] > 1);
                    let isFraudDev = (deviceCounts[r.deviceId] > 1);
                    
                    // Check against Referrer's IP/Device (need referrer obj)
                    // We only have referrerName. We need to find referrer obj from users
                    const referrerObj = users[r.referrer]; // This assumes referrerName is username, which it is from idToUsername
                    
                    let sameAsUpline = false;
                    if(referrerObj) {
                        if(referrerObj.ip && r.ip && r.ip !== 'Unknown' && referrerObj.ip === r.ip) sameAsUpline = true;
                        if(referrerObj.deviceId && r.deviceId && referrerObj.deviceId !== 'Unknown' && referrerObj.deviceId === r.deviceId) sameAsUpline = true;
                    }

                    let fraudAlert = '';
                    if(isFraudIP || isFraudDev || sameAsUpline) {
                        fraudAlert = '<div style="color:#ff4444; font-size:0.8rem; margin-top:5px;"><i class="fas fa-exclamation-triangle"></i> พบความผิดปกติ!</div>';
                        if(sameAsUpline) fraudAlert += '<div style="font-size:0.75rem; color:orange;">IP/Device ตรงกับ Upline</div>';
                        else if(isFraudIP) fraudAlert += '<div style="font-size:0.75rem; color:orange;">IP ซ้ำกันหลายบัญชี</div>';
                    }

                    let statusBadge = '';
                    if(r.status === 'pending') statusBadge = '<span class="badge badge-warning">รอตรวจสอบ</span>';
                    else if(r.status === 'approved') statusBadge = '<span class="badge badge-success">อนุมัติแล้ว</span>';
                    else if(r.status === 'rejected') statusBadge = '<span class="badge badge-danger">ปฏิเสธ</span>';
                    else if(r.status === 'fraud') statusBadge = '<span class="badge badge-danger" style="background:darkred;">ทุจริต</span>';
                    else statusBadge = `<span class="badge">${r.status}</span>`;

                    let actionBtns = '';
                    if(r.status === 'pending') {
                        // Pass referrer name for reference, but backend mainly needs referee username
                        actionBtns = `
                            <button onclick="updateRefStatus('${r.referrer}', '${r.name}', 'approved')" class="btn-sm btn-green" title="อนุมัติ"><i class="fas fa-check"></i></button>
                            <button onclick="updateRefStatus('${r.referrer}', '${r.name}', 'rejected')" class="btn-sm btn-red" title="ปฏิเสธ"><i class="fas fa-times"></i></button>
                            <button onclick="updateRefStatus('${r.referrer}', '${r.name}', 'fraud')" class="btn-sm" style="background:black; border:1px solid red;" title="ระบุว่าทุจริต"><i class="fas fa-ban"></i></button>
                        `;
                    } else {
                        actionBtns = '<span style="color:#aaa;">-</span>';
                    }

                    tr.innerHTML = `
                        <td>${new Date(r.date).toLocaleString()}</td>
                        <td style="font-weight:bold; color:var(--primary);">${r.referrer}</td>
                        <td style="font-weight:bold;">${r.name}</td>
                        <td>${statusBadge}</td>
                        <td style="font-size:0.85rem; color:#aaa;">
                            IP: ${r.ip || 'N/A'}<br>
                            Dev: ${r.deviceId ? r.deviceId.substr(0,8)+'...' : 'N/A'}
                            ${fraudAlert}
                        </td>
                        <td>${actionBtns}</td>
                    `;
                    tb.appendChild(tr);
                });
            } catch(err) {
                console.error('Load Referrals Error:', err);
                showToast('ไม่สามารถโหลดข้อมูลแนะนำเพื่อนได้', 'error');
            }
        }

        async function updateRefStatus(referrer, referee, status) {
            if(!confirm(`ยืนยันเปลี่ยนสถานะเป็น ${status}?`)) return;
            
            try {
                const res = await fetch('/api/admin/update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: referee, status, referrer_id: referrer }) 
                });
                
                const data = await res.json();
                if(data.success) {
                    showToast(`อัปเดตสถานะเป็น ${status} แล้ว`, 'success');
                    renderReferrals();
                    if(typeof updateMonitor === 'function') updateMonitor();
                } else {
                    showToast('เกิดข้อผิดพลาด: ' + (data.error || 'Unknown'), 'error');
                }
            } catch(err) {
                console.error(err);
                showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
            }
        }

        async function saveShopNotice() {
            const txt = document.getElementById('shopNotice').value || '';
            try {
                await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ shop_notice: txt })
                });
                showToast('บันทึกประกาศร้านค้าแล้ว', 'success');
            } catch(e) { showToast('Connection Error', 'error'); }
        }
        async function disableShop() {
            try {
                await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ shop_disabled: 'true' })
                });
                showToast('ปิดร้านค้าชั่วคราว', 'warning');
            } catch(e) { showToast('Connection Error', 'error'); }
        }
        async function enableShop() {
            try {
                await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ shop_disabled: 'false' })
                });
                showToast('เปิดร้านค้าแล้ว', 'success');
            } catch(e) { showToast('Connection Error', 'error'); }
        }
        async function clearShopItems() {
            if(!confirm('ล้างสินค้าทั้งหมด?')) return;
            try {
                const res = await fetch('/api/admin/shop/clear', { method: 'POST' });
                const data = await res.json();
                if(data.success) {
                    renderShop();
                    showToast('ล้างสินค้าทั้งหมดแล้ว', 'success');
                } else {
                    showToast('Error: ' + data.error, 'error');
                }
            } catch(e) { showToast('Connection Error', 'error'); }
        }

        // Transactions
        let currentTransFilter = 'all';
        let currentTransactions = []; // Store for viewSlip access
        let currentUsers = {}; // Store for bank info access

        async function clearTransactions() {
            if(confirm('คุณแน่ใจหรือไม่ที่จะล้างประวัติธุรกรรมทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                try {
                    const res = await fetch('/api/admin/transactions/clear', { method: 'POST' });
                    const data = await res.json();
                    
                    if(data.success) {
                        renderTrans();
                        showToast('ล้างประวัติธุรกรรมแล้ว', 'success');
                    } else {
                        showToast('Error: ' + data.error, 'error');
                    }
                } catch(e) { 
                    console.error(e);
                    showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
                }
            }
        }

        function filterTrans(status) {
            currentTransFilter = status;
            renderTrans();
        }

        async function renderTrans() {
            loadPaymentSettings(); 
            
            try {
                // Fetch both transactions and users for cross-referencing (bank info)
                const [resTrans, resUsers] = await Promise.all([
                    fetch('/api/admin/transactions'),
                    fetch('/api/admin/users')
                ]);
                
                const trans = await resTrans.json();
                const users = await resUsers.json();
                
                currentTransactions = trans;
                currentUsers = users;

                // Sort by timestamp
                trans.sort((a, b) => (b.timestamp || b.date || 0) - (a.timestamp || a.date || 0));
                
                const tb = document.querySelector('#transTable tbody');
                tb.innerHTML = '';

                if(trans.length === 0) {
                    tb.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--text-muted);">
                        <i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px; opacity:0.5;"></i><br>
                        ไม่พบประวัติธุรกรรม
                    </td></tr>`;
                    document.getElementById('navTransBadge').style.display = 'none';
                    return;
                }

                let pendingCount = 0;

                trans.forEach(t => {
                    if(t.status === 'pending') pendingCount++;
                    if(currentTransFilter !== 'all' && t.status !== currentTransFilter) return;

                    let statusBadge = '';
                    if(t.status === 'pending') statusBadge = '<span class="badge badge-warning">รอตรวจสอบ</span>';
                    else if(t.status === 'approved') statusBadge = '<span class="badge badge-success">อนุมัติแล้ว</span>';
                    else if(t.status === 'rejected') statusBadge = '<span class="badge badge-danger">ปฏิเสธ</span>';

                    let actionBtns = '';
                    if(t.status === 'pending') {
                        actionBtns = `
                            <button onclick="approveTrans(${t.id}, 'approved')" class="btn-sm btn-green"><i class="fas fa-check"></i></button>
                            <button onclick="approveTrans(${t.id}, 'rejected')" class="btn-sm btn-red"><i class="fas fa-times"></i></button>
                        `;
                    }

                    let slipLink = t.slip ? `<button onclick="viewSlip(${t.id})" class="btn-sm btn-primary"><i class="fas fa-image"></i> ดู</button>` : '-';

                    let tr = document.createElement('tr');
                    const typeLabel = t.type === 'deposit' ? '<span style="color:#10b981">ฝากเงิน</span>' : '<span style="color:#ef4444">ถอนเงิน</span>';
                    
                    const ts = t.timestamp || t.date;
                    const dateStr = ts ? new Date(ts).toLocaleString() : 'Invalid Date';

                    tr.innerHTML = `
                        <td>${dateStr}</td>
                        <td style="font-weight: bold; color: white;">${t.user}</td>
                        <td style="text-transform: uppercase;">${typeLabel}</td>
                        <td style="font-weight: bold;">฿${parseFloat(t.amount).toLocaleString()}</td>
                        <td>${slipLink}</td>
                        <td>${statusBadge}</td>
                        <td>${actionBtns}</td>
                    `;
                    tb.appendChild(tr);
                });
                
                const badge = document.getElementById('navTransBadge');
                if(badge) {
                    badge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
                    badge.innerText = pendingCount;
                }
            } catch(err) {
                console.error('Load Trans Error:', err);
                showToast('ไม่สามารถโหลดข้อมูลธุรกรรมได้', 'error');
            }
        }

        async function approveTrans(id, status) {
            try {
                const res = await fetch('/api/admin/update-transaction-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, status })
                });
                
                const data = await res.json();
                if(data.success) {
                    renderTrans();
                    renderDashboard();
                    const statusThai = status === 'approved' ? 'อนุมัติ' : 'ปฏิเสธ';
                    showToast(`ทำเครื่องหมายธุรกรรมเป็น ${statusThai}`, 'success');
                } else {
                    showToast('เกิดข้อผิดพลาด: ' + data.error, 'error');
                }
            } catch(err) {
                console.error(err);
                showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
            }
        }
        
        function viewSlip(id) {
            let t = currentTransactions.find(item => item.id === id);
            if(t) {
                if(t.slip) {
                    document.getElementById('modalImg').src = t.slip;
                    document.getElementById('modalImg').style.display = 'block';
                } else {
                    document.getElementById('modalImg').style.display = 'none';
                }

                // Show User Bank Info
                const u = currentUsers[t.user] || {};
                
                const content = document.getElementById('modalBankContent');
                let bankHtml = '';
                
                if(t.type === 'deposit') {
                     bankHtml = `
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px;">
                            <div style="color: var(--success); font-weight: bold; font-size: 1.1rem;">ฝากเงิน: ฿${parseFloat(t.amount).toLocaleString()}</div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">${new Date(t.timestamp || t.date).toLocaleString('th-TH')}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #94a3b8;">ผู้ทำรายการ:</span>
                            <span style="color: white; font-weight: bold;">${t.user}</span>
                        </div>
                        <div style="margin-top: 5px; padding-top: 5px; border-top: 1px dashed rgba(255,255,255,0.1);">
                            <div style="color: var(--warning); margin-bottom: 3px; font-size: 0.9rem;">บัญชีที่โอนเข้ามา (ข้อมูลผู้ใช้):</div>
                            ${u.bank ? `
                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 5px 15px; font-size: 0.9rem;">
                                    <div style="color: #94a3b8;">ธนาคาร:</div>
                                    <div style="color: var(--secondary); font-weight: bold;">${u.bank.toUpperCase()}</div>
                                    <div style="color: #94a3b8;">เลขบัญชี:</div>
                                    <div style="color: white; letter-spacing: 0.5px;">${u.acc}</div>
                                    <div style="color: #94a3b8;">ชื่อบัญชี:</div>
                                    <div style="color: white;">${u.name}</div>
                                </div>
                            ` : '<div style="color: var(--danger);">ยังไม่ได้ลงทะเบียนบัญชีธนาคาร</div>'}
                        </div>
                     `;
                } else {
                    // Withdraw
                     bankHtml = `
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px;">
                            <div style="color: var(--danger); font-weight: bold; font-size: 1.1rem;">ถอนเงิน: ฿${parseFloat(t.amount).toLocaleString()}</div>
                            <div style="font-size: 0.8rem; color: #94a3b8;">${new Date(t.timestamp || t.date).toLocaleString('th-TH')}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #94a3b8;">ผู้ทำรายการ:</span>
                            <span style="color: white; font-weight: bold;">${t.user}</span>
                        </div>
                        <div style="margin-top: 5px; padding-top: 5px; border-top: 1px dashed rgba(255,255,255,0.1);">
                            <div style="color: var(--warning); margin-bottom: 3px; font-size: 0.9rem;">โอนไปยังบัญชี:</div>
                            ${u.bank ? `
                                <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.1rem; font-weight: bold; color: var(--secondary);">${u.bank.toUpperCase()}</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: white; letter-spacing: 1px;">${u.acc}</div>
                                    <div style="color: #ccc;">${u.name}</div>
                                </div>
                            ` : '<div style="color: var(--danger);">ไม่พบข้อมูลบัญชีธนาคาร!</div>'}
                        </div>
                     `;
                }
                
                content.innerHTML = bankHtml;
                document.getElementById('imgModal').style.display = 'flex';
            } else {
                showToast('ไม่พบข้อมูลธุรกรรม', 'error');
            }
        }

        // Announcements & System
        async function postAnnounce() {
            const txt = document.getElementById('announceText').value;
            if(txt) {
                const annObj = { msg: txt, date: new Date().toISOString() };
                try {
                    await fetch('/api/admin/settings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ mining_announcement: annObj })
                    });
                    document.getElementById('currentAnnounce').innerText = txt;
                    document.getElementById('announceText').value = '';
                    showToast('อัปเดตประกาศแล้ว', 'success');
                } catch(e) { showToast('Connection Error', 'error'); }
            }
        }
        
        async function clearAnnounce() {
            try {
                await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ mining_announcement: null })
                });
                document.getElementById('currentAnnounce').innerText = '- ไม่มีประกาศที่ใช้งานอยู่ -';
                showToast('ล้างประกาศแล้ว', 'success');
            } catch(e) { showToast('Connection Error', 'error'); }
        }

        async function resetSystem() {
            if(confirm('⚠️ อันตราย! คุณแน่ใจหรือไม่ที่จะล้างข้อมูลทั้งหมด? การกระทำนี้ไม่สามารถกู้คืนได้!')) {
                try {
                    const res = await fetch('/api/admin/reset-system', { method: 'POST' });
                    if(res.ok) {
                        alert('ระบบถูกรีเซ็ตแล้ว');
                        location.reload();
                    }
                } catch(e) { alert('Error resetting system'); }
            }
        }

        // Payment Settings
        async function savePaymentSettings() {
            const bank = document.getElementById('adminBankName').value;
            const number = document.getElementById('adminBankNumber').value;
            const name = document.getElementById('adminAccName').value;
            
            if(!number || !name) {
                showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }

            try {
                await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        admin_bank_name: bank,
                        admin_bank_number: number,
                        admin_acc_name: name
                    })
                });
                showToast('บันทึกข้อมูลบัญชีธนาคารแล้ว', 'success');
            } catch(e) { showToast('Connection Error', 'error'); }
        }

        async function loadPaymentSettings() {
            try {
                const res = await fetch('/api/admin/settings');
                const settings = await res.json();
                
                const bank = settings.admin_bank_name || 'promptpay';
                const number = settings.admin_bank_number || '';
                const name = settings.admin_acc_name || '';
                
                const elBank = document.getElementById('adminBankName');
                const elNum = document.getElementById('adminBankNumber');
                const elName = document.getElementById('adminAccName');
                
                if(elBank) elBank.value = bank;
                if(elNum) elNum.value = number;
                if(elName) elName.value = name;
            } catch(e) { console.error('Load Settings Error:', e); }
        }

        // --- Live Monitor System ---
        let soundEnabled = false;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('btnSound');
            if(soundEnabled) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.classList.remove('btn-gray');
                btn.classList.add('btn-primary');
                playBeep(); // Test sound
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-gray');
            }
        }

        function playBeep() {
            if(!soundEnabled || audioCtx.state === 'suspended') {
                if(soundEnabled) audioCtx.resume();
                return;
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.value = 880; // A5
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        async function updateMonitor() {
            const feed = document.getElementById('monitorFeed');
            if(!feed) return;

            let pendingCount = 0;
            let fraudCount = 0;
            // Mock online users for now, or implement heartbeat later
            let onlineCount = Math.floor(Math.random() * 5) + 1; 

            let allAlerts = [];

            try {
                const [resTrans, resUsers] = await Promise.all([
                    fetch('/api/admin/transactions'),
                    fetch('/api/admin/users')
                ]);
                const trans = await resTrans.json();
                const users = await resUsers.json();
                
                const usersArray = Object.values(users);

                // 1. Pending Transactions
                trans.forEach(t => {
                    if(t.status === 'pending') {
                        pendingCount++;
                        allAlerts.push({
                            type: 'trans',
                            data: t,
                            time: t.timestamp || t.date || Date.now(),
                            priority: 'high'
                        });
                    }
                });

                // 2. Pending Referrals & Fraud Check
                const ipCounts = {};
                const deviceCounts = {};
                
                // Build fraud maps from ALL users
                usersArray.forEach(u => {
                    if(u.ip && u.ip !== 'Unknown') ipCounts[u.ip] = (ipCounts[u.ip] || 0) + 1;
                    if(u.deviceId && u.deviceId !== 'Unknown') deviceCounts[u.deviceId] = (deviceCounts[u.deviceId] || 0) + 1;
                });

                usersArray.forEach(u => {
                    if(u.status === 'pending') {
                        pendingCount++;
                        
                        // Check fraud
                        let isFraud = false;
                        if(ipCounts[u.ip] > 1) isFraud = true;
                        if(deviceCounts[u.deviceId] > 1) isFraud = true;
                        if(isFraud) fraudCount++;

                        allAlerts.push({
                            type: 'referral',
                            data: { ...u, referrer: u.referrer_id },
                            time: u.regDate ? new Date(u.regDate).getTime() : Date.now(),
                            priority: isFraud ? 'critical' : 'medium',
                            isFraud: isFraud
                        });
                    }
                });

                // Sort by time desc
                allAlerts.sort((a, b) => b.time - a.time);

                // Update Counters
                if(document.getElementById('monitorPendingCount')) 
                    document.getElementById('monitorPendingCount').innerText = pendingCount;
                if(document.getElementById('monitorFraudCount'))
                    document.getElementById('monitorFraudCount').innerText = fraudCount;
                
                // Render Feed
                feed.innerHTML = '';
                if(allAlerts.length === 0) {
                    feed.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">ระบบปกติ ไม่มีรายการแจ้งเตือน</div>';
                } else {
                    allAlerts.forEach(alert => {
                        const item = document.createElement('div');
                        item.className = 'monitor-item';
                        if(alert.priority === 'critical') item.style.borderLeft = '4px solid var(--danger)';
                        else if(alert.priority === 'high') item.style.borderLeft = '4px solid var(--warning)';
                        else item.style.borderLeft = '4px solid var(--primary)';

                        let icon = '';
                        let title = '';
                        let desc = '';
                        let time = new Date(alert.time).toLocaleTimeString('th-TH');

                        if(alert.type === 'trans') {
                            icon = '<i class="fas fa-exchange-alt" style="color:var(--warning)"></i>';
                            title = `แจ้งฝาก/ถอน: ${alert.data.user}`;
                            desc = `${alert.data.type === 'deposit' ? 'ฝาก' : 'ถอน'} ฿${parseFloat(alert.data.amount).toLocaleString()}`;
                        } else if(alert.type === 'referral') {
                            icon = alert.isFraud ? '<i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i>' : '<i class="fas fa-user-plus" style="color:var(--primary)"></i>';
                            title = `สมัครสมาชิกใหม่: ${alert.data.username}`;
                            desc = `Ref: ${alert.data.referrer || '-'} ${alert.isFraud ? '<span style="color:var(--danger)">(เสี่ยงทุจริต)</span>' : ''}`;
                        }

                        item.innerHTML = `
                            <div style="display:flex; gap:15px; align-items:center;">
                                <div style="width:40px; height:40px; background:rgba(255,255,255,0.05); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                    ${icon}
                                </div>
                                <div>
                                    <div style="font-weight:bold; font-size:0.9rem;">${title}</div>
                                    <div style="font-size:0.8rem; color:var(--text-muted);">${desc}</div>
                                </div>
                                <div style="margin-left:auto; font-size:0.75rem; color:var(--text-muted);">${time}</div>
                            </div>
                        `;
                        
                        if(alert.priority === 'critical' && soundEnabled) playBeep(); 

                        feed.appendChild(item);
                    });
                }

            } catch(e) {
                console.error('Monitor Error:', e);
            }
                }



        function clearAllAlerts() {
             updateMonitor();
             showToast('รีเฟรชข้อมูลแล้ว', 'success');
        }

        // Hook into LiveSync
        liveSync.on('transactions', (data) => {
            if(data && data.length > 0) {
                 const hasPending = data.some(t => t.status === 'pending');
                 if(hasPending) {
                     playBeep();
                     showToast('มีธุรกรรมใหม่เข้ามา!', 'info');
                 }
            }
            updateMonitor();
            renderTrans();
            renderDashboard();
        });

        liveSync.on('referrals_updated', (data) => {
             // Check if pending in the update data
             // data structure: { username: referrerName, refs: [...] }
             const pendingRef = data.refs.find(r => r.status === 'pending');
             if(pendingRef) {
                 playBeep();
                 showToast(`เพื่อนใหม่! ${pendingRef.name} สมัครผ่านรหัสแนะนำ (รอตรวจสอบ)`, 'info');
             }
             updateMonitor();
             renderReferrals();
        });

        // Initial Load
        loadPaymentSettings();

        renderDashboard();
        renderTrans(); // to set badge
        renderReferrals(); // to set badge
        updateMonitor(); // Init monitor
        
        // Poll for updates
        setInterval(() => {
            updateMonitor();
            // renderDashboard(); // Optional: refresh dashboard stats too
        }, 10000);
        
        // Additional Pulse Animation for Monitor
        setInterval(() => {
            const dot = document.querySelector('.pulse-dot');
            if(dot) {
                dot.style.opacity = (dot.style.opacity === '0.5' ? '1' : '0.5');
            }
        }, 800);
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

    </script>
</body>
</html>